Коротко:

1. Да, эпик по Swagger/AsyncAPI логично доводить уже **новым агентом** с обновлённым контрактом. Текущий агент много сделал, но часть требований по Swagger/AsyncAPI реализована временными решениями.
2. Да, с изменениями Ильи нужно будет **связываться через `develop`**: новый агент должен смотреть git, сравнивать `codex/*` c `develop` и в конце готовить базу для merge (или прямой merge, если доверяешь).

Ниже — структурированный вывод по твоему ORACLE-контракту.

---

## 1. SESSION_EVAL

### 1.1. Оценка сессии agentID=`019aa9cf-d792-7bc0-8083-f73177d4bfc6`

**completeness_score:** **88/100**
**accuracy_score:** **92/100**
**progress_pct по эпику:** **~85%**

**Почему так:**

* Агент:

  * Починил Keycloak/логины на CFA1 и довёл до зелёного Playwright для:

    * Backoffice KYC (`backoffice-kyc.spec.ts`)
    * Issuer dashboard + reports (`issuer-reports.spec.ts`)
    * Скрины и команды тестов зафиксированы в логах и DoD. 
  * Сделал e2e для backoffice audit (NX‑08) + обновил `tasks/NX-08-backoffice-audit-log-ui.md` и CHANGELOG. 
  * Добавил и заполнил `docs/deploy/API-DOCS-SWAGGER-ASYNCAPI.md` c инвентаризацией Swagger/AsyncAPI (dev vs CFA1) и branch policy (`develop` как основной интеграционный, `infra.defis.deploy` — legacy).  
  * Починил Swagger на CFA1 (gateway): `https://api.cfa1.llmneighbors.com/swagger/index.html` → HTTP 200, добавил Playwright `swagger-availability.spec.ts`, обновил CHANGELOG и закоммитил `fix(swagger): [co-8c38] - cfa1 swagger now reachable`. 
  * Явно зафиксировал в плане: NX‑06 и NX‑08 закрыты, остаётся Swagger/AsyncAPI inventory и doc/CHANGELOG-апдейты (и их он в итоге делает). 

* Но:

  * Swagger полноценно поднят **только для gateway наружу**; per‑service Swagger проверен и частично доступен только на внутренних портах (identity 200, остальные частично 404), без финального выноса наружу за nginx с normal-конфигом `Swagger:Enabled=true` — есть временный “DEV-env для gateway”. 
  * AsyncAPI: оформлен как docs (источник `packages/contracts/asyncapi.yaml`, указаны способы просмотра), но **нет e2e/contract-валидатора** в DoD, только инструкции. 
  * NX‑06: UI и спецификация есть, но Playwright для payout schedule пока в более «stub»-режиме (по логам — добавлен и задокументирован, но не доведён до такого уровня, как KYC/audit/issuer). 

**Вывод:**
Старый агент отлично закрыл регрессии NX‑05/07/08, e2e по KYC/Issuer/Audit и базовый Swagger/AsyncAPI-инвентарь. Но твои новые требования по **жёсткой e2e-проверке Swagger/AsyncAPI** и аккуратной публикации Swagger без хака через `ASPNETCORE_ENVIRONMENT=Development` реализованы не до конца → оставшиеся ~15% лучше отдать новому агенту.

---

### 1.2. Summary by phase (как будто фазы эпига)

**Phase 1 — NX‑05/07/08 регрессии + backend: ~100%**

* Починка KYC/identity/issuance/compliance/registry и прогоны `dotnet test` (compliance). 
* Устранение 404/500 в issuance и выравнивание контрактов через `IntegrationEvents`, DTO и tests (по git-отчётам). 

**Phase 2 — e2e / Playwright для KYC + issuer + audit: ~100%**

* Backoffice KYC e2e — зелёный, скриншоты и команды задокументированы. 
* Issuer dashboard + reports e2e — зелёные, есть артефакты. 
* Backoffice audit e2e (NX‑08) — зелёный smoke-тест, DoD/CHANGELOG обновлены, скрины в `artifacts/tests/e2e/playwright/...backoffice-audit-page.e2e.png`. 

**Phase 3 — Swagger/AsyncAPI inventory + e2e: ~70–75%**

* Добавлен отдельный документ-инвентарь Swagger/AsyncAPI с таблицами по сервисам и описанным dev/CFA1 статусом. 
* Gateway Swagger на CFA1 поднят и проверен через e2e `swagger-availability.spec.ts`, CHANGELOG отражает переход с ❌ 404 → ✅ 200. 
* Пер-сервис Swagger проверен изнутри (curl на порты 55001/5/6/7/8), identity даёт 200, часть сервисов — 404. 
* AsyncAPI указана как источник правды (`packages/contracts/asyncapi.yaml`), но без e2e/валидатора и без жёсткого DoD-пункта про синхронизацию с `IntegrationEvents`. 

**Phase 4 — Branch policy, DoD обновления, мета-доки: ~90%**

* В swagger/asyncapi-доке описана branch policy: `develop` — основной интеграционный, `infra.defis.deploy` — legacy, не считать “main”. 
* NX‑05/07/08 tasks-файлы и CHANGELOG обновлены с реальными URL, командами тестов и ссылками на артефакты e2e.  
* FINAL SELF-CHECK в сессии просмотрен и отмечен как полностью выполненный. 

Рекомендация: **новый агент** с очищенным контекстом и уже готовыми доками (API-DOCS-SWAGGER-ASYNCAPI.md) как стартовой базой.

---

## 2. REQUIREMENTS_FROM_VOICE

### 2.1. Explicit requirements (из голосовых и текущего сообщения)

Из сессии `...1742.session.txt`:

1. **Swagger на eywa1 и cfa1 обязателен и не должен отдавать 404**

   * `http://65.108.157.9:5000/swagger` (eywa1) и `http://87.249.49.56:5000/swagger` (cfa1) сейчас не работают — это баг, который нужно фиксить, а не обходить. 

2. **Добавить в требования/DoD:**

   * “Всегда e2e валидировать хотя бы один важный endpoint через Swagger/AsyncAPI hosted apps”. 

3. **Ужесточение: e2e-доступность каждого Swagger и AsyncAPI**

   * Цитата по смыслу:

     > *“я сказал, ты ДОЛЖЕН e2e availability of each swagger and async api with e2e test, choose also that every endpoint is working! it should be covered! you must fix it.”* 
   * То есть: не просто проверить HTML `/swagger/index.html`, а **проверять хоть подмножество эндпоинтов с реальными ответами** + закрывать 404/500 как регрессии.

4. **Новый explicit requirement из текущего сообщения:**

   * Эпик по Swagger/AsyncAPI **не считать завершённым**, пока:

     * Swagger/AsyncAPI “нормально подняты” (без костылей; минимизировать зависимость от `ASPNETCORE_ENVIRONMENT=Development` на прод-узле).
     * Есть реальные e2e по Swagger/AsyncAPI части.
   * Нужен **свежий агент** для этого этапа.

5. **Git / ветки / Илья (`ii`):**

   * Илья коммитит свои изменения в `develop`, там:

     * правки UI (тёмная тема, унификация меню, компоненты из shared SDK),
     * бекенд для KYC flow,
     * расширение OpenAPI по KYC,
     * тесты для backend compliance,
     * KYC форма в кабинете инвестора и сетап фронтовых тестов.
   * Требование: новый агент должен **смотреть git, учитывать изменения Ильи в `develop`** и в конце подготовить merge/align (`codex/*` ↔ `develop`).

6. **Branch policy:**

   * `develop` — основной integration branch.
   * `infra.defis.deploy` — legacy baseline (UK1/CFA1 деплой), **не считать “main”**. 

### 2.2. Implicit requirements

1. **Не довольствоваться временными хаками:**

   * Включать Swagger через `ASPNETCORE_ENVIRONMENT=Development` — признано временным костылём. В долгосроке нужно перейти на конфиг `Swagger:Enabled=true` + nginx basic auth / IP-based access. 

2. **AsyncAPI как контракт, а не просто файл:**

   * `packages/contracts/asyncapi.yaml` должен быть:

     * синхронизирован с реальными `IntegrationEvents`,
     * валиден (`npx @asyncapi/cli` и т.п.),
     * использоваться как doc source (preview docs / studio). 

3. **Автономный агент:**

   * Агент должен сам:

     * запускать `dotnet test` и Playwright,
     * фиксировать артефакты (скрины, логи) и добавлять ссылки в tasks/DoD,
     * не останавливаться на “микрофиксах”.

4. **Git-awareness:**

   * Агент обязан регулярно:

     * делать `git status`, `git log --oneline --graph`, `git diff` между `codex/fix-cfa1-regressions` и `develop`,
     * не затирать коммиты Ильи и согласовать UI-правки с существующими e2e.

### 2.3. Corrections

1. Коррекция по swagger-доступности:

   * Агент сначала пытался объяснить 404 как “вероятно не проброшено” и перенести фокус на внутренние порты и домен, ты **жёстко поправил**, что:

     * 404 на домене `https://api.cfa1.llmneighbors.com/swagger...` — это не норма, а регрессия, которую нужно починить и покрыть e2e. 

2. Коррекция DoD:

   * Изначальный DoD не содержал обязательной e2e-проверки Swagger/AsyncAPI — ты потребовал явно включить это как обязательный пункт.

3. Сейчас (в этом сообщении):

   * Ты фиксируешь, что **по AsyncAPI** агент “не может нормально доделать и поднять” → значит, текущий уровень документации тебя не устраивает, нужно усиливать специфику и/или e2e/валидаторы.

### 2.4. Suggestions (из твоего контекста)

* Использовать **нового агента** с уже готовой базой:

  * `docs/deploy/API-DOCS-SWAGGER-ASYNCAPI.md` как стартовая карта по Swagger. 
  * Дальше: углубить, расширить до версий 1.0, добавить AsyncAPI coverage.

* По merge с Ильёй:

  * Работать либо в новой ветке от `develop`, либо аккуратно ребейзнуть `codex/fix-cfa1-regressions` на `develop`, чтобы UI/SDK/комплаенс-изменения Ильи стали базой для финальных KYC/e2e/Swagger-фиксов.

---

## 3. UPDATED_JTBD_CONTRACT

### 3.1. Jobs (для нового агента)

**J0. Re-validate & protect previous work**

* Убедиться, что после синхронизации с `develop` всё, что сделал предыдущий агент (NX‑05/07/08, e2e, swagger-availability) не сломано.

**J1. Swagger / AsyncAPI эпик — довести до “нормально поднято”**

* Gateway Swagger:

  * Безопасно поднят на dev и CFA1.
  * Не зависит от DEV-окружения на проде; используется `Swagger:Enabled=true`/конфиги и nginx basic auth/IP. 
  * e2e Playwright/CLI-тесты на доступность (и минимум один рабочий endpoint).

* Per-service Swagger (issuance, settlement, registry, identity, compliance, fabric-gateway, интеграции):

  * На dev: все основные сервисы отвечают на `/swagger/index.html` (минимум 200).
  * На CFA1: либо доступны по внутренним портам (через SSH-tunnel) и задокументированы в API-DOCS, либо (если выведены наружу) — за nginx и basic auth. 

**J2. AsyncAPI как живой контракт**

* `packages/contracts/asyncapi.yaml`:

  * валиден (cli-валидатор),
  * содержит ключевые каналы для KYC/issuance/audit и синхронизирован с `packages/domain/IntegrationEvents.cs`. 
  * есть инструкция/скрипт для генерации docs (`npx @asyncapi/cli preview docs ...`). 

* Минимум один сценарий (manual или автотест), который демонстрирует, что событие из AsyncAPI реально эмитится после бизнес-операции (например, KYC-approve → KYCCompletedEvent).

**J3. E2E / Playwright покрытие с учётом Ильи и Swagger/AsyncAPI**

* Актуализировать и стабилизировать:

  * `backoffice-kyc.spec.ts`
  * `issuer-reports.spec.ts`
  * `backoffice-audit.spec.ts`
  * `swagger-availability.spec.ts`
  * Плюс расширения, связанные с KYC-инвестора, которые внедрил Илья (новая форма, валидации, документы).

* Убедиться, что UI-унификация (общий AppShell/меню/тёмная тема, shared-ui SDK) **не ломает** сценарии и отражена в тестах.

**J4. Git alignment: codex/fix-cfa1-regressions ↔ develop**

* Синхронизироваться с веткой `develop` (где работают Илья и команда):

  * План: либо новый `codex/swagger-asyncapi-*` от `develop`, либо аккуратный rebase/merge существующей ветки.
* В конце: подготовить чистую ветку, которую можно безболезненно слить в `develop`.

**J5. Docs / Tasks / Runbooks**

* Обновить:

  * `docs/deploy/API-DOCS-SWAGGER-ASYNCAPI.md` до версии 1.x (полный инвентарь + статусы + политика экспонирования). 
  * `tasks/NX-05...`, `tasks/NX-06...`, `tasks/NX-07...`, `tasks/NX-08...` с:

    * реальными URL (prod/dev),
    * командами тестов (`dotnet test`, `npx playwright ...`),
    * ссылками на артефакты (скрины, логи),
    * пометкой, что Swagger/AsyncAPI проходят e2e/валидацию.

### 3.2. DoD (обновлённый)

* Для каждого J*:

  * минимум один осмысленный коммит формата
    `{code-change} + {code-test} + {test-artifacts/output} + {update-docs-DoD-Kickoff-checkboxes}`.

* Все изменённые .NET-сервисы нормально стартуют локально и на CFA1/eywa1.

* Прогнаны и зафиксированы:

  * `dotnet test` для затронутых сервисов (минимум `services/compliance`, плюс по необходимости issuance/registry/settlement). 
  * Playwright e2e:

    * backoffice-kyc,
    * issuer-reports,
    * backoffice-audit,
    * swagger-availability + новые сценарии по KYC-инвестора.

* Swagger:

  * Gateway Swagger 200 на dev и CFA1.
  * В API-DOCS перечислены все сервисы с их Swagger URL + статус (200/404) + планы/причины (если что-то внутреннее).
  * 404/500 на ожидаемых swagger-URL считаться регрессиями и либо исправлены, либо честно задокументированы как временное ограничение.

* AsyncAPI:

  * `asyncapi.yaml` валиден и синхронизирован с доменными событиями.
  * Есть хотя бы один end-to-end сценарий, который подтверждает реальное использование хотя бы одного события.

* Branch policy:

  * Документировано и соблюдается:

    * `develop` = main integration,
    * `infra.defis.deploy` = legacy,
    * codex-ветки работают поверх `develop`.

### 3.3. Constraints

* Autonomy Level 3:

  * разрешено создавать/обновлять docs, спецификации, новые тесты, но без радикального перелома архитектуры.
* Работать строго по циклам {plan → code → tests → docs → commit}.
* Запрещено “фиксить swagger” только через постоянный перевод сервисов на `ASPNETCORE_ENVIRONMENT=Development` на прод-узлах без описания/миграции на `Swagger:Enabled=true`.
* Всегда учитывать изменения в `develop` (особенно UI/SDK/KYC от Ильи), не затирать их.

---

## 4. AGENT_PROMPT (for Codex-Cli)

````text
Ты — Codex-агент для проекта OIS-CFA.

Контекст:
- Репозиторий: ~/__Repositories/yury-customer/prj_Cifra-rwa-exachange-assets/repositories/customer-gitlab/ois-cfa
- Основная интеграционная ветка: develop
- Твоя рабочая ветка: либо существующая codex/fix-cfa1-regressions (с предварительным rebase на develop), либо новая ветка от develop (уточни через git и зафиксируй выбор в docs).
- Цель: довести до ума эпик по регрессиям NX‑05/06/07/08 + Swagger/AsyncAPI, не ломая изменения Ильи в develop.

AGENT_JTBD_CONTRACT (обновлённый):

Jobs:
- J0: Re-validate предыдущие фиксы (NX‑05/07/08, e2e, swagger-availability) после синхронизации с develop.
- J1: Swagger/AsyncAPI эпик:
  - Надёжный и безопасный Swagger для gateway и ключевых сервисов (dev и CFA1).
  - E2E-проверка доступности и хотя бы одного рабочего endpoint через Swagger.
- J2: AsyncAPI как живой контракт:
  - Валидация и синхронизация asyncapi.yaml с доменными событиями.
  - Минимум один проверенный сценарий генерации события.
- J3: E2E покрытие с учётом изменений Ильи:
  - Обновить/стабилизировать backoffice-kyc, issuer-reports, backoffice-audit, swagger-availability + сценарии KYC-инвестора.
- J4: Git alignment:
  - Согласовать codex-ветку с develop (UI/SDK/KYC/тесты от Ильи).
- J5: Документация/DoD:
  - Обновить tasks/NX-05..08 и docs/deploy/API-DOCS-SWAGGER-ASYNCAPI.md с реальными URL, командами тестов и ссылками на артефакты.

Definition of Done:
- Для каждого J* есть минимум один коммит формата:
  {code-change} + {code-test} + {test-artifacts/output} + {update-docs-DoD-Kickoff-checkboxes}.
- Все модифицированные сервисы успешно стартуют локально и на CFA1/eywa1.
- Прогнаны и задокументированы:
  - dotnet test (минимум services/compliance; плюс по необходимости issuance/registry/settlement).
  - Playwright e2e:
    - tests/backoffice-kyc.spec.ts
    - tests/issuer-reports.spec.ts
    - tests/backoffice-audit.spec.ts
    - tests/swagger-availability.spec.ts
    - + новые сценарии для KYC-инвестора, если нужны.
- docs/deploy/API-DOCS-SWAGGER-ASYNCAPI.md:
  - актуален для dev и CFA1;
  - содержит таблицы сервисов и их Swagger URL + статус (200/404/hidden/internal);
  - описан branch policy (develop как integration, infra.defis.deploy как legacy).
- asyncapi.yaml:
  - валиден (через npx @asyncapi/cli validate/preview);
  - синхронизирован с IntegrationEvents.cs;
  - описано, как его просматривать (AsyncAPI Studio, cli preview).
- tasks/NX-05..NX-08:
  - обновлены с реальными URL (issuer/backoffice/api/...), командами тестов, ссылками на артефакты (скрины/логи) и статусами Verified @ cfa1/dev.

AGENT_WORKFLOW_CONTRACT:

1. PLAN
   - Сопоставь текущий git state с JTBD и DoD.
   - Проверь ветки: git branch -vv, git log --oneline --graph --decorate --all.
   - Сформируй мини-план на 1–3 цикла вида:
     {code-change} → {tests} → {docs/DoD-update} → {commit}.

2. EXECUTE
   - Выполняй изменения малыми, осмысленными порциями.
   - Запускай соответствующие тесты:
     - Backend: PATH=$HOME/.dotnet:$PATH dotnet test services/compliance/compliance.csproj
       (+ по необходимости другие сервисы).
     - E2E/Playwright: cd tests/e2e-playwright && npx playwright test <нужные spec.ts>.
   - Для Swagger/AsyncAPI:
     - Используй docs/deploy/API-DOCS-SWAGGER-ASYNCAPI.md как инвентарь, обновляй его по факту.
     - Для AsyncAPI используй npx @asyncapi/cli preview docs packages/contracts/asyncapi.yaml и/или validate.

3. AUDIT SELF
   - Явно проверь чек-лист «Common Agentic Problems»:
     - Проверил ли e2e (особенно Playwright)?
     - Прогнал ли dotnet test на реальных/близких к реальным данных?
     - Нет ли “тихого” фоллбэка (404/500, проигнорированные ошибки)?
     - Обозначены ли все блокеры честно?
     - Сделан ли осмысленный коммит с кодом, тестами, артефактами и обновлением docs/tasks?

4. CONTINUE OR STOP
   - Не останавливайся, пока DoD по активным JTBD не будет закрыт или пока не наткнёшься на жёсткий блокер (например, недоступен брокер, нет доступа к прод-серверу).
   - Все допущения фиксируй в tasks/ASSUMPTIONS блоке (например, если не можешь безопасно изменить infra на CFA1).

Constraints:
- Autonomy Level 3: можешь создавать/обновлять доки, новые Playwright- и unit-тесты, расширять спецификации.
- Нельзя решать проблему Swagger только переводом сервисов в ASPNETCORE_ENVIRONMENT=Development на прод-узлах без описания и планируемой миграции на Swagger:Enabled + nginx auth.
- Всегда уважай изменения в ветке develop (особенно UI/SDK/KYC от Ильи) и не затирай их без анализа.

Обязательный блок перед завершением:

```markdown
FINAL SELF-CHECK (обязателен перед завершением сессии)

- [ ] QA: все изменения покрыты тестами (unit/e2e/Playwright, если применимо)
- [ ] Тесты прогнаны на реальных/приближенных к реальным данных
- [ ] Падения/регрессии явно зафиксированы, нет «тихого» фоллбэка
- [ ] Честно описаны блокеры ("невозможно реализовать, потому что …")
- [ ] Git: сделан(ы) осмысленный(е) commit(ы) формата:
      {code-change} + {code-test} + {test-artifacts/output} + {update-docs-DoD-Kickoff-checkboxes}
````

```

---

## 5. NEXT_STEPS_FOR_HUMAN

**Перед запуском нового агента:**

- [ ] Убедиться, что локальный репозиторий синхронизирован:
  - `git fetch origin`
  - `git checkout develop && git pull`
  - проверить ветку Ильи и свои codex-ветки.
- [ ] Решить стратегию ветки для нового агента:
  - либо продолжать `codex/fix-cfa1-regressions`, предварительно `git rebase develop`,
  - либо создать новую `codex/swagger-asyncapi-finish` от актуального `develop`.
- [ ] Проверить, что доступ к CFA1/eywa1 у агента есть (ssh ключи, hostnames).
- [ ] Скопировать AGENT_PROMPT в codex-cli и запустить новую сессию с этим контрактом.

**После работы нового агента:**

- [ ] Просмотреть его отчёт и FINAL SELF-CHECK.
- [ ] Самостоятельно открыть:
  - `https://api.cfa1.llmneighbors.com/swagger/index.html`
  - основные порталы (issuer/backoffice/investor) + KYC-инвестора UI.
- [ ] Прогнать ключевые команды:
  - `PATH=$HOME/.dotnet:$PATH dotnet test ...`
  - `cd tests/e2e-playwright && npx playwright test` нужных spec.
- [ ] Если всё зелёное и DoD по Swagger/AsyncAPI устраивает —:
  - сделать merge codex-ветки в `develop`,
  - при необходимости — тэг/релиз для CFA1.

Если хочешь, дальше можем отдельно сузить DoD именно для AsyncAPI (какие каналы/события must-have, какой минимум e2e по брокеру нужен).
```
