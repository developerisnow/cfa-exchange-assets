Project Path: uk1

Source Tree:

```txt
uk1
├── docker-compose.keycloak-proxy.yml
└── nginx-cfa-portals.conf

```

`uk1/docker-compose.keycloak-proxy.yml`:

```yml
# Override file to expose Keycloak via public hostname behind nginx sidecar.
# Usage: docker compose -f docker-compose.yml -f docker-compose.override.yml -f ops/infra/uk1/docker-compose.keycloak-proxy.yml up -d keycloak keycloak-proxy

services:
  keycloak:
    ports:
      - "8081:8080"
    environment:
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"
      KC_HTTP_MANAGEMENT_ENABLED: "true"
      KC_HOSTNAME_URL: ${KEYCLOAK_PUBLIC_URL:-https://auth.cfa.llmneighbors.com}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_FEATURES: hostname:v1
    networks:
      ois-network:
        aliases:
          - keycloak

  keycloak-proxy:
    image: nginx:1.27-alpine
    container_name: ois-keycloak-proxy
    depends_on:
      - keycloak
    restart: unless-stopped
    volumes:
      - ./ops/keycloak/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs/keycloak:/etc/nginx/tls:ro
    ports:
      - "8080:8080"
      - "8443:8443"
    networks:
      - ois-network

```

`uk1/nginx-cfa-portals.conf`:

```conf
# Template for /etc/nginx/sites-available/cfa-portals.conf
# Usage: envsubst < nginx-cfa-portals.conf > /etc/nginx/sites-available/cfa-portals.conf
# Required env vars:
#   CFA_BASE_DOMAIN=cfa.llmneighbors.com
#   AUTH_HOST=auth.cfa.llmneighbors.com
#   ISSUER_HOST=issuer.cfa.llmneighbors.com
#   INVESTOR_HOST=investor.cfa.llmneighbors.com
#   BACKOFFICE_HOST=backoffice.cfa.llmneighbors.com
#   API_HOST=api.cfa.llmneighbors.com
# Optional:
#   KC_UPSTREAM=127.0.0.1:8081
#   ISSUER_UPSTREAM=127.0.0.1:3001
#   INVESTOR_UPSTREAM=127.0.0.1:3002
#   BACKOFFICE_UPSTREAM=127.0.0.1:3003
#   API_UPSTREAM=127.0.0.1:5000

map $http_x_forwarded_proto $forward_proto {
    default $http_x_forwarded_proto;
}

upstream kc_upstream { server ${KC_UPSTREAM:-127.0.0.1:8081}; }
upstream issuer_upstream { server ${ISSUER_UPSTREAM:-127.0.0.1:3001}; }
upstream investor_upstream { server ${INVESTOR_UPSTREAM:-127.0.0.1:3002}; }
upstream backoffice_upstream { server ${BACKOFFICE_UPSTREAM:-127.0.0.1:3003}; }
upstream api_upstream { server ${API_UPSTREAM:-127.0.0.1:5000}; }

proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Host $host;
proxy_set_header X-Forwarded-Proto https;
proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
proxy_read_timeout 120s;

ssl_certificate /etc/letsencrypt/live/${CFA_BASE_DOMAIN}/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/${CFA_BASE_DOMAIN}/privkey.pem;
ssl_session_cache shared:SSL:20m;

server {
    listen 80 default_server;
    server_name ${AUTH_HOST} ${ISSUER_HOST} ${INVESTOR_HOST} ${BACKOFFICE_HOST} ${API_HOST};
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ${AUTH_HOST};
    location / { proxy_pass http://kc_upstream; }
}

server {
    listen 443 ssl http2;
    server_name ${ISSUER_HOST};
    location / { proxy_pass http://issuer_upstream; }
}

server {
    listen 443 ssl http2;
    server_name ${INVESTOR_HOST};
    location / { proxy_pass http://investor_upstream; }
}

server {
    listen 443 ssl http2;
    server_name ${BACKOFFICE_HOST};
    location / { proxy_pass http://backoffice_upstream; }
}

server {
    listen 443 ssl http2;
    server_name ${API_HOST};
    location / { proxy_pass http://api_upstream; }
}

```