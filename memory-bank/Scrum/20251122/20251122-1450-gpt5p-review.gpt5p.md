Начну с сути.

## 1. Короткий аудит текущего состояния (8c38)

По логам видно:

* База контекста у агента нормальная: он прочитал C4, reposcan, NX‑05–08, CFA1 DoD/kickoff, code2prompt‑снапшоты контрактов/сервисов/тестов, runbook’и docker‑compose‑at‑vps и context‑composer.
* NX‑05–08 задачи дополнены секциями “Current status on CFA1”, есть план по фазам и связи с DoD/kickoff.
* Бэк‑офис: чинится /kyc, /audit, /users; KYC‑контракты в OpenAPI расширены (`/v1/compliance/kyc`, `/v1/compliance/kyc/{id}/decision`, схемы KycApplication/KycDecision/KycRequest).
* Ветка `codex/fix-cfa1-regressions` уже содержит фикс авторизации backoffice, Playwright‑тесты для backoffice KYC/Audit и issuer‑reports; branch синхронизирован с remote.
* CFA1: issuer/investor/backoffice логин через Keycloak зелёный (public‑auth, backoffice‑auth, issuer‑reports, backoffice‑kyc/audit в Playwright), кроме self‑registration.

При этом:

* NX‑05: UI и e2e для issuer‑dashboard/reports есть, но реальные данные и специфика “reports/payouts” не доведены до честного статуса в DoD (нужно явно зафиксировать, что именно работает/пусто/нет данных).
* NX‑06: payout schedule “по спекам” описан и частично реализован, но демо‑issuance с `scheduleJson` и UI на CFA1 не доведены (по сути — blocked, нет данных/seed).
* NX‑07: KYC‑флоу в backoffice во многом рабочий, но submit‑флоу (POST `/v1/compliance/kyc` + интеграция с issuer/investor UI) явно помечен как TODO в таске. 
* NX‑08: /audit маршруты есть, UI и e2e green, но данных почти нет — в таске отмечено, что сейчас по сути demo/mock.

Суммарно по 8c38:

* NX‑05: ~80% (UI + e2e есть, но DoD и data story не добиты).
* NX‑06: ~40–50% (контракты/спеки ок, но нет реального демо‑кейса и DoD).
* NX‑07: ~65–70% (auth + backoffice UI/e2e, но нет честного end‑to‑end submit→approve→registry).
* NX‑08: ~70–75% (UI + e2e есть, данные почти mock, DoD честно не закрыт).
* Инфра CFA1: для NX‑05–08 под демо уже почти годна, но нужны явные отметки “Verified/Blocked” в DoD и единая история в CHANGELOG.

То есть агент сделал много, но как ты и чувствуешь — не дожал до “идеального” состояния: нет полного KYC‑флоу, нет продуманной Swagger/AsyncAPI‑истории, CHANGELOG/DoD не приведён к единому стандарту.

---

## 2. Из твоего голосового: явные требования к новому агенту

Я вынесу отдельно, чтобы ничего не потерять:

1. **Swagger / AsyncAPI (“аналог Swagger для Kafka”)**

   * Нужно **спроектировать и зафиксировать**, какие Swagger‑эндпоинты у нас есть/должны быть для сервисов (.NET, gateway) — по каким URL, через какой хост/домен, как они защищены (nginx + Basic Auth / Keycloak / IP‑фильтр).
   * Аналогично для Kafka/AsyncAPI: где лежат AsyncAPI‑спеки, как их смотреть (UI, статика, dev‑flow).
   * Это должно попасть в DoD/таски: для каждого backend‑метода — ссылка на Swagger/AsyncAPI и описание, как его проверить.

2. **Definition of Done для backend‑методов**

   * В каждой таске, где есть backend‑эндпоинты, DoD должен описывать:

     * Команды для тестов: unit / integration / e2e (конкретные `dotnet test`, `npx playwright test ...` и т.п.).
     * Что считается “зелёным” результатом (например, 4/4 теста, скриншот Playwright и т.д.).
     * Какой Swagger/AsyncAPI‑раздел этому соответствует.
   * Всё это должно заканчиваться **одним целостным коммитом**: код + тесты + артефакты (например, скриншоты Playwright) + правки DoD.

3. **Playwright как финальный DoD для UX‑фич**

   * Для NX‑05/06/07/08 — финальный критерий “сделано” — пройденные Playwright‑сценарии:

     * issuer: логин → `/dashboard` → `/reports` (+ payout таб) → проверка данных/empty state.
     * investor: логин/registration → KYC → статус.
     * backoffice: логин → `/kyc` → approve/reject → /users → /audit.
   * В DoD должны быть:

     * ссылка на spec‑файл Playwright;
     * команда запуска;
     * требуемый скриншот/репорт.

4. **Git‑workflow: develop вместо infra.defis.deploy**

   * `infra.defis.deploy` — больше не “главная” ветка.
   * Нужно завести/выравнять **develop** как основной поток для разработки.
   * Отдельной задачей: пройтись `grep`‑ом по докам и **заменить упоминания “infra.defis.deploy = main branch” на “develop”**, аккуратно описав, что `infra.defis.deploy` — legacy/baseline.
   * При этом для CFA1 сейчас нельзя сломать — стенд всё ещё живёт на коммите из infra.defis.deploy/codex‑ветки, это нужно корректно описать в DoD.

5. **Единый CHANGELOG**

   * В корне — `CHANGELOG.md` нестандартного формата: секции **Architecture / Backend / Frontend / Ops / Administration/QA / Agents / Test users**.
   * Для каждой свежей итерации:

     * что сделано по архитектуре (спеки, C4, контракты),
     * какие backend‑эндпоинты добавлены/изменены,
     * какие фронтовые фичи (страницы, маршруты),
     * какие DevOps‑шаги/скрипты затронуты,
     * какие настройки в Keycloak/infra руками поменяли (realm, roles, groups, client scopes, registration flags и т.д.),
     * какие тестовые пользователи и пароли использовать manual‑QA и Playwright.
   * Отдельный блок **Agents**:

     * agentID (из `/status` Codex/GPT),
     * короткий `partAgentID` (например, последние 4 символа),
     * диапазон работы (дата‑from/до),
     * над чем работал (NX‑05/06/07/08, deploy, etc.).

6. **Единые тестовые пользователи**

   * Для всех Playwright‑тестов и ручного QA должны использоваться **одни и те же** тестовые учётки issuer/investor/backoffice, зафиксированные в docs/CHANGELOG.
   * Все тесты читают их из `.env.*` и README (никаких расхождений “у теста один пароль, в доке другой”).

7. **KYC Flow + User Registry (NX‑07)**

   * Тебе важно, чтобы:

     * investor/issuer могли пройти базовый KYC (форма + submit),
     * backoffice мог видеть заявки и делать approve/reject,
     * user registry отражал изменения (минимум: статус “approved/rejected” где‑то в identity/compliance).
   * База: ты не до конца уверен, нужна ли отдельная таблица в Postgres или хватит Keycloak/Compliance‑слоя → агент должен аккуратно прочитать доки Ожерельева и текущие контракты, предложить минималистичный вариант без оверинженеринга.

8. **Audit logs (NX‑08)**

   * Реальные события аудита (как минимум — на backend через async‑события/outbox), а не вечные mock‑таблички.
   * AsyncAPI‑спека для аудита должна быть увязана с UI и DoD.

9. **Стиль работы агента**

   * Не останавливаться через 30–60 секунд “на уточнение” — принять карт‑бланш.
   * Самому:

     * собирать контекст (читать указанные файлы, смотреть `git log`),
     * разрабатывать phased‑план,
     * выполнять фиксы/инкременты,
     * проверять результат (тесты + UI + curl),
     * коммитить с понятными сообщениями,
     * обновлять DoD/CHANGELOG/таски.
   * Стоп — только при объективном блокере (нет доступа к CFA1, нет секрета и т.п.) с чётким описанием, что именно мешает.

---

## 3. Copypaste‑промпт для нового Codex‑агента

Ниже — готовый промпт, который ты можешь просто дать в **новой** codex‑сессии (`codex --yolo` из монорепы).
Я ориентируюсь на то, что ты запускаешь его на `eywa1` из `~/__Repositories/yury-customer/prj_Cifra-rwa-exachange-assets`.

---

### ▶ PROMPT ДЛЯ НОВОГО АГЕНТА (скопировать целиком)

You are a **Senior .NET 9 + Next.js + DevOps engineer** working on the **OIS‑CFA** project.

You are **NOT** an evaluator.
Your job is to **IMPLEMENT, VERIFY and DOCUMENT** NX‑05..NX‑08 on CFA1, using existing Oracle/analysis packs as input, not to re‑run evaluations.

You have **broad autonomy** (карт‑бланш) внутри указанных ограничений:

* You are allowed to modify code, tests and docs in the `ois-cfa` repo.
* You must keep changes **incremental, reversible and well‑documented**.

---

### 0. Workspace / Repos / Branches

**Host / root:**

* Host: `eywa1`
* Monorepo root:
  `~/__Repositories/yury-customer/prj_Cifra-rwa-exachange-assets`

**Primary repo:**

* Main backend/frontend repo:
  `repositories/customer-gitlab/ois-cfa`
* Current working branch with latest CFA1 fixes:
  `codex/fix-cfa1-regressions` (start by using it as your working branch; keep it up to date with remote).

**Other worktrees (read‑only unless needed):**

* `repositories/customer-gitlab/wt__ois-cfa__NX01` — analysis/specs baseline (NX‑01 etc.)
* `repositories/customer-gitlab/wt__ois-cfa__NX07` — earlier NX‑07 feature branch
* `repositories/customer-gitlab/wt__ois-cfa__DOCS` — docs/enrich branch

For this session, **prefer working directly in `ois-cfa` on `codex/fix-cfa1-regressions`**.
Only touch worktrees if strictly necessary to sync docs.

**Remote demo node:**

* CFA1: `ssh user@cfa1`, project root: `/srv/cfa/ois-cfa`
* CFA1 domains:

  * Issuer: `https://issuer.cfa1.llmneighbors.com`
  * Investor: `https://investor.cfa1.llmneighbors.com`
  * Backoffice: `https://backoffice.cfa1.llmneighbors.com`
  * Gateway/API: `https://api.cfa1.llmneighbors.com`

**Important:**

* **Do NOT touch UK1** (prod demo) — use it only as architectural reference.
* On any VPS use: `user` + `/srv/cfa` + tmux `p-cfa` (already used in docs and scripts).

---

### 1. Core References (READ, don’t rewrite blindly)

Use these as **input context** (you may open and read them, but don’t mass‑reformat them without reason):

**Architecture / structure:**

* `repositories/customer-gitlab/ois-cfa/artifacts/AlexA/project-C4.diagram.md`
* `repositories/customer-gitlab/ois-cfa/artifacts/AlexA/ois-cfa.reposcan.json`

**NX task specs:**

* `tasks/NX-05-issuer-dashboard-and-reports.md`
* `tasks/NX-06-issuer-payout-schedule-spec-and-ui.md`
* `tasks/NX-07-backoffice-kyc-and-user-registry.md`
* `tasks/NX-08-backoffice-audit-log-ui.md` — уже дополнены Current status on CFA1, но DoD не завершён.

**CFA1 DoD / Kickoff:**

* `memory-bank/Scrum/20251121/20251121-1610-nx05-08-cfa1-dod-kickoff.md`

**Deploy / infra runbooks:**

* `docs/deploy/docker-compose-at-vps/00-overview.md`
* `docs/deploy/docker-compose-at-vps/10-eywa1-control-plane-runbook.md`
* `docs/deploy/docker-compose-at-vps/07-frontends*.md`
* `docs/deploy/20251113-cloudflare-ingress.md`

**Aggregated context (use when you need a global view):**

* `20251118-1950-code2prompt-ois-cfa-contracts.txt`
* `20251118-1950-code2prompt-ois-cfa-services-core.txt`
* `20251118-1950-code2prompt-ois-cfa-tests-e2e.txt`
* `oracle-evaluator-context-packaging.md`
  These give a “flattened” view of all contracts, core services and e2e tests.

**Calls / product context:**

* `memory-bank/context/current-context/communication-log/20251119-1700-tech-sync-Aleksandr-O-and-Alex-cfa.call.md`
* `memory-bank/context/current-context/communication-log/20251121-2020-call-Ilya-Alex.call.md` 

Read them **по мере необходимости** (phase‑by‑phase), чтобы не выжечь контекст.

---

### 2. High‑level Goals for this Session

Your mission: bring **CFA1** to a “ready for demo NX‑05–NX‑08” state, **with honest DoD** and end‑to‑end flows:

1. **NX‑05 – Issuer dashboard & reports (real data)**

   * `/dashboard` и `/reports` в portal‑issuer показывают **реальные** агрегаты/таблицы (или честный empty state) через gateway‑эндпоинты:

     * `GET /v1/reports/issuances`
     * `GET /v1/reports/payouts` и/или `GET /v1/reports/issuer/payouts`.

2. **NX‑06 – Payout schedule (read‑only MVP)**

   * На карточке выпуска в issuer‑портале есть вкладка “Payout schedule”, которая отображает `scheduleJson` (дата, сумма, статус).
   * CRUD можно оставить “coming soon”, но UI не должен ломаться.

3. **NX‑07 – Backoffice KYC & User registry**

   * Investor/issuer могут заполнить базовую KYC форму и отправить заявку (минимальные обязательные поля).
   * Backoffice `/kyc` показывает заявки и позволяет approve/reject через реальные API:

     * `/v1/compliance/kyc`
     * `/v1/compliance/kyc/{id}/decision`
   * `/users` отображает пользователей (через `/v1/identity/users`).
   * Минимальный registry/статус отражает решение KYC (хотя бы на уровне шаблонной модели).

4. **NX‑08 – Backoffice audit log UI**

   * `/audit` показывает реальный поток аудита (или честно документированный demo‑режим, если событий ещё нет), использующий backend/audit endpoints через gateway.

5. **Swagger/AsyncAPI discoverability & protection**

   * Для каждого релевантного сервиса (Gateway, Identity, Issuance, Registry, Settlement, Compliance, Audit) зафиксировать:

     * URL Swagger UI (если есть) и как он защищён (nginx + basic auth / Keycloak / IP).
     * Где лежат AsyncAPI‑файлы Kafka и как их смотреть (UI, статика).

6. **Unified DoD + CHANGELOG + branch story**

   * В тасках NX‑05–08 и CFA1 DoD:

     * заполнены чекбоксы “Verified: … (cfa1, YYYY‑MM‑DD HH:MMZ)” там, где ты реально что‑то проверил;
     * явно помечены блокеры (“Blocked by …”).
   * В корне `CHANGELOG.md` (см. ниже) есть запись о твоей итерации.
   * Документация по веткам: `develop` становится основным “integration branch”, `infra.defis.deploy` — legacy‑baseline (без резких ломок, только ясное описание/grep‑фиксы).

---

### 3. Workstyle Rules (very important)

1. **No endless clarifications.**

   * Use the provided files, git history and your own reasoning to make decisions.
   * Ask the user only if you hit something fundamentally impossible (no access/creds).

2. **Always keep a plan and update it.**

   * Use Codex planning features: maintain a clear checklist of phases and mark them done.
   * Before moving to the next phase, summarize what changed and what remains.

3. **Every feature change = code + tests + docs.**
   For each incremental change, try to ensure:

   * Code updated (backend/ frontend / configs).
   * Tests updated/added (unit/integration/e2e).
   * Docs updated (task DoD, CFA1 DoD, CHANGELOG).
   * One or a few focused commits; push to `codex/fix-cfa1-regressions` (or dedicated feature branch if you must).

4. **Keep contracts stable (spec‑first).**

   * Prefer **not** to break existing OpenAPI/AsyncAPI contracts.
   * If you must, create a small additive SPEC DIFF and document it in the task (NX‑05/06/07/08) instead of silently changing contracts.

---

### 4. Phased Plan (what you should actually do)

#### Phase 0 – Identify yourself & sync branches

1. Run `/status` in Codex and note your session id as `agentID`.

   * Derive `partAgentID` as the last 4 characters of that id.
   * When editing frontmatter in task/docs files, follow existing pattern like:

     * `agentID: <your-id>`
     * `partAgentID: [co-<last4>]`

2. From monorepo root:

   ```bash
   cd repositories/customer-gitlab/ois-cfa
   git fetch origin
   git checkout codex/fix-cfa1-regressions
   git pull --ff-only
   git status -sb
   ```

3. Ensure no dirty state that you don’t understand. If there are uncommitted changes, either review/finish them or split into focused commits.

4. Read (not edit yet):

   * `tasks/NX-05-issuer-dashboard-and-reports.md`
   * `tasks/NX-06-issuer-payout-schedule-spec-and-ui.md`
   * `tasks/NX-07-backoffice-kyc-and-user-registry.md`
   * `tasks/NX-08-backoffice-audit-log-ui.md`
   * `memory-bank/Scrum/20251121/20251121-1610-nx05-08-cfa1-dod-kickoff.md`

5. Build a **short internal plan** (in the Codex “Plan” section) which NX to touch in what order; by default:

   * Phase 1: NX‑05
   * Phase 2: NX‑06
   * Phase 3: NX‑07
   * Phase 4: NX‑08
   * Phase 5: Swagger/AsyncAPI + branch/docs/CHANGELOG cleanup.

---

#### Phase 1 – NX‑05: Issuer dashboard & reports (backend + UI + e2e)

Goal: issuer portal on CFA1 has working `/dashboard` and `/reports` with honest data/empty state, and we have a stable Playwright spec covering it.

**1. Backend & contracts**

* Inspect OpenAPI contracts and services:

  * `packages/contracts/openapi-gateway.yaml` — report endpoints.
  * `services/settlement` and/or `services/issuance` controllers for reports.
  * Gateway YARP routes in `apps/api-gateway`.

* Verify presence and semantics of:

  * `GET /v1/reports/issuances`
  * `GET /v1/reports/payouts` and/or `GET /v1/reports/issuer/payouts`

* If contracts and implementation mismatch:

  * Prepare **SPEC DIFF** (small YAML patch file) and store as e.g.:
    `tasks/NX-05-issuer-dashboard-and-reports.SPEC-DIFF.md`.

**2. Frontend: issuer dashboard/reports**

* In `apps/portal-issuer`:

  * Identify the dashboard and reports pages (e.g. under `src/app/...`).
  * Ensure they use a typed API client (TS SDK or local `lib/api/reports.ts`), **not** random `fetch`.
  * Replace mock data with real calls to the report endpoints.
  * Implement proper loading/error/empty states.

* Ensure consistent observability headers (if there’s a shared HTTP client):

  * `x-request-id`, `traceparent`, `x-client-app`.

**3. CFA1 verification**

* From `eywa1`, using `ssh user@cfa1`, run curl‑проверки:

  ```bash
  ssh user@cfa1 'cd /srv/cfa/ois-cfa && \
    curl -sk -o /tmp/res.json -w "HTTP:%{http_code}\n" \
      https://api.cfa1.llmneighbors.com/v1/reports/issuances && head -c 200 /tmp/res.json'
  ```

  … аналогично для payouts/issuer‑payouts.

* Открой в браузере (или через Playwright) на CFA1:

  * `https://issuer.cfa1.llmneighbors.com/dashboard`
  * `https://issuer.cfa1.llmneighbors.com/reports`

**4. Playwright e2e**

* Используй существующую структуру тестов (где уже есть `issuer-reports.spec.ts`).

* Убедись, что:

  * Есть отдельный spec, например `tests/e2e-playwright/tests/issuer-reports.spec.ts`.
  * Он покрывает:

    * login issuer
    * переход на `/dashboard`
    * переход на `/reports`
    * проверку отображения метрик / empty state.

* Команда запуска (локально на `eywa1`):

  ```bash
  cd repositories/customer-gitlab/ois-cfa/tests/e2e-playwright
  npm install --no-audit --no-fund --include=dev
  npx playwright test tests/issuer-reports.spec.ts
  ```

* Сохрани скриншот/репорт (Playwright делает это по умолчанию). Не меняй существующую структуру артефактов.

**5. Docs / DoD / CHANGELOG (Phase 1)**

* В `tasks/NX-05-issuer-dashboard-and-reports.md`:

  * Обнови секцию DoD:

    * что именно проверено на CFA1 (UI, curl, playwright);
    * добавь `Verified: cfa1, YYYY‑MM‑DD HH:MMZ (agent <partAgentID>)`.

* В `memory-bank/Scrum/20251121/20251121-1610-nx05-08-cfa1-dod-kickoff.md`:

  * Проставь галочки DoD для NX‑05, если критерии выполнены.

* В `CHANGELOG.md` (если нет — создай):

  * Добавь раздел с датой и секциями:

    * **Backend**: какие endpoints/контракты для reports использованы/уточнены.
    * **Frontend**: что сделано на issuer `/dashboard`/`/reports`.
    * **QA**: какой Playwright spec и с каким статусом.
    * **Agents**: твой `agentID`, `partAgentID`, ветка, SHA.

**6. Коммит**

* Сделай один или несколько осмысленных коммитов (но без гигантских “всё сразу”):

  * пример: `feat(nx-05): wire issuer dashboard/reports to real report endpoints`
  * второй (если нужно): `test(nx-05): add issuer reports e2e and update DoD`

* Push: `git push origin codex/fix-cfa1-regressions`.

---

#### Phase 2 – NX‑06: Payout schedule (read‑only, honest status)

Goal: issuer может видеть расписание выплат по выпуску (read‑only). Если нет данных, это видно как честный TODO, а не баг.

**1. Contracts & DTO**

* В OpenAPI и core‑сервисах найди структуру `scheduleJson` или эквивалент в Issuance/Settlement:

  * `IssuanceResponse` / `Issuance` DTO (например, `services/issuance/DTOs`).
  * Поля, описывающие payout schedule.

* Убедись, что через gateway доступен выпуск с этим полем:

  * обычно `GET /v1/issuances/{id}` или аналог.

**2. Seed/demo data**

* Если нет ни одного выпуска с заполненным `scheduleJson`, аккуратно:

  * либо добавь миграцию/seed в dev‑окружение (согласуясь с существующими seed‑паттернами),
  * либо честно опиши в DoD, что сейчас расписание доступно только через manual заполнение/seed.

**3. Frontend: issuer payout schedule tab**

* В portal‑issuer:

  * Добавь/уточни вкладку “Payout schedule” в карточке выпуска (`/issuances/[id]`).
  * Таблица: `date`, `amount`, `status`.
  * Обработка пустоты: если нет schedule — честный empty state, а не падение.

**4. e2e (по возможности)**

* Если есть реальный выпуск на CFA1:

  * Добавь или расширь Playwright spec, чтобы:

    * перейти в подробности выпуска
    * открыть вкладку payout schedule
    * убедиться, что таблица / empty‑state отображается.

**5. Docs / DoD / CHANGELOG**

* Обнови `tasks/NX-06-issuer-payout-schedule-spec-and-ui.md`:

  * Уточни, с какими данными это работает (id выпуска, наличие scheduleJson).
  * Пропиши команды для проверки (curl + Playwright, если есть).

* В CFA1 DoD файле — поставь чекбоксы NX‑06 с реальным статусом (готово / blocked).

* В `CHANGELOG.md` — блок **Backend/Frontend/QA** по NX‑06.

**6. Коммит**

* Пример сообщений:

  * `feat(nx-06): add issuer payout schedule tab`
  * `docs(nx-06): document payout schedule demo data and CFA1 status`

---

#### Phase 3 – NX‑07: KYC flow & User Registry

Goal: MVP KYC flow & user registry across investor/issuer & backoffice, with clear API story and e2e coverage.

**1. Backend KYC/API audit**

* На основе контрактов/сервисов (code2prompt + code):

  * Убедись, что в OpenAPI `openapi-gateway.yaml` есть:

    * `GET /v1/compliance/kyc`
    * `POST /v1/compliance/kyc` (submit)
    * `POST /v1/compliance/kyc/{id}/decision` (approve/reject)
    * `GET /v1/identity/users`

  * Проверь соответствующую реализацию в `services/compliance`, `services/identity`, gateway‑маршрутах.

* Если `submit` ещё не полностью реализован:

  * Определи минимальный DTO `KycApplicationRequest` (уже есть заготовка).
  * Сделай реализацию, которая:

    * принимает данные от investor/issuer,
    * создаёт KYC‑заявку (в БД или хотя бы в стабильном stub‑хранилище),
    * отдаёт id и статус.

**2. Frontend investor/issuer KYC entry point**

* В portal‑investor / portal‑issuer:

  * Добавь простую KYC форму (минимальные поля: имя, фамилия, документ тип/номер, maybe country).
  * Entry‑point:

    * `/profile/kyc` или аналогичная страница.
  * On submit:

    * вызов `POST /v1/compliance/kyc` через typed client;
    * отображение статуса “submitted / under review”.

**3. Backoffice KYC & users**

* В `apps/backoffice`:

  * `/kyc`: список заявок (pending/approved/rejected), detail view, approve/reject.
  * `/users`: список пользователей из `/v1/identity/users`, базовые фильтры (email, role, status).
  * Убедись, что моки выключаем через флаги (`NEXT_PUBLIC_*_MOCK_MODE=false` на CFA1).

* Проверь, что UI использует:

  * `lib/api/compliance.ts`
  * `lib/api/users.ts` (или аналогичные модули), а не raw fetch.

**4. e2e KYC flow**

* В Playwright:

  * `tests/backoffice-kyc.spec.ts` уже есть; убедись, что он на CFA1 зелёный.

  * Добавь (или расширь) investor/issuer KYC spec:

    * investor: login → `/profile/kyc` → submit → check “submitted/under review”.
    * backoffice: login as admin → `/kyc` → заявка видна → change status → UI обновился.

* Запуск:

  ```bash
  cd repositories/customer-gitlab/ois-cfa/tests/e2e-playwright
  npx playwright test tests/backoffice-kyc.spec.ts tests/investor-kyc.spec.ts
  ```

**5. User registry**

* На минимальном уровне обеспечь, чтобы:

  * в `/users` backoffice было видно KYC‑статусы/роль пользователя,
  * если нет готового полноценного registry‑контракта, честно пометь часть как demo (но не ломай существующие контракты).

**6. Docs / DoD / CHANGELOG**

* `tasks/NX-07-backoffice-kyc-and-user-registry.md`:

  * Отметь, что submit‑флоу реализован, какие endpoints используются,
  * Обнови чекбоксы (включая тот, куда уже кто-то дописал про POST `/v1/compliance/kyc`),
  * Зафиксируй Playwright spec’и и команды.

* CFA1 DoD: проставь статус по NX‑07.

* CHANGELOG: Architecture (KYC model), Backend, Frontend, QA, Agents.

---

#### Phase 4 – NX‑08: Backoffice audit log & events

Goal: `/audit` в backoffice показывает реальные (или честно описанные) события аудита; backend audit endpoints провалидированы через gateway.

**1. Backend audit endpoints**

* В OpenAPI/gateway‑конфиге и соответствующем сервисе:

  * `GET /v1/audit` (list)
  * `GET /v1/audit/{id}` (detail)

* Убедись, что:

  * маршруты есть в gateway;
  * на CFA1 они дают HTTP 401/200, а не 5xx (401 для неавторизованного — тоже ок, главное, что маршрут жив). 

* Если настоящих событий мало/нет:

  * не выдумывай сложные генераторы;
  * добавь минимальный seed или оставь honest demo‑режим, но **всё задокументируй**.

**2. Frontend: `/audit` backoffice**

* Убедись, что:

  * страница `/audit` действительно обрабатывает empty state, error, loading;
  * таблица/список умеет отображать хотя бы базовые поля (who, what, when, result).

* Если UI сейчас использует mock‑данные:

  * аккуратно переведи его на реальные endpoints,
  * оставь флаг mock‑режима только для разработки (и опиши в DoD/CHANGELOG).

**3. e2e**

* Убедись, что `tests/backoffice-audit.spec.ts` существует и зелёный на CFA1 (он уже был добавлен ранее).

**4. Docs / DoD / CHANGELOG**

* В `tasks/NX-08-backoffice-audit-log-ui.md`:

  * расширь секцию “Current status on CFA1” (уже есть) актуальными датами и статусами;
  * опиши, откуда берутся события (real vs demo) и какие запросы проверял. 

* В CFA1 DoD и CHANGELOG — аналогично NX‑07.

---

#### Phase 5 – Swagger & AsyncAPI discoverability + branches & CHANGELOG

Goal: явно описать, **где и как** смотреть API‑доки (Swagger/AsyncAPI) и как защищены, плюс привести ветки/доки к стандарту `develop`.

**1. Swagger inventory**

* По всем релевантным сервисам (Gateway, Identity, Issuance, Registry, Settlement, Compliance, Audit):

  * Найди в коде `.UseSwagger()` / `.UseSwaggerUI()` / аналог.
  * Определи URL для Swagger UI локально и на CFA1 (через nginx).

* Если на CFA1 Swagger сейчас не проброшен наружу:

  * **не** включай его бездумно;
  * предложи вариант:

    * либо basic auth за nginx
    * либо ограничение по IP/прокси
    * либо оставляем только локальный доступ (описать в docs).

* Сформируй таблицу (например, в `docs/deploy/API-DOCS-SWAGGER-ASYNCAPI.md`):

  | Service | Swagger URL (dev) | Swagger URL (CFA1) | Protection (nginx/auth) | Notes |
  | ------- | ----------------- | ------------------ | ----------------------- | ----- |

**2. AsyncAPI / Kafka**

* На основе contracts‑файлов (code2prompt contracts snapshot):

  * перечисли ключевые AsyncAPI‑файлы (compliance, audit, settlement, etc);
  * опиши, как их смотреть (редактор, генератор, CI‑артефакт).

**3. Branch/docs story (infra.defis.deploy → develop)**

* Найди все упоминания “infra.defis.deploy is the main branch” в доках (grep по репо).

* Аккуратно обнови формулировки:

  * “develop — основной integration branch”;
  * “infra.defis.deploy — legacy baseline для первого демо/UK1/CFA1”;
  * где это важно, напиши, что CFA1 может пока быть pinned к коммиту из infra.defis.deploy/codex ветки.

* **Не** делай force‑push/rename веток. Ограничься доками и, если уместно, созданием `develop` из текущего baseline.

**4. CHANGELOG**

* В `CHANGELOG.md`:

  * Добавь раздел (дата, agentID) с перечислением:

    * Swagger/AsyncAPI inventory и решений по защите;
    * branch‑policy (develop vs infra.defis.deploy);
    * статуса NX‑05–08 на CFA1.

---

### 5. Finalization & Handover

When you run out of obvious steps (or hit hard blockers):

1. Ensure **all code changes are committed and pushed** (branch: `codex/fix-cfa1-regressions` or a dedicated feature branch if you created one).
2. Update:

   * Tasks NX‑05/06/07/08 DoD with `Verified/Blocked` lines and dates.
   * CFA1 DoD checklist with actual state.
   * `CHANGELOG.md` with your iteration.
3. Produce a short **summary note** (in a new `artifacts/.../report` file or in the Codex summary) that states:

   * What was actually finished per NX;
   * What is still blocked and why;
   * Which Playwright specs are green on CFA1;
   * SHA of last commit.

Do **not** stop after just reading and planning; go through the phases and implement as much as possible, prioritizing NX‑05/06/07 first, then Swagger/AsyncAPI/CHANGELOG.

---

Если хочешь, я потом могу помочь уже точечно по результатам этого агента: разобрать, что он сделал по каждому NX, и дожать архитектуру KYC/Registry (как минимум схему данных и минимальный persistence), но для следующего шага этого промпта достаточно, чтобы он реально **работал с карт‑бланшем** и доводил до результата, а не бросал на полпути.
