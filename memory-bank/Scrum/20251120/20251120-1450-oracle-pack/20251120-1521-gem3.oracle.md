# Prompt
"./20251120-1457-prompt3.oracle.md"
# Output 
–ü—Ä–∏–≤–µ—Ç, –ê–ª–µ–∫—Å. –Ø ‚Äî **Oracle Evaluator**.

–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≤–µ—Å—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: —Ç–≤–æ–π –º–∞—Å—Å–∏–≤–Ω—ã–π —Å–ø—Ä–∏–Ω—Ç –ø–æ –∫–æ–¥–∏–Ω–≥—É (NX-03...08), —Ä–∞–±–æ—Ç—É –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ (`eywa1` logs) –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

–¢—ã —Å–¥–µ–ª–∞–ª –æ–≥—Ä–æ–º–Ω—ã–π —Ä—ã–≤–æ–∫. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Control Plane –Ω–∞ `eywa1`) –∏ Codebase (Spec-First) –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å. –û–¥–Ω–∞–∫–æ, —Å—Ç—ã–∫ –º–µ–∂–¥—É –Ω–∏–º–∏ (Deploy/Config) –≤—Å—ë –µ—â–µ –∏—Å–∫—Ä–∏—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —á–∞—Å—Ç–∏ Auth –∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.

–ù–∏–∂–µ ‚Äî –º–æ–π –≥–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç –∏ –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ `*.cfa.telex.global`.

---

### 1. Deep Findings Table (Double Audit)

–Ø —Å–≤–µ–ª –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON-—Å–µ—Å—Å–∏–∏ (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞) –∏ TXT-–ª–æ–≥–æ–≤ (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞).

| Area | Severity | Finding | Missed by | Actions / Mitigation |
| :--- | :--- | :--- | :--- | :--- |
| **Infra / Ops** | **High** | **Reactive Permission Management.** –ê–≥–µ–Ω—Ç –Ω–∞ `cfa1` –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —É–ø–∏—Ä–∞–ª—Å—è –≤ `EACCES` –ø—Ä–∏ `npm install` –∏ –ª–µ—á–∏–ª —ç—Ç–æ —Ä—É—á–Ω—ã–º `chown`. –°–∫—Ä–∏–ø—Ç `deploy-node.sh` –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ "Hint", –Ω–æ –Ω–µ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º. | **GPT5 CLI (Ops)** | –í–Ω–µ–¥—Ä–∏—Ç—å –∂–µ—Å—Ç–∫–∏–π `chown -R user:user` –≤ –∫–æ–Ω–µ—Ü `deploy-node.sh` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º PM2/Build. |
| **Auth / Keycloak** | **High** | **Redirect URI Mismatch on cfa1.** –¢–µ—Å—Ç—ã Playwright –ø—Ä–æ—Ö–æ–¥–∏–ª–∏, –Ω–æ —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ 502/307 loops. –ü—Ä–∏—á–∏–Ω–∞: —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω –º–µ–∂–¥—É `NEXTAUTH_URL` –≤ `.env.local` –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–∞ –≤ Keycloak. –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ Keycloak (`bootstrap-realm.sh`) —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–æ–º–µ–Ω–æ–≤. | **Gemini3 (Dev)** | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `kcadm.sh` —Å –∂–µ—Å—Ç–∫–∏–º —Å–ø–∏—Å–∫–æ–º –¥–æ–º–µ–Ω–æ–≤ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ (Idempotent script), –∞ –Ω–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ —Ä—É—á–Ω–æ–π —Ç—é–Ω–∏–Ω–≥. |
| **Code / Tests** | Medium | **NX-03 Fix Reliability.** –§–∏–∫—Å 500-–π –æ—à–∏–±–∫–∏ —Å–¥–µ–ª–∞–Ω —á–µ—Ä–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç `null` –∏ `UseInMemoryDatabase`. –≠—Ç–æ –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ –ø—Ä–æ–¥–µ (`Npgsql`) –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥—Ä–∞–π–≤–µ—Ä–∞ –ø—Ä–∏ `FindAsync` –∏–¥–µ–Ω—Ç–∏—á–Ω–æ (–æ–±—ã—á–Ω–æ –¥–∞, –Ω–æ —Ä–∏—Å–∫ –µ—Å—Ç—å). | **GPT5 CLI (Dev)** | –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î (–≤ CI –ø–∞–π–ø–ª–∞–π–Ω–µ, –Ω–µ –ª–æ–∫–∞–ª—å–Ω–æ). |
| **NX-07 / KYC** | Medium | **Incomplete Implementation.** NX-07 –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ WIP/Deferred. –í–µ—Ç–∫–∞ `feature/NX-07` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –≤–º–µ—Ä–¥–∂–µ–Ω–∞ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —Å –ø–æ–ª–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º. | **All Agents** | –Ø–≤–Ω–æ –≤–∫–ª—é—á–∏—Ç—å NX-07 –≤ —Å–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç –∫–∞–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1, –∏–Ω–∞—á–µ Backoffice –±—É–¥–µ—Ç "–±–µ–∑–∑—É–±—ã–º". |
| **Git Hygiene** | Low | **Zip Policy Success.** –°–∫—Ä–∏–ø—Ç `zip_branches.sh` –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –æ—Ç–ª–∏—á–Ω–æ. –í–µ—Ç–∫–∏ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã. –ù–æ `feature/NX-07` –æ—Å—Ç–∞–ª–∞—Å—å –≤–∏—Å–µ—Ç—å –≤ worktree. | **-** | –ù–µ –∑–∞–±—ã—Ç—å –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å NX-07 –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. |

---

### 2. Mermaid View: The Delivery Pipeline

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≥–æ, –∫–∞–∫ —Ç–≤–æ–π –∫–æ–¥ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞, –∏ –≥–¥–µ –º—ã —Å–µ–π—á–∞—Å –º–µ–Ω—è–µ–º –∫–æ–ª–µ—Å–∞ (–¥–æ–º–µ–Ω).

```mermaid
flowchart TD
    subgraph Dev_Machine ["Dev Environment Monorepo"]
        Code[NX-05/06/08 Code] --> Merge[Merge to infra.defis.deploy]
        Merge --> Zip[Script: zip_branches.sh]
        Zip --> Repo[GitLab: ois-cfa]
    end

    subgraph Control_Plane ["Eywa1 Control Plane"]
        Repo --> Pull[git pull wt__NX01]
        Config[".env.cfa{n}" Local Secrets] --> DNS_Script["cloudflare-dns-upsert.sh"]
        DNS_Script --> CloudflareAPI
    end

    subgraph Targets ["Target VPS Nodes"]
        direction TB
        subgraph UK1 ["UK1 Stable"]
            Style1[Legacy Deploy]
        end
        
        subgraph CFA_Node ["CFA1 / FIN2"]
            User[User: user]
            Prov[provision-node.sh]
            Dep[deploy-node.sh]
            
            Prov --> Sys[System: Docker, Nginx, Users]
            Dep --> App[App: Docker Compose + PM2]
            
            App -.-> Auth_Fail["‚ö†Ô∏è Auth Redirect Issue"]
        end
    end

    CloudflareAPI --"New Domain: telex.global"--> CloudflareDNS
    CloudflareDNS --> CFA_Node
    
    style Auth_Fail stroke:#f00,stroke-width:2px,stroke-dasharray: 5 5
```

---

### 3. Auth & Domain Plan: Migration to `telex.global`

–ú—ã –ø–µ—Ä–µ–µ–∑–∂–∞–µ–º —Å `llmneighbors.com` –Ω–∞ `telex.global`. –≠—Ç–æ —Ç—Ä–µ–±—É–µ—Ç —Ö–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–∞—Ö.

**Root Cause –ø—Ä–æ–±–ª–µ–º –Ω–∞ cfa1:**
–ê–≥–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–∏–ª `.env.local` –¥–ª—è Next.js, –Ω–æ Keycloak (–≤–Ω—É—Ç—Ä–∏ Docker) "–Ω–µ –∑–Ω–∞–ª" –æ –Ω–æ–≤—ã—Ö –¥–æ–º–µ–Ω–∞—Ö, —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ –∫–æ–Ω—Ñ–∏–≥ (Realm) –æ—Å—Ç–∞–ª—Å—è —Å—Ç–∞—Ä—ã–º –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–ø–∞–ª.

**–ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏:**

1.  **Cloudflare Credentials:**
    *   –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ `/home/user/__Repositories/cloudflare__developerisnow/.env` –ª–µ–∂–∞—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è `telex.global`.
    *   –°–æ–∑–¥–∞–π –∫–æ–Ω—Ñ–∏–≥ `.env.cfa_new`:
        ```bash
        CF_ZONE_NAME=telex.global
        CF_ZONE_ID=<new_zone_id>
        CF_API_TOKEN=<new_token>
        CF_HOST_PREFIXES=auth,issuer,investor,backoffice,api
        CF_BASE_LABEL=cfa1  # –∏–ª–∏ cfa2
        ```

2.  **Certbot Strategy:**
    *   –ù—É–∂–Ω–æ –ø–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞ —Ü–µ–ª–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ (fin2/cfa1), —Ç–∞–∫ –∫–∞–∫ –¥–æ–º–µ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è. –°—Ç–∞—Ä—ã–µ certs –¥–ª—è `llmneighbors` –Ω–µ –ø–æ–¥–æ–π–¥—É—Ç.

3.  **Frontend Re-config:**
    *   –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ `/srv/cfa/ois-cfa/apps/*/` –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å `.env.local`:
        *   `NEXT_PUBLIC_API_BASE_URL=https://api.cfa1.telex.global`
        *   `NEXT_PUBLIC_KEYCLOAK_URL=https://auth.cfa1.telex.global`
        *   `NEXTAUTH_URL=https://<app>.cfa1.telex.global`

4.  **Keycloak Fix (The Silver Bullet):**
    *   –í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ –∫–æ–≤—ã—Ä—è–Ω–∏—è, –º—ã –Ω–∞–ø–∏—à–µ–º —Å–∫—Ä–∏–ø—Ç `ops/scripts/auth/update-redirects.sh`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –¥–æ–º–µ–Ω –∏ —á–µ—Ä–µ–∑ `kcadm.sh` –ø–∞—Ç—á–∏—Ç –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—ã —Ä–∞–∑–æ–º.

---

### 4. DoD & Kickoff (Next Sprint / Migration)

**Definition of Done –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏:**
- [ ] **DNS:** `*.cfa{n}.telex.global` —Ä–µ–∑–æ–ª–≤—è—Ç—Å—è –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞.
- [ ] **SSL:** Valid Let's Encrypt wildcard cert for `*.cfa{n}.telex.global`.
- [ ] **Auth:** –õ–æ–≥–∏–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `auth.cfa{n}.telex.global` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫ `Invalid redirect uri`.
- [ ] **E2E:** Playwright —Ç–µ—Å—Ç—ã (`npm test`) –ø—Ä–æ—Ö–æ–¥—è—Ç —Å –∫–æ–Ω—Ñ–∏–≥–æ–º –ø–æ–¥ `telex.global`.

**Kickoff Checklist:**
1.  –í—ã–±—Ä–∞—Ç—å —Å–µ—Ä–≤–µ—Ä-–∂–µ—Ä—Ç–≤—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é `fin2` –∫–∞–∫ —á–∏—Å—Ç—ã–π –ª–∏—Å—Ç, `cfa1` –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –±—ç–∫–∞–ø/—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ).
2.  –ü–æ–ª—É—á–∏—Ç—å `CF_ZONE_ID` –∏ —Ç–æ–∫–µ–Ω –¥–ª—è `telex.global`.
3.  –ó–∞–ø—É—Å—Ç–∏—Ç—å **Prompt Package A** (—Å–º. –Ω–∏–∂–µ).

---

### 5. Prompt Strategy (Copy & Paste)

–ß—Ç–æ–±—ã –∞–≥–µ–Ω—Ç—ã –Ω–µ —Ç—É–ø–∏–ª–∏, –¥–∞–≤–∞–π –∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞–∫–µ—Ç–∞–º–∏.

#### üì¶ Package A: "Infrastructure Migration & Auth Fix"
*–¶–µ–ª—å: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω –∏ –ø–æ—á–∏–Ω–∏—Ç—å Keycloak.*

**Context Files:**
- `docs/deploy/docker-compose-at-vps/10-eywa1-control-plane-runbook.md`
- `ops/scripts/deploy/deploy-node.sh`
- `ops/scripts/cloudflare-dns-upsert.sh`

**Prompt:**
```text
ROLE: DevOps Architect.
GOAL: Migrate environment 'fin2' to use domain '*.cfa2.telex.global'.
INPUTS: Cloudflare credentials for telex.global are available in env.

TASKS:
1. Create/Update `ops/scripts/auth/update-client-uris.sh`. This script must:
   - Exec into `ois-keycloak` container.
   - Authenticate `kcadm.sh`.
   - For clients [portal-issuer, portal-investor, backoffice], UPDATE `rootUrl`, `redirectUris`, `webOrigins` to match the argument `https://<app>.cfa2.telex.global`.
2. Create `.env.cfa2_telex` on eywa1 and run `cloudflare-dns-upsert.sh`.
3. SSH into `fin2`:
   - Run Certbot for new domain.
   - Update Nginx configs (replace llmneighbors -> telex.global).
   - Update `.env.local` for all 3 apps.
   - Restart PM2.
   - Run the new `update-client-uris.sh`.
4. Verify with `curl -I`.
```

#### üì¶ Package B: "E2E Verification"
*–¶–µ–ª—å: –ü—Ä–æ–≥–Ω–∞—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ –Ω–æ–≤–æ–º –¥–æ–º–µ–Ω–µ.*

**Context Files:**
- `tests/e2e-playwright/playwright.config.ts`
- `tests/e2e-playwright/.env` (template)

**Prompt:**
```text
ROLE: QA Automation Engineer.
GOAL: Verify deployment on `*.cfa2.telex.global`.
TASKS:
1. Update `tests/e2e-playwright/.env` with new domains (`telex.global`) and fresh credentials.
2. Run `npx playwright test`.
3. If auth fails, capture screenshot and analyze Keycloak logs.
4. If success, save report to `artifacts/tests/e2e/migration-success.png`.
```

---

### 6. Open Questions & Risks

1.  **SMTP Reputation:** –ù–æ–≤—ã–π –¥–æ–º–µ–Ω `telex.global` –º–æ–∂–µ—Ç –Ω–µ –∏–º–µ—Ç—å —Ä–µ–ø—É—Ç–∞—Ü–∏–∏. –ü–∏—Å—å–º–∞ –æ—Ç `auth` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è) –º–æ–≥—É—Ç –ª–µ—Ç–µ—Ç—å –≤ —Å–ø–∞–º –∂–µ—Å—Ç—á–µ, —á–µ–º —Å `llmneighbors`.
    *   *Mitigation:* –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–∞–ø–∫—É –°–ø–∞–º, –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å DKIM/SPF (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞).
2.  **Data Persistence:** –ü—Ä–∏ –ø–µ—Ä–µ–µ–∑–¥–µ –Ω–∞ `fin2` –º—ã —Ç–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å `cfa1`, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–º –≤–æ–ª—å—é–º—ã.
    *   *Decision:* –î–ª—è dev-—Å—Ç–µ–Ω–¥–∞ —ç—Ç–æ –û–ö. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤–∞–∂–Ω—ã ‚Äî –Ω—É–∂–µ–Ω scp –¥–∞–º–ø –±–∞–∑—ã.
3.  **Shared UI Builds:** –ê–≥–µ–Ω—Ç —Ñ–∏–∫—Å–∏–ª `npm install` –≤ `shared-ui`. –£–±–µ–¥–∏—Å—å, —á—Ç–æ `package-lock.json` –≤ –∫–æ—Ä–Ω–µ –∏ –≤ `apps/shared-ui` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –∏–Ω–∞—á–µ CI/CD –Ω–∞ GitHub Actions –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞ VPS –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç.

**–í–µ—Ä–¥–∏–∫—Ç:** –¢—ã –≥–æ—Ç–æ–≤ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π **Package A**, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –¥–æ–º–µ–Ω –∏ "–ø—Ä–∏–∂–µ—á—å" –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Keycloak —Å–∫—Ä–∏–ø—Ç–æ–º.