# Prompt
"./20251120-1457-prompt1.oracle.md"
# Output 
1. **Findings (severity order)**

---

### [BLOCKER] NX‑07: Backoffice KYC UI is wired to *mock* / mismatched APIs

**Summary.**
Backoffice KYC pages (`/kyc`, `/users`) are implemented on the frontend, but they call API contracts that either do not exist on the backend or are still mock‑only. This makes NX‑07 non‑runnable against a real stack after NX‑05/06/08.

**Details / evidence**

* Frontend API client `apps/backoffice/src/lib/api/compliance.ts` expects:

  * `GET /v1/compliance/kyc?status=pending|approved|rejected` → list of KYC requests.
  * `POST /v1/compliance/kyc/{id}/decision` → approve/reject KYC.
  * `GET /v1/identity/users` → user registry.
    It also contains explicit mock fallbacks (“fallback mock until backend is ready”).
* The NX‑07 spec / task docs describe exactly these endpoints (/v1/compliance/kyc*, /v1/identity/users*) as the canonical contracts.
* Compliance service **today** exposes a different set of endpoints:

  * `POST /v1/compliance/kyc/check`
  * `POST /v1/compliance/qualification/evaluate`
  * `GET /v1/compliance/investors/{id}/status`
  * Admin KYC actions on *investor* endpoints: `POST /v1/compliance/kyc/investors/{id}/approve|reject`
  * A pair of task endpoints: `GET /v1/kyc/tasks`, `POST /v1/kyc/tasks`.

**Consequence.**
On a real environment (UK1 / cfa1 / new VPS) the Backoffice KYC UI will either:

* silently fall back to mocks (showing stale/fake data), or
* fail with 404s because `/v1/compliance/kyc` and `/v1/compliance/kyc/{id}/decision` are not implemented.

This is a **hard blocker** for any realistic NX‑07 demo.

---

### [BLOCKER] NX‑07: No real User Registry API (`/v1/identity/users`)

**Summary.**
The “Users” page in Backoffice and the NX‑07 spec assume a list‑users API on the Identity service. That API does not exist; Identity is still a minimal stub, with user listing implemented only as a mock in the frontend.

**Details / evidence**

* `apps/backoffice/src/lib/api/compliance.ts` calls `GET /v1/identity/users` and falls back to a hard‑coded array if the backend doesn’t respond. 
* `apps/backoffice/src/app/users/page.tsx` renders a registry based entirely on that API client. 
* The architecture/docs explicitly call out Identity as “stub / Keycloak only”, not a proper user registry. 

**Consequence.**
Backoffice “Users” will never display real, authoritative user data on any environment; it cannot be relied on for KYC / registry operations. This is also a **hard blocker** for declaring NX‑07 “live”.

---

### [HIGH] NX‑07: Spec vs implementation drift in Compliance/KYC

**Summary.**
There is now a three‑way mismatch between:

* **NX‑07 spec** (docs, sequence diagrams),
* **Backoffice client** (`/v1/compliance/kyc`, `/v1/compliance/kyc/{id}/decision`), and
* **Compliance service** (KYC tasks + investor approval endpoints under `/v1/kyc/tasks` and `/v1/compliance/kyc/investors/{id}/approve|reject`).

The backend actually has a reasonably rich KYC model (`KycTaskEntity`, list/create/resolve operations), but the REST surface exposed to the gateway doesn’t map to the UI and spec contracts. 

**Consequence.**

* Any attempt to “just wire Backoffice to Compliance” will require a non‑trivial refactor of either the API or the UI.
* The risk is that multiple partially‑used endpoints accumulate, making support and future auditability harder.

I’d treat this as a **design‑level blocker** for NX‑07 specifically, and a **high‑severity** tech‑debt item for the platform.

---

### [HIGH] New VPS/domain: Secrets & environment story is incomplete / scattered

**Summary.**
Mechanics and tooling for provisioning a new node are strong, but the story for *which* secrets and env files must be created for a new domain/VPS is fragmented across multiple docs.

**Evidence**

* `ops/scripts/deploy/provision-node.sh` robustly creates a dedicated user, installs Docker, Node 20, tmux etc. on a remote host and prepares `/srv/cfa`.
* `ops/scripts/deploy/deploy-node.sh` clones `ois-cfa` on the remote, checks out `infra.defis.deploy`, and runs `docker compose` with local `.env` and compose overrides. It assumes those files already exist and are correct. 
* Classic UK1 docs (`docs/deploy/docker-compose-at-vps/0x-*.md`) describe `.env` contents and `docker-compose.*.yml` combos, but paths and conventions there are `/opt/ois-cfa`, not `/srv/cfa`. 
* Cloudflare multi‑account docs plus `ops/scripts/cloudflare-dns-upsert.sh` require environment files with `CF_API_TOKEN`, `CF_ZONE_ID`, `CF_ACCOUNT_ID`, `CF_HOST_PREFIXES`, `CF_BASE_LABEL`, etc., but there’s no single “variables matrix” that says: “for new domain X, create `.env.X`, `.cloudflare.X.env`, with these values”.

**Consequence.**

* A senior engineer can absolutely bring up a new VPS/domain with these pieces, but it’s easy to mis‑set or forget variables (Keycloak authority, API_PUBLIC_URL, JWT signing keys, DB creds, CF_ZONE_ID, etc.).
* That’s not a *code* blocker, but it **does** increase risk of broken auth, wrong hostnames in tokens, or misrouted traffic on first deploy to a non‑UK1 environment.

---

### [MEDIUM] NX‑05/06 naming mismatch between WBS and actual code

**Summary.**

* WBS / context docs still describe NX‑05 as “Identity baseline (Keycloak, roles)” and NX‑06 as “CI quality gates”. 
* In the codebase and branches, NX‑05 is “Issuer dashboard & reports” and NX‑06 is “Issuer payout schedule”.

**Consequence.**

* Future planning and reporting will be confusing: the same NX IDs are used for different scopes depending on whether you look at docs or branches.
* This doesn’t break runtime behaviour, but it will bite you in audits and when somebody tries to cross‑reference “what exactly shipped in NX‑05”.

---

### [MEDIUM] Doc drift: UK1 vs CFA1/new nodes (paths & processes)

**Summary.**

* “Old” Docker‑Compose runbooks (01–09) are UK1‑centric and assume `/opt/ois-cfa` plus manual steps for building apps. 
* New `10-eywa1-control-plane-runbook` describes a multi‑VPS setup (cfa1, fin2), uses `/srv/cfa`, and orchestrates `provision-node.sh` / `deploy-node.sh`.

**Consequence.**

* Someone following only the 0x-series docs may end up in the wrong directory or skipping the new automation; someone following only `10-eywa1-control-plane` might miss the older but still‑relevant env/compose details.
* Not a runtime issue, but a **process friction** point.

---

### [LOW] Zip‑workflow is manual only (no CI guardrails)

**Summary.**

* The `artifacts/git/branch-zip-workflow.md` and `scripts/git/zip_branches.sh` implement a nice policy: only zip branches that are fully merged into `infra.defis.deploy` (`git merge-base --is-ancestor`), tag them as `zip/<branch>`, then delete local & remote branch and associated worktrees.
* `artifacts/git/branch-zip-20251120.txt` records that NX‑01, NX‑03, NX‑05, NX‑06, NX‑08 branches were merged and zipped; NX‑07 is intentionally left as active work.

**Consequence.**

* For now, the state looks clean (no stray NX‑01/03/05/06/08 worktrees, zip tags present), but there’s nothing preventing a future merge from skipping the zip step. It’s a process discipline item, not an immediate problem.

---

### [LOW] Positive confirmation: NX‑01/03/05/06/08 *are* integrated into `infra.defis.deploy`

**Summary.**

* The “sprint closure” report explicitly lists merges of NX‑01, NX‑03, NX‑05, NX‑06, NX‑08 into `infra.defis.deploy`, including notes about keeping new Issuance InMemory toggle and the report/payout features. 
* Branch‑zip ledger confirms the same branches, by name, as “merged into infra.defis.deploy (2025‑11‑20)”. 

**Consequence.**

* `infra.defis.deploy` is the correct “golden” branch for deployment, containing all NX‑01/03/05/06/08 work and the NX‑03 Issuance 500‑error fix (InMemory toggle + 404 handling).

---

2. **Deployment Checklist for New VPS / New Domain**

(*Assumption: target branch = `infra.defis.deploy`; server is Ubuntu‑like; deployment pattern follows `10-eywa1-control-plane-runbook` + `docker-compose-at-vps` docs.*)

| Phase                                     | Steps (what to do)                                                                                                                                                                                                                                                                                                                                                                                                                              | Required Inputs / Secrets                                                                                                                                                                                                                                                                                                                        |
| ----------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **0. Pre‑flight / Planning**              | • Choose target branch/tag (e.g. `infra.defis.deploy`).  • Decide environment codename (e.g. `cfa2`, `fin2`) and fully‑qualified hostnames for gateway, Keycloak, frontends.  • Decide whether this VPS shares the existing Cloudflare zone or uses a new zone/account (per `MULTI_ACCOUNT_SETUP.md`).                                                                                                                                          | • Git read access to `ois-cfa`.  • Target domain(s): e.g. `cfa2.example.com`, `auth.cfa2.example.com`, `issuer.cfa2.example.com`, `backoffice.cfa2.example.com`.  • High‑level infra decisions (re‑use existing Postgres vs new DB).                                                                                                             |
| **1. Provision VPS (Phase 2 in runbook)** | From your ops laptop, run `ops/scripts/deploy/provision-node.sh <host> <remote-user> /srv/cfa`. This script: creates the user, propagates SSH keys, installs Docker, docker‑compose plugin, Nginx, Node 20 via nvm, tmux, etc.                                                                                                                                                                                                                  | On *ops machine*:  • SSH key able to log in as root on new VPS.  • `REMOTE_USER` name (e.g. `cfa`).  • `REMOTE_PROJECT_ROOT` (e.g. `/srv/cfa`).  On *VPS*: outbound internet to Docker + Node repos.                                                                                                                                             |
| **2. Prepare Git repo & env on VPS**      | SSH to VPS as `REMOTE_USER`, then:  1) `cd /srv/cfa`.  2) Run `ops/scripts/deploy/deploy-node.sh --clone-only` (or manually `git clone` `ois-cfa` and checkout `infra.defis.deploy`).  3) Create environment files: `.env` for services, `.env.apps` if used, following `docs/deploy/docker-compose-at-vps/02-env-and-compose.md` and UK1 examples, but **adapted to new hostnames and /srv/cfa path**.                                         | **DB & infra secrets**:  • `POSTGRES_HOST/USER/PASSWORD/DB` for core DB.   • Any Kafka credentials or bootstrap servers (if not local).  • `KEYCLOAK_DB_PASSWORD` (if managing KC DB here).  • JWT signing keys or Keycloak realm secret if using external auth.  • Per‑service connection strings (Issuance, Registry, Settlement, Compliance). |
| **3. Cloudflare / DNS for new domain**    | 1) In Cloudflare, create new zone or add needed records to existing zone per `docs/deploy/20251113-cloudflare-ingress.md` and `MULTI_ACCOUNT_SETUP.md`.  2) Create `.cloudflare.<env>.env` (or similar) with `CF_API_TOKEN`, `CF_ACCOUNT_ID`, `CF_ZONE_ID`, `CF_ZONE_NAME`, `CF_HOST_PREFIXES`, `CF_BASE_LABEL`.  3) Run `ops/scripts/cloudflare-dns-upsert.sh -f .cloudflare.<env>.env -h <vps-ip>` to upsert A records for gateway/auth/apps. | • Cloudflare API token with DNS edit rights for the chosen zone.  • `CF_ACCOUNT_ID`, `CF_ZONE_ID`, `CF_ZONE_NAME`.  • List of host prefixes: e.g. `api,auth,issuer,investor,backoffice`.  • VPS public IP.                                                                                                                                       |
| **4. TLS / Nginx**                        | 1) Reuse UK1 Nginx configs as templates but point to new hostnames, using `/srv/cfa` paths (not `/opt/ois-cfa`). 2) Either offload TLS at Cloudflare (flexible / full) or run `ops/scripts/setup-certs.sh` / certbot on the VPS. 3) Ensure Nginx proxies gateway (port 55000) and apps (53001/53002/53003, etc.) to correct hostnames.                                                                                                          | • TLS certificate material if terminating on VPS, or Cloudflare TLS mode configured.  • Nginx vhost templates (from UK1).  • Hostname ↔ port mapping decisions.                                                                                                                                                                                  |
| **5. Deploy stack via Compose**           | From `/srv/cfa/ois-cfa` on VPS:  1) Ensure `.env` is correct.  2) Run `docker compose -f docker-compose.yml -f docker-compose.override.yml -f docker-compose.kafka.override.yml -f docker-compose.services.yml -f docker-compose.apps.yml up -d --build` (or equivalent subset if you exclude some apps).   3) Check container logs for migrations (Issuance uses `RunMigrations` / `MIGRATE_ON_STARTUP`).                                      | • Proper env variables for `UseInMemoryDatabase` and `RunMigrations` per service (esp. Issuance).  • Optional feature toggles (Kafka enabled/disabled, mock ledger, etc.).                                                                                                                                                                       |
| **6. Smoke tests & health checks**        | 1) From local or ops host, run `make check-health` (if available) or the documented curl smoke tests from `08-smoke-tests.md` against the *new* gateway host.   2) Verify: `/health` on gateway; Issuer & Investor portals return 200 on `/`; Keycloak login works with new redirect URIs.   3) For Backoffice/Audit: log in via Keycloak, open `/audit`, `/reports`, `/payouts`, confirm no 5xx in logs.                                       | • Working Keycloak realm with updated clients / redirect URIs for new hostnames.  • Test credentials for `issuer` and `backoffice` roles (per auth policies in Issuance/Compliance).                                                                                                                                                             |
| **7. Backup & restore hooks**             | Configure backup strategy using `ops/scripts/backup.sh` and `ops/scripts/restore.sh` as per docs (Postgres backup & restore pipelines).                                                                                                                                                                                                                                                                                                         | • S3/bucket or filesystem path for dump storage.  • Credentials / access to backup storage.                                                                                                                                                                                                                                                      |

**Verdict on new VPS readiness:**
Tooling and docs are **sufficient but not fully “one‑click”**. A senior engineer can stand up a new VPS/domain with moderate effort; the main risks are human error in env/secret wiring and hostname mismatches, not missing code.

---

3. **NX‑07 Readiness (Backoffice KYC & User Registry)**

---

### 3.1 What is already in place

**Backend**

* **Compliance/KYC domain model**:

  * `KycTaskEntity` with status, assignee, etc.
  * `IComplianceService.CreateKycTaskAsync`, `ListKycTasksAsync`, `UpdateKycStatusAsync`. 
  * Minimal eventing / outbox integration is present (or at least scaffolded) on the compliance side. 
* **KYC admin endpoints (not yet used by Backoffice)**:

  * `GET /v1/kyc/tasks` — list tasks.
  * `POST /v1/kyc/tasks` — create task.
  * `POST /v1/compliance/kyc/investors/{id}/approve` / `reject` — decision endpoints.

So, the *data plane* for KYC tasks is reasonably ready; what’s missing is a stable REST façade aligned with the Backoffice client.

**Frontend**

* **Backoffice KYC page** (`apps/backoffice/src/app/kyc/page.tsx`):

  * Uses React Query to fetch KYC requests (`listKycRequests`) and mutate decisions (`submitKycDecision`).
  * Implements filters by status and simple table/grid UI using `shared-ui`/shadcn components.
* **Backoffice Users page** (`/users`):

  * Renders a table/grid of users from `listUsers()`.
* **Routing / shell**:

  * `apps/backoffice/src/app/page.tsx` redirects to `/kyc` by default, so the KYC screen is the “home” view. 
* **Auth wiring**:

  * Backoffice is configured to work with Keycloak roles (e.g. `backoffice`), reusing the global auth wiring established in NX‑01/NX‑02 for Issuance/Gateway.

**Infra**

* NX‑01/02 gave you validated OpenAPI specs and YARP routing that include Compliance and Identity clusters; NX‑03 ensured tests are green with the InMemory toggle; NX‑05/06/08 have been merged into `infra.defis.deploy`.
* Backoffice is already included in `docker-compose.apps.yml` and runbooks as a first‑class app (even if NX‑07 features are partial).

---

### 3.2 What is blocking NX‑07 right now

1. **API contract mismatch (frontend vs backend)** – *see BLOCKER above*

   * UI calls `/v1/compliance/kyc` & `/v1/compliance/kyc/{id}/decision`; backend exposes `/v1/kyc/tasks` and `/v1/compliance/kyc/investors/{id}/approve|reject`.

2. **Missing Identity “User Registry” API**

   * No `/v1/identity/users` in Identity service; only mocks in frontend.

3. **Mocks still active in production code path**

   * `compliance.ts` explicitly falls back to hard‑coded lists if backend calls fail; there is no feature flag to disable mocks in “real” environments. 

4. **No e2e tests for NX‑07 flows**

   * Existing runbooks and test suites focus on Issuance and basic gateway health, plus issuer/investor flows. KYC / Backoffice user journeys are not part of the smoke tests list (`08-smoke-tests.md` etc.).

5. **Docs still describe “ideal” NX‑07, not the current partial state**

   * The NX‑07 tasks/architecture docs show a clean flow (Backoffice → Compliance → Identity) that doesn’t match current endpoints and mocks.

---

### 3.3 Suggested actions (concrete “issues” for CLI agents)

You can literally turn these into Git issues or CLI prompts.

**NX07‑API‑1: Align KYC list & decision endpoints**

* **Goal:** Make Backoffice `/kyc` talk to the real Compliance service without mocks.
* **Recommended direction (least disruption):**

  1. Add façade endpoints in Compliance:

     * `GET /v1/compliance/kyc` → internally call `ListKycTasksAsync` and map `KycTaskEntity` → DTO expected by Backoffice table.
     * `POST /v1/compliance/kyc/{id}/decision` → map `{status, comment}` → `UpdateKycStatusAsync` for underlying task/investor.
  2. Expose these endpoints in the API gateway YARP config + OpenAPI.
  3. Remove (or deprecate) ad‑hoc `/v1/kyc/tasks` from public surface if not used elsewhere.

**NX07‑API‑2: Implement `/v1/identity/users` minimal endpoint**

* **Goal:** Backoffice “Users” page should show *real* users.
* **Minimal viable implementation:**

  1. In Identity service, implement `GET /v1/identity/users` that:

     * Either proxies to Keycloak Admin API (paginated, filtered) or
     * Reads from a local “shadow” table populated via nightly sync / manual import.
  2. Return DTO compatible with `UserSummary` in backoffice client (`id`, `email`, `roles`, `createdAt`, `status`).
  3. Wire this endpoint into YARP and API matrix docs.

**NX07‑FRONT‑1: Remove hardcoded mocks in production builds**

* Add a feature flag, e.g. `NX07_USE_MOCKS`; in dev mode you can still fall back to stubs, but in `NODE_ENV=production` the API client should **fail loudly** rather than silently mock. 

**NX07‑TEST‑1: Add KYC & User Registry e2e/smoke tests**

* Extend `08-smoke-tests.md` / Playwright suite to cover:

  * Login as `backoffice` user.
  * Open `/kyc`: expect at least one task, approve it, verify status change via API.
  * Open `/users`: list users, filter, verify result consistent with Identity/Keycloak.

**NX07‑DOC‑1: Update NX‑07 spec to match reality**

* Update `docs/context`/task docs:

  * Document final KYC endpoints (`/v1/compliance/kyc`, `/v1/compliance/kyc/{id}/decision`, `/v1/identity/users`).
  * Clarify that Compliance stores **tasks**, not raw KYC “applications”, and how statuses map.

---

4. **Open Questions for Engineers Before Rollout**

These are the things I’d want answered in the next sync before pushing `infra.defis.deploy` to a new VPS/domain and trying to show NX‑07.

1. **Target environment / domain contract**

   * What is the *exact* domain set for the new VPS? (e.g. `cfa2.llmneighbors.com` vs a completely new zone).
   * Are we using a **new Cloudflare account/zone** (per `MULTI_ACCOUNT_SETUP.md`) or reusing the existing one?

2. **Secrets management model**

   * Where do `.env` and `.cloudflare.*.env` live for the new VPS? Git‑ignored files on ops laptop, a secret manager, or something else?
   * Who owns the master list of required env vars (DB, Kafka, Keycloak, JWT, etc.) for each environment? Right now it’s scattered across docs and compose files.

3. **Keycloak realm & roles**

   * Is the new environment reusing the existing `ois` realm, or should it have a dedicated realm/client set?
   * Are `issuer` and `backoffice` roles already configured, and do we have test accounts for them in the new domain?

4. **NX‑07 scope in the upcoming rollout**

   * Is NX‑07 expected to be **fully functional** on the new VPS, or can it be explicitly labelled as “preview / partially mocked”?
   * If partial is acceptable, what’s the minimal acceptable behaviour? (e.g. read‑only list of KYC tasks from the real DB, but no approval, or vice‑versa).

5. **Data sources for User Registry**

   * Should `/v1/identity/users` be a thin façade over Keycloak Admin (source of truth), or do we need a separate OIS “user registry” DB with additional metadata (e.g. external IDs, KYC level)?

6. **Branch / tag policy after this release**

   * After deploying `infra.defis.deploy` to new VPS, do we continue to treat it as the golden branch, or do we want a `release/*` tag for that snapshot?
   * Should the branch‑zip workflow be added to CI (or at least to a documented release checklist) to avoid forgetting to archive future NX branches?

If you’d like, I can next help you turn these findings into a set of concrete Git issues / CLI prompts (one per “NX07‑API‑1”, “NX07‑FRONT‑1”, etc.) so agents can just copy‑paste and execute.
