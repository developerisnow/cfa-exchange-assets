

### 1.2. По ТЗ (NX‑05/06/07/08) критичных дыр **нет**

* Брайншторм по NX‑05/06/07/08 + ветка `docs/enrich-nx-tasks` уже обеспечивают:

  * DoD/Kickoff, Mermaid, таблицы эндпоинтов и UI‑flows для NX‑06/07/08. 
* Твои «ночные» задачи по обогащению TЗ и последующие фиксы — уже закоммичены и попали в `infra.defis.deploy`/основной main. 
* Проблемы, которые подняли оракулы (нэйминг в WBS vs код, InMemory vs Postgres в тестах Issuance), — это **реализация/техдолг**, а не пробоина в требованиях. 

> То есть: **ТЗ ок, дыра именно в имплементации NX‑07 и в инфраструктуре (auth+deploy).**

---

### 1.3. Прав ли ты по стратегии: «сначала CFA1 + новый CF‑аккаунт, потом всё остальное»?

Я бы немного уточнил формулировку, но направление верное:

* В w11/w12 уже зафиксирован multi‑account подход: отдельные `.env.cfa1`, `.env.cfa2` для разных зон/аккаунтов Cloudflare, плюс helper `cloudflare-dns-upsert.sh`. 
* В oracle‑пакете ты добавляешь новый Cloudflare‑аккаунт с кредами `CLOUDFLARE_CFA_*` для домена `telex.global` и предлагаешь использовать сабдомены `*.cfa{n}.telex.global`. 
* Gemini‑eval (p2.2/p3) предлагают:

  * Либо **переключить cfa1** на `*.cfa1.telex.global` на текущем хосте; 
  * Либо поднять **чистый стенд на fin2**, используя `telex.global` как новый «золотой» домен (логический новый cfa1). 

С учётом всего:

> **Мой вердикт:**
> да, правильно: следующая осмысленная цель — **рабочий стенд CFA1 на новом Cloudflare‑аккаунте `telex.global`** (физически лучше на `fin2`, чтобы не ковырять старый cfa1), а потом — доработка NX‑07 и добивка техдолга.

---

## 2. Единая таблица для manual (deliverables, keep/cut, оценка)

Формат: можно прямо так сохранить как
`memory-bank/Scrum/20251120/20251120-MASTER-RELEASE-PLAN-NX05-08.table.md`.

Обозначения размера:
**XS (~<1ч), S (1–2ч), M (0.5–1 день), L (1–2 дня)** для одного фокусированного агента/разработчика.

| Phase | Epic / Area                           | Deliverable (что должно быть в конце)                                                                                                     | Ключевые шаги (для агентов / CLI)                                                                                                                                                                                                                                                                                                                                                         | Keep / Cut                                                                        | Size |
| ----- | ------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- | ---- |
| 1     | Infra & DNS (telex)                   | Новый домен `*.cfa1.telex.global` (или `*.cfa2.telex.global` на fin2) с корректными A‑записями `auth, api, issuer, investor, backoffice`. | 1) В репо `cloudflare__developerisnow` создать `.env.cfa1.telex` (или `.env.cfa2.telex`) с `CF_ZONE_NAME=telex.global`, `CF_ZONE_ID`, `CF_API_TOKEN`, `CF_HOST_PREFIXES`, `CF_BASE_LABEL=cfa1`/`cfa2` из `CLOUDFLARE_CFA_*`.  2) Запустить `./ops/scripts/cloudflare-dns-upsert.sh .env.cfa1.telex <ip fin2/cfa1>`.                                                                       | **Keep**                                                                          | S    |
| 1     | Deploy scripts                        | `deploy-node.sh` больше не ломает права, `npm install` стабильно на сервере.                                                              | В `ops/scripts/deploy/deploy-node.sh` заменить подсказку на явный `sudo chown -R user:user $REMOTE_PROJECT_ROOT` (или эквивалент через `$(id -un):$(id -gn)`) перед `npm install`.                                                                                                                                                                                                        | **Keep**                                                                          | XS   |
| 1     | Provision / Deploy                    | На выбранном хосте (`fin2` лучше) поднят docker‑compose‑стек OIS‑CFA с ветки `infra.defis.deploy`.                                        | 1) `ops/scripts/deploy/provision-node.sh <host>` — создать пользователя, поставить Docker/Node/Nginx (скрипт уже есть).  2) `ops/scripts/deploy/deploy-node.sh <host>` с обновлённым `chown`. 3) Проверить контейнеры и pm2.                                                                                                                                                              | **Keep**                                                                          | M    |
| 1     | Nginx & SSL                           | HTTPS для `*.cfa1.telex.global` на новом CF‑аккаунте, Nginx знает новые хосты.                                                            | 1) На хосте: выпустить wildcard‑сертификат для `*.cfa1.telex.global` через certbot (HTTP/DNS challenge). 2) Обновить Nginx‑конфиги, заменить старые домены (`llmneighbors.com`) на `telex.global`. 3) Рестарт Nginx.                                                                                                                                                                      | **Keep**                                                                          | M    |
| 1     | Frontend env                          | Portals (`issuer`, `investor`, `backoffice`) смотрят на `https://*.cfa1.telex.global` и бэкенд/Keycloak по новым URL.                     | Обновить `.env.local`/конфиги для всех трёх фронтов (NEXT_PUBLIC_API_BASE_URL, NEXTAUTH_URL/Keycloak realm URL) под новые домены; перезапустить pm2 с `--update-env`.                                                                                                                                                                                                                     | **Keep**                                                                          | S    |
| 1     | Auth / Keycloak                       | Логин на новом домене работает: Issuer/Investor/Backoffice логинятся без 3xx/5xx и странных редиректов.                                   | 1) Добавить `ops/scripts/auth/fix-redirects.sh` или `update-client-uris.sh` — внутри: `docker exec ois-keycloak kcadm.sh ...` и обновление `rootUrl`, `redirectUris`, `webOrigins` для клиентов (issuer, investor, backoffice) под `https://*.cfa1.telex.global/*`.   2) Запустить скрипт, проверить в админке, что URIs обновились. 3) Smoke‑тест логина.                                | **Keep**                                                                          | M    |
| 1     | Smoke / Health                        | Проверено, что новый стенд жив.                                                                                                           | `curl -I https://issuer.cfa1.telex.global`, `curl https://api.cfa1.telex.global/health` и быстрый ручной логин в Issuer portal.                                                                                                                                                                                                                                                           | **Keep**                                                                          | XS   |
| 2     | NX‑03 / Issuance                      | Фикс NX‑03 (404 вместо 500) влит в `infra.defis.deploy`, тесты зелёные и не зависят от InMemory в проде.                                  | 1) Убедиться, что ветка `fix/NX-03-issuance-500` влита в `infra.defis.deploy` (код уже готов и пушнут).  2) Привести конфиг тестов к паттерну: InMemory только для тестов, в runtime — Postgres (проблема, поднятая GPT‑5p‑p3).  3) Прогнать `dotnet test` и, по возможности, CI.                                                                                                         | **Keep**                                                                          | M    |
| 2     | NX‑07 Backend                         | Бэкенд для KYC/User Registry существует: backoffice KYC реально ходит в API.                                                              | 1) В `services/compliance` реализовать эндпоинты `/v1/compliance/kyc` (list), decision и загрузку документов по контракту, который уже использует фронт.   2) В `services/identity` реализовать (или честно замокать) `/v1/identity/users`. 3) Добавить миграции/таблицы для KYC‑заявок/документов. 4) Связать backoffice‑клиент (React Query) с этими эндпоинтами, убрать «вечные моки». | **Keep (Critical)**                                                               | L    |
| 2     | NX‑07 Frontend polish                 | UI KYC/Users в backoffice показывает реальные данные и адекватные ошибки.                                                                 | 1) Проверить страницы `/kyc` и `/users` на соответствие контракту API.  2) Подчистить toasts/loader’ы/empty states под реальные ответы бэка. 3) При необходимости добавить feature flag «KYC enabled» (чтобы можно было выключить).                                                                                                                                                       | **Keep**                                                                          | M    |
| 2     | NX‑05/06 sanity                       | NX‑05/06 работают на новом домене (dashboards, payouts), без критичных расхождений с ТЗ.                                                  | 1) Быстрый smoke: логин → dashboard → reports (NX‑05) и payout schedule (NX‑06).  2) Если нужно — минимальные корректировки по критичным багам.                                                                                                                                                                                                                                           | **Keep**, но **лимитировать глубину** (не превращать в новый спринт)              | S–M  |
| 3     | E2E / Playwright                      | На `*.cfa1.telex.global` проходит базовый набор е2е: логин, issuer‑flows, базовый KYC.                                                    | 1) Обновить `tests/e2e-playwright/.env` и `playwright.config.ts` на новый домен. 2) Прогнать `npx playwright test`. 3) Сохранить отчёт/скриншоты в `artifacts/tests/e2e/...`.                                                                                                                                                                                                             | **Keep**                                                                          | M    |
| 3     | Docs sync                             | Runbooks и docs не врут: UK1 ≠ telex, домены не перепутаны.                                                                               | 1) Обновить `10-eywa1-control-plane-runbook.md`: явно разделить «готов для UK1» vs «готов для telex/global cfa{n}».  2) Обновить `MULTI_ACCOUNT_SETUP.md` под новый CF‑аккаунт и `telex.global`.                                                                                                                                                                                          | **Keep, но low‑prio** (после живого стенда)                                       | S    |
| 4     | Zip/worktree hygiene                  | Архивы `zip/*` соответствуют merged веткам, worktree без мусора, oracle‑контексты воспроизводимы.                                         | 1) Проверить, что `zip/tasks/NX-01-*`, `zip/tasks/NX-05-*` и `zip/deploy` соответствуют текущему состоянию веток (это у тебя почти уже сделано и зафиксировано в w12).  2) При желании — добавить zip для NX‑06/07/08.                                                                                                                                                                    | **Cut/Defer** — не блокирует деплой; вернуться позже, если будет запрос на архивы | S–M  |
| 4     | Docs enrichment (Mermaid, WBS и т.п.) | Красивые ТЗ c Mermaid, DoD, Kickoff для NX‑06/07/08.                                                                                      | Большая часть уже сделана в ветке `docs/enrich-nx-tasks`. Остальное — только если захочешь довести до идеала (диаграммы, таблицы).                                                                                                                                                                                                                                                        | **Cut** для текущего релиза, оставить как фоновый UX‑/docs‑долг                   | M    |
| 4     | Meta‑infra (oracle‑packaging)         | Пайплайн `context.txt + prompt.md` для оракулов стабилен.                                                                                 | Всё уже сделано: DoD‑док, skill `oracle-evaluator-context-packaging.md`, code2prompt‑снапшот на 2.3MB и т.д.   **Никаких действий сейчас не нужно.**                                                                                                                                                                                                                                      | **Cut** — использовать как есть                                                   | 0    |

Если коротко по **keep/cut**:

* **KEEP (первым делом):** Phase 1 (Infra/Auth), NX‑03 фиксация, NX‑07 backend, базовый e2e.
* **KEEP (но не заваливаться глубоко):** sanity по NX‑05/06, обновление runbook’ов.
* **CUT/DEFER:** zip‑архивы, дальнейшее украшательство ТЗ, любые новые эксперименты с oracle‑пакетами.

---

## 3. Ответ на твою гипотезу про последовательность шагов

> «Сначала довести до рабочего состояния CFA1, но на втором Cloudflare‑аккаунте, потом поменять домены и уже поверх этого добивать NX‑07» — **да, но…**

С учётом всего того, что уже написано в runbooks и master‑планах, я бы сформулировал твой план так:

1. **Выбрать хост для «нового CFA1»**

   * Если хочешь минимально рисковать — пусть это будет **`fin2`** (чистый сервер под `telex.global`), а старый `cfa1` не трогать. 
   * Логически это будет `cfa1.telex.global`, физически — fin2.

2. **Сделать Phase 1 из таблицы (Infra + Auth)**

   * Cloudflare `.env.cfa1.telex` / `.env.cfa2.telex`, DNS‑upsert, deploy‑скрипт с `chown`, Nginx+SSL, Keycloak‑скрипт. 
   * После этого у тебя есть **«CFA1/fin2 на telex» с рабочим логином**.

3. **Влить NX‑03 и довести NX‑07 backend до «минимально честного» состояния**

   * Т.е. хотя бы list + decision, users list, без всей глубины будущего compliance. 

4. **Только после этого уже думать про дополнительные окружения, UK1‑разделение, zip‑архивы и т.п.**

Так ты избежишь ловушки, где всё время уходишь в инфраструктурную/мета‑работу, а «рабочего CFA на telex» всё нет.

---

## 4. Немного мета‑фидбэка про твой «ADHD‑перегон»

Ты сейчас сделал достаточно редкую вещь:

* Собрал **oracle‑контекст** (context.txt + prompt) автоматикой,
* Прогнал по нему **несколько моделей** (Gemini/GPT‑5),
* Потом **сам** их оценил и только после этого попросил ещё модель оценить оценки.

Это реально топовый уровень контроля качества, но есть и обратная сторона:

* Каждая следующая итерация даёт всё меньше уникальной информации (мы уже видим, что все тыкают в одни и те же три проблемы).
* Стоимость по времени/вниманию растёт, а value становится всё более маргинальным.

Сейчас, по состоянию на вот этот master‑план:

> **Ты уже собрал достаточно контекста, чтобы остановить «мета‑шум» и перейти к чистому исполнению.**

Практически:

* Зафиксируй эту таблицу и короткий текстовый Master Plan (можно прям как `20251120-MASTER-RELEASE-PLAN-NX05-08.md` из oracle‑паков). 
* В следующем треде с Gemini 3/CLI‑агентом:

  * Дай ему **только**: runbook + scripts + этот Master Plan + context snapshot.
  * Пусть делает **одну Phase за запуск** (например: сейчас только Phase 1).

И отдельно — не ругай себя за этот двухчасовой мета‑забег. Ты фактически построил себе «систему второго мнения» и обнаружил, что:

* по ТЗ всё ок,
* главные риски видишь **ты сам**, а модели только подсвечивают детали.

Дальше уже не надо доказывать себе, что ты ничего не упустил — лучше дать этим выводам материализоваться в рабочий `issuer.cfa1.telex.global` и живой KYC‑бэкенд.
