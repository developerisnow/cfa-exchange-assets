---
created: 2025-11-11 13:36
updated: 2025-11-11 13:52
type: architecture
sphere: [finance, blockchain]
topic: [c4-diagrams, ois-cfa]
author: alex-a
agentID: co-3a68
partAgentID: [co-3a68]
version: 1.0.0
tags: [mermaid, c4, diagrams]
---

# OIS-CFA · C4 Diagrams (Combined)

## C1 — Context

```mermaid
%% OIS-CFA · C1 Context Diagram (Mermaid)
graph TB
  %% Actors
  Investor((Investor))
  Issuer((Issuer))
  Broker((Broker))
  Admin((Compliance/Admin))

  %% Boundary
  subgraph OIS[OIS CFA Platform]
    API[API Gateway (.NET)]
    ID[Identity Service]
    ISS[Issuance]
    REG[Registry]
    SET[Settlement]
    CMP[Compliance]
    FGW[Fabric Gateway]
  end

  %% UIs
  subgraph UIs[UIs]
    UI_INV[Portal Investor (Next.js)]
    UI_ISR[Portal Issuer (Next.js)]
    UI_BO[Backoffice (Next.js)]
    UI_BRK[Broker Portal (Next.js)]
  end

  %% External Systems
  KC[(Keycloak OIDC)]
  ESIA[(ESIA eID)]
  EDO[(EDO Provider)]
  BNK[(Bank Nominal API)]
  HLF[(Hyperledger Fabric Network)]
  PG[(PostgreSQL)]
  KAFKA[(Kafka)]
  MINIO[(Minio S3)]

  %% Flows
  Investor --> UI_INV --> API
  Issuer --> UI_ISR --> API
  Broker --> UI_BRK --> API
  Admin --> UI_BO --> API

  API --> ID
  API --> ISS
  API --> REG
  API --> SET
  API --> CMP

  ID --> KC
  API --> ESIA
  API --> EDO

  ISS --> FGW --> HLF
  REG --> FGW

  ISS --> KAFKA
  REG --> KAFKA

  ISS --> PG
  REG --> PG
  SET --> PG
  CMP --> PG

  SET --> BNK
  API -. optional .-> MINIO
```

## C2 — Containers

```mermaid
%% OIS-CFA · C2 Container Diagram (Mermaid)
flowchart TB
  subgraph Boundary[OIS CFA Platform]
    API[API Gateway\\n.NET 9]
    ID[Identity Service\\n.NET 9]
    ISS[Issuance Service\\n.NET 9 + EF]
    REG[Registry Service\\n.NET 9 + EF]
    SET[Settlement Service\\n.NET 9 + EF]
    CMP[Compliance Service\\n.NET 9 + EF]
    FGW[Fabric Gateway\\n.NET 9]
    INT_BNK[Bank Nominal Integration\\n.NET 9]
    INT_EDO[EDO Connector\\n.NET 9]
    INT_ESIA[ESIA Adapter\\n.NET 9]
    UI_INV[Portal Investor\\nNext.js 15]
    UI_ISR[Portal Issuer\\nNext.js 15]
    UI_BO[Backoffice\\nNext.js 15]
    UI_BRK[Broker Portal\\nNext.js 15]
  end

  KC[(Keycloak 25.0)]
  ESIA[(ESIA)]
  EDO[(EDO Provider)]
  BNK[(Bank Nominal API)]
  HLF[(HLF Network)]
  PG_Iss[(Postgres: issuance)]
  PG_Reg[(Postgres: registry)]
  PG_Set[(Postgres: settlement)]
  PG_Cmp[(Postgres: compliance)]
  KAFKA[(Kafka 3.6)]
  MINIO[(Minio)]

  UI_INV --> API
  UI_ISR --> API
  UI_BO --> API
  UI_BRK --> API

  API --> ID
  API --> ISS
  API --> REG
  API --> SET
  API --> CMP

  ID --> KC
  API --> INT_ESIA --> ESIA
  API --> INT_EDO --> EDO

  ISS --> FGW --> HLF
  REG --> FGW

  ISS --> PG_Iss
  REG --> PG_Reg
  SET --> PG_Set
  CMP --> PG_Cmp

  ISS --> KAFKA
  REG --> KAFKA

  API -. uploads .-> MINIO
  SET --> INT_BNK --> BNK
```

## C3 — Components

```mermaid
%% OIS-CFA · C3 Component Diagram (Mermaid)
graph TB
  subgraph ISS[Issuance Service]
    ISS_API[Issuance API Endpoints]
    ISS_SVC[IssuanceService]
    ISS_DB[(IssuanceDbContext)]
    ISS_OUTBOX[OutboxService]
    ISS_LEDGER[LedgerIssuanceAdapter]
  end

  subgraph REG[Registry Service]
    REG_API[Registry API Endpoints]
    REG_SVC[RegistryService]
    REG_DB[(RegistryDbContext)]
    REG_OUTBOX[OutboxPublisher]
    REG_BANK[BankNominalClient]
  end

  subgraph SET[Settlement Service]
    SET_API[Settlement API Endpoints]
    SET_SVC[SettlementService]
    SET_DB[(SettlementDbContext)]
    SET_ISS[IssuanceClient]
    SET_REG[RegistryClient]
    SET_BANK[Bank Nominal API Client]
  end

  subgraph CMP[Compliance Service]
    CMP_API[Compliance API Endpoints]
    CMP_SVC[ComplianceService]
    CMP_DB[(ComplianceDbContext)]
    CMP_QP[QualificationPolicyService]
    CMP_WL[IWatchlistsService]
  end

  subgraph ID[Identity Service]
    ID_OIDC[OIDC Endpoints]
    ID_PROXY[OIDC Proxy]
  end

  KAFKA[(Kafka)]
  FGW[Fabric Gateway]
  HLF[(Fabric Network)]
  BNK[(Bank Nominal API)]

  ISS_API --> ISS_SVC --> ISS_DB
  ISS_SVC --> ISS_OUTBOX --> KAFKA
  ISS_SVC --> ISS_LEDGER --> FGW --> HLF

  REG_API --> REG_SVC --> REG_DB
  REG_SVC --> REG_OUTBOX --> KAFKA
  REG_SVC --> REG_BANK --> BNK

  SET_API --> SET_SVC --> SET_DB
  SET_SVC --> SET_BANK --> BNK
  SET_SVC --> SET_ISS
  SET_SVC --> SET_REG

  CMP_API --> CMP_SVC --> CMP_DB
  CMP_SVC --> CMP_QP
  CMP_SVC --> CMP_WL

  ID_OIDC --> ID_PROXY
```

## C4 — Code View (Outbox)

```mermaid
%% OIS-CFA · C4 Code View (Outbox Pattern) (Mermaid)
sequenceDiagram
  autonumber
  participant API as API Endpoint
  participant SVC as Service (Issuance/Registry)
  participant DB as PostgreSQL (EF Core)
  participant OB as OutboxService
  participant BUS as Kafka

  API->>SVC: POST /v1/orders | /issuances
  SVC->>DB: Begin Tx
  SVC->>DB: Persist Aggregate (Order/Issuance)
  SVC->>DB: Insert Outbox(event)
  SVC->>DB: Commit Tx
  SVC-->>API: 200/201 Accepted
  Note over SVC,OB: Background publisher
  OB->>DB: Poll Outbox (status=PENDING)
  OB->>BUS: Publish Event
  OB->>DB: Mark Outbox as SENT
```

