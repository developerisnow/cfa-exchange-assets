{
  "meta": {
    "project": "ois-cfa",
    "generated_at": "2025-11-11T10:47:21Z",
    "source": [
      "./repositories/customer-gitlab/ois-cfa",
      "./repositories/customer-gitlab/ois-cfa/packages/contracts",
      "./repositories/customer-gitlab/ois-cfa/docs",
      "./repositories/customer-gitlab/ois-cfa/ops"
    ],
    "version": "shtgn-1.0"
  },
  "contexts": {
    "OIS_CFA_Platform": {
      "description": "Operator Information System for Russian Digital Financial Assets (RWA). MVP: issuance, purchase, payouts, redemption.",
      "c4_level": "Context"
    },
    "External_Systems": {
      "description": "Keycloak (OIDC), ESIA eID, EDO provider, Bank Nominal API, HLF (ledger), PostgreSQL, Kafka, Minio.",
      "c4_level": "Context"
    }
  },
  "containers": {
    "api_gateway": {"name": "API Gateway", "description": ".NET 9 gateway; public REST for UIs; routes to services.", "technology": ".NET 9 / REST", "c4_level": "Container"},
    "identity_service": {"name": "Identity Service", "description": "OIDC/OAuth2 proxy; Keycloak/ESIA integration.", "technology": ".NET 9 / OIDC", "c4_level": "Container"},
    "issuance_service": {"name": "Issuance Service", "description": "Issuance lifecycle; EF Core; Outbox; optional HLF.", "technology": ".NET 9 / EF Core / Kafka", "c4_level": "Container"},
    "registry_service": {"name": "Registry Service", "description": "Orders, wallets, holdings; bank nominal integration.", "technology": ".NET 9 / EF Core / Kafka", "c4_level": "Container"},
    "settlement_service": {"name": "Settlement Service", "description": "DvP, payouts, reconciliation; bank interactions.", "technology": ".NET 9 / EF Core", "c4_level": "Container"},
    "compliance_service": {"name": "Compliance Service", "description": "KYC/AML, investor status, qualification policy.", "technology": ".NET 9 / EF Core", "c4_level": "Container"},
    "fabric_gateway": {"name": "Fabric Gateway", "description": "Boundary for HLF chaincode operations.", "technology": ".NET 9", "c4_level": "Container"},
    "integration_bank_nominal": {"name": "Bank Nominal Integration", "description": "Adapter/client for bank nominal API.", "technology": ".NET 9", "c4_level": "Container"},
    "integration_edo": {"name": "EDO Connector", "description": "Electronic document exchange connector.", "technology": ".NET 9", "c4_level": "Container"},
    "integration_esia": {"name": "ESIA Adapter", "description": "Adapter for ESIA eID provider.", "technology": ".NET 9", "c4_level": "Container"},
    "frontend_portal_investor": {"name": "Portal Investor", "description": "Investor UI.", "technology": "Next.js 15 / TS / Tailwind", "c4_level": "Container"},
    "frontend_portal_issuer": {"name": "Portal Issuer", "description": "Issuer UI.", "technology": "Next.js 15 / TS / Tailwind", "c4_level": "Container"},
    "frontend_backoffice": {"name": "Backoffice", "description": "Admin/ops UI.", "technology": "Next.js 15 / TS / Tailwind", "c4_level": "Container"},
    "frontend_broker_portal": {"name": "Broker Portal", "description": "Broker UI (optional).", "technology": "Next.js 15 / TS / Tailwind", "c4_level": "Container"},
    "chaincode_issuance": {"name": "Chaincode Issuance", "description": "HLF chaincode for issuance domain.", "technology": "Go / HLF 2.2+", "c4_level": "Container"},
    "chaincode_registry": {"name": "Chaincode Registry", "description": "HLF chaincode for registry domain.", "technology": "Go / HLF 2.2+", "c4_level": "Container"}
  },
  "components": {
    "gateway_endpoints": {"name": "Gateway Endpoints", "description": "REST handlers for issuances, orders, wallets, settlement, compliance.", "technology": ".NET Minimal APIs/Controllers", "dependencies": ["identity_client", "issuance_client", "registry_client", "settlement_client", "compliance_client"], "c4_level": "Component"},
    "identity_oidc": {"name": "OIDC Proxy", "description": "/.well-known, authorize, token, userinfo; proxies to Keycloak/ESIA.", "technology": ".NET 9", "dependencies": ["keycloak"], "c4_level": "Component"},
    "issuance_core": {"name": "IssuanceService", "description": "Create/publish/close issuance; EF Core; Outbox.", "technology": ".NET 9 / EF Core", "dependencies": ["issuance_db", "kafka", "fabric_adapter"], "c4_level": "Component"},
    "registry_core": {"name": "RegistryService", "description": "Place orders, update wallets; integrates bank nominal.", "technology": ".NET 9 / EF Core", "dependencies": ["registry_db", "kafka", "bank_nominal_client"], "c4_level": "Component"},
    "settlement_core": {"name": "SettlementService", "description": "Run payouts batch (DvP), reconciliation.", "technology": ".NET 9 / EF Core", "dependencies": ["settlement_db", "bank_nominal_client", "issuance_client", "registry_client"], "c4_level": "Component"},
    "compliance_core": {"name": "ComplianceService", "description": "KYC status, qualification policy evaluation.", "technology": ".NET 9 / EF Core", "dependencies": ["compliance_db"], "c4_level": "Component"},
    "fabric_adapter": {"name": "LedgerIssuanceAdapter", "description": "Submit issuance ops to HLF via Fabric Gateway.", "technology": ".NET 9", "dependencies": ["fabric_gateway"], "c4_level": "Component"},
    "bank_nominal_client": {"name": "BankNominalClient", "description": "HTTP client for bank nominal platform.", "technology": ".NET 9 / HttpClient", "dependencies": ["bank_nominal_api"], "c4_level": "Component"},
    "issuance_db": {"name": "IssuanceDbContext", "description": "EF Core DbContext for issuance.", "technology": "PostgreSQL / EF Core", "dependencies": [], "c4_level": "Code"},
    "registry_db": {"name": "RegistryDbContext", "description": "EF Core DbContext for registry.", "technology": "PostgreSQL / EF Core", "dependencies": [], "c4_level": "Code"},
    "settlement_db": {"name": "SettlementDbContext", "description": "EF Core DbContext for settlement.", "technology": "PostgreSQL / EF Core", "dependencies": [], "c4_level": "Code"},
    "compliance_db": {"name": "ComplianceDbContext", "description": "EF Core DbContext for compliance.", "technology": "PostgreSQL / EF Core", "dependencies": [], "c4_level": "Code"}
  },
  "domain_glossary": {
    "CFA": {"description": "Digital Financial Asset (ЦФА).", "c4_level": "Context"},
    "Issuance": {"description": "Lifecycle of creating/publishing a CFA issuance.", "c4_level": "Context"},
    "Order": {"description": "Investor request to buy CFA.", "c4_level": "Context"},
    "Wallet": {"description": "Investor holdings and balances.", "c4_level": "Context"},
    "Payout": {"description": "Scheduled payment to investors.", "c4_level": "Context"},
    "KYC": {"description": "Know Your Customer verification.", "c4_level": "Context"},
    "Qualification": {"description": "Investor qualification evaluation tier.", "c4_level": "Context"},
    "ESIA": {"description": "Russian eID provider.", "c4_level": "Context"},
    "Bank Nominal": {"description": "Custody/broker API used for fiat legs.", "c4_level": "Context"}
  },
  "deployment_topology": {
    "local_docker": {
      "name": "Local Docker Compose",
      "description": "Local development topology using docker-compose.",
      "relationships": [
        {"source": "frontend_portal_investor", "destination": "api_gateway", "description": "HTTP REST"},
        {"source": "frontend_portal_issuer", "destination": "api_gateway", "description": "HTTP REST"},
        {"source": "frontend_backoffice", "destination": "api_gateway", "description": "HTTP REST"},
        {"source": "api_gateway", "destination": "identity_service", "description": "Auth/OIDC"},
        {"source": "api_gateway", "destination": "issuance_service", "description": "REST"},
        {"source": "api_gateway", "destination": "registry_service", "description": "REST"},
        {"source": "api_gateway", "destination": "settlement_service", "description": "REST"},
        {"source": "api_gateway", "destination": "compliance_service", "description": "REST"},
        {"source": "identity_service", "destination": "keycloak", "description": "OIDC"},
        {"source": "issuance_service", "destination": "postgres", "description": "EF Core"},
        {"source": "registry_service", "destination": "postgres", "description": "EF Core"},
        {"source": "settlement_service", "destination": "postgres", "description": "EF Core"},
        {"source": "compliance_service", "destination": "postgres", "description": "EF Core"},
        {"source": "issuance_service", "destination": "kafka", "description": "Outbox → Kafka"},
        {"source": "registry_service", "destination": "kafka", "description": "Outbox → Kafka"},
        {"source": "issuance_service", "destination": "fabric_gateway", "description": "Ledger ops"},
        {"source": "registry_service", "destination": "fabric_gateway", "description": "Ledger ops"},
        {"source": "fabric_gateway", "destination": "fabric_network", "description": "HLF client"},
        {"source": "settlement_service", "destination": "integration_bank_nominal", "description": "Bank API"},
        {"source": "api_gateway", "destination": "integration_esia", "description": "ESIA flows"},
        {"source": "api_gateway", "destination": "integration_edo", "description": "EDO flows"},
        {"source": "any_service", "destination": "minio", "description": "Object storage (optional)"}
      ],
      "c4_level": "Container"
    }
  },
  "data_schema": {
    "description": "Service-per-database EF Core on PostgreSQL. Separate DBs/schemas per service.",
    "tables": {
      "Issuance": {"description": "Issuance aggregate root", "columns": ["Id (uuid pk)", "Code (string unique)", "Name (string)", "Status (enum)", "Schedule (json)"]},
      "Order": {"description": "Investor orders", "columns": ["Id (uuid pk)", "InvestorId (uuid)", "IssuanceId (uuid fk)", "Status (enum)", "Amount (numeric)", "CreatedAt (timestamp)"]},
      "Wallet": {"description": "Holdings per investor", "columns": ["Id (uuid pk)", "InvestorId (uuid)", "Balance (numeric)", "UpdatedAt (timestamp)"]},
      "Payout": {"description": "Scheduled payouts", "columns": ["Id (uuid pk)", "IssuanceId (uuid fk)", "DueDate (date)", "Amount (numeric)", "Status (enum)"]},
      "KycResult": {"description": "Compliance KYC results", "columns": ["Id (uuid pk)", "InvestorId (uuid)", "Decision (enum)", "Reason (string)", "CheckedAt (timestamp)"]}
    },
    "relationships": [
      {"from": "Issuance", "to": "Order", "type": "One-to-Many", "description": "Orders per issuance"},
      {"from": "Issuance", "to": "Payout", "type": "One-to-Many", "description": "Scheduled payouts per issuance"},
      {"from": "Order", "to": "Wallet", "type": "Many-to-One", "description": "Wallet updates from executed orders"}
    ]
  },
  "api_endpoints": [
    {"name": "Gateway API", "prefix": "/", "description": "Public REST for UIs.", "endpoints": [
      {"method": "GET", "path": "/health", "description": "Health", "authentication": "none"},
      {"method": "POST", "path": "/issuances", "description": "Create issuance", "authentication": "jwt"},
      {"method": "GET", "path": "/issuances/{id}", "description": "Get issuance", "authentication": "jwt"},
      {"method": "POST", "path": "/issuances/{id}/publish", "description": "Publish issuance", "authentication": "jwt"},
      {"method": "POST", "path": "/issuances/{id}/close", "description": "Close issuance", "authentication": "jwt"},
      {"method": "POST", "path": "/v1/orders", "description": "Place order", "authentication": "jwt"},
      {"method": "GET", "path": "/v1/orders/{id}", "description": "Get order", "authentication": "jwt"},
      {"method": "GET", "path": "/v1/wallets/{investorId}", "description": "Get wallet", "authentication": "jwt"},
      {"method": "POST", "path": "/v1/issuances/{id}/redeem", "description": "Redeem issuance", "authentication": "jwt"},
      {"method": "POST", "path": "/v1/settlement/run", "description": "Run settlement", "authentication": "jwt"},
      {"method": "GET", "path": "/v1/reports/payouts", "description": "Payouts report", "authentication": "jwt"},
      {"method": "POST", "path": "/v1/compliance/kyc/check", "description": "KYC check", "authentication": "jwt"},
      {"method": "POST", "path": "/v1/compliance/qualification/evaluate", "description": "Qualification evaluate", "authentication": "jwt"},
      {"method": "GET", "path": "/v1/compliance/investors/{id}/status", "description": "Investor compliance status", "authentication": "jwt"}
    ]},
    {"name": "Identity API", "prefix": "/", "description": "OIDC endpoints.", "endpoints": [
      {"method": "GET", "path": "/.well-known/openid-configuration", "description": "OIDC config", "authentication": "none"},
      {"method": "GET", "path": "/authorize", "description": "Authorize", "authentication": "none"},
      {"method": "POST", "path": "/token", "description": "Token", "authentication": "client"},
      {"method": "GET", "path": "/userinfo", "description": "Userinfo", "authentication": "jwt"}
    ]},
    {"name": "Issuance Service API", "prefix": "/v1", "description": "Issuance domain.", "endpoints": [
      {"method": "POST", "path": "/issuances", "description": "Create issuance", "authentication": "service"},
      {"method": "GET", "path": "/issuances/{id}", "description": "Get issuance", "authentication": "service"},
      {"method": "POST", "path": "/issuances/{id}/publish", "description": "Publish issuance", "authentication": "service"},
      {"method": "POST", "path": "/issuances/{id}/close", "description": "Close issuance", "authentication": "service"}
    ]},
    {"name": "Registry Service API", "prefix": "/v1", "description": "Orders, wallets.", "endpoints": [
      {"method": "POST", "path": "/orders", "description": "Place order", "authentication": "service", "headers": ["Idempotency-Key: uuid"]},
      {"method": "GET", "path": "/orders/{id}", "description": "Get order", "authentication": "service"},
      {"method": "GET", "path": "/wallets/{investorId}", "description": "Get wallet", "authentication": "service"},
      {"method": "POST", "path": "/issuances/{id}/redeem", "description": "Redeem issuance", "authentication": "service"}
    ]},
    {"name": "Settlement Service API", "prefix": "/v1", "description": "Settlement & reports.", "endpoints": [
      {"method": "POST", "path": "/settlement/run", "description": "Run settlement", "authentication": "service"},
      {"method": "GET", "path": "/reports/payouts", "description": "Payouts report", "authentication": "service"}
    ]},
    {"name": "Compliance Service API", "prefix": "/v1", "description": "KYC/Qualification/Complaints.", "endpoints": [
      {"method": "POST", "path": "/compliance/kyc/check", "description": "KYC check", "authentication": "service"},
      {"method": "POST", "path": "/compliance/qualification/evaluate", "description": "Qualification evaluate", "authentication": "service"},
      {"method": "GET", "path": "/compliance/investors/{id}/status", "description": "Investor status", "authentication": "service"},
      {"method": "POST", "path": "/complaints", "description": "Create complaint", "authentication": "service"},
      {"method": "GET", "path": "/complaints/{id}", "description": "Get complaint", "authentication": "service"}
    ]},
    {"name": "Bank Nominal Integration API", "prefix": "/", "description": "Nominal accounts.", "endpoints": [
      {"method": "POST", "path": "/nominal/accounts", "description": "Open nominal account", "authentication": "service"},
      {"method": "GET", "path": "/nominal/accounts/{accountId}", "description": "Get account", "authentication": "service"}
    ]}
  ],
  "external_services": {
    "postgres": {"type": "db", "description": "PostgreSQL 16 database(s) per service", "technology": "PostgreSQL"},
    "kafka": {"type": "queue", "description": "Event streaming bus (outbox consumers)", "technology": "Apache Kafka 3.6"},
    "zookeeper": {"type": "queue", "description": "Kafka coordination", "technology": "Zookeeper"},
    "keycloak": {"type": "auth", "description": "Identity provider (OIDC)", "technology": "Keycloak 25.0"},
    "minio": {"type": "object-storage", "description": "S3-compatible object storage", "technology": "Minio"},
    "fabric_network": {"type": "platform", "description": "Hyperledger Fabric network", "technology": "HLF 2.2+"},
    "bank_nominal_api": {"type": "third-party", "description": "Bank nominal API for fiat legs", "technology": "HTTP"},
    "esia": {"type": "third-party", "description": "ESIA eID provider", "technology": "OIDC"},
    "edo_provider": {"type": "third-party", "description": "Electronic document operator", "technology": "HTTP"}
  },
  "sources": [
    {"path": "apps/api-gateway/Program.cs", "role": "api", "anchors": ["health", "issuances", "orders", "wallets", "settlement", "compliance", "redeem", "authorize"]},
    {"path": "apps/api-gateway/Dockerfile", "role": "deployment", "anchors": ["base image", "publish", "entrypoint"]},
    {"path": "services/identity/Program.cs", "role": "api", "anchors": ["/.well-known", "/authorize", "/token", "/userinfo", "BearerAuth"]},
    {"path": "services/issuance/IssuanceDbContext.cs", "role": "data_schema", "anchors": ["DbSet<Issuance>", "OnModelCreating"]},
    {"path": "services/issuance/Services/IssuanceService.cs", "role": "component", "anchors": ["Create", "Publish", "Close", "OutboxService", "LedgerIssuanceAdapter"]},
    {"path": "services/issuance/Services/OutboxService.cs", "role": "component", "anchors": ["Poll", "Publish", "MarkSent"]},
    {"path": "services/issuance/Services/LedgerIssuanceAdapter.cs", "role": "component", "anchors": ["Submit", "FabricGateway"]},
    {"path": "services/registry/RegistryDbContext.cs", "role": "data_schema", "anchors": ["DbSet<Order>", "DbSet<Wallet>"]},
    {"path": "services/registry/Services/RegistryService.cs", "role": "component", "anchors": ["PlaceOrder", "OutboxPublish", "WalletUpdate", "BankNominalClient"]},
    {"path": "services/settlement/SettlementDbContext.cs", "role": "data_schema", "anchors": ["DbSet<Payout>", "Indexes"]},
    {"path": "services/settlement/Services/SettlementService.cs", "role": "component", "anchors": ["RunBatch", "Reconcile", "IssueClient", "RegistryClient"]},
    {"path": "services/compliance/ComplianceDbContext.cs", "role": "data_schema", "anchors": ["DbSet<KycResult>", "Migrations"]},
    {"path": "services/compliance/Services/ComplianceService.cs", "role": "component", "anchors": ["CheckKyc", "EvaluateQualification", "InvestorStatus"]},
    {"path": "services/fabric-gateway/FabricGatewayService.cs", "role": "component", "anchors": ["SubmitTransaction", "Connect"]},
    {"path": "packages/contracts/openapi-gateway.yaml", "role": "api", "anchors": ["/health", "/issuances", "/v1/orders", "/v1/wallets", "/v1/settlement/run", "/v1/reports/payouts", "/v1/compliance/kyc/check", "/v1/issuances/{id}/redeem"]},
    {"path": "packages/contracts/openapi-identity.yaml", "role": "api", "anchors": ["/.well-known/openid-configuration", "/authorize", "/token", "/userinfo"]},
    {"path": "packages/contracts/openapi-issuance.yaml", "role": "api", "anchors": ["/v1/issuances", "/v1/issuances/{id}", "/v1/issuances/{id}/publish", "/v1/issuances/{id}/close"]},
    {"path": "packages/contracts/openapi-registry.yaml", "role": "api", "anchors": ["/v1/orders", "/v1/orders/{id}", "/v1/wallets/{investorId}", "/v1/issuances/{id}/redeem"]},
    {"path": "packages/contracts/openapi-settlement.yaml", "role": "api", "anchors": ["/v1/settlement/run", "/v1/reports/payouts"]},
    {"path": "packages/contracts/openapi-compliance.yaml", "role": "api", "anchors": ["/v1/compliance/kyc/check", "/v1/compliance/qualification/evaluate", "/v1/compliance/investors/{id}/status", "/v1/complaints", "/v1/complaints/{id}"]},
    {"path": "packages/contracts/openapi-integrations-bank.yaml", "role": "api", "anchors": ["/nominal/accounts", "/nominal/accounts/{accountId}"]},
    {"path": "packages/contracts/asyncapi.yaml", "role": "api", "anchors": ["topics", "schemas"]},
    {"path": "packages/contracts/schemas/*.json", "role": "schema", "anchors": ["CFA", "Order", "Wallet", "Payout", "KycResult", "TxHistoryItem", "RegistryTx", "AuditEvent"]},
    {"path": "docker-compose.yml", "role": "deployment", "anchors": ["postgres", "kafka", "zookeeper", "keycloak", "minio", "healthcheck"]},
    {"path": "ops/helm/**", "role": "deployment", "anchors": ["fabric-ca", "orderer", "peer", "chaincode-build", "values.yaml", "ingress"]},
    {"path": "chaincode/issuance/issuance.go", "role": "component", "anchors": ["Init", "Invoke", "CreateIssuance"]},
    {"path": "chaincode/registry/registry.go", "role": "component", "anchors": ["Init", "Invoke", "CreateOrder"]},
    {"path": "docs/architecture/10-HighLevel-Architecture.md", "role": "context", "anchors": ["C1", "C2", "C3", "C4"]},
    {"path": "README.md", "role": "context", "anchors": ["MVP", "Quick start", "Requirements"]}
  ]
}

