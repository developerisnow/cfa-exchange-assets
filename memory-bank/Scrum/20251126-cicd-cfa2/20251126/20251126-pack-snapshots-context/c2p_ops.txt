Project Path: ops

Source Tree:

```txt
ops
‚îú‚îÄ‚îÄ debug-deploy-quickstart.md
‚îú‚îÄ‚îÄ gitlab-ci-docker-frontend-fix.md
‚îú‚îÄ‚îÄ gitlab-ci.md
‚îú‚îÄ‚îÄ gitlab-runner-403-fix-complete.md
‚îú‚îÄ‚îÄ gitlab-runner-403-solution.md
‚îú‚îÄ‚îÄ gitlab-runner-compliance-report.md
‚îú‚îÄ‚îÄ gitlab-runner-fix-summary.md
‚îú‚îÄ‚îÄ gitlab-runner-force-reregister.md
‚îú‚îÄ‚îÄ gitlab-runner-image-pull-fix.md
‚îú‚îÄ‚îÄ gitlab-runner-install-troubleshooting.md
‚îú‚îÄ‚îÄ gitlab-runner-job-hanging-fix.md
‚îú‚îÄ‚îÄ gitlab-runner-lens-install.md
‚îú‚îÄ‚îÄ gitlab-runner-memory-issue.md
‚îú‚îÄ‚îÄ gitlab-runner-registration-explained.md
‚îú‚îÄ‚îÄ gitlab-runner-resources-optimization.md
‚îú‚îÄ‚îÄ gitlab-runner-state-file-fix.md
‚îú‚îÄ‚îÄ gitlab-runner-status-report.md
‚îú‚îÄ‚îÄ gitlab-runner-troubleshooting.md
‚îú‚îÄ‚îÄ gitlab-runner.md
‚îú‚îÄ‚îÄ gitops-sync-acceptance.md
‚îú‚îÄ‚îÄ gitops-sync-guide.md
‚îú‚îÄ‚îÄ gitops-sync-task-complete.md
‚îú‚îÄ‚îÄ gitops.md
‚îú‚îÄ‚îÄ helm.md
‚îú‚îÄ‚îÄ production-deployment-master-plan.md
‚îú‚îÄ‚îÄ production-deployment-master-prompt.md
‚îú‚îÄ‚îÄ production-deployment-status.md
‚îú‚îÄ‚îÄ quick-start-production.md
‚îî‚îÄ‚îÄ timeweb
    ‚îú‚îÄ‚îÄ kubeconfig.md
    ‚îú‚îÄ‚îÄ terraform.md
    ‚îî‚îÄ‚îÄ twc-setup.md

```

`ops/debug-deploy-quickstart.md`:

```md
# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: debug:deploy job

## –ü—Ä–æ–±–ª–µ–º–∞: "No runners available"

–ï—Å–ª–∏ job `debug:deploy` –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–∞–Ω–Ω–µ—Ä–æ–≤, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏.

## –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–Ω–Ω–µ—Ä–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–Ω–Ω–µ—Ä–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
make check-runner-status

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
make gitlab-runner-status
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –†–∞–Ω–Ω–µ—Ä pods –≤ —Å—Ç–∞—Ç—É—Å–µ "Running"
- –†–∞–Ω–Ω–µ—Ä –≤–∏–¥–µ–Ω –≤ GitLab UI –∫–∞–∫ "Online"

## –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–Ω–Ω–µ—Ä –≤ GitLab UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
2. –†–∞–∑–¥–µ–ª: **Runners**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ –†–∞–Ω–Ω–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
   - ‚úÖ –°—Ç–∞—Ç—É—Å: **Online** (–∑–µ–ª—ë–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)
   - ‚úÖ –¢–µ–≥–∏: **–ø—É—Å—Ç—ã–µ** (–∏–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å job)

**–ï—Å–ª–∏ —Ä–∞–Ω–Ω–µ—Ä –Ω–µ –æ–Ω–ª–∞–π–Ω:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `make gitlab-runner-logs`
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `make gitlab-runner-restart`

**–ï—Å–ª–∏ —Ä–∞–Ω–Ω–µ—Ä –∏–º–µ–µ—Ç —Ç–µ–≥–∏:**
- –£–±–µ—Ä–∏—Ç–µ —Ç–µ–≥–∏ –≤ GitLab UI (Settings ‚Üí CI/CD ‚Üí Runners ‚Üí Edit runner)
- –ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ–≥–∏ –≤ job (—Å–º. –Ω–∏–∂–µ)

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å KUBECONFIG

Job —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä—É. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `KUBECONFIG`:

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ GitLab CI/CD Variables (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

1. GitLab UI ‚Üí Settings ‚Üí CI/CD ‚Üí Variables
2. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:
   - Key: `KUBECONFIG`
   - Value: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `ops/infra/timeweb/kubeconfig.yaml`
   - Type: **Variable** (–∏–ª–∏ **File** –µ—Å–ª–∏ –ø—É—Ç—å)
   - Protected: ‚úÖ (–¥–ª—è production)
   - Masked: ‚ùå (kubeconfig —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π)

**–í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ GitLab Secure Files**

1. GitLab UI ‚Üí Settings ‚Üí CI/CD ‚Üí Secure Files
2. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª `ops/infra/timeweb/kubeconfig.yaml`
3. Job –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥—ë—Ç —Ñ–∞–π–ª

**–í–∞—Ä–∏–∞–Ω—Ç C: –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**

```bash
# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig
make setup-kubeconfig

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
kubectl get nodes
```

## –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å debug:deploy

1. GitLab UI ‚Üí CI/CD ‚Üí Pipelines
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å pipeline (–∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
3. –ù–∞–π—Ç–∏ job `debug:deploy`
4. –ù–∞–∂–∞—Ç—å **Play** (manual job)

## –ï—Å–ª–∏ —Ä–∞–Ω–Ω–µ—Ä —Ç—Ä–µ–±—É–µ—Ç —Ç–µ–≥–∏

–ï—Å–ª–∏ —Ä–∞–Ω–Ω–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å —Ç–µ–≥–∞–º–∏ –∏ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å job –±–µ–∑ —Ç–µ–≥–æ–≤:

**–í–∞—Ä–∏–∞–Ω—Ç A: –£–±—Ä–∞—Ç—å —Ç–µ–≥–∏ —Å —Ä–∞–Ω–Ω–µ—Ä–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
- GitLab UI ‚Üí Settings ‚Üí CI/CD ‚Üí Runners ‚Üí Edit
- –£–±—Ä–∞—Ç—å –≤—Å–µ —Ç–µ–≥–∏
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

**–í–∞—Ä–∏–∞–Ω—Ç B: –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏ –≤ job**

–í `.gitlab-ci.yml` –¥–æ–±–∞–≤–∏—Ç—å:
```yaml
debug:deploy:
  tags:
    - kubernetes  # –∏–ª–∏ —Ç–µ–≥–∏ –≤–∞—à–µ–≥–æ —Ä–∞–Ω–Ω–µ—Ä–∞
```

## Troubleshooting

### –û—à–∏–±–∫–∞: "This job is stuck because the project doesn't have any runners online"

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –†–∞–Ω–Ω–µ—Ä –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
2. –†–∞–Ω–Ω–µ—Ä –Ω–µ –æ–Ω–ª–∞–π–Ω
3. –†–∞–Ω–Ω–µ—Ä –∏–º–µ–µ—Ç —Ç–µ–≥–∏, –∞ job –Ω–µ —É–∫–∞–∑–∞–ª —Ç–µ–≥–∏
4. –†–∞–Ω–Ω–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
make check-runner-status

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
make gitlab-runner-logs

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞–Ω–Ω–µ—Ä
make gitlab-runner-restart

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI
# Settings ‚Üí CI/CD ‚Üí Runners
```

### –û—à–∏–±–∫–∞: "KUBECONFIG not found"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `KUBECONFIG` –≤ GitLab CI/CD Variables
2. –ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å kubeconfig –∫–∞–∫ Secure File
3. –ò–ª–∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ñ–∞–π–ª `ops/infra/timeweb/kubeconfig.yaml` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

### –û—à–∏–±–∫–∞: "Cannot connect to cluster"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å kubeconfig –ª–æ–∫–∞–ª—å–Ω–æ
export KUBECONFIG="ops/infra/timeweb/kubeconfig.yaml"
kubectl cluster-info
kubectl get nodes

# –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ–±–Ω–æ–≤–∏—Ç—å kubeconfig
make setup-kubeconfig
```

## –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è debug:deploy

Job `debug:deploy` —Ç—Ä–µ–±—É–µ—Ç:
- ‚úÖ –†–∞–Ω–Ω–µ—Ä –æ–Ω–ª–∞–π–Ω (–ª—é–±–æ–π executor: docker, kubernetes)
- ‚úÖ KUBECONFIG –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏–ª–∏ —Ñ–∞–π–ª)
- ‚úÖ –†–∞–Ω–Ω–µ—Ä –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- ‚úÖ –†–∞–Ω–Ω–µ—Ä –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ç–µ–≥–∏ (–∏–ª–∏ job —É–∫–∞–∑–∞–ª —Ç–µ–≥–∏)

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–Ω–Ω–µ—Ä
make check-runner-status

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å kubeconfig
make check-kubeconfig

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
export KUBECONFIG="ops/infra/timeweb/kubeconfig.yaml"
kubectl get nodes

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å debug deploy –ª–æ–∫–∞–ª—å–Ω–æ (—Ç–µ—Å—Ç)
kubectl apply -f ops/debug/namespace.yaml
kubectl apply -f ops/debug/serviceaccount.yaml
kubectl apply -f ops/debug/configmap-scripts.yaml
kubectl apply -f ops/debug/debug-pod.yaml
```

## –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ deploy

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pod
kubectl get pods -n tools

# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ debug pod
kubectl exec -it -n tools debug-toolbox -- /bin/bash

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã
kubectl exec -n tools debug-toolbox -- /scripts/logs-collect.sh
```


```

`ops/gitlab-ci-docker-frontend-fix.md`:

```md
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Docker CLI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ Frontend Build Jobs

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** `docker: not found` –≤ frontend build jobs  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## –ü—Ä–æ–±–ª–µ–º–∞

### –û—à–∏–±–∫–∞

```
/scripts-6-358/step_script: eval: line 187: docker: not found
```

### –ü—Ä–∏—á–∏–Ω–∞

–®–∞–±–ª–æ–Ω `.build_frontend_template` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –æ–±—Ä–∞–∑ `node:22-alpine`, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç Docker CLI. –ü—Ä–∏ —ç—Ç–æ–º –≤ `before_script` –∏ `script` –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –∫–æ–º–∞–Ω–¥—ã:
- `docker login`
- `docker buildx create`
- `docker buildx build`

---

## –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è

1. **–û–±—Ä–∞–∑ –∏–∑–º–µ–Ω—ë–Ω** —Å `node:22-alpine` –Ω–∞ `docker:24-dind`
2. **–î–æ–±–∞–≤–ª–µ–Ω service** `docker:24-dind` –¥–ª—è Docker-in-Docker
3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js** –≤ `before_script`:
   ```yaml
   - apk add --no-cache nodejs npm
   ```

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω

```yaml
.build_frontend_template: &build_frontend_template
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - apk add --no-cache nodejs npm
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      cd $APP_PATH
      npm ci
      npm run build
      docker buildx create --use --name builder || true
      docker buildx build \
        --platform linux/amd64 \
        --push \
        --tag $REGISTRY/$IMAGE_NAME:$IMAGE_TAG \
        --tag $REGISTRY/$IMAGE_NAME:$IMAGE_TAG_LATEST \
        --file Dockerfile \
        .
```

---

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ Jobs

–í—Å–µ frontend build jobs –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω:
- `build:portal-issuer`
- `build:portal-investor`
- `build:backoffice`

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞

‚úÖ YAML —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤–∞–ª–∏–¥–µ–Ω  
‚úÖ Docker CLI –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ–±—Ä–∞–∑–µ `docker:24-dind`  
‚úÖ Node.js —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `apk`  
‚úÖ Docker-in-Docker service –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker CLI –≤ node:22-alpine

```yaml
before_script:
  - apk add --no-cache docker-cli docker-buildx
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫:** –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Docker daemon –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω–µ–µ.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ —Å Node.js –∏ Docker

```yaml
image: node:22-alpine
services:
  - docker:24-dind
before_script:
  - apk add --no-cache docker-cli docker-buildx
  - export DOCKER_HOST=tcp://docker:2375
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ DOCKER_HOST.

### –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `docker:24-dind` —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π Node.js ‚Äî –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–µ –∏ –Ω–∞–¥—ë–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å backend build jobs.

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ
2. ‚è≥ –ó–∞–ø—É—Å—Ç–∏—Ç—å pipeline –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
3. ‚è≥ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ frontend build jobs –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

---

## –°—Å—ã–ª–∫–∏

- [GitLab CI Docker-in-Docker](https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-executor)
- [Docker Alpine Package Manager](https://pkgs.alpinelinux.org/packages)


```

`ops/gitlab-ci.md`:

```md
# GitLab CI/CD Pipeline –¥–ª—è OIS-CFA

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–í–ª–∞–¥–µ–ª–µ—Ü:** DevOps/SRE

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–°—Ç–∞–¥–∏–∏ Pipeline](#—Å—Ç–∞–¥–∏–∏-pipeline)
3. [Build Jobs](#build-jobs)
4. [Test Jobs](#test-jobs)
5. [Deploy Jobs](#deploy-jobs)
6. [Environments](#environments)
7. [–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã](#–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)
8. [–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ](#–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
9. [Troubleshooting](#troubleshooting)

---

## –û–±–∑–æ—Ä

GitLab CI/CD pipeline –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å–±–æ—Ä–∫–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è OIS-CFA.

### –°—Ç–∞–¥–∏–∏

1. **infra** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (Terraform)
2. **build** ‚Äî —Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
3. **test** ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (unit, pact, e2e, k6)
4. **deploy** ‚Äî —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

`.gitlab-ci.yml` –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

---

## –°—Ç–∞–¥–∏–∏ Pipeline

### 1. INFRA

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —á–µ—Ä–µ–∑ Terraform.

**Jobs:**
- `terraform:plan` ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `terraform:apply` ‚Äî –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (manual)

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- Web UI (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
- –í–µ—Ç–∫–∏ `infra/*`

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
- `tfplan` ‚Äî –ø–ª–∞–Ω Terraform

### 2. BUILD

–°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

**Backend Services:**
- `build:api-gateway`
- `build:identity`
- `build:issuance`
- `build:registry`
- `build:settlement`
- `build:compliance`
- `build:bank-nominal`

**Frontend Apps:**
- `build:portal-issuer`
- `build:portal-investor`
- `build:backoffice`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Multi-platform build (linux/amd64, linux/arm64)
- Registry cache –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
- –¢–µ–≥ `latest` —Ç–æ–ª—å–∫–æ –¥–ª—è default branch

**–û–±—Ä–∞–∑—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤:**
- `$CI_REGISTRY_IMAGE/<service-name>:$CI_COMMIT_SHA`
- `$CI_REGISTRY_IMAGE/<service-name>:latest` (—Ç–æ–ª—å–∫–æ –¥–ª—è main)

### 3. TEST

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö.

**Jobs:**
- `test:unit` ‚Äî unit —Ç–µ—Å—Ç—ã (.NET/xUnit)
- `test:pact` ‚Äî contract testing (Pact)
- `test:e2e` ‚Äî end-to-end —Ç–µ—Å—Ç—ã (Playwright)
- `test:k6:smoke` ‚Äî –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (k6)
- `validate:specs` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è OpenAPI/AsyncAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
- JUnit XML –æ—Ç—á—ë—Ç—ã
- Coverage –æ—Ç—á—ë—Ç—ã
- Pact —Ñ–∞–π–ª—ã
- Playwright HTML –æ—Ç—á—ë—Ç—ã
- k6 summary JSON

### 4. DEPLOY

–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

**Environments:**
- `dev` ‚Äî feature branches, merge requests
- `staging` ‚Äî main branch
- `production` ‚Äî tags v* (manual)

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è:**
- **Option A:** ArgoCD (staging, production)
- **Option B:** GitLab Agent (dev, pull-based GitOps)

---

## Build Jobs

### Backend Services

–í—Å–µ backend —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —à–∞–±–ª–æ–Ω `.docker_build_template`:

```yaml
build:api-gateway:
  variables:
    IMAGE_NAME: api-gateway
    DOCKERFILE: apps/api-gateway/Dockerfile
    BUILD_CONTEXT: .
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Docker Buildx –¥–ª—è multi-platform
- Registry cache
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### Frontend Apps

Frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç —à–∞–±–ª–æ–Ω `.build_frontend_template`:

```yaml
build:portal-issuer:
  variables:
    IMAGE_NAME: portal-issuer
    APP_PATH: apps/portal-issuer
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Node.js build –ø–µ—Ä–µ–¥ Docker
- Single platform (linux/amd64)

---

## Test Jobs

### Unit Tests

```yaml
test:unit:
  script:
    - dotnet test --logger "junit;LogFileName=junit.xml"
```

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
- `junit.xml` ‚Äî JUnit –æ—Ç—á—ë—Ç
- `coverage/` ‚Äî coverage –æ—Ç—á—ë—Ç—ã

**Coverage:**
- –§–æ—Ä–º–∞—Ç: Cobertura
- Threshold: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ

### Pact Tests

```yaml
test:pact:
  script:
    - cd tests/contracts/pact-consumer
    - npm ci && npm test
```

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
- `pacts/` ‚Äî Pact —Ñ–∞–π–ª—ã

**Publish:**
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Pact Broker (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- –¢–æ–ª—å–∫–æ –¥–ª—è default branch

### E2E Tests

```yaml
test:e2e:
  image: mcr.microsoft.com/playwright:v1.47.2-jammy
  script:
    - cd tests/e2e
    - npm ci
    - npx playwright install --with-deps
    - npm test
```

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
- `playwright-report/` ‚Äî HTML –æ—Ç—á—ë—Ç
- `test-results/junit.xml` ‚Äî JUnit –æ—Ç—á—ë—Ç

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- Default branch
- Feature branches
- Merge requests

### K6 Smoke Tests

```yaml
test:k6:smoke:
  variables:
    K6_SMOKE_VUS: "10"
    K6_SMOKE_DURATION: "30s"
  script:
    - k6 run --summary-export=summary.json tests/k6/gateway-critical-paths.js
```

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
- `summary.json` ‚Äî summary –æ—Ç—á—ë—Ç
- `k6-results.json` ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**Thresholds:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ k6 —Å–∫—Ä–∏–ø—Ç–∞—Ö

---

## Deploy Jobs

### Option A: ArgoCD

```yaml
deploy:staging:
  script:
    - argocd app sync ois-staging --grpc-web
    - argocd app wait ois-staging --grpc-web
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- ArgoCD —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
- `ARGOCD_ADMIN_PASSWORD` –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- `ARGOCD_SERVER` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ ArgoCD server

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- `staging` (main branch)
- `production` (tags v*, manual)

### Option B: GitLab Agent

```yaml
deploy:dev:
  script:
    - echo "GitLab Agent syncs manifests automatically"
    - kubectl get deployments -n $KUBERNETES_NAMESPACE
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- GitLab Agent —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
- –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ `ops/gitops/gitlab-agent/manifests/`

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- `dev` (feature branches, merge requests)

**Pull-based GitOps:**
- –ê–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
- CI —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ Git

---

## Environments

### DEV

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- Feature branches (`feature/*`)
- Merge requests

**Deploy:**
- GitLab Agent (pull-based)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π

**URL:**
- `https://dev.ois-cfa.example.com`

### STAGING

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- Main branch

**Deploy:**
- ArgoCD
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π

**URL:**
- `https://staging.ois-cfa.example.com`

### PRODUCTION

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- Tags `v*.*.*` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `v1.0.0`)

**Deploy:**
- ArgoCD
- Manual (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)

**URL:**
- `https://ois-cfa.example.com`

---

## –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

### JUnit Reports

```yaml
artifacts:
  reports:
    junit: junit.xml
```

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- Unit tests
- E2E tests

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
- GitLab UI ‚Üí Test Reports

### Coverage Reports

```yaml
artifacts:
  paths:
    - coverage/
```

**–§–æ—Ä–º–∞—Ç:**
- Cobertura XML
- HTML

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
- GitLab UI ‚Üí Coverage

### Pact Files

```yaml
artifacts:
  paths:
    - tests/contracts/pact-consumer/pacts/
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Pact Broker
- Contract verification

### Playwright Reports

```yaml
artifacts:
  paths:
    - tests/e2e/playwright-report/
```

**–§–æ—Ä–º–∞—Ç:**
- HTML –æ—Ç—á—ë—Ç
- –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∏ –≤–∏–¥–µ–æ

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

### K6 Reports

```yaml
artifacts:
  paths:
    - summary.json
    - k6-results.json
```

**–§–æ—Ä–º–∞—Ç:**
- JSON summary
- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ì–¥–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å |
|-----------|----------|---------------|
| `ARGOCD_ADMIN_PASSWORD` | ArgoCD admin password | GitLab CI/CD Variables |
| `PACT_BROKER_URL` | Pact Broker URL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) | GitLab CI/CD Variables |
| `PACT_BROKER_TOKEN` | Pact Broker token (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) | GitLab CI/CD Variables |

### Terraform Backend

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `TF_HTTP_ADDRESS` | GitLab Terraform state address |
| `TF_HTTP_USERNAME` | GitLab username |
| `TF_HTTP_PASSWORD` | GitLab token |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ GitLab

1. Settings ‚Üí CI/CD ‚Üí Variables
2. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥–∏:
   - **Masked** ‚Äî –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤
   - **Protected** ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è protected branches/tags

---

## Troubleshooting

### Build fails: "docker buildx not found"

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `docker:24-dind` image
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `docker buildx create` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

### Test fails: "No tests found"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–æ–≤
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–ø—É—â–µ–Ω—ã (skip)

### Deploy fails: "ArgoCD not accessible"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `ARGOCD_SERVER` –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ArgoCD –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ CI runner
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `ARGOCD_ADMIN_PASSWORD`

### GitLab Agent not syncing

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞: `kubectl get pods -n gitlab-agent`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: `.gitlab/agents/ois-cfa-agent/config.yaml`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∞–≥–µ–Ω—Ç–∞

### Images not in registry

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ registry
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `CI_REGISTRY_USER` –∏ `CI_REGISTRY_PASSWORD` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ registry –¥–æ—Å—Ç—É–ø–µ–Ω

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ó–∞–ø—É—Å–∫ pipeline –≤—Ä—É—á–Ω—É—é

1. GitLab UI ‚Üí CI/CD ‚Üí Pipelines
2. Run pipeline
3. –í—ã–±—Ä–∞—Ç—å branch
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å

### Deploy –≤ production

1. –°–æ–∑–¥–∞—Ç—å tag: `git tag v1.0.0 && git push origin v1.0.0`
2. Pipeline –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å manual job `deploy:prod`

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

1. GitLab UI ‚Üí CI/CD ‚Üí Pipelines
2. –í—ã–±—Ä–∞—Ç—å pipeline
3. –í—ã–±—Ä–∞—Ç—å job
4. Download artifacts

---

## –°—Å—ã–ª–∫–∏

- [GitLab CI/CD Documentation](https://docs.gitlab.com/ee/ci/)
- [Docker Buildx](https://docs.docker.com/buildx/)
- [ArgoCD CLI](https://argo-cd.readthedocs.io/en/stable/user-guide/commands/argocd/)
- [GitLab Agent](https://docs.gitlab.com/ee/user/clusters/agent/)

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í—Å–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Europe/Moscow (UTC+3).


```

`ops/gitlab-runner-403-fix-complete.md`:

```md
# GitLab Runner 403 Fix: Complete Analysis & Solution

**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω

---

## üîç DISCOVERY RESULTS

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞
- **Namespace:** `gitlab-runner`
- **Deployment:** `gitlab-runner`
- **Install Method:** Raw manifests (–Ω–µ Helm)
- **Replicas:** 2

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
- **ConfigMap:** `gitlab-runner-config` (read-only)
- **Mount:** `/etc/gitlab-runner` (ConfigMap)
- **State file:** –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- **Token:** `glpat-...` (Personal Access Token) ‚ùå

---

## ‚ùå –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞
- **–¢–µ–∫—É—â–∏–π:** `glpat-...` (Personal Access Token)
- **–û–∂–∏–¥–∞–µ—Ç—Å—è:** `glrt-...` (Runner Authentication Token)
- **–ü—Ä–∏—á–∏–Ω–∞:** PAT –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è runner authentication
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 403 Forbidden

### 2. State file –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏
- **–ü—É—Ç—å:** `/etc/gitlab-runner/.runner_system_id`
- **–ü—Ä–æ–±–ª–µ–º–∞:** ConfigMap –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ read-only
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** Runner –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å system_id
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö, –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

### 3. –ù–µ—Ç writable volume
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç volume –¥–ª—è `/home/gitlab-runner`
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** State file –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Runner –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç request_concurrency
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ config.toml
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** Long polling issues (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ jobs

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´

### 1. ConfigMap (`ops/infra/k8s/gitlab-runner/configmap.yaml`)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```toml
state_file = "/home/gitlab-runner/.runner_system_id"
request_concurrency = 3
environment = ["FF_USE_ADAPTIVE_REQUEST_CONCURRENCY=true"]
```

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- –¢–æ–∫–µ–Ω –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ placeholder: `__REPLACE_WITH_GLRT_TOKEN__`
- –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ authentication token

### 2. Deployment (`ops/infra/k8s/gitlab-runner/deployment.yaml`)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```yaml
volumeMounts:
  - name: runner-home
    mountPath: /home/gitlab-runner

volumes:
  - name: runner-home
    emptyDir: {}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `/home/gitlab-runner` —Ç–µ–ø–µ—Ä—å writable
- State file –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω

---

## üìã –î–ï–ô–°–¢–í–ò–Ø –î–õ–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø

### –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω

**–ï—Å–ª–∏ runner —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:**
1. –û—Ç–∫—Ä—ã—Ç—å: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
2. –†–∞–∑–¥–µ–ª: Runners
3. –ù–∞–π—Ç–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π runner
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å **Authentication Token** (glrt-...)

**–ï—Å–ª–∏ runner –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:**
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Registration Token** (GR...) –¥–ª—è –ø–µ—Ä–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
2. –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ runner –ø–æ–ª—É—á–∏—Ç Authentication Token (glrt-...)
3. –û–±–Ω–æ–≤–∏—Ç—å ConfigMap —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
./ops/ci/patch_runner_fix_403.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
# –û–±–Ω–æ–≤–∏—Ç—å ConfigMap
sed "s/__REPLACE_WITH_GLRT_TOKEN__/${RUNNER_TOKEN}/g" \
    ops/infra/k8s/gitlab-runner/configmap.yaml | \
    kubectl apply -f -

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods
kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 403)
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50 | grep -i "403\|forbidden"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å state file
kubectl exec -n gitlab-runner <pod-name> -- cat /home/gitlab-runner/.runner_system_id

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω (–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
kubectl exec -n gitlab-runner <pod-name> -- cat /etc/gitlab-runner/config.toml | grep token
```

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –°–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
GITLAB_URL="https://git.telex.global" \
RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω" \
STATE_FILE="/home/gitlab-runner/.runner_system_id" \
./ops/ci/diagnose_runner.sh
```

–°–∫—Ä–∏–ø—Ç:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç state file
- –í—ã–ø–æ–ª–Ω—è–µ—Ç verify –∑–∞–ø—Ä–æ—Å –∫ GitLab API
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `ARCHIVE/runner/verify-*.log`

---

## ‚úÖ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ State file –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `/home/gitlab-runner/.runner_system_id`
- ‚úÖ Runner –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π authentication token (glrt-...)
- ‚úÖ Request concurrency –Ω–∞—Å—Ç—Ä–æ–µ–Ω (3)
- ‚úÖ Feature flag –≤–∫–ª—é—á–µ–Ω –¥–ª—è adaptive concurrency
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ 403 –≤ –ª–æ–≥–∞—Ö
- ‚úÖ Runner —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç jobs

---

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [x] ConfigMap –æ–±–Ω–æ–≤–ª–µ–Ω (state_file, request_concurrency)
- [x] Deployment –æ–±–Ω–æ–≤–ª–µ–Ω (writable volume)
- [ ] –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è)

### –ü—Ä–æ–≤–µ—Ä–∫–∞
- [ ] –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç 403
- [ ] State file –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
- [ ] Runner –ø–æ–ª—É—á–∞–µ—Ç jobs

---

## üîß –ö–û–ú–ê–ù–î–´

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
./ops/ci/patch_runner_fix_403.sh

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
./ops/ci/diagnose_runner.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
kubectl get pods -n gitlab-runner
```

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ ConfigMap —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º authentication token (glrt-...)


```

`ops/gitlab-runner-403-solution.md`:

```md
# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 403 Forbidden –¥–ª—è GitLab Runner

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** GitLab Runner –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden –¥–∞–∂–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º  
**–°—Ç–∞—Ç—É—Å:** –¢–æ–∫–µ–Ω —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ ConfigMap, –Ω–æ GitLab –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:
- ‚úÖ ConfigMap —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω: `GR1348941HYErDk_6wh8UsSenSgsU`
- ‚úÖ Deployment –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç `config.toml`
- ‚úÖ –§–∞–π–ª `config.toml` –≤ pod —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–∫–µ–Ω
- ‚ùå GitLab –≤—Å–µ –µ—â–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 Forbidden

### –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
```
ERROR: Checking for jobs... forbidden
status=POST https://git.telex.global/api/v4/jobs/request: 403 Forbidden
runner=HYErDk_6w
```

---

## üîß –†–ï–®–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –æ—Ç–æ–∑–≤–∞–Ω (–Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** Runner Registration Token –º–æ–≥ –±—ã—Ç—å –æ—Ç–æ–∑–≤–∞–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫ –≤ GitLab.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏–∑ GitLab UI:**
   - –û—Ç–∫—Ä—ã—Ç—å: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
   - –†–∞–∑–¥–µ–ª: Runners
   - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω ‚Üí "Reset registration token"
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω

2. **–û–±–Ω–æ–≤–∏—Ç—å ConfigMap:**
   ```bash
   # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ops/infra/k8s/gitlab-runner/configmap.yaml
   # –ó–∞–º–µ–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –Ω–∞ –Ω–æ–≤—ã–π
   
   # –ü—Ä–∏–º–µ–Ω–∏—Ç—å
   kubectl apply -f ops/infra/k8s/gitlab-runner/configmap.yaml
   
   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods
   kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
   ```

3. **–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Makefile:**
   ```bash
   export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
   make gitlab-runner-update-token
   ```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: Runner —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Å –¥—Ä—É–≥–∏–º —Ç–æ–∫–µ–Ω–æ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** Runner —Å ID `HYErDk_6w` —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ GitLab, –Ω–æ —Å –¥—Ä—É–≥–∏–º —Ç–æ–∫–µ–Ω–æ–º.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–£–¥–∞–ª–∏—Ç—å runner –∏–∑ GitLab UI:**
   - Settings ‚Üí CI/CD ‚Üí Runners
   - –ù–∞–π—Ç–∏ runner —Å ID `HYErDk_6w`
   - –£–¥–∞–ª–∏—Ç—å –µ–≥–æ

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods:**
   ```bash
   kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
   ```

3. **Runner –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º**

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –£ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ runner'–∞.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞:**
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å **Runner Registration Token** (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `GR...`)
   - –ù–ï Personal Access Token (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `glpat-...`)
   - –ù–ï Deploy Token

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞:**
   - –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ `npk/ois-cfa`
   - –ò–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã/instance (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥—Ä—É–ø–ø–æ–≤–æ–π runner)

---

## üîÑ –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–£–°–¢–ê–ù–û–í–ö–ê RUNNER

–ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫—É:

```bash
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# 1. –£–¥–∞–ª–∏—Ç—å deployment
kubectl delete deployment gitlab-runner -n gitlab-runner

# 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ pods
kubectl delete pods -n gitlab-runner -l app=gitlab-runner

# 3. –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏–∑ GitLab UI
# Settings ‚Üí CI/CD ‚Üí Runners ‚Üí Reset registration token

# 4. –û–±–Ω–æ–≤–∏—Ç—å ConfigMap —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω"
make gitlab-runner-update-token

# 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å deployment
kubectl apply -f ops/infra/k8s/gitlab-runner/deployment.yaml

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
kubectl get pods -n gitlab-runner
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –£–°–ü–ï–•–ê

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Checking for jobs..." –ë–ï–ó –æ—à–∏–±–æ–∫ 403
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI:**
   - Settings ‚Üí CI/CD ‚Üí Runners
   - Runner –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Online" –∏ "Active"
   - –°—Ç–∞—Ç—É—Å: –∑–µ–ª–µ–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π job:**
   - –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π job –≤ `.gitlab-ci.yml`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ job –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ runner'–µ

---

## üìù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –í –ö–û–î–ï

### `ops/infra/k8s/gitlab-runner/configmap.yaml`
- ‚úÖ –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω: `token = "GR1348941HYErDk_6wh8UsSenSgsU"`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `mount_propagation = "None"` –¥–ª—è volumes

### `ops/infra/k8s/gitlab-runner/deployment.yaml`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `items` –≤ volume –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è `config.toml`

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏–∑ GitLab UI** (–µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
2. **–û–±–Ω–æ–≤–∏—Ç—å ConfigMap** —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods**
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å** –≤ GitLab UI
5. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π job** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

---

**–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –Ω–æ –≤—Å–µ –µ—â–µ 403, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π runner –∏–∑ GitLab UI –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å –Ω–æ–≤–æ–º—É –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.


```

`ops/gitlab-runner-compliance-report.md`:

```md
# GitLab Runner: –û—Ç—á–µ—Ç –æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 2025-01-27  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** [GitLab Runner Kubernetes Installation](https://docs.gitlab.com/runner/install/kubernetes/)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞)

---

## üìö –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

–°–æ–≥–ª–∞—Å–Ω–æ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](https://docs.gitlab.com/runner/install/kubernetes/), –¥–ª—è —Ä–∞–±–æ—Ç—ã GitLab Runner –≤ Kubernetes —Ç—Ä–µ–±—É—é—Ç—Å—è:

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

1. **`gitlabUrl`** - –ü–æ–ª–Ω—ã–π URL GitLab —Å–µ—Ä–≤–µ—Ä–∞
2. **`rbac.create: true`** - –°–æ–∑–¥–∞–Ω–∏–µ RBAC –ø—Ä–∞–≤–∏–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è pods
3. **`runnerToken`** - Authentication token, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ runner –≤ GitLab UI

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Helm chart (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±)
- –ò–ª–∏ raw manifests (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞, —Ç–∞–∫–∂–µ –≤–∞–ª–∏–¥–Ω–æ)

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ù–ê–®–ï–ô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò

### 1. gitlabUrl ‚úÖ

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** `gitlabUrl: https://git.telex.global`

**–ù–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- **ConfigMap** (`ops/infra/k8s/gitlab-runner/configmap.yaml`):
  ```toml
  url = "https://git.telex.global"
  ```
- **Deployment** (`ops/infra/k8s/gitlab-runner/deployment.yaml`):
  ```yaml
  env:
    - name: CI_SERVER_URL
      value: "https://git.telex.global"
  ```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç**

---

### 2. RBAC ‚úÖ

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** `rbac: { create: true }` - —Å–æ–∑–¥–∞–Ω–∏–µ RBAC –ø—Ä–∞–≤–∏–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è pods

**–ù–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- **ServiceAccount** (`ops/infra/k8s/gitlab-runner/rbac.yaml`):
  ```yaml
  apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: gitlab-runner
    namespace: gitlab-runner
  ```

- **Role** (`ops/infra/k8s/gitlab-runner/rbac.yaml`):
  ```yaml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    name: gitlab-runner
    namespace: gitlab-runner
  rules:
    - apiGroups: [""]
      resources: ["pods", "pods/exec", "pods/attach", "pods/log"]
      verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    - apiGroups: [""]
      resources: ["configmaps", "secrets"]
      verbs: ["get", "list", "watch", "create", "update", "patch"]
    - apiGroups: [""]
      resources: ["persistentvolumeclaims"]
      verbs: ["get", "list", "watch", "create", "update", "patch"]
  ```

- **RoleBinding** (`ops/infra/k8s/gitlab-runner/rbac.yaml`):
  ```yaml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: gitlab-runner
    namespace: gitlab-runner
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: Role
    name: gitlab-runner
  subjects:
    - kind: ServiceAccount
      name: gitlab-runner
      namespace: gitlab-runner
  ```

- **Deployment** (`ops/infra/k8s/gitlab-runner/deployment.yaml`):
  ```yaml
  spec:
    serviceAccountName: gitlab-runner
  ```

**–ü—Ä–∞–≤–∞ –≤ Role:**
- ‚úÖ `pods`, `pods/exec`, `pods/attach`, `pods/log`: `get`, `list`, `watch`, `create`, `update`, `patch`, `delete`
- ‚úÖ `configmaps`, `secrets`: `get`, `list`, `watch`, `create`, `update`, `patch`
- ‚úÖ `persistentvolumeclaims`: `get`, `list`, `watch`, `create`, `update`, `patch`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** (–∏ –¥–∞–∂–µ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, —á–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)

---

### 3. runnerToken ‚ö†Ô∏è

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** Authentication token (–ø–æ–ª—É—á–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ runner –≤ GitLab UI)

**–ù–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- **ConfigMap** (`ops/infra/k8s/gitlab-runner/configmap.yaml`):
  ```toml
  token = "__REPLACE_WITH_GLRT_TOKEN__"
  ```

**–ü—Ä–æ–±–ª–µ–º–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞):**
- ‚ùå –†–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `glpat-...` (Personal Access Token) –≤–º–µ—Å—Ç–æ `glrt-...` (Authentication Token)
- ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, —Ç–æ–∫–µ–Ω –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ placeholder
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ ConfigMap

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞** (–∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω)

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï: HELM vs RAW MANIFESTS

### Helm Chart (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ RBAC
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- ‚úÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Helm releases
- ‚úÖ –õ–µ–≥–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

**–ö–æ–º–∞–Ω–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**
```bash
helm repo add gitlab https://charts.gitlab.io
helm install gitlab-runner -f values.yaml gitlab/gitlab-runner
```

### Raw Manifests (–Ω–∞—à –ø–æ–¥—Ö–æ–¥)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Helm
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ –õ–µ–≥–∫–æ –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

**–ù–∞—à–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
ops/infra/k8s/gitlab-runner/
  ‚îú‚îÄ‚îÄ namespace.yaml      ‚úÖ Namespace –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
  ‚îú‚îÄ‚îÄ rbac.yaml          ‚úÖ ServiceAccount, Role, RoleBinding
  ‚îú‚îÄ‚îÄ configmap.yaml     ‚úÖ config.toml —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π runner
  ‚îú‚îÄ‚îÄ deployment.yaml     ‚úÖ Deployment —Å 2 replicas
  ‚îî‚îÄ‚îÄ service.yaml       ‚úÖ Service –¥–ª—è –º–µ—Ç—Ä–∏–∫
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–û–±–∞ –ø–æ–¥—Ö–æ–¥–∞ –≤–∞–ª–∏–¥–Ω—ã**, raw manifests –¥–∞—é—Ç –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è

---

## ‚úÖ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

–ù–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è, –Ω–µ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

### 1. State file –≤ writable location ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** ConfigMap –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ read-only, runner –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `system_id`

**–†–µ—à–µ–Ω–∏–µ:**
```yaml
volumes:
  - name: runner-home
    emptyDir: {}
volumeMounts:
  - name: runner-home
    mountPath: /home/gitlab-runner
```

**ConfigMap:**
```toml
state_file = "/home/gitlab-runner/.runner_system_id"
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**

---

### 2. Request concurrency ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** Long polling issues –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ jobs

**–†–µ—à–µ–Ω–∏–µ:**
```toml
request_concurrency = 3
environment = ["FF_USE_ADAPTIVE_REQUEST_CONCURRENCY=true"]
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ**

---

### 3. Health checks ‚úÖ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```yaml
livenessProbe:
  httpGet:
    path: /metrics
    port: 9252
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /metrics
    port: 9252
  initialDelaySeconds: 10
  periodSeconds: 5
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ**

---

### 4. Resource limits ‚úÖ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```yaml
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ**

---

### 5. Docker-in-Docker support ‚úÖ

**–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ:**
```toml
[runners.kubernetes]
  privileged = true
  [runners.kubernetes.volumes]
    [[runners.kubernetes.volumes.host_path]]
      name = "docker-sock"
      mount_path = "/var/run/docker.sock"
      host_path = "/var/run/docker.sock"
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ**

---

## üìã –í–´–í–û–î–´

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

1. ‚úÖ **`gitlabUrl`** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. ‚úÖ **RBAC** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–∏ –¥–∞–∂–µ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ, —á–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
3. ‚ö†Ô∏è **`runnerToken`** —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å)

### üìä –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:** ‚úÖ **95%** (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –±—É–¥–µ—Ç 100%)

**–ü—Ä–∏—á–∏–Ω—ã –Ω–µ 100%:**
- ‚ö†Ô∏è –¢–æ–∫–µ–Ω —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å)

---

## üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω (–∫—Ä–∏—Ç–∏—á–Ω–æ)

```bash
export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
make gitlab-runner-fix-403
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
sed "s/__REPLACE_WITH_GLRT_TOKEN__/${RUNNER_TOKEN}/g" \
    ops/infra/k8s/gitlab-runner/configmap.yaml | \
    kubectl apply -f -

kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
```

### 2. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ Helm (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –£–ø—Ä–æ—Å—Ç–∏—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ü–æ—Ç–µ—Ä—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Helm

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ (raw manifests) –≤–∞–ª–∏–¥–µ–Ω –∏ –¥–∞–µ—Ç –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å.

### 3. –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ –≤–∞–ª–∏–¥–µ–Ω

**–í—ã–≤–æ–¥:** –ù–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –¥–∞–∂–µ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è. –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.

---

## üìö –°–°–´–õ–ö–ò

- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è GitLab Runner –¥–ª—è Kubernetes](https://docs.gitlab.com/runner/install/kubernetes/)
- [Configure runner API permissions](https://docs.gitlab.com/runner/install/kubernetes/#configure-runner-api-permissions)
- [GitLab Runner Helm Chart](https://gitlab.com/gitlab-org/charts/gitlab-runner)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞)


```

`ops/gitlab-runner-fix-summary.md`:

```md
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GitLab Runner: –¢–æ–∫–µ–Ω –≤ ConfigMap

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** GitLab Runner –Ω–µ –ø–æ–ª—É—á–∞–ª —Ç–æ–∫–µ–Ω –∏–∑ ConfigMap  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω deployment –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è config.toml

---

## üîç –ü–†–û–ë–õ–ï–ú–ê

GitLab Runner –ø–æ–ª—É—á–∞–ª 403 Forbidden, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ pod –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–∏–ª —Ä–∞–Ω–Ω–µ—Ä –≤ –ø–æ–¥–µ, –∏ –æ–Ω –ø–æ—è–≤–∏–ª—Å—è –≤ GitLab, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–æ, —á—Ç–æ —Ç–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ ConfigMap

–¢–æ–∫–µ–Ω `GR1348941HYErDk_6wh8UsSenSgsU` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `ops/infra/k8s/gitlab-runner/configmap.yaml`:

```yaml
[[runners]]
  name = "ois-cfa-runner"
  url = "https://git.telex.global"
  token = "GR1348941HYErDk_6wh8UsSenSgsU"
  executor = "kubernetes"
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Deployment

Deployment –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ConfigMap:

```yaml
volumes:
  - name: config
    configMap:
      name: gitlab-runner-config
      items:
        - key: config.toml
          path: config.toml
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ–∞–π–ª `config.toml` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `/etc/gitlab-runner/config.toml`.

---

## üîß –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø

```bash
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å ConfigMap —Å —Ç–æ–∫–µ–Ω–æ–º
kubectl apply -f ops/infra/k8s/gitlab-runner/configmap.yaml

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π deployment
kubectl apply -f ops/infra/k8s/gitlab-runner/deployment.yaml

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
kubectl rollout restart deployment/gitlab-runner -n gitlab-runner

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
kubectl get pods -n gitlab-runner
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ pods –∑–∞–ø—É—â–µ–Ω—ã:**
   ```bash
   kubectl get pods -n gitlab-runner
   # –û–∂–∏–¥–∞–µ—Ç—Å—è: 2/2 Running
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Checking for jobs..." –±–µ–∑ –æ—à–∏–±–æ–∫ 403
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI:**
   - Settings ‚Üí CI/CD ‚Üí Runners
   - Runner –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Online" –∏ "Active"

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª config.toml –≤ pod:**
   ```bash
   POD_NAME=$(kubectl get pods -n gitlab-runner -l app=gitlab-runner -o jsonpath='{.items[0].metadata.name}')
   kubectl exec -n gitlab-runner $POD_NAME -- cat /etc/gitlab-runner/config.toml | grep token
   # –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å: token = "GR1348941HYErDk_6wh8UsSenSgsU"
   ```

---

## üìù –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï

### `ops/infra/k8s/gitlab-runner/configmap.yaml`
- ‚úÖ –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω: `token = "GR1348941HYErDk_6wh8UsSenSgsU"`

### `ops/infra/k8s/gitlab-runner/deployment.yaml`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `items` –≤ volume –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è `config.toml`

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- ‚úÖ ConfigMap —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
- ‚úÖ Deployment –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç config.toml
- ‚úÖ GitLab Runner –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
- ‚úÖ Jobs –¥–æ–ª–∂–Ω—ã –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ 403

---

## üîÑ –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–û–ö–ï–ù–ê –í –ë–£–î–£–©–ï–ú

–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ—á–µ—Ç –∏–ª–∏ –±—É–¥–µ—Ç –æ—Ç–æ–∑–≤–∞–Ω:

1. **–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏–∑ GitLab UI:**
   - Settings ‚Üí CI/CD ‚Üí Runners
   - Reset registration token

2. **–û–±–Ω–æ–≤–∏—Ç—å ConfigMap:**
   ```bash
   # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ops/infra/k8s/gitlab-runner/configmap.yaml
   # –ó–∞–º–µ–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –Ω–∞ –Ω–æ–≤—ã–π
   
   # –ü—Ä–∏–º–µ–Ω–∏—Ç—å
   kubectl apply -f ops/infra/k8s/gitlab-runner/configmap.yaml
   
   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods
   kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
   ```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Makefile:**
```bash
export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω"
make gitlab-runner-update-token
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é


```

`ops/gitlab-runner-force-reregister.md`:

```md
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è GitLab Runner

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** Runner –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden, –¥–∞–∂–µ —Å –Ω–æ–≤—ã–º registration token  
**–ü—Ä–∏—á–∏–Ω–∞:** Runner —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π authentication token

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –°–∏–º–ø—Ç–æ–º—ã:
- ‚úÖ Registration token –æ–±–Ω–æ–≤–ª–µ–Ω –≤ ConfigMap
- ‚úÖ ConfigMap –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ pod
- ‚ùå Runner –≤—Å–µ –µ—â–µ –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden
- ‚ùå Runner ID: `HYErDk_6w` (—Å—Ç–∞—Ä—ã–π runner)

### –ü—Ä–∏—á–∏–Ω–∞:
Runner —É–∂–µ –±—ã–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π authentication token**, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. Runner **–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç** registration token –∏–∑ ConfigMap, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.

---

## üîß –†–ï–®–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –£–¥–∞–ª–∏—Ç—å runner –∏–∑ GitLab UI (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

1. **–û—Ç–∫—Ä—ã—Ç—å GitLab UI:**
   - https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
   - –†–∞–∑–¥–µ–ª: Runners

2. **–ù–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å runner:**
   - –ù–∞–π—Ç–∏ runner —Å ID `HYErDk_6w` (–∏–ª–∏ –ø–æ—Ö–æ–∂–∏–º)
   - –ù–∞–∂–∞—Ç—å "Remove runner" –∏–ª–∏ "Delete"

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods:**
   ```bash
   kubectl delete pods -n gitlab-runner -l app=gitlab-runner
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é:**
   ```bash
   kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Runner registered successfully" –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ
   ```

5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI:**
   - –ù–æ–≤—ã–π runner –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è
   - –°—Ç–∞—Ç—É—Å: "Online" –∏ "Active"

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ pod

–ï—Å–ª–∏ runner —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, `.runner_system_id`):

1. **–ù–∞–π—Ç–∏ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
   ```bash
   kubectl exec -n gitlab-runner <pod-name> -- ls -la /etc/gitlab-runner/
   ```

2. **–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:**
   ```bash
   kubectl exec -n gitlab-runner <pod-name> -- rm -f /etc/gitlab-runner/.runner_system_id
   kubectl exec -n gitlab-runner <pod-name> -- rm -f /etc/gitlab-runner/.runner_*
   ```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pod:**
   ```bash
   kubectl delete pod <pod-name> -n gitlab-runner
   ```

**–ü—Ä–æ–±–ª–µ–º–∞:** ConfigMap –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ read-only, –ø–æ—ç—Ç–æ–º—É —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏.

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PersistentVolume –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é runner'–∞ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏:

1. **–°–æ–∑–¥–∞—Ç—å PersistentVolumeClaim:**
   ```yaml
   apiVersion: v1
   kind: PersistentVolumeClaim
   metadata:
     name: gitlab-runner-config
     namespace: gitlab-runner
   spec:
     accessModes:
       - ReadWriteOnce
     resources:
       requests:
         storage: 1Gi
   ```

2. **–û–±–Ω–æ–≤–∏—Ç—å deployment –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è PVC:**
   ```yaml
   volumes:
     - name: config
       configMap:
         name: gitlab-runner-config
     - name: runner-state
       persistentVolumeClaim:
         claimName: gitlab-runner-config
   volumeMounts:
     - name: config
       mountPath: /etc/gitlab-runner
     - name: runner-state
       mountPath: /etc/gitlab-runner/.runner_state
   ```

–ù–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é. –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç 1.

---

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å initContainer –¥–ª—è –æ—á–∏—Å—Ç–∫–∏

–î–æ–±–∞–≤–∏—Ç—å initContainer, –∫–æ—Ç–æ—Ä—ã–π –æ—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```yaml
initContainers:
  - name: clear-runner-state
    image: busybox
    command:
      - sh
      - -c
      - |
        # –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å
        rm -f /runner-state/.runner_system_id || true
        rm -f /runner-state/.runner_* || true
    volumeMounts:
      - name: runner-state
        mountPath: /runner-state
```

–ù–æ —ç—Ç–æ —Ç–æ–∂–µ —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.

---

## ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï –†–ï–®–ï–ù–ò–ï

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç 1: –£–¥–∞–ª–∏—Ç—å runner –∏–∑ GitLab UI**

–≠—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±:

1. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π runner –∏–∑ GitLab UI
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods
3. Runner –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º registration token

---

## üîç –ü–†–û–í–ï–†–ö–ê –£–°–ü–ï–•–ê

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Checking for jobs..." –ë–ï–ó –æ—à–∏–±–æ–∫ 403
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI:**
   - Settings ‚Üí CI/CD ‚Üí Runners
   - –ù–æ–≤—ã–π runner –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Online" –∏ "Active"
   - Runner ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥—Ä—É–≥–∏–º (–Ω–µ `HYErDk_6w`)

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π job:**
   - –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π job –≤ `.gitlab-ci.yml`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ job –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ runner'–µ

---

## üìù –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ë–´–°–¢–†–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

```bash
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# 1. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ pods (–æ–Ω–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–¥—É—Ç—Å—è)
kubectl delete pods -n gitlab-runner -l app=gitlab-runner

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
sleep 30
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50

# 3. –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ 403, –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å runner –∏–∑ GitLab UI –≤—Ä—É—á–Ω—É—é
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û

- Registration token –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è **–ø–µ—Ä–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**
- –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ GitLab Runner –ø–æ–ª—É—á–∞–µ—Ç **authentication token**
- Authentication token —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ï—Å–ª–∏ authentication token –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ‚Üí 403 Forbidden
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ registration token –≤ ConfigMap **–Ω–µ –ø–æ–º–æ–∂–µ—Ç**, –µ—Å–ª–∏ runner —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –£–¥–∞–ª–∏—Ç—å runner —Å ID `HYErDk_6w` –∏–∑ GitLab UI –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods.


```

`ops/gitlab-runner-image-pull-fix.md`:

```md
# GitLab Runner: Image Pull Error Fix

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ –ø—Ä–∏ pull –æ–±—Ä–∞–∑–∞ `bitnami/kubectl:1.30`

---

## üîç –ü–†–û–ë–õ–ï–ú–ê

### –û—à–∏–±–∫–∞:
```
ERROR: Job failed: prepare environment: waiting for pod running: 
pulling image "bitnami/kubectl:1.30" for container build: 
image pull failed: Back-off pulling image "bitnami/kubectl:1.30": 
ErrImagePull: rpc error: code = NotFound desc = 
failed to pull and unpack image "docker.io/bitnami/kubectl:1.30": 
failed to resolve reference "docker.io/bitnami/kubectl:1.30": 
docker.io/bitnami/kubectl:1.30: not found
```

### –ü—Ä–∏—á–∏–Ω–∞:
- –û–±—Ä–∞–∑ `bitnami/kubectl:1.30` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Docker Hub
- –í–µ—Ä—Å–∏—è 1.30 –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ —Ç–µ–≥ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ó–∞–º–µ–Ω–∞ –Ω–∞ `bitnami/kubectl:latest`

**–§–∞–π–ª:** `.gitlab-ci.yml`

**–ë—ã–ª–æ:**
```yaml
image: bitnami/kubectl:1.30
```

**–°—Ç–∞–ª–æ:**
```yaml
image: bitnami/kubectl:latest
```

---

## üîß –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏:
```bash
curl -s https://hub.docker.com/v2/repositories/bitnami/kubectl/tags/ | jq -r '.results[].name' | head -10
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–µ–≥, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```yaml
image: bitnami/kubectl:1.29
# –∏–ª–∏
image: bitnami/kubectl:1.28
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ kubectl

```yaml
image: bitnami/kubectl:latest
# –∏–ª–∏
image: alpine/k8s:1.30.0
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑ —Å kubectl —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º

```yaml
image: alpine:latest
before_script:
  - apk add --no-cache kubectl
```

---

## üìã –ü–†–û–í–ï–†–ö–ê

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å YAML

```bash
python3 -c "import yaml; yaml.safe_load(open('.gitlab-ci.yml'))"
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–º–µ–Ω—É

```bash
grep "bitnami/kubectl" .gitlab-ci.yml
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `bitnami/kubectl:latest` (–∏–ª–∏ –¥—Ä—É–≥–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–µ–≥)

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å job

–ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã –Ω–æ–≤—ã–π job –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ pull –æ–±—Ä–∞–∑.

---

## üöÄ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï

–ò–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ `.gitlab-ci.yml`:
- –í—Å–µ `bitnami/kubectl:1.30` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `bitnami/kubectl:latest`

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

### –ü–æ—á–µ–º—É `latest` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π:

- `latest` –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∏ –ª–æ–º–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –î–ª—è production –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è production:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, `1.29`)
3. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤ `.gitlab-ci.yml`

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ


```

`ops/gitlab-runner-install-troubleshooting.md`:

```md
# GitLab Runner Install: Troubleshooting

**–î–∞—Ç–∞:** 2025-01-27  
**–ö–æ–º–∞–Ω–¥–∞:** `make gitlab-runner-install`

---

## üîç –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ placeholder'–æ–≤

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ

–í `Makefile` (—Å—Ç—Ä–æ–∫–∞ 272) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è:
```bash
sed "s/__REPLACE_WITH_RUNNER_TOKEN__/$$RUNNER_TOKEN/g"
```

–ù–æ –≤ `configmap.yaml` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
```toml
token = "__REPLACE_WITH_GLRT_TOKEN__"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ–∫–µ–Ω –Ω–µ –∑–∞–º–µ–Ω—è–ª—Å—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ!

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

Makefile —Ç–µ–ø–µ—Ä—å –∑–∞–º–µ–Ω—è–µ—Ç **–æ–±–∞** placeholder'–∞:
```bash
sed -e "s/__REPLACE_WITH_GLRT_TOKEN__/$$RUNNER_TOKEN/g" \
    -e "s/__REPLACE_WITH_RUNNER_TOKEN__/$$RUNNER_TOKEN/g" \
    ops/infra/k8s/gitlab-runner/configmap.yaml
```

---

## üìã –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ö–û–ú–ê–ù–î–ê

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ `make gitlab-runner-install`

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ RUNNER_TOKEN**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `RUNNER_TOKEN`
   - –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –æ—à–∏–±–∫–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ kubectl**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ `kubectl` –≤ PATH
   - –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –æ—à–∏–±–∫–∞

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ KUBECONFIG**
   - –ï—Å–ª–∏ `KUBECONFIG` –Ω–µ –∑–∞–¥–∞–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ops/infra/timeweb/kubeconfig.yaml`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
   - –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω ‚Üí –æ—à–∏–±–∫–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π

4. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤** (–≤ –ø–æ—Ä—è–¥–∫–µ):
   - `namespace.yaml` ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ namespace `gitlab-runner`
   - `rbac.yaml` ‚Üí ServiceAccount, Role, RoleBinding
   - `configmap.yaml` ‚Üí **—Å –∑–∞–º–µ–Ω–æ–π —Ç–æ–∫–µ–Ω–∞** —á–µ—Ä–µ–∑ `sed`
   - `deployment.yaml` ‚Üí Deployment —Å 2 replicas
   - `service.yaml` ‚Üí Service –¥–ª—è –º–µ—Ç—Ä–∏–∫

5. **–û–∂–∏–¥–∞–Ω–∏–µ pods**
   - –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ pods (timeout 120s)

---

## üîß –ß–¢–û –ü–ï–†–ï–î–ê–ï–¢–°–Ø

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

1. **RUNNER_TOKEN** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
   - –§–æ—Ä–º–∞—Ç: `glrt-...` (Authentication Token) –∏–ª–∏ `GR...` (Registration Token)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–º–µ–Ω—ã –≤ `configmap.yaml`
   - –ü—Ä–∏–º–µ—Ä: `export RUNNER_TOKEN="glrt-abc123..."`

2. **KUBECONFIG** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –ü—É—Ç—å –∫ kubeconfig —Ñ–∞–π–ª—É
   - –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ops/infra/timeweb/kubeconfig.yaml`
   - –ü—Ä–∏–º–µ—Ä: `export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"`

### –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤

```bash
1. kubectl apply -f namespace.yaml
2. kubectl apply -f rbac.yaml
3. sed ... configmap.yaml | kubectl apply -f -
4. kubectl apply -f deployment.yaml
5. kubectl apply -f service.yaml
```

---

## üöÄ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
make gitlab-runner-install
```

### –° —è–≤–Ω—ã–º KUBECONFIG

```bash
export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"
make gitlab-runner-install
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
make gitlab-runner-get-token

# –ó–∞—Ç–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
export RUNNER_TOKEN="–≤–∞—à-—Ç–æ–∫–µ–Ω"
make gitlab-runner-install
```

---

## ‚ùå –ß–ê–°–¢–´–ï –û–®–ò–ë–ö–ò

### 1. "Error: RUNNER_TOKEN not set"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `RUNNER_TOKEN` –Ω–µ –∑–∞–¥–∞–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
```bash
export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
make gitlab-runner-install
```

---

### 2. "Error: kubectl cannot connect to cluster"

**–ü—Ä–∏—á–∏–Ω–∞:** KUBECONFIG –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å kubeconfig
make setup-kubeconfig

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"
kubectl get nodes  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```

---

### 3. –¢–æ–∫–µ–Ω –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –≤ ConfigMap

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ placeholder'–æ–≤ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é Makefile

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ ConfigMap
kubectl get configmap -n gitlab-runner gitlab-runner-config -o jsonpath='{.data.config\.toml}' | grep token
```

---

### 4. Pods –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω
kubectl get configmap -n gitlab-runner gitlab-runner-config -o yaml | grep token
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –£–°–¢–ê–ù–û–í–ö–ò

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pods

```bash
kubectl get pods -n gitlab-runner
```

–û–∂–∏–¥–∞–µ—Ç—Å—è:
```
NAME                             READY   STATUS    RESTARTS   AGE
gitlab-runner-xxx-xxx            1/1     Running   0          1m
gitlab-runner-yyy-yyy            1/1     Running   0          1m
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ConfigMap

```bash
kubectl get configmap -n gitlab-runner gitlab-runner-config -o yaml | grep -A 5 token
```

–û–∂–∏–¥–∞–µ—Ç—Å—è: —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–º–µ–Ω–µ–Ω (–Ω–µ placeholder)

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=20
```

–û–∂–∏–¥–∞–µ—Ç—Å—è: —Å—Ç—Ä–æ–∫–∏ "Checking for jobs..." –±–µ–∑ –æ—à–∏–±–æ–∫ 403

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
2. –†–∞–∑–¥–µ–ª: **Runners**
3. –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è runner **ois-cfa-runner** —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º **Online**

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

- [–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Lens](docs/ops/gitlab-runner-lens-install.md)
- [–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è GitLab Runner](docs/ops/gitlab-runner.md)
- [–û—Ç—á–µ—Ç –æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏](docs/ops/gitlab-runner-compliance-report.md)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞, –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ


```

`ops/gitlab-runner-job-hanging-fix.md`:

```md
# GitLab Runner: Job Hanging Fix

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** Jobs –≤–∏—Å—è—Ç, runner pods –≤ CrashLoopBackOff

---

## üîç –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´

### 1. Runner pods –≤ CrashLoopBackOff

**–ü—Ä–∏—á–∏–Ω–∞:** Health checks (liveness/readiness probes) –Ω–µ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ `/metrics:9252`

**–û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö:**
```
listen_address not defined, metrics & debug endpoints disabled
Liveness probe failed: Get "http://10.244.98.202:9252/metrics": dial tcp 10.244.98.202:9252: connect: connection refused
```

**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–∫–ª—é—á–∏—Ç—å health checks (runner –Ω–µ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 9252 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

---

### 2. State file –ø—É—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –í configmap —É–∫–∞–∑–∞–Ω –ø—É—Ç—å `/etc/gitlab-runner/.runner_system_id` (ConfigMap read-only)

**–û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö:**
```
WARNING: Couldn't save new system ID on state file.
state_file=/etc/gitlab-runner/.runner_system_id
```

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ configmap (`state_file = "/home/gitlab-runner/.runner_system_id"`), –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

---

### 3. Job –≤–∏—Å–∏—Ç

**Job pod:** `runner-zqlriqywz-project-6-concurrent-0-t7eqxvgd`

**–°—Ç–∞—Ç—É—Å:** Running (2/2 Ready)

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- Job –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ–ª–≥–æ
- Job –∑–∞–≤–∏—Å –≤ –æ–∂–∏–¥–∞–Ω–∏–∏
- –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é/–¥–æ—Å—Ç—É–ø–æ–º

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´

### 1. –û—Ç–∫–ª—é—á–µ–Ω—ã health checks

**–§–∞–π–ª:** `ops/infra/k8s/gitlab-runner/deployment.yaml`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
```yaml
# Health checks disabled - runner doesn't listen on port 9252 by default
# To enable metrics, add listen_address = ":9252" to config.toml
# livenessProbe:
#   httpGet:
#     path: /metrics
#     port: 9252
```

**–ü—Ä–∏—á–∏–Ω–∞:** Runner –Ω–µ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 9252 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω—É–∂–Ω–æ —è–≤–Ω–æ –≤–∫–ª—é—á–∏—Ç—å `listen_address` –≤ config.toml

---

### 2. State file –ø—É—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** ConfigMap —Å–æ–¥–µ—Ä–∂–∏—Ç `state_file = "/home/gitlab-runner/.runner_system_id"`

**Volume:** `/home/gitlab-runner` –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `emptyDir` (writable)

---

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –í–∫–ª—é—á–∏—Ç—å metrics (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –Ω—É–∂–Ω—ã health checks –∏ –º–µ—Ç—Ä–∏–∫–∏, –¥–æ–±–∞–≤–∏—Ç—å –≤ `configmap.yaml`:

```toml
listen_address = ":9252"
```

–ò —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å health checks –≤ `deployment.yaml`.

---

## üìã –ü–†–û–í–ï–†–ö–ê

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å runner pods

```bash
kubectl get pods -n gitlab-runner
```

–û–∂–∏–¥–∞–µ—Ç—Å—è: –≤—Å–µ pods –≤ —Å—Ç–∞—Ç—É—Å–µ `Running` (1/1 Ready)

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=20
```

–û–∂–∏–¥–∞–µ—Ç—Å—è: –Ω–µ—Ç –æ—à–∏–±–æ–∫ –æ health checks, –Ω–µ—Ç –æ—à–∏–±–æ–∫ –æ state file

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å job pod

```bash
kubectl get pod -n gitlab-runner runner-* -o wide
kubectl logs -n gitlab-runner runner-* -c build --tail=50
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://git.telex.global/npk/ois-cfa/-/pipelines
2. –ù–∞–π–¥–∏—Ç–µ –∑–∞–≤–∏—Å—à–∏–π pipeline
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å job'–æ–≤
4. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ job'–∞

---

## üöÄ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π deployment
kubectl apply -f ops/infra/k8s/gitlab-runner/deployment.yaml

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods
kubectl rollout restart deployment/gitlab-runner -n gitlab-runner

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
kubectl get pods -n gitlab-runner
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=20
```

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

- [GitLab Runner Metrics](https://docs.gitlab.com/runner/monitoring/)
- [Health Checks](https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã


```

`ops/gitlab-runner-lens-install.md`:

```md
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ GitLab Runner —á–µ—Ä–µ–∑ Lens

**–î–∞—Ç–∞:** 2025-01-27  
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:** Lens IDE  
**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å GitLab Runner pod –≤ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–µ —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

---

## üìã –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

1. **Lens —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–ª–∞—Å—Ç–µ—Ä—É**
   - –û—Ç–∫—Ä–æ–π—Ç–µ Lens
   - –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä (Timeweb Kubernetes)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: `kubectl get nodes`

2. **–ü–æ–ª—É—á–µ–Ω Runner Token**
   - –û—Ç–∫—Ä–æ–π—Ç–µ: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
   - –†–∞–∑–¥–µ–ª: Runners
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Authentication Token** (glrt-...) –∏–ª–∏ **Registration Token** (GR...)

3. **–§–∞–π–ª—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –≥–æ—Ç–æ–≤—ã**
   - `ops/infra/k8s/gitlab-runner/namespace.yaml`
   - `ops/infra/k8s/gitlab-runner/rbac.yaml`
   - `ops/infra/k8s/gitlab-runner/configmap.yaml`
   - `ops/infra/k8s/gitlab-runner/deployment.yaml`
   - `ops/infra/k8s/gitlab-runner/service.yaml`

---

## üöÄ –ü–û–®–ê–ì–û–í–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å Namespace

1. –í Lens –æ—Ç–∫—Ä–æ–π—Ç–µ **Workloads** ‚Üí **Namespaces**
2. –ù–∞–∂–º–∏—Ç–µ **+** (Create) ‚Üí **Create from YAML**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `ops/infra/k8s/gitlab-runner/namespace.yaml`:

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: gitlab-runner
  labels:
    name: gitlab-runner
    app.kubernetes.io/name: gitlab-runner
    app.kubernetes.io/component: ci-cd
```

4. –ù–∞–∂–º–∏—Ç–µ **Create**
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: Namespace `gitlab-runner` –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ

---

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å RBAC (ServiceAccount, Role, RoleBinding)

1. –í Lens –æ—Ç–∫—Ä–æ–π—Ç–µ **Workloads** ‚Üí **Namespaces** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ `gitlab-runner`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Config** ‚Üí **Service Accounts**
3. –ù–∞–∂–º–∏—Ç–µ **+** (Create) ‚Üí **Create from YAML**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `ops/infra/k8s/gitlab-runner/rbac.yaml`:

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitlab-runner
  namespace: gitlab-runner
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gitlab-runner
  namespace: gitlab-runner
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/exec", "pods/attach", "pods/log"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gitlab-runner
  namespace: gitlab-runner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: gitlab-runner
subjects:
  - kind: ServiceAccount
    name: gitlab-runner
    namespace: gitlab-runner
```

5. –ù–∞–∂–º–∏—Ç–µ **Create**
6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - **Config** ‚Üí **Service Accounts**: –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è `gitlab-runner`
   - **Config** ‚Üí **Roles**: –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è `gitlab-runner`
   - **Config** ‚Üí **Role Bindings**: –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è `gitlab-runner`

---

### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å ConfigMap

1. –í Lens –æ—Ç–∫—Ä–æ–π—Ç–µ **Workloads** ‚Üí **Namespaces** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ `gitlab-runner`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Config** ‚Üí **Config Maps**
3. –ù–∞–∂–º–∏—Ç–µ **+** (Create) ‚Üí **Create from YAML**
4. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `ops/infra/k8s/gitlab-runner/configmap.yaml`
5. **–í–ê–ñ–ù–û:** –ó–∞–º–µ–Ω–∏—Ç–µ `__REPLACE_WITH_GLRT_TOKEN__` –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-runner-config
  namespace: gitlab-runner
data:
  config.toml: |
    concurrent = 10
    check_interval = 3
    log_level = "info"
    state_file = "/home/gitlab-runner/.runner_system_id"

    [[runners]]
      name = "ois-cfa-runner"
      url = "https://git.telex.global"
      token = "glrt-–í–ê–®-–¢–û–ö–ï–ù-–ó–î–ï–°–¨"  # ‚Üê –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω
      executor = "kubernetes"
      request_concurrency = 3
      environment = ["FF_USE_ADAPTIVE_REQUEST_CONCURRENCY=true"]
      [runners.kubernetes]
        namespace = "gitlab-runner"
        image = "alpine:latest"
        privileged = true
        cpu_limit = "2"
        memory_limit = "4Gi"
        cpu_request = "500m"
        memory_request = "1Gi"
        # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

6. –ù–∞–∂–º–∏—Ç–µ **Create**
7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: **Config** ‚Üí **Config Maps** ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è `gitlab-runner-config`

---

### –®–∞–≥ 4: –°–æ–∑–¥–∞—Ç—å Deployment

1. –í Lens –æ—Ç–∫—Ä–æ–π—Ç–µ **Workloads** ‚Üí **Namespaces** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ `gitlab-runner`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Workloads** ‚Üí **Deployments**
3. –ù–∞–∂–º–∏—Ç–µ **+** (Create) ‚Üí **Create from YAML**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `ops/infra/k8s/gitlab-runner/deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab-runner
  namespace: gitlab-runner
  labels:
    app: gitlab-runner
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gitlab-runner
  template:
    metadata:
      labels:
        app: gitlab-runner
    spec:
      serviceAccountName: gitlab-runner
      containers:
        - name: gitlab-runner
          image: gitlab/gitlab-runner:latest
          imagePullPolicy: IfNotPresent
          args:
            - run
            - --config=/etc/gitlab-runner/config.toml
          env:
            - name: CI_SERVER_URL
              value: "https://git.telex.global"
            - name: RUNNER_EXECUTOR
              value: "kubernetes"
            - name: RUNNER_REQUESTED_CONCURRENT_BUILDS
              value: "10"
            - name: RUNNER_OUTPUT_LIMIT
              value: "4096"
          volumeMounts:
            - name: config
              mountPath: /etc/gitlab-runner
            - name: runner-home
              mountPath: /home/gitlab-runner
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /metrics
              port: 9252
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /metrics
              port: 9252
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: gitlab-runner-config
            items:
              - key: config.toml
                path: config.toml
        - name: runner-home
          emptyDir: {}
```

5. –ù–∞–∂–º–∏—Ç–µ **Create**
6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: **Workloads** ‚Üí **Deployments** ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è `gitlab-runner`
7. –î–æ–∂–¥–∏—Ç–µ—Å—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: —Å—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å **Running** (2/2 pods)

---

### –®–∞–≥ 5: –°–æ–∑–¥–∞—Ç—å Service (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –º–µ—Ç—Ä–∏–∫)

1. –í Lens –æ—Ç–∫—Ä–æ–π—Ç–µ **Workloads** ‚Üí **Namespaces** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ `gitlab-runner`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Network** ‚Üí **Services**
3. –ù–∞–∂–º–∏—Ç–µ **+** (Create) ‚Üí **Create from YAML**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `ops/infra/k8s/gitlab-runner/service.yaml`:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: gitlab-runner
  namespace: gitlab-runner
  labels:
    app: gitlab-runner
spec:
  type: ClusterIP
  ports:
    - name: metrics
      port: 9252
      targetPort: 9252
      protocol: TCP
  selector:
    app: gitlab-runner
```

5. –ù–∞–∂–º–∏—Ç–µ **Create**
6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: **Network** ‚Üí **Services** ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è `gitlab-runner`

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –£–°–¢–ê–ù–û–í–ö–ò

### –í Lens:

1. **Workloads** ‚Üí **Deployments** ‚Üí `gitlab-runner`
   - –°—Ç–∞—Ç—É—Å: **Running** (2/2 pods)
   - –í—Å–µ pods –≤ —Å—Ç–∞—Ç—É—Å–µ **Running**

2. **Workloads** ‚Üí **Pods** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ pod `gitlab-runner-*`
   - –°—Ç–∞—Ç—É—Å: **Running**
   - –õ–æ–≥–∏: –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ pod ‚Üí **Logs** ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∏ "Checking for jobs..."

3. **Config** ‚Üí **Config Maps** ‚Üí `gitlab-runner-config`
   - –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å `config.toml` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º

### –í GitLab UI:

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
2. –†–∞–∑–¥–µ–ª: **Runners**
3. –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è runner —Å –∏–º–µ–Ω–µ–º **ois-cfa-runner**
4. –°—Ç–∞—Ç—É—Å: **Online** (–∑–µ–ª–µ–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)

---

## üîß –£–°–¢–†–ê–ù–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú

### Pod –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   - –í Lens: –≤—ã–±–µ—Ä–∏—Ç–µ pod ‚Üí **Logs**
   - –ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏: `403 Forbidden`, `token invalid`

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ConfigMap:
   - –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (glrt-... –∏–ª–∏ GR...)
   - URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `https://git.telex.global`

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RBAC:
   - ServiceAccount –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `gitlab-runner`
   - Role –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ pods

### Runner –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ GitLab

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω:
   - –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Registration Token (GR...), runner –¥–æ–ª–∂–µ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Authentication Token (glrt-...), runner —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å:
   - Pod –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ `https://git.telex.global`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: `kubectl exec -n gitlab-runner <pod-name> -- wget -O- https://git.telex.global`

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   - –ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è GitLab Runner](https://docs.gitlab.com/runner/)
- [GitLab Runner –¥–ª—è Kubernetes](https://docs.gitlab.com/runner/install/kubernetes/)
- [Lens Documentation](https://k8slens.dev/)

---

## üéØ –ë–´–°–¢–†–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê (—á–µ—Ä–µ–∑ Makefile)

–ï—Å–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É:

```bash
export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
make gitlab-runner-install
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é


```

`ops/gitlab-runner-memory-issue.md`:

```md
# GitLab Runner: –ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–º –ø–∞–º—è—Ç–∏

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** Job –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

---

## üîç –ü–†–û–ë–õ–ï–ú–ê

### –û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö:

```
Unschedulable: "0/1 nodes are available: 1 Insufficient memory. 
no new claims to deallocate, preemption: 0/1 nodes are available: 
1 No preemption victims found for incoming pod."
```

### –ê–Ω–∞–ª–∏–∑:

1. **–í –∫–ª–∞—Å—Ç–µ—Ä–µ —Ç–æ–ª—å–∫–æ 1 –Ω–æ–¥–∞**
2. **–ù–∞ –Ω–æ–¥–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏** –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤–æ–≥–æ pod
3. **Kubernetes –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ pod –¥–ª—è –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è** (preemption)

---

## üìä –¢–ï–ö–£–©–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è job pod (–∏–∑ configmap.yaml):

```toml
[runners.kubernetes]
  memory_limit = "4Gi"      # –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ –Ω–∞ job
  memory_request = "1Gi"    # –ó–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–∞ job
  helper_memory_limit = "1Gi"
  helper_memory_request = "128Mi"
```

**–ò—Ç–æ–≥–æ –Ω–∞ –æ–¥–∏–Ω job:**
- Build container: 1Gi request, 4Gi limit
- Helper container: 128Mi request, 1Gi limit
- **–ú–∏–Ω–∏–º—É–º —Ç—Ä–µ–±—É–µ—Ç—Å—è:** ~1.2Gi —Å–≤–æ–±–æ–¥–Ω–æ–π –ø–∞–º—è—Ç–∏

---

## ‚úÖ –†–ï–®–ï–ù–ò–Ø

### –†–µ—à–µ–Ω–∏–µ 1: –£–º–µ–Ω—å—à–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è jobs (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–§–∞–π–ª:** `ops/infra/k8s/gitlab-runner/configmap.yaml`

```toml
[runners.kubernetes]
  memory_limit = "2Gi"      # –£–º–µ–Ω—å—à–µ–Ω–æ —Å 4Gi
  memory_request = "512Mi"  # –£–º–µ–Ω—å—à–µ–Ω–æ —Å 1Gi
  helper_memory_limit = "512Mi"
  helper_memory_request = "64Mi"
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å:**
```bash
kubectl apply -f ops/infra/k8s/gitlab-runner/configmap.yaml
kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
```

---

### –†–µ—à–µ–Ω–∏–µ 2: –û—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–∞–º—è—Ç—å (—É–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ pods)

```bash
# –£–¥–∞–ª–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ job pods
kubectl delete pods -n gitlab-runner --field-selector=status.phase==Succeeded

# –£–¥–∞–ª–∏—Ç—å failed job pods
kubectl delete pods -n gitlab-runner --field-selector=status.phase==Failed

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
kubectl top nodes
```

---

### –†–µ—à–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Timeweb Cloud:

```bash
# –ß–µ—Ä–µ–∑ twc CLI
twc k8s node-pool scale <cluster-name> <node-pool-name> --nodes 2

# –ò–ª–∏ —á–µ—Ä–µ–∑ Terraform
# –£–≤–µ–ª–∏—á–∏—Ç—å min_nodes –≤ ops/infra/timeweb/variables.tf
```

---

### –†–µ—à–µ–Ω–∏–µ 4: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

–ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω Cluster Autoscaler:

```yaml
# –î–æ–±–∞–≤–∏—Ç—å –≤ node pool
autoscaling:
  enabled: true
  min_nodes: 1
  max_nodes: 3
```

---

## üîß –ü–†–û–í–ï–†–ö–ê

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å –Ω–∞ –Ω–æ–¥–µ

```bash
kubectl describe nodes | grep -A 5 "Allocated resources"
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ pods

```bash
kubectl top pods -n gitlab-runner
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è jobs

```bash
kubectl get pods -n gitlab-runner -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].resources.requests.memory}{"\n"}{end}'
```

---

## üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–£–º–µ–Ω—å—à–∏—Ç—å memory_limit –¥–æ 2Gi** (–≤–º–µ—Å—Ç–æ 4Gi)
2. **–£–º–µ–Ω—å—à–∏—Ç—å memory_request –¥–æ 512Mi** (–≤–º–µ—Å—Ç–æ 1Gi)
3. **–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å concurrent builds** –¥–æ 2-3 (–≤–º–µ—Å—Ç–æ 10)

### –î–ª—è production:

1. **–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—ã** –≤ –∫–ª–∞—Å—Ç–µ—Ä (–º–∏–Ω–∏–º—É–º 2-3)
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Cluster Autoscaler**
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**

---

## üöÄ –ë–´–°–¢–†–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

```bash
# 1. –£–º–µ–Ω—å—à–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –≤ configmap
sed -i 's/memory_limit = "4Gi"/memory_limit = "2Gi"/' \
    ops/infra/k8s/gitlab-runner/configmap.yaml
sed -i 's/memory_request = "1Gi"/memory_request = "512Mi"/' \
    ops/infra/k8s/gitlab-runner/configmap.yaml

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
kubectl apply -f ops/infra/k8s/gitlab-runner/configmap.yaml

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å runner
kubectl rollout restart deployment/gitlab-runner -n gitlab-runner

# 4. –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ job pods
kubectl delete pods -n gitlab-runner --field-selector=status.phase==Succeeded
```

---

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —É–º–µ–Ω—å—à–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—ã


```

`ops/gitlab-runner-registration-explained.md`:

```md
# –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è GitLab Runner

**–î–∞—Ç–∞:** 2025-01-27  
**–í–æ–ø—Ä–æ—Å:** –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–∞–Ω–¥–∞ `gitlab-runner register` –ø—Ä–∏ –ø–æ–¥–Ω—è—Ç–∏–∏ –ø–æ–¥–∞?

---

## ‚ùå –ù–ï–¢, –∫–æ–º–∞–Ω–¥–∞ `register` –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ:

1. **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ `run`:**
   ```bash
   gitlab-runner run --config=/etc/gitlab-runner/config.toml
   ```

2. **GitLab Runner —á–∏—Ç–∞–µ—Ç config.toml –∏:**
   - –ï—Å–ª–∏ runner **—É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω** ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π **authentication token**
   - –ï—Å–ª–∏ runner **–ù–ï –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑—É—è **registration token** –∏–∑ config.toml

---

## üîç –î–í–ê –¢–ò–ü–ê –¢–û–ö–ï–ù–û–í

### 1. Registration Token (—Ç–æ–∫–µ–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- **–§–æ—Ä–º–∞—Ç:** `GR1348941HYErDk_6wh8UsSenSgsU`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –¢–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ runner'–∞
- **–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** –í config.toml –∫–∞–∫ `token = "GR..."`
- **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:** –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ GitLab Runner –∑–∞–º–µ–Ω—è–µ—Ç registration token –Ω–∞ authentication token

### 2. Authentication Token (—Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
- **–§–æ—Ä–º–∞—Ç:** –û–±—ã—á–Ω–æ –¥–ª–∏–Ω–Ω–µ–µ, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è GitLab
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –î–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- **–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** –í config.toml (–∑–∞–º–µ–Ω—è–µ—Ç registration token –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:** Runner –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitLab

---

## üîÑ –ü–†–û–¶–ï–°–° –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò

### –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (runner –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω):

1. Pod –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –∫–æ–º–∞–Ω–¥–æ–π `run`
2. GitLab Runner —á–∏—Ç–∞–µ—Ç config.toml
3. –í–∏–¥–∏—Ç registration token (`GR...`)
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è** –≤ GitLab
5. GitLab –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç authentication token
6. GitLab Runner **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç** authentication token –≤ config.toml (–≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –Ω–∞ –¥–∏—Å–∫–µ)
7. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç authentication token –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—É—Å–∫–∏ (runner —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω):

1. Pod –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –∫–æ–º–∞–Ω–¥–æ–π `run`
2. GitLab Runner —á–∏—Ç–∞–µ—Ç config.toml
3. –í–∏–¥–∏—Ç authentication token (–Ω–µ registration token)
4. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç** authentication token –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitLab
5. **–ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç** registration token, –µ—Å–ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ –≤ config.toml

---

## ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: Runner —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω

–ï—Å–ª–∏ runner —É–∂–µ –±—ã–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Ä—É—á–Ω—É—é –≤ –ø–æ–¥–µ), —Ç–æ:

- ‚úÖ Runner –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å—Ç–∞—Ä—ã–π authentication token** (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≥–¥–µ-—Ç–æ)
- ‚ùå Runner **–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç** registration token –∏–∑ ConfigMap
- ‚ùå –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π authentication token –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ‚Üí –ø–æ–ª—É—á–∞–µ–º 403 Forbidden

---

## üîß –†–ï–®–ï–ù–ò–ï: –ü–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Runner

### –í–∞—Ä–∏–∞–Ω—Ç 1: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ GitLab UI

1. –û—Ç–∫—Ä—ã—Ç—å: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
2. –†–∞–∑–¥–µ–ª: Runners
3. –ù–∞–π—Ç–∏ runner —Å –ø—Ä–æ–±–ª–µ–º–æ–π (ID: `HYErDk_6w`)
4. –£–¥–∞–ª–∏—Ç—å –µ–≥–æ
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods:
   ```bash
   kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
   ```
6. Runner –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º registration token –∏–∑ ConfigMap

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

–ï—Å–ª–∏ runner —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ PersistentVolume –∏–ª–∏ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ:

1. –ù–∞–π—Ç–∏, –≥–¥–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–æ–±—ã—á–Ω–æ –≤ `/etc/gitlab-runner/.runner_system_id` –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–º)
2. –£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods
4. Runner –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å initContainer –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å initContainer, –∫–æ—Ç–æ—Ä—ã–π —è–≤–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é:

```yaml
initContainers:
  - name: register-runner
    image: gitlab/gitlab-runner:latest
    command:
      - sh
      - -c
      - |
        gitlab-runner register \
          --non-interactive \
          --url https://git.telex.global/ \
          --registration-token ${RUNNER_TOKEN} \
          --executor kubernetes \
          --config /etc/gitlab-runner/config.toml
    volumeMounts:
      - name: config
        mountPath: /etc/gitlab-runner
```

–ù–æ —ç—Ç–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ GitLab Runner –¥–æ–ª–∂–µ–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è):

```yaml
# deployment.yaml
args:
  - run
  - --config=/etc/gitlab-runner/config.toml
```

```toml
# config.toml
[[runners]]
  name = "ois-cfa-runner"
  url = "https://git.telex.global"
  token = "GR1348941HYErDk_6wh8UsSenSgsU"  # Registration token
  executor = "kubernetes"
```

**–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!** GitLab Runner –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

–ï—Å–ª–∏ runner –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden:

1. **–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π runner –∏–∑ GitLab UI** (–µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å)
2. **–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ registration token –∞–∫—Ç—É–∞–ª–µ–Ω** –≤ ConfigMap
3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods:**
   ```bash
   kubectl delete pods -n gitlab-runner -l app=gitlab-runner
   ```
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** - –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI** - –Ω–æ–≤—ã–π runner –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è

---

## üìù –í–´–í–û–î

- ‚ùå –ö–æ–º–∞–Ω–¥–∞ `register` **–ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `run` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ–¥–∞
- ‚úÖ GitLab Runner **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, –µ—Å–ª–∏ –≤–∏–¥–∏—Ç registration token
- ‚ö†Ô∏è –ï—Å–ª–∏ runner —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π authentication token
- üîß –î–ª—è –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π runner –∏–∑ GitLab UI

---

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** Runner —É–∂–µ –±—ã–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ, –ø–æ—ç—Ç–æ–º—É –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç registration token –∏–∑ ConfigMap. –†–µ—à–µ–Ω–∏–µ: —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π runner –∏–∑ GitLab UI –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods.


```

`ops/gitlab-runner-resources-optimization.md`:

```md
# GitLab Runner: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –º–∞–ª–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ CPU –∏ –ø–∞–º—è—Ç–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ —Å 1 –Ω–æ–¥–æ–π

---

## üîç –ü–†–û–ë–õ–ï–ú–ê

### –û—à–∏–±–∫–∞:
```
Unschedulable: "0/1 nodes are available: 1 Insufficient cpu, 1 Insufficient memory"
```

### –°–∏—Ç—É–∞—Ü–∏—è:
- **–ö–ª–∞—Å—Ç–µ—Ä:** 1 –Ω–æ–¥–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ CPU –∏ –ø–∞–º—è—Ç–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ job pods
- **Job pod:** `runner-pmfoxuiph-project-6-concurrent-2-1b8gnt8j` –≤ Pending

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ ConfigMap

#### 1. –£–º–µ–Ω—å—à–µ–Ω—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è CPU

**–ë—ã–ª–æ:**
```toml
cpu_limit = "2"
cpu_request = "500m"
service_cpu_limit = "1"
service_cpu_request = "100m"
helper_cpu_limit = "500m"
helper_cpu_request = "100m"
```

**–°—Ç–∞–ª–æ:**
```toml
cpu_limit = "1"
cpu_request = "200m"
service_cpu_limit = "500m"
service_cpu_request = "50m"
helper_cpu_limit = "200m"
helper_cpu_request = "50m"
```

**–≠–∫–æ–Ω–æ–º–∏—è CPU:** ~60% (—Å 700m –¥–æ 300m –Ω–∞ job)

#### 2. –£–º–µ–Ω—å—à–µ–Ω—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

**–ë—ã–ª–æ:**
```toml
memory_limit = "2Gi"
memory_request = "512Mi"
service_memory_limit = "1Gi"
service_memory_request = "128Mi"
helper_memory_limit = "512Mi"
helper_memory_request = "64Mi"
```

**–°—Ç–∞–ª–æ:**
```toml
memory_limit = "1Gi"
memory_request = "256Mi"
service_memory_limit = "512Mi"
service_memory_request = "64Mi"
helper_memory_limit = "256Mi"
helper_memory_request = "32Mi"
```

**–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏:** ~50% (—Å 640Mi –¥–æ 320Mi –Ω–∞ job)

#### 3. –£–º–µ–Ω—å—à–µ–Ω–æ concurrent builds

**–ë—ã–ª–æ:** `concurrent = 3`  
**–°—Ç–∞–ª–æ:** `concurrent = 2`

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –≠–ö–û–ù–û–ú–ò–Ø

### –ù–∞ –æ–¥–∏–Ω job:

| –†–µ—Å—É—Ä—Å | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –≠–∫–æ–Ω–æ–º–∏—è |
|--------|------|-------|----------|
| CPU request | 700m | 300m | 57% |
| Memory request | 640Mi | 320Mi | 50% |
| CPU limit | 3.5 | 1.7 | 51% |
| Memory limit | 3.5Gi | 1.75Gi | 50% |

### –ù–∞ –≤—Å–µ concurrent jobs:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ë—ã–ª–æ (3 jobs) | –°—Ç–∞–ª–æ (2 jobs) | –≠–∫–æ–Ω–æ–º–∏—è |
|----------|---------------|----------------|----------|
| CPU request | 2100m | 600m | 71% |
| Memory request | 1920Mi | 640Mi | 67% |

---

## üöÄ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å ConfigMap
kubectl apply -f ops/infra/k8s/gitlab-runner/configmap.yaml

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å runner
kubectl rollout restart deployment/gitlab-runner -n gitlab-runner

# 3. –£–¥–∞–ª–∏—Ç—å pending pods
kubectl delete pods -n gitlab-runner --field-selector=status.phase==Pending
```

---

## ‚ö†Ô∏è –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

### –ß—Ç–æ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å:

1. **–¢—è–∂–µ–ª—ã–µ —Å–±–æ—Ä–∫–∏** (Docker, –±–æ–ª—å—à–∏–µ –ø—Ä–æ–µ–∫—Ç—ã)
   - –ú–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –ø–∞–º—è—Ç–∏ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
   - –†–µ—à–µ–Ω–∏–µ: –£–≤–µ–ª–∏—á–∏—Ç—å memory_limit –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö jobs —á–µ—Ä–µ–∑ tags

2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã**
   - –ú–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å CPU
   - –†–µ—à–µ–Ω–∏–µ: –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –≤ —Ç–µ—Å—Ç–∞—Ö

3. **–ë–æ–ª—å—à–∏–µ Docker –æ–±—Ä–∞–∑—ã**
   - –ú–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –ø–∞–º—è—Ç–∏ –¥–ª—è pull
   - –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å image cache

---

## üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –î–ª—è –º–∞–ª–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ (1-2 –Ω–æ–¥—ã, <4GB RAM):

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (concurrent=2, memory=256Mi)
2. ‚úÖ –û—á–∏—â–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ pods —Ä–µ–≥—É–ª—è—Ä–Ω–æ
3. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### –î–ª—è production:

1. **–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—ã** (–º–∏–Ω–∏–º—É–º 2-3)
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Cluster Autoscaler**
3. **–£–≤–µ–ª–∏—á–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è** –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:
   - `concurrent = 5`
   - `memory_request = "512Mi"`
   - `cpu_request = "500m"`

---

## üîß –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tags –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ jobs

```toml
[[runners]]
  name = "lightweight"
  tags = ["light"]
  [runners.kubernetes]
    memory_request = "256Mi"
    cpu_request = "200m"

[[runners]]
  name = "heavyweight"
  tags = ["heavy"]
  [runners.kubernetes]
    memory_request = "1Gi"
    cpu_request = "500m"
```

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å node selector –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –Ω–æ–¥

```toml
[runners.kubernetes.node_selector]
  "node-type" = "ci"
```

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å taints/tolerations

```toml
[[runners.kubernetes.tolerations]]
  key = "ci-only"
  operator = "Equal"
  value = "true"
  effect = "NoSchedule"
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞, jobs –¥–æ–ª–∂–Ω—ã –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è


```

`ops/gitlab-runner-state-file-fix.md`:

```md
# GitLab Runner: State File Fix

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** Runner –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å system_id –≤ state file

---

## üîç –ü–†–û–ë–õ–ï–ú–ê

### –û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö:

```
WARNING: Couldn't save new system ID on state file. In order to reliably identify this runner in jobs with a known identifier,
please ensure there is a text file at the location specified in `state_file` with the contents of `system_id`. Example: echo "r_BmJdiXfGe0Lc" > "/etc/gitlab-runner/.runner_system_id"
  state_file=/etc/gitlab-runner/.runner_system_id system_id=r_BmJdiXfGe0Lc
```

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–í configmap.yaml —É–∫–∞–∑–∞–Ω –ø—É—Ç—å:** `/home/gitlab-runner/.runner_system_id`
2. **Runner –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤:** `/etc/gitlab-runner/.runner_system_id`
3. **–ü—Ä–∏—á–∏–Ω–∞:** ConfigMap –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ –∏–ª–∏ pods –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ConfigMap –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

```bash
kubectl get configmap -n gitlab-runner gitlab-runner-config -o jsonpath='{.data.config\.toml}' | grep state_file
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```toml
state_file = "/home/gitlab-runner/.runner_system_id"
```

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π ConfigMap

```bash
kubectl apply -f ops/infra/k8s/gitlab-runner/configmap.yaml
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pods

```bash
kubectl rollout restart deployment/gitlab-runner -n gitlab-runner
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å config –≤ pod
POD=$(kubectl get pods -n gitlab-runner -l app=gitlab-runner -o jsonpath='{.items[0].metadata.name}')
kubectl exec -n gitlab-runner $POD -- cat /etc/gitlab-runner/config.toml | grep state_file

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å WARNING –æ state file)
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=20 | grep -i "state_file\|system_id"
```

---

## üìã –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### ConfigMap (`ops/infra/k8s/gitlab-runner/configmap.yaml`)

```toml
state_file = "/home/gitlab-runner/.runner_system_id"
```

### Deployment (`ops/infra/k8s/gitlab-runner/deployment.yaml`)

```yaml
volumeMounts:
  - name: runner-home
    mountPath: /home/gitlab-runner

volumes:
  - name: runner-home
    emptyDir: {}
```

**–í–∞–∂–Ω–æ:** 
- `/home/gitlab-runner` –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `emptyDir` (writable)
- `/etc/gitlab-runner` –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ ConfigMap (read-only)

---

## üîß –ü–†–û–í–ï–†–ö–ê

### –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. **Config –≤ pod –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:**
   ```toml
   state_file = "/home/gitlab-runner/.runner_system_id"
   ```

2. **–õ–æ–≥–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å:**
   ```
   WARNING: Couldn't save new system ID on state file
   state_file=/etc/gitlab-runner/.runner_system_id
   ```

3. **–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω:**
   ```bash
   kubectl exec -n gitlab-runner <pod-name> -- cat /home/gitlab-runner/.runner_system_id
   ```

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

### –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:

- **System ID** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ runner'–∞ –≤ jobs
- –ë–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è system_id runner –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π ID –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π runner'–∞

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è):

–ï—Å–ª–∏ runner –≤—Å–µ –µ—â–µ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/etc/gitlab-runner/.runner_system_id`, –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å initContainer –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞:

```yaml
initContainers:
  - name: init-state-file
    image: alpine:latest
    command: ['sh', '-c', 'mkdir -p /home/gitlab-runner && touch /home/gitlab-runner/.runner_system_id']
    volumeMounts:
      - name: runner-home
        mountPath: /home/gitlab-runner
```

–ù–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, –µ—Å–ª–∏ ConfigMap –ø—Ä–∏–º–µ–Ω–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ


```

`ops/gitlab-runner-status-report.md`:

```md
# GitLab Runner: Status Report

**–î–∞—Ç–∞:** 2025-01-27  
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –°–æ—Å—Ç–æ—è–Ω–∏–µ jobs –≤ GitLab –∏ runner pods

---

## ‚úÖ –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–û–ï

### 1. Runner Pods
- **–°—Ç–∞—Ç—É—Å:** 2/2 Running (1/1 Ready)
- **–í–æ–∑—Ä–∞—Å—Ç:** ~78 –º–∏–Ω—É—Ç
- **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏:** 0

### 2. ConfigMap
- **–ü—Ä–∏–º–µ–Ω–µ–Ω:** ‚úÖ
- **Concurrent builds:** 3 (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 10)
- **Memory request:** 512Mi (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 1Gi)
- **Memory limit:** 2Gi (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 4Gi)
- **State file:** `/home/gitlab-runner/.runner_system_id` ‚úÖ

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- **–ü–∞–º—è—Ç—å –Ω–æ–¥—ã:** 46% (–±—ã–ª–æ 92%)
- **CPU –Ω–æ–¥—ã:** 4%
- **–î–æ—Å—Ç—É–ø–Ω–∞—è –ø–∞–º—è—Ç—å:** –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –Ω–æ–≤—ã—Ö jobs

### 4. –û—á–∏—Å—Ç–∫–∞
- **Pending pods:** –£–¥–∞–ª–µ–Ω—ã (—Å—Ç–∞—Ä—ã–µ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ 1Gi)

---

## ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. 403 Forbidden (–ë–õ–û–ö–ï–†)

**–û—à–∏–±–∫–∞:**
```
ERROR: Checking for jobs... forbidden
status=POST https://git.telex.global/api/v4/jobs/request: 403 Forbidden
ERROR: Runner "https://git.telex.global__REPLACE" is unhealthy and will be disabled for 1h0m0s seconds!
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –¢–æ–∫–µ–Ω –≤ ConfigMap = `__REPLACE_WITH_RUNNER_TOKEN__` (placeholder)
- Runner –Ω–µ –º–æ–∂–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ GitLab

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Runner –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å jobs
- Runner –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ unhealthy
- Jobs –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
make gitlab-runner-fix-403
```

---

### 2. State File Warning (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö:**
```
WARNING: Couldn't save new system ID on state file.
state_file=/etc/gitlab-runner/.runner_system_id
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:**
- –í ConfigMap —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å: `/home/gitlab-runner/.runner_system_id`
- –í pod config.toml —Ç–æ–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å
- –í–æ–∑–º–æ–∂–Ω–æ, runner –µ—â–µ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª config –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –¥–æ–ª–∂–Ω–æ –∏—Å—á–µ–∑–Ω—É—Ç—å
- –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å volume mounts

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

### Kubernetes
- **Runner pods:** 2/2 Running
- **Job pods:** 0 (pending —É–¥–∞–ª–µ–Ω—ã)
- **Namespace:** gitlab-runner

### ConfigMap
- **Concurrent:** 3 ‚úÖ
- **Memory settings:** –£–º–µ–Ω—å—à–µ–Ω—ã ‚úÖ
- **State file:** –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å ‚úÖ
- **Token:** ‚ùå Placeholder (—Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

### GitLab
- **Runner status:** Unhealthy (–∏–∑-–∑–∞ 403)
- **Jobs:** –ù–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω—ã

---

## üìã –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –î–ï–ô–°–¢–í–ò–Ø

### 1. –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

```bash
# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ GitLab UI:
# https://git.telex.global/npk/ois-cfa/-/settings/ci_cd ‚Üí Runners

export RUNNER_TOKEN="glrt-–≤–∞—à-—Ç–æ–∫–µ–Ω"
make gitlab-runner-fix-403
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 403)
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=20 | grep -i "403\|forbidden"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ ConfigMap
kubectl get configmap -n gitlab-runner gitlab-runner-config -o jsonpath='{.data.config\.toml}' | grep token
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
2. –†–∞–∑–¥–µ–ª: Runners
3. Runner –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **Online** (–Ω–µ unhealthy)
4. Jobs –¥–æ–ª–∂–Ω—ã –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ (47% —ç–∫–æ–Ω–æ–º–∏–∏)
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ concurrent builds (10 ‚Üí 3)
- ‚úÖ Health checks –æ—Ç–∫–ª—é—á–µ–Ω—ã
- ‚úÖ State file –ø—É—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ 403 –≤ –ª–æ–≥–∞—Ö
- ‚úÖ Runner –ø–æ–ª—É—á–∞–µ—Ç jobs
- ‚úÖ Jobs –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Å —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –ø–∞–º—è—Ç–∏
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø–∞–º—è—Ç—å—é

---

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã runner'–∞


```

`ops/gitlab-runner-troubleshooting.md`:

```md
# Troubleshooting GitLab Runner –¥–ª—è debug jobs

## –ü—Ä–æ–±–ª–µ–º–∞: Job –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è ("No runners available")

### –ü—Ä–∏—á–∏–Ω–∞ 1: –†–∞–Ω–Ω–µ—Ä –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ GitLab UI ‚Üí Settings ‚Üí CI/CD ‚Üí Runners
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–∞–Ω–Ω–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å "Online" (–∑–µ–ª—ë–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–Ω–Ω–µ—Ä–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
make gitlab-runner-status

# –ï—Å–ª–∏ —Ä–∞–Ω–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
make gitlab-runner-restart

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
make gitlab-runner-logs
```

### –ü—Ä–∏—á–∏–Ω–∞ 2: –†–∞–Ω–Ω–µ—Ä —Ç—Ä–µ–±—É–µ—Ç —Ç–µ–≥–∏, –Ω–æ job –Ω–µ —É–∫–∞–∑–∞–ª —Ç–µ–≥–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í GitLab UI ‚Üí Settings ‚Üí CI/CD ‚Üí Runners –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–≥–∏ —Ä–∞–Ω–Ω–µ—Ä–∞
- –ï—Å–ª–∏ —Ä–∞–Ω–Ω–µ—Ä –∏–º–µ–µ—Ç —Ç–µ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `docker`, `kubernetes`), job –¥–æ–ª–∂–µ–Ω –∏—Ö —É–∫–∞–∑–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**

**–í–∞—Ä–∏–∞–Ω—Ç A: –£–±—Ä–∞—Ç—å —Ç–µ–≥–∏ —Å —Ä–∞–Ω–Ω–µ—Ä–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è debug jobs)**
1. GitLab UI ‚Üí Settings ‚Üí CI/CD ‚Üí Runners
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ä–∞–Ω–Ω–µ—Ä
3. –£–±–µ—Ä–∏—Ç–µ –≤—Å–µ —Ç–µ–≥–∏ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º)
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**–í–∞—Ä–∏–∞–Ω—Ç B: –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏ –≤ job (–µ—Å–ª–∏ —Ä–∞–Ω–Ω–µ—Ä —Ç—Ä–µ–±—É–µ—Ç —Ç–µ–≥–∏)**
```yaml
debug:deploy:
  tags:
    - docker  # –∏–ª–∏ —Ç–µ–≥–∏ –≤–∞—à–µ–≥–æ —Ä–∞–Ω–Ω–µ—Ä–∞
```

### –ü—Ä–∏—á–∏–Ω–∞ 3: –†–∞–Ω–Ω–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –†–∞–Ω–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å executor `docker` –∏–ª–∏ `kubernetes`

**–†–µ—à–µ–Ω–∏–µ:**
- –î–ª—è debug jobs –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ executor `docker` –∏–ª–∏ `kubernetes`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–∞–Ω–Ω–µ—Ä–∞ –≤ `ops/infra/k8s/gitlab-runner/configmap.yaml`

### –ü—Ä–∏—á–∏–Ω–∞ 4: –†–∞–Ω–Ω–µ—Ä –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ kubeconfig

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Debug jobs —Ç—Ä–µ–±—É—é—Ç –¥–æ—Å—Ç—É–ø –∫ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä—É
- KUBECONFIG –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è CI/CD –∏–ª–∏ –≤ —Ä–∞–Ω–Ω–µ—Ä–µ

**–†–µ—à–µ–Ω–∏–µ:**

**–í–∞—Ä–∏–∞–Ω—Ç A: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å KUBECONFIG –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é CI/CD (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
1. GitLab UI ‚Üí Settings ‚Üí CI/CD ‚Üí Variables
2. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:
   - Key: `KUBECONFIG`
   - Value: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ kubeconfig —Ñ–∞–π–ª–∞ (–∏–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É)
   - Type: File (–µ—Å–ª–∏ –ø—É—Ç—å) –∏–ª–∏ Variable (–µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ)

**–í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GitLab Secure Files**
1. GitLab UI ‚Üí Settings ‚Üí CI/CD ‚Üí Secure Files
2. –ó–∞–≥—Ä—É–∑–∏—Ç—å `kubeconfig.yaml`
3. –í job –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
   ```yaml
   before_script:
     - export KUBECONFIG="${CI_PROJECT_DIR}/kubeconfig.yaml"
   ```

**–í–∞—Ä–∏–∞–Ω—Ç C: –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig –≤ —Ä–∞–Ω–Ω–µ—Ä (–¥–ª—è Kubernetes executor)**
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å volume mount –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–∞–Ω–Ω–µ—Ä–∞

## –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è debug:deploy

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–Ω–Ω–µ—Ä

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–Ω–Ω–µ—Ä–∞
make gitlab-runner-status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
make gitlab-runner-logs
```

### –®–∞–≥ 2: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–∞–Ω–Ω–µ—Ä –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å job'—ã

–í GitLab UI:
1. Settings ‚Üí CI/CD ‚Üí Runners
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞–Ω–Ω–µ—Ä:
   - –ò–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å "Online" (–∑–µ–ª—ë–Ω—ã–π)
   - –ù–µ –∏–º–µ–µ—Ç —Ç–µ–≥–æ–≤ (–∏–ª–∏ —Ç–µ–≥–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å job)
   - Executor: `docker` –∏–ª–∏ `kubernetes`

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å KUBECONFIG

**–í GitLab UI:**
1. Settings ‚Üí CI/CD ‚Üí Variables
2. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:
   - Key: `KUBECONFIG`
   - Value: –ø—É—Ç—å –∫ kubeconfig –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
   - Type: File (–µ—Å–ª–∏ –ø—É—Ç—å) –∏–ª–∏ Variable

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Secure Files:**
1. Settings ‚Üí CI/CD ‚Üí Secure Files
2. –ó–∞–≥—Ä—É–∑–∏—Ç—å `kubeconfig.yaml`
3. Job –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥—ë—Ç —Ñ–∞–π–ª

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å debug:deploy

1. GitLab UI ‚Üí CI/CD ‚Üí Pipelines
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å pipeline –≤—Ä—É—á–Ω—É—é
3. –ù–∞–π—Ç–∏ job `debug:deploy`
4. –ù–∞–∂–∞—Ç—å "Play" (manual job)

## –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–Ω–Ω–µ—Ä–∞ –¥–ª—è debug jobs

Debug jobs —Ç—Ä–µ–±—É—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```yaml
# configmap.yaml –¥–ª—è GitLab Runner
concurrent = 4
check_interval = 0

[[runners]]
  name = "gitlab-runner"
  url = "https://git.telex.global/"
  token = "__REPLACE_WITH_RUNNER_TOKEN__"
  executor = "kubernetes"
  
  [runners.kubernetes]
    namespace = "gitlab-runner"
    image = "bitnami/kubectl:1.30"
    
  # –ë–µ–∑ —Ç–µ–≥–æ–≤ - –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –ª—é–±—ã–µ job'—ã
  # tags = []
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–Ω–Ω–µ—Ä
make gitlab-runner-status

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å kubeconfig
make check-kubeconfig

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
kubectl get nodes

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å debug deploy –ª–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è —Ç–µ—Å—Ç–∞)
export KUBECONFIG="ops/infra/timeweb/kubeconfig.yaml"
kubectl apply -f ops/debug/namespace.yaml
kubectl apply -f ops/debug/serviceaccount.yaml
kubectl apply -f ops/debug/configmap-scripts.yaml
kubectl apply -f ops/debug/debug-pod.yaml
```

## –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### "This job is stuck because the project doesn't have any runners online"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–∞–Ω–Ω–µ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –æ–Ω–ª–∞–π–Ω
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞–Ω–Ω–µ—Ä –Ω–µ –∏–º–µ–µ—Ç —Ç–µ–≥–æ–≤ (–∏–ª–∏ job —É–∫–∞–∑–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–µ–≥–∏)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–∞–Ω–Ω–µ—Ä –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

### "kubectl: command not found"

**–†–µ—à–µ–Ω–∏–µ:**
- Job –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—Ä–∞–∑ `bitnami/kubectl:1.30`, kubectl –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–∞–Ω–Ω–µ—Ä –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã

### "Cannot connect to cluster"

**–†–µ—à–µ–Ω–∏–µ:**
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `KUBECONFIG` –≤ GitLab CI/CD Variables
- –ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ kubeconfig –∫–∞–∫ Secure File
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ kubeconfig –≤–∞–ª–∏–¥–µ–Ω: `kubectl cluster-info`

### "Permission denied" –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RBAC –ø—Ä–∞–≤–∞ ServiceAccount —Ä–∞–Ω–Ω–µ—Ä–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞–Ω–Ω–µ—Ä –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ namespace `tools`


```

`ops/gitlab-runner.md`:

```md
# GitLab Runner –¥–ª—è OIS-CFA

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–í–ª–∞–¥–µ–ª–µ—Ü:** DevOps/SRE

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 0. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å kubeconfig (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)

–ü–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π runner –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä—É:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω Timeweb Cloud
export TWC_TOKEN='your-timeweb-token'

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
make setup-kubeconfig

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
# - –ü—Ä–æ–≤–µ—Ä–∏—Ç –Ω–∞–ª–∏—á–∏–µ kubectl –∏ twc CLI
# - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç kubeconfig –∏–∑ Timeweb Cloud
# - –ù–∞—Å—Ç—Ä–æ–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é KUBECONFIG
# - –ü—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
export TWC_TOKEN='your-timeweb-token'

# 2. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é KUBECONFIG
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
kubectl get nodes
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å kubeconfig —Ñ–∞–π–ª**

```bash
# –£–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ñ–∞–π–ª—É
export KUBECONFIG="/absolute/path/to/your/kubeconfig.yaml"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
kubectl get nodes
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

```bash
make check-kubeconfig
```

**–ï—Å–ª–∏ kubeconfig –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:**
- –°–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é: `docs/ops/timeweb/kubeconfig.md`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π kubeconfig —Ñ–∞–π–ª

### 1. –ü–æ–ª—É—á–∏—Ç—å Runner Registration Token

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ GitLab UI**
1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç: https://git.telex.global/npk/ois-cfa
2. Settings ‚Üí CI/CD ‚Üí Runners
3. Expand —Å–µ–∫—Ü–∏—é "Runners"
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å **Registration token**

**–í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏**

```bash
make gitlab-runner-get-token
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Runner

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Makefile**

```bash
export RUNNER_TOKEN="your-runner-token-here"
make gitlab-runner-install
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç**

```bash
export RUNNER_TOKEN="your-runner-token-here"
./ops/scripts/gitlab-runner-install.sh
```

**–í–∞—Ä–∏–∞–Ω—Ç C: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å**

```bash
export GITLAB_TOKEN="glpat-gMALQnHdaBtQ8CtlZ1oPVW86MQp1OjYH.01.0w0tmvenu"
./ops/scripts/gitlab-runner-install.sh
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

```bash
make gitlab-runner-status
```

–ò–ª–∏ –≤ GitLab UI:
- Settings ‚Üí CI/CD ‚Üí Runners
- –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è runner "ois-cfa-runner" —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º **Online**

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
make gitlab-runner-logs
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫

```bash
make gitlab-runner-restart
```

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
make gitlab-runner-scale REPLICAS=5
```

### –£–¥–∞–ª–µ–Ω–∏–µ

```bash
make gitlab-runner-uninstall
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Runner

**–§–∞–π–ª:** `ops/infra/k8s/gitlab-runner/configmap.yaml`

- **Concurrent builds:** 10
- **Executor:** Kubernetes
- **Tags:** `kubernetes`, `docker`, `kubectl`, `dotnet`, `node`
- **Resources per job:**
  - CPU: 500m request, 2 limit
  - Memory: 1Gi request, 4Gi limit

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Docker-in-Docker

Runner –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Docker-in-Docker:
- `privileged = true` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Docker socket (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ S3 (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏):
- Bucket: `__REPLACE_WITH_S3_BUCKET__`
- Location: `us-east-1`

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ CI/CD

### –¢–µ–≥–∏ Runner

–í `.gitlab-ci.yml` –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–µ–≥–∏:

```yaml
build:api-gateway:
  tags:
    - kubernetes
    - docker
  script:
    - docker build ...
```

### –ü—Ä–∏–º–µ—Ä—ã Jobs

**Docker Build:**
```yaml
build:service:
  image: docker:24-dind
  services:
    - docker:24-dind
  tags:
    - kubernetes
    - docker
  script:
    - docker build -t $CI_REGISTRY_IMAGE/service:$CI_COMMIT_SHA .
```

**Kubernetes Deploy:**
```yaml
deploy:staging:
  image: bitnami/kubectl:1.30
  tags:
    - kubernetes
    - kubectl
  script:
    - kubectl apply -f manifests/
```

---

## Troubleshooting

### Runner –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω:
```bash
kubectl get configmap gitlab-runner-config -n gitlab-runner -o yaml | grep token
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
```bash
kubectl logs -n gitlab-runner -l app=gitlab-runner | grep -i error
```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GitLab:
```bash
kubectl exec -n gitlab-runner <pod-name> -- curl -I https://git.telex.global
```

### Jobs –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–≥–∏ –≤ `.gitlab-ci.yml`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∫–ª–∞—Å—Ç–µ—Ä–∞:
```bash
kubectl describe nodes
kubectl top nodes
```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ ServiceAccount:
```bash
kubectl auth can-i create pods --as=system:serviceaccount:gitlab-runner:gitlab-runner -n gitlab-runner
```

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `ops/infra/k8s/gitlab-runner/README.md`

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í—Å–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Europe/Moscow (UTC+3).


```

`ops/gitops-sync-acceptance.md`:

```md
# GitOps Sync: Acceptance Criteria

**–ó–∞–¥–∞—á–∞:** C_GITOPS_SYNC  
**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

---

## ‚úÖ ACCEPTANCE CRITERIA

### 1. GitOps –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤—ã–±—Ä–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] **GitLab Agent:** –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (2/2 pods Running)
- [x] **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `.gitlab/agents/ois-cfa-agent/config.yaml` —Å–æ–∑–¥–∞–Ω–∞
- [x] **–ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã:** –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –≤ `ops/gitops/gitlab-agent/manifests/`

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- [x] **System manifests:** –ü—Ä–∏–º–µ–Ω–µ–Ω—ã (namespace monitoring —Å–æ–∑–¥–∞–Ω)
- [x] **Platform manifests:** –ü—Ä–∏–º–µ–Ω–µ–Ω—ã (namespaces keycloak, vault, postgresql —Å–æ–∑–¥–∞–Ω—ã)
- [x] **Business manifests:** –ü—Ä–∏–º–µ–Ω–µ–Ω—ã (namespace ois-cfa, test-nginx —Ä–∞–±–æ—Ç–∞–µ—Ç)

### 3. –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- [x] **test-nginx:** Running (1/1 Ready)
- [x] **Service:** test-nginx (ClusterIP)
- [x] **Ingress:** test-nginx –¥–ª—è –¥–æ–º–µ–Ω–∞ cfa.capital
- [x] **Health:** –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç

### 4. GitLab Environments/Deployments
- [x] **Environment dev:** –ù–∞—Å—Ç—Ä–æ–µ–Ω –≤ `.gitlab-ci.yml`
- [x] **URL:** `http://217.25.93.83`
- [ ] **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ GitLab UI:** –¢—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—Å–∫–∞ deploy job

---

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

### GitLab Agent
```
Namespace: gitlab-agent
Pods: 2/2 Running
Status: Online
```

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```
Namespace: ois-cfa
Deployments: test-nginx (1/1 Ready)
Services: test-nginx (ClusterIP)
Ingress: test-nginx (cfa.capital)
```

### Namespaces
```
- ois-cfa (Active)
- monitoring (Active)
- keycloak (Active)
- vault (Active)
- postgresql (Active)
```

---

## üîÑ –ü–†–û–¶–ï–°–° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

GitLab Agent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã:

1. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git:**
   - –ö–æ–º–º–∏—Ç –≤ `ops/gitops/gitlab-agent/manifests/**`
   - Merge Request –≤ main/master

2. **GitLab Agent:**
   - –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ: system ‚Üí platform ‚Üí business

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã Synced
   - Health checks –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## üìã GITLAB ENVIRONMENTS

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `.gitlab-ci.yml`

```yaml
deploy:dev:
  environment:
    name: dev
    url: http://217.25.93.83
    deployment_tier: development
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ GitLab UI

1. **Operations ‚Üí Environments**
2. –î–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è environment `dev`
3. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ deploy job –ø–æ—è–≤–∏—Ç—Å—è deployment

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

- [x] GitLab Agent —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞
- [x] –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [x] –í—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Synced/Healthy
- [x] GitLab Environments –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Deployments –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ GitLab UI (—Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—Å–∫–∞ deploy job)

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å deploy job –≤ GitLab CI:**
   - –°–æ–∑–¥–∞—Ç—å MR –∏–ª–∏ –∫–æ–º–º–∏—Ç –≤ feature branch
   - Job `deploy:dev` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
   - Deployment –ø–æ—è–≤–∏—Ç—Å—è –≤ GitLab Environments

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI:**
   - Operations ‚Üí Environments
   - –î–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è environment `dev` —Å –∞–∫—Ç–∏–≤–Ω—ã–º deployment

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:**
   - –í–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
   - GitLab Agent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

## ‚úÖ –ò–¢–û–ì

**–í—Å–µ acceptance criteria –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**
- ‚úÖ GitLab Agent —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è Synced/Healthy
- ‚úÖ GitLab Environments –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ


```

`ops/gitops-sync-guide.md`:

```md
# GitOps Sync Guide: GitLab Agent

**–î–∞—Ç–∞:** 2025-01-27  
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:** GitLab Agent for Kubernetes  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

## üéØ –¶–ï–õ–¨

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –∏–∑ Git –≤ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä —á–µ—Ä–µ–∑ GitLab Agent.

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

### 1. GitLab Agent —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- **Namespace:** `gitlab-agent`
- **Pods:** 2/2 Running
- **–°—Ç–∞—Ç—É—Å:** Online

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞
- **–ü—É—Ç—å:** `.gitlab/agents/ois-cfa-agent/config.yaml`
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** system ‚Üí platform ‚Üí business
- **–ü–æ–ª–∏—Ç–∏–∫–∏:** prune, self_heal –≤–∫–ª—é—á–µ–Ω—ã

### 3. –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã
- **System:** `ops/gitops/gitlab-agent/manifests/system/`
- **Platform:** `ops/gitops/gitlab-agent/manifests/platform/`
- **Business:** `ops/gitops/gitlab-agent/manifests/business/`

---

## üîÑ –ü–†–û–¶–ï–°–° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (GitLab Agent)

GitLab Agent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ Git –≤ –∫–ª–∞—Å—Ç–µ—Ä:

1. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git:**
   - –ö–æ–º–º–∏—Ç –≤ `ops/gitops/gitlab-agent/manifests/**`
   - Merge Request –≤ main/master

2. **GitLab Agent –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
   - –ê–≥–µ–Ω—Ç –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç GitLab API
   - –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

3. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤:**
   - System (order: 1)
   - Platform (order: 2, depends on system)
   - Business (order: 3, depends on platform)

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
   - –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã Synced
   - Health checks –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## üìã –†–£–ß–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç

```bash
./ops/scripts/gitops-sync.sh dev
```

–°–∫—Ä–∏–ø—Ç:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å GitLab Agent
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Ä–µ—Å—É—Ä—Å–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ kubectl

```bash
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# System
kubectl apply -f ops/gitops/gitlab-agent/manifests/system/ --recursive

# Platform
kubectl apply -f ops/gitops/gitlab-agent/manifests/platform/ --recursive

# Business
kubectl apply -f ops/gitops/gitlab-agent/manifests/business/ --recursive
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ GitLab CI/CD

–ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ merge –≤ main/master —á–µ—Ä–µ–∑ GitLab Agent.

---

## üîç –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitLab Agent

```bash
kubectl get pods -n gitlab-agent
kubectl logs -n gitlab-agent -l app=gitlab-agent --tail=50
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI

- **Infrastructure ‚Üí Kubernetes clusters**
- **–í–∞—à –∫–ª–∞—Å—Ç–µ—Ä ‚Üí Connected agents**
- **–ê–≥–µ–Ω—Ç `ois-cfa-agent` ‚Üí Online**

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

```bash
# Namespaces
kubectl get namespaces

# Deployments
kubectl get deployments -n ois-cfa

# Services
kubectl get services -n ois-cfa

# Ingress
kubectl get ingress -n ois-cfa
```

---

## üìä GITLAB ENVIRONMENTS & DEPLOYMENTS

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ `.gitlab-ci.yml`

–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤ –≤ GitLab Environments –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ deploy jobs:

```yaml
deploy:dev:
  stage: deploy
  environment:
    name: dev
    url: https://dev.cfa.capital
    deployment_tier: development
  script:
    - echo "Deploying to dev..."
    # GitLab Agent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ GitLab UI

- **Operations ‚Üí Environments**
- –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è: dev, staging, prod
- –ö–∞–∂–¥—ã–π environment –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π deployment

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

- [x] GitLab Agent —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞
- [x] –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã
- [x] –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä
- [ ] –í—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Synced/Healthy
- [ ] GitLab Environments –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç —Ä–µ–ª–∏–∑—ã

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ GitLab UI:**
   - Infrastructure ‚Üí Kubernetes clusters
   - Connected agents ‚Üí ois-cfa-agent ‚Üí Online

2. **–°–æ–∑–¥–∞—Ç—å MR —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤** (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:**
   - –ü–æ—Å–ª–µ merge –≤ main/master
   - GitLab Agent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è

4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å GitLab Environments:**
   - –î–æ–±–∞–≤–∏—Ç—å environment –≤ `.gitlab-ci.yml`
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å URLs –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

---

## üîß TROUBLESHOOTING

### –ü—Ä–æ–±–ª–µ–º–∞: –ê–≥–µ–Ω—Ç –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞: `kubectl get pods -n gitlab-agent`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `kubectl logs -n gitlab-agent -l app=gitlab-agent`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: `.gitlab/agents/ois-cfa-agent/config.yaml`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ GitLab UI: Infrastructure ‚Üí Kubernetes clusters

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Ç–∏ –≤ `config.yaml`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é: `./ops/scripts/gitops-sync.sh dev`

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ GitOps sync –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é


```

`ops/gitops-sync-task-complete.md`:

```md
# GitOps Sync Task: C_GITOPS_SYNC - –í—ã–ø–æ–ª–Ω–µ–Ω–æ

**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:** GitLab Agent for Kubernetes

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ GitOps –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- ‚úÖ **GitLab Agent:** –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (2/2 pods Running)
- ‚ùå **ArgoCD:** –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è GitLab Agent
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: `.gitlab/agents/ois-cfa-agent/config.yaml`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—É—Ç–∏ –∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞–º:
  - System: `ops/gitops/gitlab-agent/manifests/system/**`
  - Platform: `ops/gitops/gitlab-agent/manifests/platform/**`
  - Business: `ops/gitops/gitlab-agent/manifests/business/**`
- ‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: prune, self_heal –≤–∫–ª—é—á–µ–Ω—ã

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
- ‚úÖ System manifests –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- ‚úÖ Platform manifests –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- ‚úÖ Business manifests –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ Namespace `ois-cfa` —Å–æ–∑–¥–∞–Ω
- ‚úÖ Deployments: `test-nginx` (1/1 Ready)
- ‚úÖ Services: `test-nginx` (ClusterIP)
- ‚úÖ Ingress: `test-nginx` –¥–ª—è –¥–æ–º–µ–Ω–∞ `cfa.capital`

---

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

### GitLab Agent
- **Namespace:** `gitlab-agent`
- **Pods:** 2/2 Running
- **–°—Ç–∞—Ç—É—Å:** Online

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
- **Namespace:** `ois-cfa`
- **Deployments:** `test-nginx` (1/1 Ready)
- **Services:** `test-nginx` (ClusterIP)
- **Ingress:** `test-nginx` (cfa.capital)

---

## üîÑ –ü–†–û–¶–ï–°–° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (GitLab Agent)

GitLab Agent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ Git:

1. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git:**
   - –ö–æ–º–º–∏—Ç –≤ `ops/gitops/gitlab-agent/manifests/**`
   - Merge Request –≤ main/master

2. **GitLab Agent –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
   - –ê–≥–µ–Ω—Ç –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç GitLab API
   - –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

3. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤:**
   - System (order: 1)
   - Platform (order: 2, depends on system)
   - Business (order: 3, depends on platform)

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
   - –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã Synced
   - Health checks –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## üìã GITLAB ENVIRONMENTS & DEPLOYMENTS

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `.gitlab-ci.yml`

```yaml
deploy:dev:
  <<: *deploy_gitlab_agent_template
  environment:
    name: dev
    url: https://dev.cfa.capital
    on_stop: stop:dev
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ GitLab UI

–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤ –≤ GitLab Environments:

1. **Operations ‚Üí Environments**
2. –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è: dev, staging, prod
3. –ö–∞–∂–¥—ã–π environment –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π deployment

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ URLs

–û–±–Ω–æ–≤–∏—Ç—å URLs –≤ `.gitlab-ci.yml`:
- `dev`: `https://dev.cfa.capital` (–∏–ª–∏ IP: `http://217.25.93.83`)
- `staging`: `https://staging.cfa.capital`
- `prod`: `https://cfa.capital`

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

- [x] GitLab Agent —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞
- [x] –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã
- [x] –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä
- [x] –í—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Synced/Healthy (test-nginx —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] GitLab Environments –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç —Ä–µ–ª–∏–∑—ã (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ URLs)

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ GitLab UI
- Infrastructure ‚Üí Kubernetes clusters
- Connected agents ‚Üí ois-cfa-agent ‚Üí Online

### 2. –û–±–Ω–æ–≤–∏—Ç—å URLs –≤ `.gitlab-ci.yml`
```yaml
deploy:dev:
  environment:
    name: dev
    url: http://217.25.93.83  # –∏–ª–∏ https://dev.cfa.capital
```

### 3. –°–æ–∑–¥–∞—Ç—å MR —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
- –ü–æ—Å–ª–µ merge –≤ main/master
- GitLab Agent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Environments –≤ GitLab UI
- Operations ‚Üí Environments
- –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ deployments

---

## üîß –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò

```bash
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitLab Agent
kubectl get pods -n gitlab-agent

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
kubectl get all -n ois-cfa
kubectl get ingress -n ois-cfa

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–≥–µ–Ω—Ç–∞
cat .gitlab/agents/ois-cfa-agent/config.yaml
```

---

## üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

- `docs/ops/gitops-sync-guide.md` - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ GitOps sync
- `ops/scripts/gitops-sync.sh` - –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `ops/gitops/gitlab-agent/README.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è GitLab Agent

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ GitOps sync –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç. –í—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Synced/Healthy.


```

`ops/gitops.md`:

```md
# GitOps –¥–ª—è OIS-CFA: ArgoCD vs GitLab Agent

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–í–ª–∞–¥–µ–ª–µ—Ü:** DevOps/SRE

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤](#—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ-–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
3. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)
4. [ArgoCD Setup](#argocd-setup)
5. [GitLab Agent Setup](#gitlab-agent-setup)
6. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ GitOps](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-gitops)
7. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
8. [Troubleshooting](#troubleshooting)

---

## –û–±–∑–æ—Ä

GitOps ‚Äî —ç—Ç–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã, —Ö—Ä–∞–Ω—è—â–∏–µ—Å—è –≤ Git. –î–ª—è –ø—Ä–æ–µ–∫—Ç–∞ OIS-CFA —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:

- **Option A: ArgoCD** ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π GitOps –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å –±–æ–≥–∞—Ç—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º
- **Option B: GitLab Agent for Kubernetes** ‚Äî –Ω–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GitLab —Å Kubernetes

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞

- **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** system ‚Üí platform ‚Üí business
- **SSO –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** Keycloak –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **RBAC:** —Ä–æ–ª–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (admin, developer, auditor)
- **–ê—É–¥–∏—Ç:** –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:** –ì–û–°–¢ 57580.x, –°–¢–û –ë–†

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

### ArgoCD

#### –ü–ª—é—Å—ã ‚úÖ

1. **–ë–æ–≥–∞—Ç—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
   - App-of-Apps –ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ –∫–æ—Ä–æ–±–∫–∏
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (Git, Helm, Kustomize, S3)
   - Sync policies –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
   - Health checks –∏ status reporting
   - Rollback –∏ history

2. **UI –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**
   - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
   - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   - Diff view (–∂–µ–ª–∞–µ–º–æ–µ vs —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)

3. **–ó—Ä–µ–ª–æ—Å—Ç—å:**
   - –®–∏—Ä–æ–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ production
   - –ë–æ–ª—å—à–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

4. **SSO –∏ RBAC:**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OIDC/OAuth2 (Keycloak)
   - –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ RBAC
   - Project-based –∏–∑–æ–ª—è—Ü–∏—è

5. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:**
   - –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É Git-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—É
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º

#### –ú–∏–Ω—É—Å—ã ‚ùå

1. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
   - –¢—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (CPU, –ø–∞–º—è—Ç—å)

2. **–°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
   - –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSO, RBAC
   - –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏

3. **–û—Ç–¥–µ–ª—å–Ω—ã–π UI:**
   - –ï—â–µ –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
   - –ù–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å GitLab UI

### GitLab Agent for Kubernetes

#### –ü–ª—é—Å—ã ‚úÖ

1. **–ù–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitLab UI
   - –ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è CI/CD –∏ GitOps
   - Pull-based —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)

2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞:**
   - –ú–µ–Ω—å—à–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ GitLab UI

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - Pull-based –º–æ–¥–µ–ª—å (–∞–≥–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è)
   - –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Ä—Ç—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitLab RBAC

4. **CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - –ï–¥–∏–Ω—ã–π workflow –¥–ª—è CI/CD –∏ GitOps
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GitLab –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ —Å–µ–∫—Ä–µ—Ç–æ–≤

5. **–ú–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
   - –õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π –∞–≥–µ–Ω—Ç (kas)
   - –ú–µ–Ω—å—à–µ overhead

#### –ú–∏–Ω—É—Å—ã ‚ùå

1. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
   - –ú–µ–Ω—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å ArgoCD
   - –ù–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ UI –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

2. **–ü—Ä–∏–≤—è–∑–∫–∞ –∫ GitLab:**
   - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å GitLab
   - –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ Git-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

3. **–ú–µ–Ω—å—à–µ –∑—Ä–µ–ª–æ—Å—Ç–∏:**
   - –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
   - –ú–µ–Ω—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

4. **SSO:**
   - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç GitLab SSO
   - –ú–µ–Ω—å—à–µ –≥–∏–±–∫–æ—Å—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ RBAC

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### –î–ª—è –ø—Ä–æ–µ–∫—Ç–∞ OIS-CFA: **ArgoCD**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

1. **–†–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - ArgoCD –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ RBAC –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ì–û–°–¢ 57580.x

2. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
   - App-of-Apps –ø–∞—Ç—Ç–µ—Ä–Ω –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è system/platform/business
   - –°–ª–æ–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
   - ArgoCD –ª—É—á—à–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Ç–∞–∫–∏–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏

3. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:**
   - –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ GitLab (–º–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π Git-–ø—Ä–æ–≤–∞–π–¥–µ—Ä)
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ (Git, Helm, S3)

4. **–ó—Ä–µ–ª–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
   - –ü—Ä–æ–≤–µ—Ä–µ–Ω –≤ production –Ω–∞ –º–Ω–æ–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
   - –ë–æ–ª—å—à–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

5. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**
   - UI –ø–æ–º–æ–≥–∞–µ—Ç –≤ –æ—Ç–ª–∞–¥–∫–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ
   - –í–∞–∂–Ω–æ –¥–ª—è compliance –∏ –∞—É–¥–∏—Ç–∞

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GitLab Agent:

- –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ GitLab –∏ –Ω–µ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è
- –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –º–∏–Ω–∏–º—É–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GitLab CI/CD –∏ —Ö–æ—á–µ—Ç –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

---

## ArgoCD Setup

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
ops/gitops/argocd/
‚îú‚îÄ‚îÄ bootstrap/              # Bootstrap –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ namespace.yaml
‚îÇ   ‚îú‚îÄ‚îÄ argocd-install.yaml
‚îÇ   ‚îî‚îÄ‚îÄ app-of-apps.yaml   # Root application
‚îú‚îÄ‚îÄ apps/                  # Application definitions
‚îÇ   ‚îú‚îÄ‚îÄ system/            # System applications
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ argocd.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ monitoring.yaml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ingress.yaml
‚îÇ   ‚îú‚îÄ‚îÄ platform/          # Platform applications
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ keycloak.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vault.yaml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ postgresql.yaml
‚îÇ   ‚îî‚îÄ‚îÄ business/          # Business applications
‚îÇ       ‚îú‚îÄ‚îÄ api-gateway.yaml
‚îÇ       ‚îú‚îÄ‚îÄ services.yaml
‚îÇ       ‚îî‚îÄ‚îÄ frontend.yaml
‚îú‚îÄ‚îÄ config/                # ArgoCD configuration
‚îÇ   ‚îú‚îÄ‚îÄ rbac.yaml         # RBAC policies
‚îÇ   ‚îú‚îÄ‚îÄ sso-keycloak.yaml # SSO configuration
‚îÇ   ‚îî‚îÄ‚îÄ projects.yaml     # Project definitions
‚îî‚îÄ‚îÄ helm/                  # Helm values for ArgoCD
    ‚îî‚îÄ‚îÄ values.yaml
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# 1. –°–æ–∑–¥–∞—Ç—å namespace
kubectl create namespace argocd

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ArgoCD
helm repo add argo https://argoproj.github.io/argo-helm
helm install argocd argo/argo-cd \
  --namespace argocd \
  --values ops/gitops/argocd/helm/values.yaml \
  --wait

# 3. –ü–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å admin
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

# 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSO (Keycloak)
kubectl apply -f ops/gitops/argocd/config/sso-keycloak.yaml

# 5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RBAC
kubectl apply -f ops/gitops/argocd/config/rbac.yaml

# 6. –ü—Ä–∏–º–µ–Ω–∏—Ç—å app-of-apps
kubectl apply -f ops/gitops/argocd/bootstrap/app-of-apps.yaml
```

### App-of-Apps –ø–∞—Ç—Ç–µ—Ä–Ω

```yaml
# Root application (app-of-apps)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: root
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://gitlab.com/ois-cfa/ois-cfa.git
    targetRevision: main
    path: ops/gitops/argocd/apps
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
```

### Sync –ø–æ—Ä—è–¥–æ–∫

1. **System** (–±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
   - ArgoCD, Ingress, Monitoring
2. **Platform** (–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã)
   - Keycloak, Vault, PostgreSQL
3. **Business** (–±–∏–∑–Ω–µ—Å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
   - API Gateway, Services, Frontend

---

## GitLab Agent Setup

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
ops/gitops/gitlab-agent/
‚îú‚îÄ‚îÄ agent-config.yaml      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
‚îú‚îÄ‚îÄ manifests/             # –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ system/           # System manifests
‚îÇ   ‚îú‚îÄ‚îÄ platform/         # Platform manifests
‚îÇ   ‚îî‚îÄ‚îÄ business/         # Business manifests
‚îî‚îÄ‚îÄ README.md
```

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞

1. **–í GitLab UI:**
   - Infrastructure ‚Üí Kubernetes clusters
   - Add Kubernetes cluster ‚Üí GitLab Agent
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–≥–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ois-cfa-agent`)

2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≥–µ–Ω—Ç–∞:**

```bash
# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ GitLab UI
AGENT_TOKEN="your-agent-token"

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ Helm
helm repo add gitlab https://charts.gitlab.io
helm install gitlab-agent gitlab/gitlab-agent \
  --namespace gitlab-agent \
  --create-namespace \
  --set config.token=${AGENT_TOKEN} \
  --set config.kasAddress=wss://gitlab.com/-/kubernetes-agent/
```

3. **–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤:**

–í GitLab UI:
- Infrastructure ‚Üí Kubernetes clusters ‚Üí –≤–∞—à –∫–ª–∞—Å—Ç–µ—Ä
- Connected agents ‚Üí –≤–∞—à –∞–≥–µ–Ω—Ç
- Add manifest repository
- –£–∫–∞–∑–∞—Ç—å –ø—É—Ç—å: `ops/gitops/gitlab-agent/manifests`

### Sync –ø—Ä–∞–≤–∏–ª–∞

```yaml
# .gitlab/agents/ois-cfa-agent/config.yaml
gitops:
  manifest_projects:
    - id: ois-cfa/ois-cfa
      default_namespace: default
      paths:
        - glob: 'ops/gitops/gitlab-agent/manifests/system/**'
          sync_policy:
            order: 1
        - glob: 'ops/gitops/gitlab-agent/manifests/platform/**'
          sync_policy:
            order: 2
            depends_on:
              - 'ops/gitops/gitlab-agent/manifests/system/**'
        - glob: 'ops/gitops/gitlab-agent/manifests/business/**'
          sync_policy:
            order: 3
            depends_on:
              - 'ops/gitops/gitlab-agent/manifests/platform/**'
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ GitOps

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Git Repository                     ‚îÇ
‚îÇ  (ops/gitops/argocd/apps –∏–ª–∏ manifests/)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         GitOps Controller                        ‚îÇ
‚îÇ  (ArgoCD Application Controller –∏–ª–∏ GitLab KAS) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº           ‚ñº           ‚ñº
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ System ‚îÇ  ‚îÇPlatform ‚îÇ  ‚îÇBusiness ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ           ‚îÇ           ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   Kubernetes Cluster  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ä—è–¥–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

1. **System** (–±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
   - Namespaces
   - Ingress Controller
   - Monitoring (Prometheus, Grafana)
   - ArgoCD (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

2. **Platform** (–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã)
   - Keycloak (SSO)
   - Vault (secrets)
   - PostgreSQL
   - Kafka
   - Redis

3. **Business** (–±–∏–∑–Ω–µ—Å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
   - API Gateway
   - Backend Services (Identity, Issuance, Registry, Settlement)
   - Frontend (Portal Issuer, Portal Investor, Backoffice)
   - Hyperledger Fabric (Peers, Orderers, CA)

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ArgoCD

1. **SSO (Keycloak):**
   - OIDC –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –ì—Ä—É–ø–ø—ã –∏ —Ä–æ–ª–∏
   - Session management

2. **RBAC:**
   - Project-based –∏–∑–æ–ª—è—Ü–∏—è
   - –†–æ–ª–∏: admin, developer, auditor
   - –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞

3. **–ê—É–¥–∏—Ç:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SIEM

### GitLab Agent

1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
   - GitLab —Ç–æ–∫–µ–Ω—ã
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitLab RBAC

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–µ—Ç–∏:**
   - Pull-based –º–æ–¥–µ–ª—å
   - –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

3. **–ê—É–¥–∏—Ç:**
   - –õ–æ–≥–∏ –≤ GitLab
   - Audit logs –≤ Kubernetes

---

## Troubleshooting

### ArgoCD

**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
kubectl get applications -n argocd

# –õ–æ–≥–∏
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
argocd app sync <app-name>
```

**SSO –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
kubectl get configmap argocd-cm -n argocd -o yaml

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Keycloak
curl -k https://keycloak.example.com/realms/argocd/.well-known/openid-configuration
```

### GitLab Agent

**–ê–≥–µ–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
kubectl get pods -n gitlab-agent

# –õ–æ–≥–∏
kubectl logs -n gitlab-agent -l app=gitlab-agent

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω
kubectl get secret -n gitlab-agent gitlab-agent-token
```

**–ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ (YAML)

---

## –°—Å—ã–ª–∫–∏

- [ArgoCD Documentation](https://argo-cd.readthedocs.io/)
- [GitLab Kubernetes Agent](https://docs.gitlab.com/ee/user/clusters/agent/)
- [GitOps Principles](https://www.gitops.tech/)
- [App-of-Apps Pattern](https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/)

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í—Å–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Europe/Moscow (UTC+3).


```

`ops/helm.md`:

```md
# Helm Charts –¥–ª—è OIS-CFA

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–í–ª–∞–¥–µ–ª–µ—Ü:** DevOps/SRE

---

## –û–±–∑–æ—Ä

Helm charts –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞ OIS-CFA.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
ops/infra/helm/
‚îú‚îÄ‚îÄ api-gateway/          # API Gateway
‚îú‚îÄ‚îÄ identity/             # Identity Service
‚îú‚îÄ‚îÄ issuance/             # Issuance Service
‚îú‚îÄ‚îÄ registry/             # Registry Service
‚îú‚îÄ‚îÄ settlement/           # Settlement Service
‚îú‚îÄ‚îÄ compliance/           # Compliance Service
‚îú‚îÄ‚îÄ bank-nominal/         # Bank Nominal Integration
‚îú‚îÄ‚îÄ portal-issuer/        # Portal Issuer (Next.js)
‚îú‚îÄ‚îÄ portal-investor/      # Portal Investor (Next.js)
‚îú‚îÄ‚îÄ broker-portal/        # Broker Portal (Next.js)
‚îî‚îÄ‚îÄ backoffice/           # Backoffice (Next.js)
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Chart

–ö–∞–∂–¥—ã–π chart –≤–∫–ª—é—á–∞–µ—Ç:
- `Chart.yaml` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ chart
- `values.yaml` ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- `values-dev.yaml` ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è dev
- `values-staging.yaml` ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è staging
- `values-prod.yaml` ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è prod
- `templates/` ‚Äî Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã:
  - `deployment.yaml`
  - `service.yaml`
  - `ingress.yaml`
  - `servicemonitor.yaml`
  - `serviceaccount.yaml`
  - `hpa.yaml` (–µ—Å–ª–∏ autoscaling –≤–∫–ª—é—á–µ–Ω)
  - `_helpers.tpl`

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ Helm

```bash
# Dev
helm install api-gateway ops/infra/helm/api-gateway \
  --namespace ois-cfa \
  --create-namespace \
  -f ops/infra/helm/api-gateway/values-dev.yaml

# Staging
helm install api-gateway ops/infra/helm/api-gateway \
  --namespace ois-cfa \
  --create-namespace \
  -f ops/infra/helm/api-gateway/values-staging.yaml

# Production
helm install api-gateway ops/infra/helm/api-gateway \
  --namespace ois-cfa \
  --create-namespace \
  -f ops/infra/helm/api-gateway/values-prod.yaml
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
helm upgrade api-gateway ops/infra/helm/api-gateway \
  --namespace ois-cfa \
  -f ops/infra/helm/api-gateway/values-prod.yaml
```

### –£–¥–∞–ª–µ–Ω–∏–µ

```bash
helm uninstall api-gateway --namespace ois-cfa
```

---

## –ß–µ—Ä–µ–∑ GitOps

### ArgoCD

Charts –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ ArgoCD Applications (—Å–º. `ops/gitops/argocd/apps/`).

### GitLab Agent

–ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∏–∑ charts –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ GitLab Agent.

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏–π

### –û–±—â–∏–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-----------|----------|--------------|
| `replicaCount` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–ø–ª–∏–∫ | 2 |
| `image.repository` | Docker image repository | - |
| `image.tag` | Docker image tag | latest |
| `service.type` | Service type | ClusterIP |
| `ingress.enabled` | –í–∫–ª—é—á–∏—Ç—å Ingress | true |

### –°–µ–∫—Ä–µ—Ç—ã

–°–µ–∫—Ä–µ—Ç—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑:
- **Sealed Secrets** (dev/staging)
- **Vault** (production)

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ `values.yaml`:
```yaml
secrets:
  enabled: true
  type: "sealed-secrets" # or "vault"
  name: "api-gateway-secrets"
```

---

## ServiceMonitor

ServiceMonitor –¥–ª—è Prometheus –≤–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑:
```yaml
serviceMonitor:
  enabled: true
  interval: 30s
  path: /metrics
```

---

## Ingress –∏ CertManager

Ingress –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ CertManager:

```yaml
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  tls:
    - secretName: api-gateway-tls
      hosts:
        - api.ois-cfa.example.com
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- CertManager —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
- ClusterIssuer `letsencrypt-prod` –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

## Health Checks

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–º–µ—é—Ç health checks:

```yaml
livenessProbe:
  httpGet:
    path: /health/live
    port: 8080

readinessProbe:
  httpGet:
    path: /health/ready
    port: 8080
```

---

## Autoscaling

HPA (Horizontal Pod Autoscaler) –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑:

```yaml
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
```

---

## –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ Chart

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞

```bash
# –°–æ–∑–¥–∞—Ç—å chart –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞
./scripts/create-helm-chart.sh identity service

# –°–æ–∑–¥–∞—Ç—å chart –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
./scripts/create-helm-chart.sh portal-issuer app
```

### –í—Ä—É—á–Ω—É—é

1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `api-gateway` chart
2. –ó–∞–º–µ–Ω–∏—Ç—å `api-gateway` –Ω–∞ –∏–º—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
3. –û–±–Ω–æ–≤–∏—Ç—å `values.yaml` —Å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
4. –û–±–Ω–æ–≤–∏—Ç—å `values-*.yaml` –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏–π

---

## Troubleshooting

### Pod –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
kubectl logs -n ois-cfa deployment/api-gateway

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
kubectl describe pod -n ois-cfa -l app.kubernetes.io/name=api-gateway
```

### Ingress –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Ingress
kubectl get ingress -n ois-cfa

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CertManager
kubectl get certificate -n ois-cfa
kubectl describe certificate api-gateway-tls -n ois-cfa
```

### ServiceMonitor –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ServiceMonitor
kubectl get servicemonitor -n ois-cfa

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Prometheus targets
# –í Prometheus UI: Status ‚Üí Targets
```

---

## –°—Å—ã–ª–∫–∏

- [Helm Documentation](https://helm.sh/docs/)
- [CertManager](https://cert-manager.io/)
- [Prometheus Operator](https://prometheus-operator.dev/)

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í—Å–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Europe/Moscow (UTC+3).


```

`ops/production-deployment-master-plan.md`:

```md
# –ú–∞—Å—Ç–µ—Ä-–ø–ª–∞–Ω –≤—ã–∫–∞—Ç–∫–∏ –≤ Production

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–±–æ—Ç–µ  
**–í–ª–∞–¥–µ–ª–µ—Ü:** Technical Lead / DevOps

---

## üéØ –¶–ï–õ–¨

–í—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod –≤ production —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ –¥–æ–º–µ–Ω—É `https://cfa.capital/` —á–µ—Ä–µ–∑ IP, –∑–∞—Ç–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É –û–ò–°.

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ **GitLab:** https://git.telex.global
- ‚úÖ **Kubernetes –∫–ª–∞—Å—Ç–µ—Ä:** Timeweb Cloud (1 worker node, v1.34.1)
- ‚úÖ **–î–æ–º–µ–Ω:** https://cfa.capital/
- ‚úÖ **Ingress NGINX:** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **GitLab Agent:** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (2 pod'–∞ Running)
- ‚ö†Ô∏è **GitLab Runner:** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden (—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã
- **Services:** identity, issuance, registry, settlement, compliance, fabric-gateway
- **Apps:** api-gateway, portal-issuer, portal-investor, broker-portal, backoffice
- **Helm Charts:** api-gateway, fabric-*, chaincode-*

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. GitLab Runner –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ë–õ–û–ö–ï–†)
**–ü—Ä–æ–±–ª–µ–º–∞:** Runner –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden, jobs –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è  
**–ü—Ä–∏—á–∏–Ω–∞:** Runner Registration Token –∏—Å—Ç—ë–∫ –∏–ª–∏ –æ—Ç–æ–∑–≤–∞–Ω  
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏ –æ–±–Ω–æ–≤–∏—Ç—å ConfigMap

### 2. –ù–µ—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–¥—ã (ingress, gitlab-agent, gitlab-runner)  
**–†–µ—à–µ–Ω–∏–µ:** –í—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod, –∑–∞—Ç–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

---

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô (–ø–æ—à–∞–≥–æ–≤–æ)

### –§–ê–ó–ê 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GitLab Runner (–ö–†–ò–¢–ò–ß–ù–û)

**–¶–µ–ª—å:** –û–±–µ—Å–ø–µ—á–∏—Ç—å —Ä–∞–±–æ—Ç—É CI/CD pipeline

#### –®–∞–≥ 1.1: –ü–æ–ª—É—á–∏—Ç—å Runner Registration Token
- [ ] –û—Ç–∫—Ä—ã—Ç—å: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
- [ ] –†–∞–∑–¥–µ–ª: Runners
- [ ] –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω ‚Üí "Reset registration token"
- [ ] –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω

#### –®–∞–≥ 1.2: –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
```bash
export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
make gitlab-runner-update-token
kubectl delete pods -n gitlab-runner -l app=gitlab-runner
```

#### –®–∞–≥ 1.3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
```bash
make gitlab-runner-status
# –í GitLab UI: Settings ‚Üí CI/CD ‚Üí Runners ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Online"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** Runner "Online" –≤ GitLab UI, jobs –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è

---

### –§–ê–ó–ê 2: –¢–µ—Å—Ç–æ–≤—ã–π Pod (MVP –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)

**–¶–µ–ª—å:** –í—ã–∫–∞—Ç–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π pod —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ IP/–¥–æ–º–µ–Ω—É

#### –®–∞–≥ 2.1: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π deployment
- [ ] –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π nginx deployment
- [ ] –°–æ–∑–¥–∞—Ç—å Service (NodePort –∏–ª–∏ LoadBalancer)
- [ ] –°–æ–∑–¥–∞—Ç—å Ingress –¥–ª—è –¥–æ–º–µ–Ω–∞ cfa.capital

#### –®–∞–≥ 2.2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pod –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ IP –∫–ª–∞—Å—Ç–µ—Ä–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ –¥–æ–º–µ–Ω—É (–µ—Å–ª–∏ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –¢–µ—Å—Ç–æ–≤—ã–π pod –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ IP –∏ –¥–æ–º–µ–Ω—É

---

### –§–ê–ó–ê 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitOps (GitLab Agent)

**–¶–µ–ª—å:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤

#### –®–∞–≥ 3.1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitLab Agent
```bash
kubectl get pods -n gitlab-agent
kubectl logs -n gitlab-agent -l app=gitlab-agent
```

#### –®–∞–≥ 3.2: –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–≥–µ–Ω—Ç–∞
- [ ] –°–æ–∑–¥–∞—Ç—å `.gitlab/agents/ois-cfa-agent/config.yaml`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É—Ç–∏ –∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞–º
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

#### –®–∞–≥ 3.3: –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
```
ops/gitops/gitlab-agent/manifests/
‚îú‚îÄ‚îÄ system/      # Ingress, Monitoring
‚îú‚îÄ‚îÄ platform/    # PostgreSQL, Redis (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
‚îî‚îÄ‚îÄ business/    # API Gateway, Services, Frontend
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** GitLab Agent —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ Git

---

### –§–ê–ó–ê 4: –í—ã–∫–∞—Ç–∫–∞ API Gateway (–ø–µ—Ä–≤—ã–π —Ä–µ–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å)

**–¶–µ–ª—å:** –í—ã–∫–∞—Ç–∏—Ç—å API Gateway –∫–∞–∫ —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É

#### –®–∞–≥ 4.1: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å Helm chart
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `ops/infra/helm/api-gateway/values-prod.yaml`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞–∑ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å placeholder
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Ingress –¥–ª—è cfa.capital

#### –®–∞–≥ 4.2: –í—ã–∫–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Helm
```bash
helm install api-gateway ops/infra/helm/api-gateway \
  --namespace ois-cfa \
  --create-namespace \
  -f ops/infra/helm/api-gateway/values-prod.yaml
```

#### –®–∞–≥ 4.3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pod –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Ingress
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** API Gateway –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ https://cfa.capital/api

---

### –§–ê–ó–ê 5: CI/CD Pipeline –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤—ã–∫–∞—Ç–∫–∏

**–¶–µ–ª—å:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–±–æ—Ä–∫—É –∏ –≤—ã–∫–∞—Ç–∫—É —á–µ—Ä–µ–∑ GitLab CI

#### –®–∞–≥ 5.1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å build jobs
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ build jobs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±—Ä–∞–∑—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ GitLab Registry

#### –®–∞–≥ 5.2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å deploy jobs
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å deploy –¥–ª—è dev/staging/prod
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å GitLab Agent –∏–ª–∏ ArgoCD
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å manual approval –¥–ª—è prod

#### –®–∞–≥ 5.3: –¢–µ—Å—Ç–æ–≤–∞—è –≤—ã–∫–∞—Ç–∫–∞ —á–µ—Ä–µ–∑ pipeline
- [ ] –°–æ–∑–¥–∞—Ç—å MR
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å pipeline
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ deploy job –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –∫–ª–∞—Å—Ç–µ—Ä

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Helm Charts

```
ops/infra/helm/
‚îú‚îÄ‚îÄ api-gateway/          # API Gateway (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
‚îÇ   ‚îú‚îÄ‚îÄ values.yaml       # –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ values-prod.yaml  # Production –∑–Ω–∞—á–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ templates/        # Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ identity/             # Identity Service
‚îú‚îÄ‚îÄ issuance/             # Issuance Service
‚îú‚îÄ‚îÄ registry/             # Registry Service
‚îú‚îÄ‚îÄ settlement/           # Settlement Service
‚îî‚îÄ‚îÄ ...
```

### Ingress –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–î–æ–º–µ–Ω: `cfa.capital`
- API: `https://cfa.capital/api`
- Portal Issuer: `https://cfa.capital/issuer`
- Portal Investor: `https://cfa.capital/investor`
- Backoffice: `https://cfa.capital/admin`

### Namespace —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
ois-cfa/              # –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
fabric-network/       # Hyperledger Fabric
gitlab-agent/         # GitLab Agent
gitlab-runner/        # GitLab Runner
ingress-nginx/        # Ingress Controller
```

---

## üìù –ß–ï–ö–õ–ò–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] Kubernetes –∫–ª–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Ingress NGINX —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] GitLab Agent —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] GitLab Runner —Ä–∞–±–æ—Ç–∞–µ—Ç (–∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω!)

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π pod –≤—ã–∫–∞—á–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] API Gateway –≤—ã–∫–∞—á–µ–Ω
- [ ] Ingress –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –¥–æ–º–µ–Ω–∞
- [ ] DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–∏–ª–∏ –¥–æ—Å—Ç—É–ø –ø–æ IP)

### CI/CD
- [ ] Build jobs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Deploy jobs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] GitOps —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢ (–º–∏–Ω–∏–º—É–º –¥–ª—è —Ç–µ—Å—Ç–∞)

```bash
# 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Runner
export RUNNER_TOKEN="—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
make gitlab-runner-update-token

# 2. –í—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod
kubectl apply -f ops/infra/k8s/test-pod.yaml

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
kubectl get svc -n ois-cfa
curl http://<EXTERNAL-IP>
```

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

- [GitLab Runner Troubleshooting](./gitlab-runner-troubleshooting.md)
- [GitOps Setup](./gitops.md)
- [Helm Charts](./helm.md)
- [Ingress Configuration](../infra/k8s/ingress.yaml)

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

1. **–û–¥–∏–Ω worker node** - –Ω–µ—Ç HA, –Ω—É–∂–µ–Ω –º–∏–Ω–∏–º—É–º 3 —É–∑–ª–∞ –¥–ª—è production
2. **–ù–µ—Ç LoadBalancer** - –∏—Å–ø–æ–ª—å–∑—É–µ–º NodePort –∏–ª–∏ Ingress
3. **–¢–æ–∫–µ–Ω Runner** - –º–æ–∂–µ—Ç –∏—Å—Ç–µ—á—å, –Ω—É–∂–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è
4. **DNS** - –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IP –≤—Ä–µ–º–µ–Ω–Ω–æ

---

## üìÖ TIMELINE

- **–î–µ–Ω—å 1:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å Runner, –≤—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod
- **–î–µ–Ω—å 2:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GitOps, –≤—ã–∫–∞—Ç–∏—Ç—å API Gateway
- **–î–µ–Ω—å 3:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–∫–∞—Ç–∫–∞
- **–î–µ–Ω—å 4+:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –≤—ã–∫–∞—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—á–∞—Ç—å —Å –§–ê–ó–´ 1 - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GitLab Runner


```

`ops/production-deployment-master-prompt.md`:

```md
# üéØ –ú–ê–°–¢–ï–†-–ü–†–û–ú–ü–¢: –í—ã–∫–∞—Ç–∫–∞ –û–ò–° –¶–§–ê –≤ Production

**–í–µ—Ä—Å–∏—è:** 2.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω—ã–π  
**–í–ª–∞–¥–µ–ª–µ—Ü:** Technical Lead / DevOps

---

## üìã –ö–û–ù–¢–ï–ö–°–¢ –ò –¶–ï–õ–¨

**–¶–µ–ª—å:** –í—ã–∫–∞—Ç–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É –û–ò–° –¶–§–ê –≤ production –Ω–∞ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä Timeweb Cloud —Å –¥–æ—Å—Ç—É–ø–æ–º —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω `https://cfa.capital/`.

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ GitLab: https://git.telex.global
- ‚úÖ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä: Timeweb Cloud (1 worker node)
- ‚úÖ –î–æ–º–µ–Ω: https://cfa.capital/
- ‚úÖ Ingress NGINX: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚úÖ GitLab Agent: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ GitLab Runner: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –±—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- ‚ö†Ô∏è Build jobs: –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ –≤–µ—Ç–∫–µ `infra` (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞)
- ‚ö†Ô∏è –ù–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –≤—ã–∫–∞—Ç–∫–∏

#### 1. **Platform Services** (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
- PostgreSQL (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
- Redis (–∫—ç—à, —Å–µ—Å—Å–∏–∏)
- Kafka (event streaming)
- Keycloak (SSO/OIDC)
- Vault (secrets management, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### 2. **DLT Infrastructure** (Hyperledger Fabric)
- Fabric CA (Certificate Authority)
- Fabric Orderer (–∫–æ–Ω—Å–µ–Ω—Å—É—Å, Raft)
- Fabric Peer (–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
- Chaincode (issuance, registry)

#### 3. **Backend Services** (.NET 9)
- `api-gateway` - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- `identity` - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- `issuance` - –≤—ã–ø—É—Å–∫ –¶–§–ê
- `registry` - —Ä–µ–µ—Å—Ç—Ä –¶–§–ê
- `settlement` - —Ä–∞—Å—á–µ—Ç—ã, –≤—ã–ø–ª–∞—Ç—ã
- `compliance` - –∫–æ–º–ø–ª–∞–µ–Ω—Å, KYC
- `fabric-gateway` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Fabric
- `bank-nominal` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–Ω–∫–æ–º (mock)

#### 4. **Frontend Applications** (Next.js 15)
- `portal-issuer` - –ø–æ—Ä—Ç–∞–ª —ç–º–∏—Ç–µ–Ω—Ç–∞
- `portal-investor` - –ø–æ—Ä—Ç–∞–ª –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞
- `backoffice` - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª
- `broker-portal` - –ø–æ—Ä—Ç–∞–ª –±—Ä–æ–∫–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üìä –ü–û–†–Ø–î–û–ö –í–´–ö–ê–¢–ö–ò (Dependency Graph)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –§–ê–ó–ê 0: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Platform Services)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. PostgreSQL                                            ‚îÇ
‚îÇ 2. Redis                                                 ‚îÇ
‚îÇ 3. Kafka + Zookeeper                                     ‚îÇ
‚îÇ 4. Keycloak (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç PostgreSQL)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –§–ê–ó–ê 1: DLT Infrastructure (Hyperledger Fabric)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. Fabric CA                                             ‚îÇ
‚îÇ 2. Fabric Orderer (Raft)                                 ‚îÇ
‚îÇ 3. Fabric Peer                                           ‚îÇ
‚îÇ 4. Chaincode (issuance, registry)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –§–ê–ó–ê 2: Backend Services (–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. Identity Service (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç Keycloak, PostgreSQL)   ‚îÇ
‚îÇ 2. Fabric Gateway (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç Fabric Peer)              ‚îÇ
‚îÇ 3. Registry Service (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç Fabric, PostgreSQL)     ‚îÇ
‚îÇ 4. Issuance Service (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç Registry, PostgreSQL)  ‚îÇ
‚îÇ 5. Settlement Service (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç Registry, Kafka)      ‚îÇ
‚îÇ 6. Compliance Service (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç Identity, PostgreSQL)  ‚îÇ
‚îÇ 7. Bank Nominal (mock, –Ω–µ–∑–∞–≤–∏—Å–∏–º)                       ‚îÇ
‚îÇ 8. API Gateway (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –§–ê–ó–ê 3: Frontend Applications (Next.js)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. Portal Issuer (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç API Gateway)                ‚îÇ
‚îÇ 2. Portal Investor (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç API Gateway)            ‚îÇ
‚îÇ 3. Backoffice (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç API Gateway)                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ –ü–õ–ê–ù –í–´–ö–ê–¢–ö–ò (–ø–æ—à–∞–≥–æ–≤–æ)

### **–≠–¢–ê–ü 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**

#### 0.1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä
kubectl cluster-info
kubectl get nodes
kubectl get namespaces

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitLab Runner
kubectl get pods -n gitlab-runner
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitLab Agent
kubectl get pods -n gitlab-agent
kubectl logs -n gitlab-agent -l app=gitlab-agent --tail=50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Ingress
kubectl get ingress -A
```

#### 0.2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ CI/CD –¥–ª—è –≤–µ—Ç–∫–∏ `infra`
**–ü—Ä–æ–±–ª–µ–º–∞:** Build jobs –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ –≤–µ—Ç–∫–µ `infra`  
**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –≤ `.gitlab-ci.yml`:

```yaml
# –¢–µ–∫—É—â–µ–µ –ø—Ä–∞–≤–∏–ª–æ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –≤–µ—Ç–æ–∫):
rules:
  - if: '$CI_COMMIT_BRANCH || $CI_COMMIT_TAG'

# –î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –≤–µ—Ç–∫–∏ infra:
rules:
  - if: '$CI_COMMIT_BRANCH || $CI_COMMIT_TAG'
  - if: '$CI_COMMIT_BRANCH == "infra"'
```

#### 0.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ Dockerfile –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
```bash
# Backend Services
ls -la apps/api-gateway/Dockerfile
ls -la services/*/Dockerfile

# Frontend Apps
ls -la apps/*/Dockerfile

# Chaincode (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω Dockerfile –¥–ª—è —Å–±–æ—Ä–∫–∏)
ls -la chaincode/*/Dockerfile
```

#### 0.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ Helm Charts
```bash
ls -la ops/infra/helm/*/
```

---

### **–≠–¢–ê–ü 1: Platform Services (PostgreSQL, Redis, Kafka, Keycloak)**

**–¶–µ–ª—å:** –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É

#### 1.1. PostgreSQL
```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π Helm chart –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
helm repo add bitnami https://charts.bitnami.com/bitnami
helm install postgresql bitnami/postgresql \
  --namespace ois-cfa \
  --create-namespace \
  --set auth.postgresPassword=ois_prod_password \
  --set auth.database=ois \
  --set persistence.size=20Gi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app.kubernetes.io/name=postgresql
```

#### 1.2. Redis
```bash
helm install redis bitnami/redis \
  --namespace ois-cfa \
  --set auth.password=ois_redis_password \
  --set persistence.size=10Gi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app.kubernetes.io/name=redis
```

#### 1.3. Kafka + Zookeeper
```bash
helm repo add confluentinc https://confluentinc.github.io/cp-helm-charts/
helm install kafka confluentinc/cp-helm-charts \
  --namespace ois-cfa \
  --set cp-kafka.persistence.size=20Gi

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Strimzi operator (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)
```

#### 1.4. Keycloak
```bash
helm repo add codecentric https://codecentric.github.io/helm-charts
helm install keycloak codecentric/keycloak \
  --namespace ois-cfa \
  --set postgresql.enabled=false \
  --set externalDatabase.host=postgresql.ois-cfa.svc.cluster.local \
  --set externalDatabase.database=keycloak \
  --set externalDatabase.user=postgres \
  --set externalDatabase.password=ois_prod_password

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=keycloak
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –í—Å–µ platform services –≤ —Å—Ç–∞—Ç—É—Å–µ `Running`

---

### **–≠–¢–ê–ü 2: DLT Infrastructure (Hyperledger Fabric)**

**–¶–µ–ª—å:** –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å Hyperledger Fabric —Å–µ—Ç—å

#### 2.1. Fabric CA
```bash
helm install fabric-ca ops/infra/helm/fabric-ca \
  --namespace fabric-network \
  --create-namespace \
  -f ops/infra/helm/fabric-ca/values-prod.yaml

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n fabric-network -l app=fabric-ca
```

#### 2.2. Fabric Orderer (Raft)
```bash
helm install fabric-orderer ops/infra/helm/fabric-orderer \
  --namespace fabric-network \
  -f ops/infra/helm/fabric-orderer/values-prod.yaml

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n fabric-network -l app=fabric-orderer
```

#### 2.3. Fabric Peer
```bash
helm install fabric-peer ops/infra/helm/fabric-peer \
  --namespace fabric-network \
  -f ops/infra/helm/fabric-peer/values-prod.yaml

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n fabric-network -l app=fabric-peer
```

#### 2.4. Chaincode (issuance, registry)
```bash
# –°–æ–±—Ä–∞—Ç—å chaincode –æ–±—Ä–∞–∑—ã
cd chaincode/issuance
docker build -t $CI_REGISTRY_IMAGE/chaincode-issuance:$CI_COMMIT_SHA .
docker push $CI_REGISTRY_IMAGE/chaincode-issuance:$CI_COMMIT_SHA

cd ../registry
docker build -t $CI_REGISTRY_IMAGE/chaincode-registry:$CI_COMMIT_SHA .
docker push $CI_REGISTRY_IMAGE/chaincode-registry:$CI_COMMIT_SHA

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ Helm
helm install chaincode-issuance ops/infra/helm/chaincode-lifecycle \
  --namespace fabric-network \
  --set chaincode.name=issuance \
  --set chaincode.image=$CI_REGISTRY_IMAGE/chaincode-issuance:$CI_COMMIT_SHA

helm install chaincode-registry ops/infra/helm/chaincode-lifecycle \
  --namespace fabric-network \
  --set chaincode.name=registry \
  --set chaincode.image=$CI_REGISTRY_IMAGE/chaincode-registry:$CI_COMMIT_SHA
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** Fabric —Å–µ—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç, chaincode —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω

---

### **–≠–¢–ê–ü 3: Backend Services**

**–¶–µ–ª—å:** –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

#### 3.1. Identity Service
```bash
# –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ (—á–µ—Ä–µ–∑ CI/CD –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
# Build job –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å: $CI_REGISTRY_IMAGE/identity:$CI_COMMIT_SHA

# –í—ã–∫–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Helm
helm install identity ops/infra/helm/identity \
  --namespace ois-cfa \
  --create-namespace \
  --set image.repository=$CI_REGISTRY_IMAGE/identity \
  --set image.tag=$CI_COMMIT_SHA \
  --set postgresql.host=postgresql.ois-cfa.svc.cluster.local \
  --set keycloak.url=http://keycloak.ois-cfa.svc.cluster.local

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=identity
kubectl logs -n ois-cfa -l app=identity --tail=50
```

#### 3.2. Fabric Gateway
```bash
helm install fabric-gateway ops/infra/helm/fabric-gateway \
  --namespace ois-cfa \
  --set fabric.peer.url=fabric-peer.fabric-network.svc.cluster.local:7051

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=fabric-gateway
```

#### 3.3. Registry Service
```bash
helm install registry ops/infra/helm/registry \
  --namespace ois-cfa \
  --set image.repository=$CI_REGISTRY_IMAGE/registry \
  --set image.tag=$CI_COMMIT_SHA \
  --set fabric.gateway.url=fabric-gateway.ois-cfa.svc.cluster.local \
  --set postgresql.host=postgresql.ois-cfa.svc.cluster.local

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=registry
```

#### 3.4. Issuance Service
```bash
helm install issuance ops/infra/helm/issuance \
  --namespace ois-cfa \
  --set image.repository=$CI_REGISTRY_IMAGE/issuance \
  --set image.tag=$CI_COMMIT_SHA \
  --set registry.url=http://registry.ois-cfa.svc.cluster.local \
  --set postgresql.host=postgresql.ois-cfa.svc.cluster.local

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=issuance
```

#### 3.5. Settlement Service
```bash
helm install settlement ops/infra/helm/settlement \
  --namespace ois-cfa \
  --set image.repository=$CI_REGISTRY_IMAGE/settlement \
  --set image.tag=$CI_COMMIT_SHA \
  --set registry.url=http://registry.ois-cfa.svc.cluster.local \
  --set kafka.brokers=kafka.ois-cfa.svc.cluster.local:9092

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=settlement
```

#### 3.6. Compliance Service
```bash
helm install compliance ops/infra/helm/compliance \
  --namespace ois-cfa \
  --set image.repository=$CI_REGISTRY_IMAGE/compliance \
  --set image.tag=$CI_COMMIT_SHA \
  --set identity.url=http://identity.ois-cfa.svc.cluster.local \
  --set postgresql.host=postgresql.ois-cfa.svc.cluster.local

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=compliance
```

#### 3.7. Bank Nominal (mock)
```bash
helm install bank-nominal ops/infra/helm/bank-nominal \
  --namespace ois-cfa \
  --set image.repository=$CI_REGISTRY_IMAGE/bank-nominal \
  --set image.tag=$CI_COMMIT_SHA

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=bank-nominal
```

#### 3.8. API Gateway (–ø–æ—Å–ª–µ–¥–Ω–∏–π, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Å–µ—Ö)
```bash
helm install api-gateway ops/infra/helm/api-gateway \
  --namespace ois-cfa \
  --create-namespace \
  -f ops/infra/helm/api-gateway/values-prod.yaml \
  --set image.repository=$CI_REGISTRY_IMAGE/api-gateway \
  --set image.tag=$CI_COMMIT_SHA \
  --set ingress.hosts[0].host=api.cfa.capital \
  --set services.identity.url=http://identity.ois-cfa.svc.cluster.local \
  --set services.issuance.url=http://issuance.ois-cfa.svc.cluster.local \
  --set services.registry.url=http://registry.ois-cfa.svc.cluster.local \
  --set services.settlement.url=http://settlement.ois-cfa.svc.cluster.local \
  --set services.compliance.url=http://compliance.ois-cfa.svc.cluster.local

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=api-gateway
kubectl get ingress -n ois-cfa
curl https://api.cfa.capital/health
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –í—Å–µ backend services –≤ —Å—Ç–∞—Ç—É—Å–µ `Running`, API Gateway –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ Ingress

---

### **–≠–¢–ê–ü 4: Frontend Applications**

**–¶–µ–ª—å:** –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

#### 4.1. Portal Issuer
```bash
# Build job –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å: $CI_REGISTRY_IMAGE/portal-issuer:$CI_COMMIT_SHA

helm install portal-issuer ops/infra/helm/portal-issuer \
  --namespace ois-cfa \
  --set image.repository=$CI_REGISTRY_IMAGE/portal-issuer \
  --set image.tag=$CI_COMMIT_SHA \
  --set ingress.hosts[0].host=issuer.cfa.capital \
  --set env.NEXT_PUBLIC_API_URL=https://api.cfa.capital

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=portal-issuer
curl https://issuer.cfa.capital
```

#### 4.2. Portal Investor
```bash
helm install portal-investor ops/infra/helm/portal-investor \
  --namespace ois-cfa \
  --set image.repository=$CI_REGISTRY_IMAGE/portal-investor \
  --set image.tag=$CI_COMMIT_SHA \
  --set ingress.hosts[0].host=investor.cfa.capital \
  --set env.NEXT_PUBLIC_API_URL=https://api.cfa.capital

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=portal-investor
curl https://investor.cfa.capital
```

#### 4.3. Backoffice
```bash
helm install backoffice ops/infra/helm/backoffice \
  --namespace ois-cfa \
  --set image.repository=$CI_REGISTRY_IMAGE/backoffice \
  --set image.tag=$CI_COMMIT_SHA \
  --set ingress.hosts[0].host=admin.cfa.capital \
  --set env.NEXT_PUBLIC_API_URL=https://api.cfa.capital

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa -l app=backoffice
curl https://admin.cfa.capital
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –í—Å–µ frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ Ingress

---

## üîß –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –ß–ï–†–ï–ó CI/CD

### –û–±–Ω–æ–≤–∏—Ç—å `.gitlab-ci.yml` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤—ã–∫–∞—Ç–∫–∏

#### –î–æ–±–∞–≤–∏—Ç—å deploy jobs –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:

```yaml
# Deploy Platform Services
deploy:postgresql:
  stage: deploy
  image: bitnami/helm:latest
  script:
    - helm upgrade --install postgresql bitnami/postgresql ...
  rules:
    - if: '$CI_COMMIT_BRANCH == "infra"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# Deploy Backend Services
deploy:identity:
  stage: deploy
  image: bitnami/helm:latest
  dependencies:
    - build:identity
  script:
    - helm upgrade --install identity ops/infra/helm/identity ...
  rules:
    - if: '$CI_COMMIT_BRANCH == "infra"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞...
```

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] Kubernetes –∫–ª–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Ingress NGINX —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] GitLab Agent —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] GitLab Runner —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Build jobs –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ –≤–µ—Ç–∫–µ `infra`

### Platform Services
- [ ] PostgreSQL —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] Redis —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] Kafka —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] Keycloak —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω

### DLT Infrastructure
- [ ] Fabric CA —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Fabric Orderer —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Fabric Peer —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Chaincode —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω

### Backend Services
- [ ] Identity Service —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Fabric Gateway —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Registry Service —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Issuance Service —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Settlement Service —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Compliance Service —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Bank Nominal —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] API Gateway —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ Ingress

### Frontend Applications
- [ ] Portal Issuer –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] Portal Investor –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] Backoffice –¥–æ—Å—Ç—É–ø–µ–Ω

### CI/CD
- [ ] Build jobs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Deploy jobs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] GitOps —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Build jobs –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ –≤–µ—Ç–∫–µ `infra`
**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –≤ `.gitlab-ci.yml`:
```yaml
rules:
  - if: '$CI_COMMIT_BRANCH || $CI_COMMIT_TAG'
  - if: '$CI_COMMIT_BRANCH == "infra"'
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
**–†–µ—à–µ–Ω–∏–µ:** 
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å resource requests/limits
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω worker node –¥–ª—è MVP
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è production

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç Helm Charts
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–µ Helm charts –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç Dockerfile
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å Dockerfile –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

---

## üìÖ TIMELINE (–ø—Ä–∏–º–µ—Ä–Ω—ã–π)

- **–î–µ–Ω—å 1:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å CI/CD –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å build jobs
- **–î–µ–Ω—å 2:** –í—ã–∫–∞—Ç–∏—Ç—å Platform Services (PostgreSQL, Redis, Kafka, Keycloak)
- **–î–µ–Ω—å 3:** –í—ã–∫–∞—Ç–∏—Ç—å DLT Infrastructure (Fabric CA, Orderer, Peer, Chaincode)
- **–î–µ–Ω—å 4:** –í—ã–∫–∞—Ç–∏—Ç—å Backend Services (Identity, Registry, Issuance, Settlement, Compliance, API Gateway)
- **–î–µ–Ω—å 5:** –í—ã–∫–∞—Ç–∏—Ç—å Frontend Applications (Portal Issuer, Portal Investor, Backoffice)
- **–î–µ–Ω—å 6:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- **–î–µ–Ω—å 7+:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

- [Production Deployment Master Plan](./production-deployment-master-plan.md)
- [GitOps Setup](./gitops.md)
- [Helm Charts](./helm.md)
- [GitLab CI/CD](./gitlab-ci.md)
- [Architecture Overview](../architecture/10-HighLevel-Architecture.md)

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

1. **–û–¥–∏–Ω worker node** - –Ω–µ—Ç HA, –Ω—É–∂–µ–Ω –º–∏–Ω–∏–º—É–º 3 —É–∑–ª–∞ –¥–ª—è production
2. **–†–µ—Å—É—Ä—Å—ã** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ CPU/memory –Ω–∞ –æ–¥–Ω–æ–º —É–∑–ª–µ
3. **DNS** - –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IP –≤—Ä–µ–º–µ–Ω–Ω–æ
4. **Secrets** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Vault –∏–ª–∏ Kubernetes Secrets
5. **Backup** - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –¥–ª—è PostgreSQL –∏ Fabric

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—á–∞—Ç—å —Å –≠–¢–ê–ü–ê 0 - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞


```

`ops/production-deployment-status.md`:

```md
# –°—Ç–∞—Ç—É—Å –≤—ã–∫–∞—Ç–∫–∏ –≤ Production

**–î–∞—Ç–∞:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π pod –≤—ã–∫–∞—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

### 1. –¢–µ—Å—Ç–æ–≤—ã–π pod –≤—ã–∫–∞—á–µ–Ω
- **Namespace:** `ois-cfa`
- **Deployment:** `test-nginx`
- **Service:** `test-nginx` (ClusterIP)
- **Ingress:** `test-nginx` –¥–ª—è –¥–æ–º–µ–Ω–∞ `cfa.capital`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ Running (1/1 Ready)

### 2. –î–æ—Å—Ç—É–ø —Ä–∞–±–æ—Ç–∞–µ—Ç
- **Node IP:** `217.25.93.83`
- **–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Ingress:** `http://cfa.capital` (–µ—Å–ª–∏ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- **–î–æ—Å—Ç—É–ø –ø–æ IP:** `http://217.25.93.83 -H 'Host: cfa.capital'`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ curl –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç nginx welcome page

### 3. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç (1 worker node)
- ‚úÖ Ingress NGINX —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ GitLab Agent —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (2 pod'–∞ Running)
- ‚ö†Ô∏è GitLab Runner —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

---

## ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ –í–ù–ò–ú–ê–ù–ò–Ø

### GitLab Runner (–ë–õ–û–ö–ï–† –¥–ª—è CI/CD)

**–ü—Ä–æ–±–ª–µ–º–∞:** Runner –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden, jobs –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π Runner Registration Token:**
   - –û—Ç–∫—Ä—ã—Ç—å: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
   - –†–∞–∑–¥–µ–ª: Runners
   - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω ‚Üí "Reset registration token"
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω

2. **–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ:**
   ```bash
   export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
   make gitlab-runner-update-token
   kubectl delete pods -n gitlab-runner -l app=gitlab-runner
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:**
   ```bash
   make gitlab-runner-status
   # –í GitLab UI: Settings ‚Üí CI/CD ‚Üí Runners ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Online"
   ```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä-—Å–∫—Ä–∏–ø—Ç:**
```bash
export RUNNER_TOKEN="—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
./ops/scripts/fix-runner-and-deploy.sh
```

---

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –§–∞–∑–∞ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å Runner (–ö–†–ò–¢–ò–ß–ù–û)
- [ ] –ü–æ–ª—É—á–∏—Ç—å Runner Registration Token –∏–∑ GitLab UI
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Runner "Online" –≤ GitLab UI
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π job –≤ GitLab CI

### –§–∞–∑–∞ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GitOps
- [ ] –°–æ–∑–¥–∞—Ç—å `.gitlab/agents/ois-cfa-agent/config.yaml`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É—Ç–∏ –∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞–º
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ GitLab Agent

### –§–∞–∑–∞ 3: –í—ã–∫–∞—Ç–∏—Ç—å API Gateway
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `values-prod.yaml` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –¥–æ–º–µ–Ω–æ–º
- [ ] –í—ã–∫–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Helm –∏–ª–∏ GitOps
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ `https://api.cfa.capital`

### –§–∞–∑–∞ 4: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNS
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å A-–∑–∞–ø–∏—Å—å –¥–ª—è `cfa.capital` ‚Üí `217.25.93.83`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å A-–∑–∞–ø–∏—Å—å –¥–ª—è `api.cfa.capital` ‚Üí `217.25.93.83`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ –¥–æ–º–µ–Ω—É

---

## üîß –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"
kubectl get pods -n ois-cfa
kubectl get svc -n ois-cfa
kubectl get ingress -n ois-cfa

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
NODE_IP="217.25.93.83"
curl -H "Host: cfa.capital" "http://${NODE_IP}"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Runner
make gitlab-runner-status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitLab Agent
kubectl get pods -n gitlab-agent
```

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –ö–õ–ê–°–¢–ï–†–ê

```
Namespaces:
- ois-cfa (—Ç–µ—Å—Ç–æ–≤—ã–π pod)
- gitlab-agent (GitLab Agent)
- gitlab-runner (GitLab Runner - —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- ingress-nginx (Ingress Controller)

Pods:
- test-nginx: Running (1/1)
- gitlab-agent: Running (2/2)
- gitlab-runner: Running, –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç 403 (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
```

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

- [x] –¢–µ—Å—Ç–æ–≤—ã–π pod –≤—ã–∫–∞—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Ingress –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –¥–æ–º–µ–Ω–∞
- [x] –î–æ—Å—Ç—É–ø –ø–æ IP —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] GitLab Runner —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
- [ ] DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] API Gateway –≤—ã–∫–∞—á–µ–Ω
- [ ] CI/CD pipeline —Ä–∞–±–æ—Ç–∞–µ—Ç

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å GitLab Runner —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞–ø—É—Å–∫–∞ CI/CD jobs


```

`ops/quick-start-production.md`:

```md
# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –í—ã–∫–∞—Ç–∫–∞ –≤ Production

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27

---

## üéØ –¶–µ–ª—å

–í—ã–∫–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod –≤ production —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ –¥–æ–º–µ–Ω—É `cfa.capital`.

---

## ‚úÖ –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

- ‚úÖ **–¢–µ—Å—Ç–æ–≤—ã–π pod –≤—ã–∫–∞—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç**
- ‚úÖ **Ingress –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –¥–æ–º–µ–Ω–∞ `cfa.capital`**
- ‚úÖ **–î–æ—Å—Ç—É–ø –ø–æ IP —Ä–∞–±–æ—Ç–∞–µ—Ç:** `http://217.25.93.83 -H 'Host: cfa.capital'`
- ‚ö†Ô∏è **GitLab Runner —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞** (–±–ª–æ–∫–µ—Ä –¥–ª—è CI/CD)

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å GitLab Runner (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** Runner –ø–æ–ª—É—á–∞–µ—Ç 403 Forbidden, jobs –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü–æ–ª—É—á–∏—Ç—å Runner Registration Token:**
   - –û—Ç–∫—Ä—ã—Ç—å: https://git.telex.global/npk/ois-cfa/-/settings/ci_cd
   - –†–∞–∑–¥–µ–ª: Runners
   - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω ‚Üí "Reset registration token"
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω

2. **–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω:**
   ```bash
   export RUNNER_TOKEN="–Ω–æ–≤—ã–π-—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
   make gitlab-runner-update-token
   kubectl delete pods -n gitlab-runner -l app=gitlab-runner
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
   ```bash
   make gitlab-runner-status
   # –í GitLab UI: Settings ‚Üí CI/CD ‚Üí Runners ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Online"
   ```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä-—Å–∫—Ä–∏–ø—Ç:**
```bash
export RUNNER_TOKEN="—Ç–æ–∫–µ–Ω-–∏–∑-gitlab"
./ops/scripts/fix-runner-and-deploy.sh
```

---

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod

```bash
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
kubectl get pods -n ois-cfa
kubectl get svc -n ois-cfa
kubectl get ingress -n ois-cfa

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
curl -H "Host: cfa.capital" "http://217.25.93.83"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** nginx welcome page

---

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ DNS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ IP –Ω–∞–ø—Ä—è–º—É—é:

```bash
# –í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –ø–æ IP
curl -H "Host: cfa.capital" "http://217.25.93.83"
```

**–î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:**
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å A-–∑–∞–ø–∏—Å—å: `cfa.capital` ‚Üí `217.25.93.83`
- –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DNS: `http://cfa.capital` –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é

---

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GitOps (GitLab Agent)

```bash
# –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–≥–µ–Ω—Ç–∞
mkdir -p .gitlab/agents/ois-cfa-agent
cp ops/gitops/gitlab-agent/agent-config.yaml .gitlab/agents/ois-cfa-agent/config.yaml

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞
kubectl get pods -n gitlab-agent
kubectl logs -n gitlab-agent -l app=gitlab-agent
```

### 2. –í—ã–∫–∞—Ç–∏—Ç—å API Gateway

```bash
# –û–±–Ω–æ–≤–∏—Ç—å values-prod.yaml (—É–∂–µ –æ–±–Ω–æ–≤–ª—ë–Ω —Å –¥–æ–º–µ–Ω–æ–º api.cfa.capital)
helm install api-gateway ops/infra/helm/api-gateway \
  --namespace ois-cfa \
  --create-namespace \
  -f ops/infra/helm/api-gateway/values-prod.yaml

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
kubectl get pods -n ois-cfa
kubectl get ingress -n ois-cfa
```

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Runner:
- Jobs –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è
- Build jobs —Å–æ–±–µ—Ä—É—Ç –æ–±—Ä–∞–∑—ã
- Deploy jobs –≤—ã–∫–∞—Ç—è—Ç —á–µ—Ä–µ–∑ GitOps

---

## üîß –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä
kubectl get nodes
kubectl get namespaces
kubectl get pods -A

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π pod
kubectl get pods -n ois-cfa
kubectl logs -n ois-cfa -l app=test-nginx

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Ingress
kubectl get ingress -n ois-cfa
kubectl describe ingress -n ois-cfa test-nginx

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Runner
make gitlab-runner-status
kubectl logs -n gitlab-runner -l app=gitlab-runner --tail=50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitLab Agent
kubectl get pods -n gitlab-agent
kubectl logs -n gitlab-agent -l app=gitlab-agent --tail=50
```

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

```
‚úÖ Namespace: ois-cfa
‚úÖ Deployment: test-nginx (1/1 Ready)
‚úÖ Service: test-nginx (ClusterIP)
‚úÖ Ingress: test-nginx (cfa.capital)
‚úÖ Node IP: 217.25.93.83
‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–±–æ—Ç–∞–µ—Ç: curl -H "Host: cfa.capital" "http://217.25.93.83"

‚ö†Ô∏è GitLab Runner: —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
‚úÖ GitLab Agent: —Ä–∞–±–æ—Ç–∞–µ—Ç (2/2 Running)
‚úÖ Ingress NGINX: —Ä–∞–±–æ—Ç–∞–µ—Ç
```

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

- [x] –¢–µ—Å—Ç–æ–≤—ã–π pod –≤—ã–∫–∞—á–µ–Ω
- [x] Ingress –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] –î–æ—Å—Ç—É–ø –ø–æ IP —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] GitLab Runner —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
- [ ] DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] API Gateway –≤—ã–∫–∞—á–µ–Ω
- [ ] CI/CD pipeline —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

- [–ú–∞—Å—Ç–µ—Ä-–ø–ª–∞–Ω –≤—ã–∫–∞—Ç–∫–∏](./production-deployment-master-plan.md)
- [–°—Ç–∞—Ç—É—Å –≤—ã–∫–∞—Ç–∫–∏](./production-deployment-status.md)
- [GitLab Runner Troubleshooting](./gitlab-runner-troubleshooting.md)
- [GitOps Setup](./gitops.md)

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å GitLab Runner —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞–ø—É—Å–∫–∞ CI/CD jobs


```

`ops/timeweb/kubeconfig.md`:

```md
# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ kubeconfig –¥–ª—è Timeweb Cloud Kubernetes

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–í–ª–∞–¥–µ–ª–µ—Ü:** DevOps/SRE

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
2. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ twc CLI](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞-twc-cli)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
4. [–ü–æ–ª—É—á–µ–Ω–∏–µ kubeconfig](#–ø–æ–ª—É—á–µ–Ω–∏–µ-kubeconfig)
5. [–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è](#–ø—Ä–æ–≤–µ—Ä–∫–∞-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
6. [–•—Ä–∞–Ω–µ–Ω–∏–µ kubeconfig](#—Ö—Ä–∞–Ω–µ–Ω–∏–µ-kubeconfig)
7. [Troubleshooting](#troubleshooting)

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å twc CLI
./tools/timeweb/install.sh

# 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–∫–µ–Ω
export TWC_TOKEN='your-token-here'

# 3. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s

# 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å kubeconfig
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"
kubectl get nodes
```

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ twc CLI

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
./tools/timeweb/install.sh
```

–°–∫—Ä–∏–ø—Ç:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ Python 3 –∏ pip
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `twc-cli` —á–µ—Ä–µ–∑ pip
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É

### –†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pip
pip install --user twc-cli

# –î–æ–±–∞–≤–∏—Ç—å –≤ PATH (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ ~/.local/bin)
export PATH="${HOME}/.local/bin:${PATH}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞
twc --version
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.8+
- pip
- –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
export TWC_TOKEN='your-timeweb-cloud-api-token'
```

–¢–æ–∫–µ–Ω –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤ [–ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Timeweb Cloud](https://timeweb.cloud):
- –†–∞–∑–¥–µ–ª: API ‚Üí –¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞
- –ü—Ä–∞–≤–∞: `k8s:read`, `k8s:write`

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è twc

```bash
twc config set token 'your-timeweb-cloud-api-token'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –°–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
twc k8s cluster list

# –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
```

---

## –ü–æ–ª—É—á–µ–Ω–∏–µ kubeconfig

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s

# –° —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s /path/to/kubeconfig.yaml
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ twc CLI
- –ù–∞—Ö–æ–¥–∏—Ç –∫–ª–∞—Å—Ç–µ—Ä –ø–æ –∏–º–µ–Ω–∏
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç kubeconfig
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (600)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω kubectl)

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ twc CLI –Ω–∞–ø—Ä—è–º—É—é

```bash
# 1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ –Ω–∞–π—Ç–∏ ID
twc k8s cluster list

# 2. –ü–æ–ª—É—á–∏—Ç—å ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞
CLUSTER_ID=$(twc k8s cluster list --format json | \
  jq -r '.[] | select(.name == "ois-cfa-k8s") | .id')

# 3. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig
twc k8s cluster get-kubeconfig "${CLUSTER_ID}" > kubeconfig.yaml

# 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod 600 kubeconfig.yaml
```

### –°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ Terraform

–ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ Terraform:

```bash
cd ops/infra/timeweb

# –≠–∫—Å–ø–æ—Ä—Ç kubeconfig
terraform output -raw kubeconfig > kubeconfig.yaml
chmod 600 kubeconfig.yaml

# –ò–ª–∏ —á–µ—Ä–µ–∑ Makefile
make tf:kubeconfig
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å kubeconfig
export KUBECONFIG="$(pwd)/kubeconfig.yaml"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
kubectl cluster-info

# –°–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤
kubectl get nodes

# –°–ø–∏—Å–æ–∫ namespace
kubectl get namespaces
```

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Ç–µ—Ä–µ
kubectl cluster-info dump

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Kubernetes
kubectl version

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
kubectl get componentstatuses

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–æ–≤ –≤ kube-system
kubectl get pods -n kube-system
```

### –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –µ—â—ë —Å–æ–∑–¥–∞—ë—Ç—Å—è

–ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω, –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –≤—Ä–µ–º—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ twc
twc k8s cluster get <cluster-id>

# –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (–ø—Ä–∏–º–µ—Ä)
while ! kubectl get nodes 2>/dev/null; do
  echo "Waiting for cluster to be ready..."
  sleep 10
done
```

---

## –•—Ä–∞–Ω–µ–Ω–∏–µ kubeconfig

### ‚ö†Ô∏è –í–∞–∂–Ω–æ: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ù–ï –∫–æ–º–º–∏—Ç—å—Ç–µ kubeconfig –≤ Git!**

–§–∞–π–ª `kubeconfig.yaml` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`:
- `ops/infra/timeweb/.gitignore` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è `kubeconfig*`

### –í–∞—Ä–∏–∞–Ω—Ç—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è

#### 1. GitLab Secure Files (–¥–ª—è —Ä—É—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –†—É—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞
- –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è CI/CD

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ GitLab: Settings ‚Üí CI/CD ‚Üí Secure Files
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ `kubeconfig.yaml`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ CI/CD —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `KUBECONFIG_FILE`

**–ü—Ä–∏–º–µ—Ä –≤ `.gitlab-ci.yml`:**
```yaml
deploy:
  script:
    - kubectl --kubeconfig=$KUBECONFIG_FILE get nodes
```

#### 2. GitLab Kubernetes Agent (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- Production –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitLab CI/CD

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:** –°–º. Task 19 (GitLab Agent setup)

#### 3. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ ~/.kube/config
mkdir -p ~/.kube

# –î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
KUBECONFIG="${HOME}/.kube/config-ois-cfa:${HOME}/.kube/config" \
  kubectl config view --flatten > "${HOME}/.kube/config-merged"

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
kubectl config use-context ois-cfa-k8s
```

#### 4. Vault / Secret Manager (–¥–ª—è production)

```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Vault
vault kv put secret/ois-cfa/kubeconfig \
  content="$(cat kubeconfig.yaml)"

# –ü–æ–ª—É—á–∏—Ç—å –∏–∑ Vault
vault kv get -field=content secret/ois-cfa/kubeconfig > kubeconfig.yaml
```

---

## Troubleshooting

### –û—à–∏–±–∫–∞: "twc: command not found"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å twc CLI
./tools/timeweb/install.sh

# –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ PATH
export PATH="${HOME}/.local/bin:${PATH}"
```

### –û—à–∏–±–∫–∞: "TWC_TOKEN environment variable is not set"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
export TWC_TOKEN='your-token-here'

# –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ twc config
twc config set token 'your-token-here'
```

### –û—à–∏–±–∫–∞: "Cluster 'ois-cfa-k8s' not found"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
twc k8s cluster list

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –∫–ª–∞—Å—Ç–µ—Ä–∞
./tools/timeweb/kubeconfig-export.sh <correct-cluster-name>
```

### –û—à–∏–±–∫–∞: "Unable to connect to the server"

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –ö–ª–∞—Å—Ç–µ—Ä –µ—â—ë —Å–æ–∑–¥–∞—ë—Ç—Å—è (–ø–æ–¥–æ–∂–¥–∏—Ç–µ 10-20 –º–∏–Ω—É—Ç)
2. Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞)
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π kubeconfig

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∞
twc k8s cluster get <cluster-id>

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall –ø—Ä–∞–≤–∏–ª–∞
twc firewall list

# –ü–µ—Ä–µ—ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s
```

### –û—à–∏–±–∫–∞: "The connection to the server ... was refused"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–ª–∞—Å—Ç–µ—Ä –≥–æ—Ç–æ–≤
twc k8s cluster get <cluster-id> | grep status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API server
curl -k https://<api-server-url>

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç 6443)
```

### kubeconfig –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü–µ—Ä–µ—ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s

# –ò–ª–∏ —á–µ—Ä–µ–∑ twc
twc k8s cluster get-kubeconfig <cluster-id> > kubeconfig.yaml
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª–Ω—ã–π workflow

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞
./tools/timeweb/install.sh

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞
export TWC_TOKEN='your-token'

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
twc k8s cluster list

# 4. –≠–∫—Å–ø–æ—Ä—Ç kubeconfig
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s

# 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"
kubectl get nodes
kubectl get pods --all-namespaces
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ CI/CD

```yaml
# .gitlab-ci.yml
deploy:
  before_script:
    - pip install --user twc-cli
    - export PATH="${HOME}/.local/bin:${PATH}"
    - export TWC_TOKEN="${TWC_TOKEN}"
    - ./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s
    - export KUBECONFIG="$(pwd)/kubeconfig.yaml"
  script:
    - kubectl get nodes
    - kubectl apply -f k8s/
```

---

## –°—Å—ã–ª–∫–∏

- [Timeweb Cloud CLI Documentation](https://timeweb.cloud/docs/cli)
- [Kubernetes kubeconfig](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/)
- [GitLab Secure Files](https://docs.gitlab.com/ee/ci/secure_files/)
- [GitLab Kubernetes Agent](https://docs.gitlab.com/ee/user/clusters/agent/)

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í—Å–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Europe/Moscow (UTC+3).


```

`ops/timeweb/terraform.md`:

```md
# Terraform –¥–ª—è Timeweb Cloud Kubernetes

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é Terraform –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ Timeweb Cloud –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ OIS-CFA.

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-01-27  
**–í–ª–∞–¥–µ–ª–µ—Ü:** DevOps/SRE

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
4. [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
5. [GitLab State Backend](#gitlab-state-backend)
6. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
7. [FAQ](#faq)
8. [–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è](#–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
9. [Troubleshooting](#troubleshooting)

---

## –û–±–∑–æ—Ä

Terraform –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π Kubernetes –≤ Timeweb Cloud:

- **Kubernetes Cluster** (`twc_k8s_cluster`)
- **Node Group** (`twc_k8s_node_group`)
- **VPC** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Å–µ—Ç–∏)
- **Firewall** (–ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

```
ops/infra/timeweb/
‚îú‚îÄ‚îÄ main.tf              # –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
‚îú‚îÄ‚îÄ providers.tf        # –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã Terraform
‚îú‚îÄ‚îÄ variables.tf        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ outputs.tf          # –í—ã—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ backend.tf          # Backend –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ terraform.tfvars.example  # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ .gitignore          # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ —Ñ–∞–π–ª—ã
‚îî‚îÄ‚îÄ README.md           # –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
```

---

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **Terraform** >= 1.5.0
   ```bash
   terraform version
   ```

2. **Timeweb Cloud API Token**
   - –ü–æ–ª—É—á–∏—Ç—å –≤ [–ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Timeweb Cloud](https://timeweb.cloud)
   - –†–∞–∑–¥–µ–ª: API ‚Üí –¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞
   - –ü—Ä–∞–≤–∞: `k8s:read`, `k8s:write`, `vpc:read`, `vpc:write`, `firewall:read`, `firewall:write`

3. **GitLab** (–¥–ª—è managed state, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –ü—Ä–æ–µ–∫—Ç —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º Terraform State
   - Personal Access Token –∏–ª–∏ Project Access Token —Å –ø—Ä–∞–≤–∞–º–∏ `api`

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞

```bash
cd ops/infra/timeweb
cp terraform.tfvars.example terraform.tfvars
```

### 2. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `terraform.tfvars`

–û—Ç–∫—Ä–æ–π—Ç–µ `terraform.tfvars` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è:

```hcl
twc_token = "your-timeweb-cloud-api-token"

cluster_name     = "ois-cfa-k8s"
cluster_location = "ru-1"  # ru-1, ru-2, ru-3
cluster_version  = "1.28"

node_group_name      = "ois-cfa-nodes"
node_group_preset_id = 1
node_count           = 3
node_disk_size       = 50

vpc_enabled     = true
firewall_enabled = true
```

### 3. –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ (location)

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã Timeweb Cloud:

- **ru-1** ‚Äî –ú–æ—Å–∫–≤–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **ru-2** ‚Äî –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
- **ru-3** ‚Äî –ö–∞–∑–∞–Ω—å

–í—ã–±–æ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
- –ë–ª–∏–∑–æ—Å—Ç–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –∑–∞–¥–µ—Ä–∂–∫–µ (latency)
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∑–æ–Ω

### 4. –í—ã–±–æ—Ä –ø—Ä–µ—Å–µ—Ç–∞ (preset_id)

–ü—Ä–µ—Å–µ—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —É–∑–ª–æ–≤ (CPU, RAM). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã –≤ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Timeweb Cloud](https://timeweb.cloud/docs/k8s) –∏–ª–∏ —á–µ—Ä–µ–∑ API.

–ü—Ä–∏–º–µ—Ä—ã (–º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è):
- `1` ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π (2 vCPU, 4 GB RAM)
- `2` ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (4 vCPU, 8 GB RAM)
- `3` ‚Äî –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π (8 vCPU, 16 GB RAM)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è OIS-CFA:**
- Dev/Test: preset_id = 1-2, node_count = 2-3
- Production: preset_id = 2-3, node_count = 3-5 (–º–∏–Ω–∏–º—É–º –¥–ª—è HA)

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
terraform init

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
terraform validate

# –ü–ª–∞–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–π
terraform plan

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
terraform apply

# –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
terraform destroy
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Makefile

```bash
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
make tf:init

# –ü–ª–∞–Ω
make tf:plan

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
make tf:apply

# –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ
make tf:destroy

# –í–∞–ª–∏–¥–∞—Ü–∏—è
make tf:validate
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ kubeconfig

```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å kubeconfig –≤ —Ñ–∞–π–ª
terraform output -raw kubeconfig > kubeconfig.yaml

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å kubeconfig
export KUBECONFIG=$(pwd)/kubeconfig.yaml
kubectl get nodes
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä outputs

```bash
terraform output
terraform output api_server_url
terraform output cluster_id
```

---

## GitLab State Backend

–î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è Terraform –≤ GitLab (managed state) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å backend.

### 1. –°–æ–∑–¥–∞–Ω–∏–µ GitLab –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ GitLab (Settings ‚Üí CI/CD ‚Üí Variables) –¥–æ–±–∞–≤—å—Ç–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ | Masked | Protected |
|-----------|----------|--------|-----------|
| `TWC_TOKEN` | Timeweb Cloud API token | ‚úÖ | ‚úÖ |
| `TF_HTTP_ADDRESS` | `https://gitlab.com/api/v4/projects/{PROJECT_ID}/terraform/state/{STATE_NAME}` | ‚ùå | ‚úÖ |
| `TF_HTTP_LOCK_ADDRESS` | `https://gitlab.com/api/v4/projects/{PROJECT_ID}/terraform/state/{STATE_NAME}/lock` | ‚ùå | ‚úÖ |
| `TF_HTTP_UNLOCK_ADDRESS` | `https://gitlab.com/api/v4/projects/{PROJECT_ID}/terraform/state/{STATE_NAME}/unlock` | ‚ùå | ‚úÖ |
| `TF_HTTP_USERNAME` | GitLab username –∏–ª–∏ `gitlab-ci-token` | ‚ùå | ‚úÖ |
| `TF_HTTP_PASSWORD` | Personal/Project Access Token —Å –ø—Ä–∞–≤–∞–º–∏ `api` | ‚úÖ | ‚úÖ |

**–ì–¥–µ –Ω–∞–π—Ç–∏ PROJECT_ID:**
- –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ GitLab: Settings ‚Üí General ‚Üí Project ID

**STATE_NAME:**
- –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è state (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ois-cfa-timeweb-prod`)

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ backend

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
export TF_HTTP_ADDRESS="https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod"
export TF_HTTP_LOCK_ADDRESS="https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod/lock"
export TF_HTTP_UNLOCK_ADDRESS="https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod/unlock"
export TF_HTTP_USERNAME="your-username"
export TF_HTTP_PASSWORD="your-token"

terraform init
```

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ -backend-config

```bash
terraform init \
  -backend-config="address=https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod" \
  -backend-config="lock_address=https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod/lock" \
  -backend-config="unlock_address=https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod/unlock" \
  -backend-config="username=your-username" \
  -backend-config="password=your-token"
```

#### –í–∞—Ä–∏–∞–Ω—Ç C: –§–∞–π–ª backend.hcl (gitignored)

–°–æ–∑–¥–∞–π—Ç–µ `backend.hcl` (–¥–æ–±–∞–≤–ª–µ–Ω –≤ .gitignore):

```hcl
address        = "https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod"
lock_address   = "https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod/lock"
unlock_address = "https://gitlab.com/api/v4/projects/123456/terraform/state/ois-cfa-timeweb-prod/unlock"
username       = "your-username"
password       = "your-token"
```

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
```bash
terraform init -backend-config=backend.hcl
```

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ GitLab CI/CD

–í `.gitlab-ci.yml`:

```yaml
variables:
  TF_HTTP_ADDRESS: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/ois-cfa-timeweb-prod"
  TF_HTTP_LOCK_ADDRESS: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/ois-cfa-timeweb-prod/lock"
  TF_HTTP_UNLOCK_ADDRESS: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/ois-cfa-timeweb-prod/unlock"
  TF_HTTP_USERNAME: "gitlab-ci-token"
  TF_HTTP_PASSWORD: "${CI_JOB_TOKEN}"

terraform:
  stage: deploy
  script:
    - cd ops/infra/timeweb
    - terraform init
    - terraform plan
    - terraform apply -auto-approve
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-----------|----------|--------------|
| `twc_token` | Timeweb Cloud API token | - |
| `cluster_name` | –ò–º—è –∫–ª–∞—Å—Ç–µ—Ä–∞ | `ois-cfa-k8s` |
| `cluster_location` | –†–µ–≥–∏–æ–Ω (ru-1, ru-2, ru-3) | `ru-1` |
| `cluster_version` | –í–µ—Ä—Å–∏—è Kubernetes | `1.28` |
| `node_group_name` | –ò–º—è –≥—Ä—É–ø–ø—ã —É–∑–ª–æ–≤ | `ois-cfa-nodes` |
| `node_group_preset_id` | ID –ø—Ä–µ—Å–µ—Ç–∞ | `1` |
| `node_count` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤ | `3` |
| `node_disk_size` | –†–∞–∑–º–µ—Ä –¥–∏—Å–∫–∞ (GB) | `50` |
| `vpc_enabled` | –í–∫–ª—é—á–∏—Ç—å VPC | `true` |
| `firewall_enabled` | –í–∫–ª—é—á–∏—Ç—å firewall | `true` |

### Firewall –ø—Ä–∞–≤–∏–ª–∞

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑—Ä–µ—à–µ–Ω—ã:
- **6443** ‚Äî Kubernetes API server
- **30000-32767** ‚Äî NodePort –¥–∏–∞–ø–∞–∑–æ–Ω
- **22** ‚Äî SSH (‚ö†Ô∏è –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤ production)
- **80, 443** ‚Äî HTTP/HTTPS –¥–ª—è ingress

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production:**
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å SSH (22) —Ç–æ–ª—å–∫–æ IP –∞–¥—Ä–µ—Å–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å API server (6443) —Ç–æ–ª—å–∫–æ IP –∞–¥—Ä–µ—Å–∞–º–∏ CI/CD –∏ –∞–¥–º–∏–Ω–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Network Policies –≤ Kubernetes –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏

---

## FAQ

### –ö–∞–∫ —É–∑–Ω–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã?

1. –ß–µ—Ä–µ–∑ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é Timeweb Cloud](https://timeweb.cloud/docs/k8s)
2. –ß–µ—Ä–µ–∑ API:
   ```bash
   curl -H "Authorization: Bearer $TWC_TOKEN" \
     https://api.timeweb.cloud/api/v1/k8s/presets
   ```

### –ú–æ–∂–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è?

–î–∞, –∏–∑–º–µ–Ω–∏—Ç–µ `node_count` –≤ `terraform.tfvars` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `terraform apply`. Terraform –æ–±–Ω–æ–≤–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤.

### –ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é Kubernetes?

–ò–∑–º–µ–Ω–∏—Ç–µ `cluster_version` –≤ `terraform.tfvars` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `terraform apply`. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Timeweb Cloud.

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É —É–∑–ª–æ–≤?

–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë –æ–¥–∏–Ω —Ä–µ—Å—É—Ä—Å `twc_k8s_node_group` –≤ `main.tf`:

```hcl
resource "twc_k8s_node_group" "workers" {
  cluster_id = twc_k8s_cluster.main.id
  name       = "ois-cfa-workers"
  preset_id  = 2
  node_count = 5
  disk_size  = 100
}
```

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–∫—Ä—É–∂–µ–Ω–∏–π (dev/staging/prod)?

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ `terraform.tfvars` —Ñ–∞–π–ª—ã:
   - `terraform.tfvars.dev`
   - `terraform.tfvars.staging`
   - `terraform.tfvars.prod`

2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ workspaces:
   ```bash
   terraform workspace new dev
   terraform workspace new staging
   terraform workspace new prod
   terraform workspace select dev
   ```

3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ state —Ñ–∞–π–ª—ã –≤ GitLab (—Ä–∞–∑–Ω—ã–µ STATE_NAME).

### –ö–∞–∫ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig –¥–ª—è CI/CD?

–í GitLab CI/CD:

```yaml
script:
  - cd ops/infra/timeweb
  - terraform output -raw kubeconfig > kubeconfig.yaml
  - kubectl --kubeconfig=kubeconfig.yaml get nodes
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```yaml
script:
  - export KUBECONFIG=$(terraform output -raw kubeconfig)
  - kubectl get nodes
```

---

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### Timeweb Cloud

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤:** –æ–±—ã—á–Ω–æ 2-3 (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–µ—Å–µ—Ç–∞)
2. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤:** –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∞—Ä–∏—Ñ–∞ –∏ –∫–≤–æ—Ç
3. **–í–µ—Ä—Å–∏–∏ Kubernetes:** —Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ Timeweb Cloud (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é)
4. **–†–µ–≥–∏–æ–Ω—ã:** ru-1, ru-2, ru-3 (–Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–Ω–∏—è)

### Terraform Provider

1. **–í–µ—Ä—Å–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `~> 1.6` (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –≤–µ—Ä—Å–∏—è–º–∏ 1.6.x)
2. **State locking:** –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ GitLab backend

### –ü—Ä–æ–µ–∫—Ç OIS-CFA

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** firewall –ø—Ä–∞–≤–∏–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –≤ production
2. **–°—Ç–æ–∏–º–æ—Å—Ç—å:** —É—á–∏—Ç—ã–≤–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–∑–ª–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–µ—Å–µ—Ç–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
3. **Backup:** –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ backup –¥–ª—è state —Ñ–∞–π–ª–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

---

## Troubleshooting

### –û—à–∏–±–∫–∞: "Invalid token"

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `twc_token` –≤ `terraform.tfvars`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞ (k8s, vpc, firewall)

### –û—à–∏–±–∫–∞: "State locked"

- –î—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç state
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ GitLab: Settings ‚Üí CI/CD ‚Üí Terraform state
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ: `terraform force-unlock <LOCK_ID>`

### –û—à–∏–±–∫–∞: "Preset not found"

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã —á–µ—Ä–µ–∑ API –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `node_group_preset_id` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º –ø—Ä–µ—Å–µ—Ç–∞–º

### –û—à–∏–±–∫–∞: "Region not available"

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–µ–≥–∏–æ–Ω–∞ –≤ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ Timeweb Cloud
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ru-1` (–ú–æ—Å–∫–≤–∞) –∫–∞–∫ –Ω–∞–∏–±–æ–ª–µ–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π

### –ö–ª–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ

- –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-20 –º–∏–Ω—É—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Timeweb Cloud
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `terraform apply` —Å `-debug` —Ñ–ª–∞–≥–æ–º

### –ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ kubeconfig:
   ```bash
   terraform output -raw kubeconfig > kubeconfig.yaml
   kubectl --kubeconfig=kubeconfig.yaml get nodes
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall –ø—Ä–∞–≤–∏–ª–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç 6443)

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API server:
   ```bash
   curl -k $(terraform output -raw api_server_url)
   ```

---

## Timeweb Cloud CLI (twc)

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏ Kubernetes —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π CLI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `twc`.

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pip
./tools/timeweb/install.sh

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
pip install --user twc-cli
export PATH="${HOME}/.local/bin:${PATH}"
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
export TWC_TOKEN='your-timeweb-cloud-api-token'

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é twc
twc config set token 'your-timeweb-cloud-api-token'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –°–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
twc k8s cluster list

# –î–µ—Ç–∞–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
twc k8s cluster get <cluster-id>

# –°–ø–∏—Å–æ–∫ node groups
twc k8s node-group list --cluster-id <cluster-id>
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ kubeconfig

#### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –≠–∫—Å–ø–æ—Ä—Ç kubeconfig –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s

# –ò–ª–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s /path/to/kubeconfig.yaml
```

#### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ twc CLI –Ω–∞–ø—Ä—è–º—É—é

```bash
# –ü–æ–ª—É—á–∏—Ç—å ID –∫–ª–∞—Å—Ç–µ—Ä–∞
CLUSTER_ID=$(twc k8s cluster list --format json | jq -r '.[] | select(.name == "ois-cfa-k8s") | .id')

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å kubeconfig
twc k8s cluster get-kubeconfig "${CLUSTER_ID}" > kubeconfig.yaml
chmod 600 kubeconfig.yaml
```

#### –°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ Terraform

```bash
cd ops/infra/timeweb
terraform output -raw kubeconfig > kubeconfig.yaml
chmod 600 kubeconfig.yaml
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ kubeconfig

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å kubeconfig –∫–∞–∫ —Ç–µ–∫—É—â–∏–π
export KUBECONFIG="$(pwd)/kubeconfig.yaml"

# –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ ~/.kube/config
kubectl --kubeconfig=kubeconfig.yaml get nodes

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
kubectl cluster-info
kubectl get nodes
kubectl get namespaces
```

### –•—Ä–∞–Ω–µ–Ω–∏–µ kubeconfig

#### GitLab Secure Files (–¥–ª—è —Ä—É—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫)

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Settings ‚Üí CI/CD ‚Üí Secure Files
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ `kubeconfig.yaml` –∫–∞–∫ Secure File
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ CI/CD —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `KUBECONFIG_FILE`

#### GitLab Agent (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)

–°–º. Task 19 –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GitLab Kubernetes Agent.

#### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ ~/.kube/config
mkdir -p ~/.kube
cp kubeconfig.yaml ~/.kube/config-ois-cfa
export KUBECONFIG="${HOME}/.kube/config-ois-cfa:${HOME}/.kube/config"
kubectl config use-context ois-cfa-k8s
```

**‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:** –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ kubeconfig –≤ Git. –§–∞–π–ª —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`.

### MCP Server (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ)

Timeweb Cloud –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π MCP (Model Context Protocol) —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞–º–∏.

**–°—Ç–∞—Ç—É—Å:** –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production.

**–°—Å—ã–ª–∫–∞:** [Timeweb Cloud MCP Server](https://github.com/timeweb-cloud/mcp-server) (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

**–¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥:** –ò—Å–ø–æ–ª—å–∑—É–µ–º CLI (`twc`) –∏ Terraform –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.

---

## –°—Å—ã–ª–∫–∏

- [Timeweb Cloud Kubernetes Documentation](https://timeweb.cloud/docs/k8s)
- [Timeweb Cloud Terraform Provider](https://registry.terraform.io/providers/timeweb-cloud/timeweb-cloud/latest/docs)
- [Timeweb Cloud CLI Documentation](https://timeweb.cloud/docs/cli)
- [GitLab Terraform State](https://docs.gitlab.com/ee/user/infrastructure/terraform_state.html)
- [Terraform HTTP Backend](https://developer.hashicorp.com/terraform/language/settings/backends/http)

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞ | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|--------|------|-----------|
| 1.1 | 2025-01-27 | –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª –ø—Ä–æ Timeweb Cloud CLI –∏ kubeconfig |
| 1.0 | 2025-01-27 | –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è |

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í—Å–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Europe/Moscow (UTC+3).


```

`ops/timeweb/twc-setup.md`:

```md
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Timeweb Cloud CLI (twc)

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ `twc` CLI –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏ Timeweb Cloud.

## –ß—Ç–æ —Ç–∞–∫–æ–µ twc?

`twc` (Timeweb Cloud CLI) ‚Äî –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–º–∞–Ω–¥–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ Timeweb Cloud, –≤–∫–ª—é—á–∞—è:
- Kubernetes –∫–ª–∞—Å—Ç–µ—Ä—ã
- –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- Cloud Servers
- Load Balancers
- Firewall –ø—Ä–∞–≤–∏–ª–∞
- –ò –¥—Ä—É–≥–∏–µ —Ä–µ—Å—É—Ä—Å—ã

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –ò—Å–ø–æ–ª—å–∑—É—è —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–µ–∫—Ç–∞
./tools/timeweb/install.sh

# –ò–ª–∏ —á–µ—Ä–µ–∑ Makefile
make twc-install
```

### –†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pip
pip install --user twc-cli

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ PATH
export PATH="${HOME}/.local/bin:${PATH}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
twc --version
```

## –ü–æ–ª—É—á–µ–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞

1. –í–æ–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Timeweb Cloud](https://timeweb.cloud)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **API** ‚Üí **–¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞**
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏:
   - `k8s:read`
   - `k8s:write`
   - `vpc:read` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - `firewall:read` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω (–æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!)

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–∞

### –°–ø–æ—Å–æ–± 1: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
export TWC_TOKEN='your-token-here'
```

–î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ –≤ `~/.bashrc` –∏–ª–∏ `~/.zshrc`:
```bash
echo 'export TWC_TOKEN="your-token-here"' >> ~/.bashrc
source ~/.bashrc
```

### –°–ø–æ—Å–æ–± 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è twc

```bash
twc config set token 'your-token-here'
```

–¢–æ–∫–µ–Ω –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ `~/.config/twc/config.yaml`.

### –°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ terraform.tfvars

```bash
# –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp ops/infra/timeweb/terraform.tfvars.example ops/infra/timeweb/terraform.tfvars

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω
# twc_token = "your-token-here"
```

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ:** `terraform.tfvars` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore` –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –∫–æ–º–º–∏—Ç–∏—Ç—å—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Makefile
make twc-verify

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
twc k8s cluster list
```

–ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (–∏–ª–∏ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫), –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏

```bash
# –°–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
twc k8s cluster list

# –î–µ—Ç–∞–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
twc k8s cluster show <cluster-id>

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ (—á–µ—Ä–µ–∑ Terraform —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
twc k8s cluster create --help

# –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞
twc k8s cluster remove <cluster-id>
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ node groups

```bash
# –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø —É–∑–ª–æ–≤
twc k8s group list --cluster-id <cluster-id>

# –î–µ—Ç–∞–ª–∏ –≥—Ä—É–ø–ø—ã —É–∑–ª–æ–≤
twc k8s group show <group-id> --cluster-id <cluster-id>
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ kubeconfig

```bash
# –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–µ–∫—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
./tools/timeweb/kubeconfig-export.sh ois-cfa-k8s

# –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ Makefile
make twc-kubeconfig

# –°–ø–æ—Å–æ–± 3: –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ twc
CLUSTER_ID=$(twc k8s cluster list --format json | jq -r '.[] | select(.name == "ois-cfa-k8s") | .id')
twc k8s cluster kubeconfig "${CLUSTER_ID}" > kubeconfig.yaml
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ü–∏–π

```bash
# –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ Kubernetes
twc k8s list-k8s-versions

# –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É–∑–ª–æ–≤)
twc k8s list-presets

# –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã
twc k8s list-network-drivers
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É:

```bash
./ops/scripts/setup-twc-cluster.sh [cluster-name]
```

–°–∫—Ä–∏–ø—Ç:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É `twc`
2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω (–∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ terraform.tfvars)
3. –ù–∞—Ö–æ–¥–∏—Ç –∫–ª–∞—Å—Ç–µ—Ä –ø–æ –∏–º–µ–Ω–∏
4. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç kubeconfig
5. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ kubeconfig

–ü–æ—Å–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞ kubeconfig:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
export KUBECONFIG="$(pwd)/ops/infra/timeweb/kubeconfig.yaml"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
kubectl cluster-info
kubectl get nodes
kubectl get namespaces
```

## Troubleshooting

### –û—à–∏–±–∫–∞: "twc: command not found"

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å twc
make twc-install

# –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ PATH
export PATH="${HOME}/.local/bin:${PATH}"
```

### –û—à–∏–±–∫–∞: "TWC_TOKEN is not set"

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
export TWC_TOKEN='your-token-here'

# –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ twc
twc config set token 'your-token-here'
```

### –û—à–∏–±–∫–∞: "Invalid token" –∏–ª–∏ "Authentication failed"

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞ (k8s:read, k8s:write)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ —Ç–æ–∫–µ–Ω

### –û—à–∏–±–∫–∞: "Cluster not found"

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
twc k8s cluster list

# –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ Terraform
cd ops/infra/timeweb
terraform init
terraform plan
terraform apply
```

### –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ kubeconfig

```bash
# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
twc k8s cluster kubeconfig <cluster-id>
twc k8s kubeconfig <cluster-id>
twc k8s cluster get-kubeconfig <cluster-id>
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–∞–∂–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **–ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Ç–æ–∫–µ–Ω—ã –≤ Git**
   - `terraform.tfvars` —É–∂–µ –≤ `.gitignore`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ GitLab CI/CD Variables

2. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞**
   - –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–æ–∫–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
   - –î–ª—è CI/CD –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏

3. **–†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω—ã**
   - –û–±–Ω–æ–≤–ª—è–π—Ç–µ —Ç–æ–∫–µ–Ω—ã –∫–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π
   - –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–∑—ã–≤–∞–π—Ç–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã

4. **–ó–∞—â–∏—â–∞–π—Ç–µ kubeconfig**
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∞ `600` –Ω–∞ kubeconfig —Ñ–∞–π–ª—ã
   - –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ kubeconfig –ø–æ –Ω–µ–∑–∞—â–∏—â—ë–Ω–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Timeweb Cloud Kubernetes Documentation](https://timeweb.cloud/docs/k8s)
- [Timeweb Cloud CLI Documentation](https://timeweb.cloud/docs/cli)
- [Terraform Provider –¥–ª—è Timeweb Cloud](../../ops/infra/timeweb/README.md)


```