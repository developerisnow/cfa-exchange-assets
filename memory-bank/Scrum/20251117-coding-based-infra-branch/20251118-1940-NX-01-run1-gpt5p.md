# Prompt
````markdown
You are Oracle, a focused one-shot problem solver. Emphasize direct answers, cite any files referenced, and clearly note when the search tool was used.  You are Oracle, a focused one-shot problem solver. Emphasize direct answers, cite any files referenced, and clearly note when the search tool is used.  Ты — GPT‑5 Pro в роли **Oracle‑архитектора NX‑01** для репозитория `ois-cfa`. Отвечай по-русски, с B2‑English terms и короткими, структурными формулировками (Why→What→How→Result, таблицы, чек-листы). Нулевая галлюцинация: любые факты только из приложенных файлов.  --- ## 0. Контекст и входные файлы  **Рабочая среда** - Control plane: монорепо `prj_Cifra-rwa-exachange-assets` (manifests, memory-bank, AGENTS, агрегированные GPT‑5 отчёты). - Code repo: `ois-cfa` (основной код, спеки, тесты). Сейчас фокус строго на задаче **NX‑01** и на ветке `infra.defis.deploy`.  **Подключённые файлы (важно использовать)** 1. `tasks/NX-01-spec-validate-and-matrix.md` — постановка задачи NX‑01. 2. `docs/context/PROJECT-CONTEXT.md` — проектный контекст, разделы про API/Event Matrix и ссылки на NX‑01..NX‑03. 3. `docs/context/WBS-OIS.md` — WBS по `ois-cfa`, связь Milestones ↔ NX‑таски (особенно M1 = NX‑01). 4. `docs/context/RULES-SUMMARY.md` — выжимка правил: spec‑first, test‑first, нулевая галлюцинация, требования к артефактам. 5. `memory-bank/snapshots-aggregated-context-duplicates/20251117-c2p_ois-cfa.txt` — свежий code2prompt‑снимок `ois-cfa@infra.defis.deploy` (структура, ключевые файлы, ссылки на спеки и код). 6. `memory-bank/snapshots-aggregated-context-duplicates/20251117-c2p_aggregated-gpt5pro-talks.txt` — агрегат твоих прошлых отчётов (V1/V3 аудит, NX‑roadmap, Trees/Branches/Leaves). 7. `packages/contracts/openapi-gateway.yaml` — спецификация API gateway. 8. `packages/contracts/openapi-issuance.yaml` — спецификация Issuance‑сервиса. 9. `packages/contracts/openapi-registry.yaml` — спецификация Registry‑сервиса. 10. `packages/contracts/asyncapi.yaml` — AsyncAPI событий Kafka.  **Суть NX‑01 (см. таск/WBS)** > Линтинг и базовая валидация OpenAPI/AsyncAPI/JSON Schemas, сверка со структурой кода и формирование проверенной **API/Event Matrix** + Gap List. Результат должен лечь в `docs/context/PROJECT-CONTEXT.md` (разделы API/Event Matrix и Gap List) + в артефакты под `artifacts/spec-*`.  Ты не можешь реально запускать Spectral/AsyncAPI/AJV, но можешь: - прочитать YAML/кодовые куски через `c2p_ois-cfa.txt` и сами openapi/asyncapi; - спроектировать команды и ожидаемые артефакты; - построить матрицу и Gap List по фактическому содержанию файлов.  --- ## 1. Задача для тебя  Используя все указанные файлы, сделай следующее:  1. **Спроектируй план lint/validate для NX‑01**:    - Для каждого вида спеки (OpenAPI gateway, OpenAPI сервисов, AsyncAPI событий, JSON Schemas) предложи конкретные команды:      - Spectral (или аналог) для `openapi-*.yaml`.      - AsyncAPI CLI (или аналог) для `asyncapi.yaml`.      - AJV (или аналог) для JSON Schema (если они есть; если нет — зафиксируй как gap).    - Для каждой команды: что именно она проверяет и какие типичные проблемы поймает применительно к этим файлам.  2. **Сформируй готовый блок API/Event Matrix для PROJECT-CONTEXT.md**:    - REST Matrix: gateway → target сервисы; реальные endpoints, методы, маршруты YARP, статус (OK/partial/missing), Notes.    - Event Matrix: Kafka topics из `asyncapi.yaml`, producer/consumer‑сервисы, полезная нагрузка/схемы, статус.    - Опирайся на `openapi-*`, `asyncapi.yaml` и на то, что видно в `c2p_ois-cfa.txt` (gateway routes, controllers, topics).  3. **Сформируй Gap List (Spec diff)**:    - По REST: несовпадения между openapi-gateway/openapi-* и кодом (endpoints есть в спеках, но нет в коде/маршрутах, и наоборот).    - По Events: несовпадения между AsyncAPI и кодом продюсеров/консьюмеров.    - По JSON Schema: наличие/отсутствие схем, несоответствие payload’ов.  4. **Опиши артефакты и связь с NX‑02/03/04**:    - Как должны выглядеть файлы:      - `artifacts/spec-lint-openapi.txt`      - `artifacts/spec-validate-asyncapi.txt`      - `artifacts/spec-validate-jsonschema.txt`    - Как результаты NX‑01 будут использоваться в NX‑02 (gateway routing/health), NX‑03 (issuance coverage), NX‑04 (registry orders flow).  Если чего-то принципиально не хватает (например, явных JSON Schemas или части asyncapi), явно фиксируй это как gap.  --- ## 2. Формат ответа  Соблюдай строго этот формат:  1. **TL;DR (3–5 bullets)** — по-русски, что нашли, насколько спеки/код согласованы, главные риски. 2. **Section 1 — Lint/Validate Plan**    - Таблица: Tool / Scope / Example command / Notes.    - Отдельно подпункт "Что смотреть в результатах" — чек-лист, что человек должен вытащить в Gap List. 3. **Section 2 — API/Event Matrix (готовый markdown-блок)**    - Дай блок, который можно прям вставить в `docs/context/PROJECT-CONTEXT.md`, с маркерами:      - `<!-- BEGIN: PROJECT-CONTEXT:API-EVENT-MATRIX -->` ... `<!-- END: PROJECT-CONTEXT:API-EVENT-MATRIX -->`.    - Внутри: две таблицы — REST API Matrix и Event Matrix — заполненные реальным содержимым по openapi/asyncapi/c2p. 4. **Section 3 — Spec Diff / Gap List (готовый markdown-блок)**    - Блок между маркерами `<!-- BEGIN: PROJECT-CONTEXT:API-EVENT-GAPS -->` / `...END...`.    - Подразделы: OpenAPI, AsyncAPI, JSON Schemas; списки только реальных проблем, с отсылками к файлам/пути. 5. **Section 4 — Artifacts & Next Steps**    - Описание структуры spec‑артефактов (3 файла) и как их использовать в NX‑02/03/04.  Всегда явно указывай, на какие файлы/фрагменты ты опираешься (с путями), и не придумывай того, чего нет в приложениях.
````

# Output
* Спеки уже **валидированы (NX‑01, 2025‑01‑27)**: 9 OpenAPI → Spectral OK, AsyncAPI OK, JSON Schemas с некритичными `uuid`/`decimal` warning’ами (AJV).
* Готовый **REST API Matrix** и **Event Matrix** уже сформированы в `PROJECT-CONTEXT.md` и `c2p` (Gateway ↔ Issuance/Registry/Settlement/Compliance + Kafka topics).
* Основные REST‑gaps: расхождение `/orders/{id}` vs `/v1/orders/{id}`, магия `/issuances`→`/v1/issuances`, отсутствие CRUD для payout schedule в Gateway OpenAPI.
* Event‑gaps: четыре топика есть в AsyncAPI, но нет продьюсеров в коде (`ois.order.placed`, `ois.order.confirmed`, `ois.payout.scheduled`, `ois.transfer.completed`).
* JSON Schema‑gaps: только форматы `uuid`/`decimal` (AJV warnings), плюс отсутствует явная матрица Schema ↔ DTO.

> Примечание: контекст собран через **file_search.msearch** по `NX-01-spec-validate-and-matrix.md`, `PROJECT-CONTEXT.md`, `WBS-OIS.md`, `RULES-SUMMARY.md`, `20251117-c2p_ois-cfa.txt`, `20251117-c2p_aggregated-gpt5pro-talks.txt`, `openapi-*.yaml`, `asyncapi.yaml`.

---

## Section 1 — Lint/Validate Plan

### 1.1 Таблица команд

| Tool                        | Scope                                                                                       | Example command                                                                                                                              | Notes                                                                                                       |
| --------------------------- | ------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| **Spectral (Node)**         | Все OpenAPI спеки: `packages/contracts/openapi-*.yaml` (в т.ч. gateway, issuance, registry) | `npx -y @stoplight/spectral-cli@6 lint packages/contracts/openapi-*.yaml > artifacts/spec-lint-openapi.txt`                                  | Базовый NX‑01 шаг. В отчёте NX‑01: **9 OpenAPI файлов, ошибок нет**.                                        |
| **Spectral (Docker)**       | Альтернатива, если Node недоступен локально                                                 | `docker run --rm -v "$PWD:/work" stoplight/spectral:6 lint /work/packages/contracts/openapi-*.yaml > artifacts/spec-lint-openapi.txt`        | Использовать тот же artifacts‑файл. В CI это может быть fallback.                                           |
| **AsyncAPI CLI (Docker)**   | `packages/contracts/asyncapi.yaml` — все Kafka topics/events                                | `docker run --rm -v "$PWD:/work" asyncapi/cli:2.10.0 validate /work/packages/contracts/asyncapi.yaml > artifacts/spec-validate-asyncapi.txt` | В NX‑01 отчёте — **AsyncAPI: Valid**, без ошибок.                                                           |
| **AJV CLI (Node)**          | Все JSON Schemas: `packages/contracts/schemas/*.json`                                       | `npx -y ajv-cli@5 compile -s packages/contracts/schemas/*.json > artifacts/spec-validate-jsonschema.txt`                                     | В NX‑01 отчёте: только предупреждения по форматам `uuid`/`decimal`, компиляция успешна.                     |
| **CI job `validate:specs`** | Централизованный запуск Spectral + AsyncAPI CLI + AJV в CI                                  | (внутри CI, согласно описанию: Spectral по `openapi-*.yaml`, AsyncAPI validate, Ajv compile)                                                 | Поддерживает NX‑01 в режиме **maintenance** (каждый MR/merge в `infra.defis.deploy` гоняет все 3 проверки). |

### 1.2 Что именно проверяется (применительно к этим файлам)

**OpenAPI (Spectral)**

* Корректность структуры OpenAPI для:

  * `openapi-gateway.yaml` — все Gateway endpoints (market, orders, investors, reports, audit, kyc, compliance, settlement, health и т.д.).
  * `openapi-issuance.yaml` — доменные операции выпуска (create/publish/close/redeem).
  * `openapi-registry.yaml` — ордера, кошельки, транзакции.
* Ссылки `$ref` внутри схем и ответов, согласованность типов (например, `IssuerIssuancesReportResponse`, `WalletResponse`, `AuditEventsResponse`).
* В NX‑01: блокирующих ошибок нет, т.е. **все openapi‑файлы формально валидны**.

**AsyncAPI CLI**

* Синтаксис `packages/contracts/asyncapi.yaml` и определения всех топиков `ois.*`.
* Корректность привязки payload‑схем (`AuditEvent`, `Order`, `Payout`, `Wallet`, `TxHistoryItem` и др.) через `$ref` на JSON Schemas.
* В NX‑01: статус `Valid`, но логически выявлено, что часть топиков не имеет продьюсеров в коде (см. Gap List).

**AJV CLI (JSON Schemas)**

* Компиляция всех схем из `packages/contracts/schemas/*.json` (Issuance, Order, Wallet, TxHistoryItem, AuditEvent, PayoutItem, IssuerReportRow и др.).
* Проверка `$ref` внутри contracts‑пакета (отдельных проблем в NX‑01 не зафиксировано).
* Реальный результат NX‑01:

  * **Warnings** по форматам `uuid` и `decimal` — AJV их не знает по умолчанию, но схемы при этом компилируются.

### 1.3 Что смотреть в результатах (чек‑лист для Gap List)

**OpenAPI / Spectral:**

* Любые **errors**/`[Error]` в `artifacts/spec-lint-openapi.txt`.
* Новые **warnings**, связанные с:

  * `unresolved $ref` (особенно cross‑file внутри `packages/contracts`).
  * Несовпадением `format` vs фактический JSON (например, decimal/uuid).
* Несогласованности между:

  * `openapi-gateway.yaml` path’ами и YARP routes в `apps/api-gateway/appsettings.json`.
  * `openapi-issuance.yaml` / `openapi-registry.yaml` и фактическими endpoint’ами в `services/issuance/Program.cs`, `services/registry/Program.cs`.

**AsyncAPI:**

* Любой non‑zero статус или предупреждения в `artifacts/spec-validate-asyncapi.txt`.
* Топики, которые:

  * Есть в AsyncAPI, но **нет продьюсеров/консьюмеров** в коде (`services/*`). Сейчас это: `ois.order.placed`, `ois.order.confirmed`, `ois.payout.scheduled`, `ois.transfer.completed`.

**JSON Schemas / AJV:**

* Любые `error`/`failed` строки в `artifacts/spec-validate-jsonschema.txt`.
* Новые форматы/типы, которые AJV не понимает (`format: xxx` без описания) — их нужно либо заменить на `pattern`, либо описать кастомный формат (фиксировать в Gap List).
* Схемы, которые не используются ни в OpenAPI, ни в AsyncAPI, ни в TS‑types (см. перечень в c2p "Model Pointers").

---

## Section 2 — API/Event Matrix (готовый блок для PROJECT-CONTEXT.md)

```md
<!-- BEGIN: PROJECT-CONTEXT:API-EVENT-MATRIX -->

## API/Event Matrix

Источники:
- OpenAPI: `packages/contracts/openapi-gateway.yaml`, `packages/contracts/openapi-issuance.yaml`, `packages/contracts/openapi-registry.yaml`  
- AsyncAPI: `packages/contracts/asyncapi.yaml`  
- Код и маршрутизация: `apps/api-gateway/appsettings.json`, `services/*`, `packages/sdks/*`, `packages/dotnet-clients/*`.  

Валидация спецификаций (NX‑01, 2025‑01‑27):
- `artifacts/spec-lint-openapi.txt` — Spectral: ✅ No errors (9 OpenAPI файлов)  
- `artifacts/spec-validate-asyncapi.txt` — AsyncAPI CLI: ✅ Valid  
- `artifacts/spec-validate-jsonschema.txt` — AJV: ⚠️ Warnings по `uuid`/`decimal` (не критично).  

### REST API Matrix (Gateway → Services)

**Gateway Implementation:** YARP (Yet Another Reverse Proxy)  
**Configuration:** `apps/api-gateway/appsettings.json`:contentReference[oaicite:41]{index=41}  
**Last Updated (matrix):** 2025‑01‑27 (NX‑02 snapshot):contentReference[oaicite:42]{index=42}  

| Gateway Endpoint | Method | YARP Route | Target Service | Service Endpoint | Status | Notes |
|------------------|--------|-----------|----------------|------------------|--------|-------|
| `/health` | GET | Direct | Gateway | `/health` | ✅ | Gateway health probe (см. `apps/api-gateway/Program.cs`).:contentReference[oaicite:43]{index=43} |
| `/issuances` | POST | `issuances` | Issuance | `/v1/issuances` | ✅ | YARP transform: `/issuances` → `/v1/issuances`. |
| `/issuances/{id}` | GET | `issuances` | Issuance | `/v1/issuances/{id}` | ✅ | Обработчик в `services/issuance/Program.cs:216`. |
| `/issuances/{id}/publish` | POST | `issuances` | Issuance | `/v1/issuances/{id}/publish` | ✅ | `services/issuance/Program.cs:228`. |
| `/issuances/{id}/close` | POST | `issuances` | Issuance | `/v1/issuances/{id}/close` | ✅ | `services/issuance/Program.cs:253`. |
| `/v1/issuances/{id}/redeem` | POST | `redeem` | Registry | `/v1/issuances/{id}/redeem` | ✅ | `services/registry/Program.cs:261`. |
| `/v1/orders` | POST | `orders` | Registry | `/v1/orders` | ✅ | `services/registry/Program.cs:212`. |
| `/orders/{id}` | GET | `orders` | Registry | `/v1/orders/{id}` | ⚠️ | OpenAPI Gateway: `/orders/{id}`, YARP/Service: `/v1/orders/{id}` (Spec diff). |
| `/v1/wallets/{investorId}` | GET | `wallets` | Registry | `/v1/wallets/{investorId}` | ✅ | `services/registry/Program.cs:249`, `GetWallet` в Registry service. |
| `/v1/settlement/run` | POST | `settlement` | Settlement | `/v1/settlement/run` | ✅ | `services/settlement/Program.cs:182`. |
| `/v1/reports/payouts` | GET | `reports` | Settlement | `/v1/reports/payouts` | ✅ | `services/settlement/Program.cs:205`, отчёты выплат. |
| `/v1/compliance/kyc/check` | POST | `compliance` | Compliance | `/v1/compliance/kyc/check` | ✅ | `services/compliance/Program.cs:192`. |
| `/v1/compliance/qualification/evaluate` | POST | `compliance` | Compliance | `/v1/compliance/qualification/evaluate` | ✅ | `services/compliance/Program.cs:204`. |
| `/v1/compliance/investors/{id}/status` | GET | `compliance` | Compliance | `/v1/compliance/investors/{id}/status` | ✅ | `services/compliance/Program.cs:216`. |
| `/v1/complaints` | POST | `complaints` | Compliance | `/v1/complaints` | ✅ | `services/compliance/Program.cs:230`. |

**YARP Clusters (apps/api-gateway/appsettings.json)**  

- `identity` → `http://identity-service:8080`  
- `issuance` → `http://issuance-service:8080`  
- `registry` → `http://registry-service:8080`  
- `settlement` → `http://settlement-service:8080`  
- `compliance` → `http://compliance-service:8080`  

> Примечание: Gateway OpenAPI также описывает `market`, `investors`, `reports`, `audit`, `kyc` endpoints, которые используются фронтендами через SDK (`AuditApi`, `InvestorsApi`, `MarketApi`, `WalletsApi`, `ReportsApi`), но пока не отражены в этой матрице по Target Service — это целевой объект расширения в NX‑02/NX‑04.  

### Event Matrix (AsyncAPI ↔ Code)

| Topic | AsyncAPI | Producer (Service) | Consumer | Status | Notes |
|-------|----------|---------------------|----------|--------|-------|
| `ois.issuance.published` | ✅ | Issuance (`IssuanceService.cs:121`) | — | ✅ | Outbox: `services/issuance/Background/OutboxPublisher.cs:67`. |
| `ois.issuance.closed` | ✅ | Issuance (`IssuanceService.cs:177`) | — | ✅ | Outbox: `services/issuance/Background/OutboxPublisher.cs:71`. |
| `ois.order.placed` | ✅ | — | — | ⚠️ | В AsyncAPI, но нет продьюсера в коде (только в тестах: `registry.Tests/OutboxPublishTests.cs:37`).:contentReference[oaicite:62]{index=62} |
| `ois.order.created` | ✅ | Registry (`RegistryService.cs:83`) | — | ✅ | Outbox: `services/registry/Background/OutboxPublisher.cs:67`. |
| `ois.order.reserved` | ✅ | Registry (`RegistryService.cs:112`) | — | ✅ | Outbox: `services/registry/Background/OutboxPublisher.cs:71`. |
| `ois.order.paid` | ✅ | Registry (`RegistryService.cs:268`) | Settlement (`OrderPaidEventConsumer.cs`, `OrderPaidConsumer.cs`) | ✅ | MassTransit wiring в `services/settlement/Program.cs:69`. |
| `ois.order.confirmed` | ✅ | — | — | ⚠️ | В AsyncAPI, но нет продьюсера в коде. |
| `ois.registry.transferred` | ✅ | Registry (`RegistryService.cs:278`) | — | ✅ | Outbox: `services/registry/Background/OutboxPublisher.cs:79`. |
| `ois.payout.executed` | ✅ | Settlement (`SettlementService.cs:175`) | — | ✅ | Outbox: `services/settlement/Background/OutboxPublisher.cs:85`. |
| `ois.payout.scheduled` | ✅ | — | — | ⚠️ | В AsyncAPI, но нет продьюсера в коде. |
| `ois.audit.logged` | ✅ | Compliance (`ComplianceService.cs:64`) | — | ✅ | Outbox: `services/compliance/Background/OutboxPublisher.cs:75`. |
| `ois.transfer.completed` | ✅ | — | — | ⚠️ | В AsyncAPI, но нет продьюсера в коде. |
| `ois.compliance.flagged` | ✅ | Compliance (`ComplianceService.cs:150,226`) | — | ✅ | Outbox: `services/compliance/Background/OutboxPublisher.cs:67`. |
| `ois.kyc.updated` | ✅ | Compliance (`ComplianceService.cs:55`) | — | ✅ | Outbox: `services/compliance/Background/OutboxPublisher.cs:71`. |

**Event SPEC DIFF:**  
Топики `ois.order.placed`, `ois.order.confirmed`, `ois.payout.scheduled`, `ois.transfer.completed` объявлены в AsyncAPI, но **не имеют продьюсеров** в коде (кроме unit‑теста для `ois.order.placed`). Требуется либо реализация продьюсеров, либо чистка AsyncAPI.  

<!-- END: PROJECT-CONTEXT:API-EVENT-MATRIX -->
```

---

## Section 3 — Spec Diff / Gap List (готовый блок)

```md
<!-- BEGIN: PROJECT-CONTEXT:API-EVENT-GAPS -->

## API/Event Gaps (NX-01 Spec Diff)

### OpenAPI (REST)

1. **Gateway vs Registry: `/orders/{id}` path mismatch**  
   - В `openapi-gateway.yaml`: `GET /orders/{id}`.  
   - В YARP: маршрут `orders` матчится на `/v1/orders/{**catch-all}`.:contentReference[oaicite:76]{index=76}  
   - В Registry service: endpoint `/v1/orders/{id}`.  
   - **Gap:** спецификация gateway не отражает префикс `/v1`. Требуется либо обновить OpenAPI, либо завести отдельный маршрут для `/orders/{id}`.  

2. **Gateway vs Issuance: `/issuances` vs `/v1/issuances`**  
   - Gateway OpenAPI и YARP принимают `/issuances/*`, YARP трансформирует в `/v1/issuances/*`.  
   - Issuance service реализует `/v1/issuances`, `/v1/issuances/{id}`, `/v1/issuances/{id}/publish`, `/v1/issuances/{id}/close`.  
   - **Status:** поведение согласовано (благодаря YARP Transform), но это нужно явно оставлять в Notes матрицы, чтобы не воспринимать как баг.  

3. **Issuer payout schedule CRUD — отсутствуют в Gateway OpenAPI**  
   - Фронтенд‑MVP планирует CRUD для payout schedule:  
     - `POST /v1/issuances/{id}/payouts/schedule`  
     - `GET /v1/issuances/{id}/payouts/schedule`  
     - `PATCH /v1/issuances/{id}/payouts/schedule/{itemId}`  
     - `DELETE /v1/issuances/{id}/payouts/schedule/{itemId}`.  
   - Сейчас эти пути **отсутствуют** в `packages/contracts/openapi-gateway.yaml`; UI использует read‑only `Issuance.scheduleJson`.  
   - **Gap:** нужно добавить endpoints + схемы (`PayoutScheduleItem`) в gateway‑спеку или пересмотреть UI‑поведение.  

4. **Aggregator endpoints без явного Target Service в матрице**  
   - В Gateway OpenAPI и SDK присутствуют:  
     - `GET /v1/market/issuances`, `GET /v1/market/issuances/{id}`.  
     - `GET /v1/investors/{id}/transactions`, `GET /v1/investors/{id}/payouts`.  
     - `GET /v1/audit`, `GET /v1/audit/{id}`, `GET /v1/audit/export.csv`.  
     - `POST /v1/kyc/{investorId}/decision`, `GET /v1/kyc/{investorId}/documents` (см. frontend context).  
   - Эти endpoints используются фронтендами и сгенерированными SDK (`AuditApi`, `InvestorsApi`, `MarketApi`, `WalletsApi`, `ReportsApi`).  
   - В текущей REST Matrix отражены только базовые маршруты `issuances/orders/wallets/settlement/compliance/complaints`.  
   - **Gap:** нет явного маппинга aggregator‑эндпоинтов на конкретные сервисы/комбинации сервисов. Это оставлено на NX‑02/NX‑04 (gateway routing + registry flow).  

5. **Gateway metrics**  
   - Все доменные сервисы имеют `/health` и `/metrics` (Prometheus).:contentReference[oaicite:90]{index=90}  
   - Gateway имеет `/health`, но **не имеет `/metrics`**.  
   - **Gap:** добавить `/metrics` (или проксировать метрики из сервисов) и описать в OpenAPI/доках NX‑02.  

### AsyncAPI (Events)

1. **Топики без продьюсеров в коде (AsyncAPI only)**  
   - `ois.order.placed` — указан в AsyncAPI, в коде только unit‑тест `registry.Tests/OutboxPublishTests.cs:37`.  
   - `ois.order.confirmed` — нет продьюсера в сервисах.  
   - `ois.payout.scheduled` — нет продьюсера в сервисах.  
   - `ois.transfer.completed` — нет продьюсера в сервисах.  
   - **Gap:** либо реализовать outbox‑продьюсеры, либо удалить/пометить эти топики как planned.  

2. **Согласованные топики (OK)**  
   - `ois.issuance.published`, `ois.issuance.closed`, `ois.order.created`, `ois.order.reserved`, `ois.order.paid`, `ois.registry.transferred`, `ois.payout.executed`, `ois.audit.logged`, `ois.compliance.flagged`, `ois.kyc.updated` — реализованы продьюсеры (и для части — консьюмеры) в коде, согласованы с AsyncAPI.  

### JSON Schemas / Models

1. **AJV format warnings (`uuid`/`decimal`)**  
   - AJV CLI при компиляции `packages/contracts/schemas/*.json` выдаёт предупреждения, что форматы `uuid` и `decimal` не известны.:contentReference[oaicite:94]{index=94}  
   - В `PROJECT-CONTEXT.md`: это зафиксировано как некритично, AJV игнорирует неизвестные форматы.:contentReference[oaicite:95]{index=95}  
   - **Gap:** формально, схемы валидны, но для строгой валидации либо:  
     - заменить `format: uuid`/`decimal` на `pattern` + `type`, либо  
     - зарегистрировать кастомные форматы в AJV (описать в README/specs tooling).  

2. **Отсутствие явной матрицы Schema ↔ DTO/Types**  
   - В c2p есть только список "Model Pointers (JSON Schemas)": `Issuance.json`, `Order.json`, `PayoutItem.json`, `AuditEvent.json`, `Wallet.json`, `TxHistoryItem.json`, `IssuerReportRow.json` и др.:contentReference[oaicite:96]{index=96}  
   - Нет единой таблицы вида `JSON Schema → C# record/TS type → OpenAPI/AsyncAPI usage`.  
   - **Gap:** для NX‑03/NX‑04 желательно добавить такую матрицу (чтобы тесты могли ссылаться на один SSOT по моделям).  

<!-- END: PROJECT-CONTEXT:API-EVENT-GAPS -->
```

---

## Section 4 — Artifacts & Next Steps

### 4.1 Структура spec‑артефактов

Опираемся на NX‑01 task и `PROJECT-CONTEXT.md`.

1. **`artifacts/spec-lint-openapi.txt`**

   * Содержимое: текстовый вывод Spectral по всем `openapi-*.yaml`.
   * Должно однозначно показывать:

     * Команду запуска (`npx ... spectral-cli@6 lint packages/contracts/openapi-*.yaml`).
     * Список файлов и итог по каждому (в NX‑01 — "No errors" по 9 файлам).
   * Использование:

     * Для любого MR — быстрый чек, что новые OpenAPI‑патчи не ломают линт.
     * Для NX‑02 — опора, что routing‑фиксы не требуют правки контрактов.

2. **`artifacts/spec-validate-asyncapi.txt`**

   * Содержимое: вывод `asyncapi/cli validate packages/contracts/asyncapi.yaml`.
   * В NX‑01: статус `Valid`, без ошибок.
   * Использование:

     * Подтверждение, что изменения в events (например, добавление новых топиков для order flow) остаются синтаксически валидными.
     * Для NX‑04 — контроль, что спецификация событий registry/settlement не расползается при расширении flow.

3. **`artifacts/spec-validate-jsonschema.txt`**

   * Содержимое: вывод `ajv-cli compile -s packages/contracts/schemas/*.json`.
   * В NX‑01: compile OK, warnings по `uuid`/`decimal`.
   * Использование:

     * Для NX‑03 (issuance tests): гарантия, что доменные модели (Issuance, Order) описаны корректно и единообразно для backend/SDK/tests.
     * Для NX‑04 (registry orders flow): контроль, что события/DTO для ордеров и транзакций (Order, TxHistoryItem, Wallet) валидны и синхронны с событиями Kafka.

### 4.2 Связь NX‑01 с NX‑02/03/04

Опираемся на WBS и aggregated talks.

* **NX‑02 — Gateway routing/health/metrics**

  * Входы из NX‑01:

    * REST API Matrix — path → YARP route → Target Service (см. Section 2).
    * Gap List по `/orders/{id}`, `/issuances` vs `/v1/issuances`, отсутствующим aggregator‑мэппингам и `/metrics` у gateway.
  * Использование:

    * Пройти по всем строкам матрицы и убедиться, что конфиг `appsettings.json` и фактические сервисы дают 200/2xx на `/health`/`/metrics` + на основные бизнес‑эндпоинты.
    * Дополнить матрицу aggregator‑эндпоинтами (market, investors, audit, kyc) и явно задокументировать, обрабатываются ли они gateway‑контроллерами или проксируются.

* **NX‑03 — Issuance endpoints alignment + tests**

  * Входы из NX‑01:

    * OpenAPI Issuance (`openapi-issuance.yaml`) и её успешный Spectral lint.
    * JSON Schemas Issuance/Order, проверенные AJV.
    * Event Matrix для `ois.issuance.published`/`closed`.
  * Использование:

    * Тесты в `issuance.Tests/*` обязаны опираться на те же модели/контракты, что описаны в схемах.
    * Любое изменение в контрактах (например, добавление payout schedule endpoints) должно сначала проходить через NX‑01 (спеки + lint), затем покрываться NX‑03 тестами.

* **NX‑04 — Registry order flow (create→reserve→paid) + events**

  * Входы из NX‑01:

    * REST Matrix для `/v1/orders`, `/orders/{id}`, `/v1/wallets/{investorId}`, `/v1/issuances/{id}/redeem`.
    * Event Matrix для `ois.order.created`, `ois.order.reserved`, `ois.order.paid`, `ois.registry.transferred`.
    * AsyncAPI gaps (топики без продьюсеров) как TODO‑список для доведения полного order‑lifecycle.
  * Использование:

    * При реализации/починке flow (create→reserve→paid→transfer) опираться на матрицу:

      * endpoint → сервис → события → topic.
    * После доработки продьюсеров для `ois.order.placed`/`confirmed`/`payout.scheduled`/`transfer.completed` — обновить AsyncAPI и Event Matrix, затем прогнать NX‑01 линты и обновить артефакты.

---

**Итого:** NX‑01 по сути уже выведен в режим **maintenance** (артефакты и матрицы существуют и валидны). Твоя задача дальше — использовать этот слой как **контрактный SSOT**:

* не трогать код, пока не обновлена спека и не прогнан lint,
* любые новые endpoints/events сначала описывать в OpenAPI/AsyncAPI/JSON Schemas,
* поддерживать API/Event Matrix и Gap List в `PROJECT-CONTEXT.md` как живой документ (через те же команды Spectral/AsyncAPI/AJV и обновление блоков из Sections 2–3).
