Я глубоко проанализировал все предоставленные материалы: логи сессий (включая сбойную `eywa1-p-cfa-w15.p1-20251121-1449.session.txt`), спецификации задач (NX-0\*), документацию и список текущих багов на `cfa1`.

Ситуация критическая. Предыдущий агент (`codex-cli`) столкнулся с дрейфом конфигурации (Configuration Drift) и, пытаясь его исправить, оставил стенд в полностью нерабочем состоянии.

Передавать эти баги обратно агенту в виде списка неэффективно. Требуется комплексное инфраструктурное вмешательство и исправление кода. Я предоставлю полный анализ и детальный план восстановления.

### Глубокий анализ причин сбоя (RCA)

Основная проблема заключалась в том, что стек фактически работал из `/opt/ois-cfa`, тогда как стандартом является `/srv/cfa/ois-cfa`. Агент попытался синхронизировать актуальный код в `/opt`, что привело к каскадному отказу:

1.  **Крах Фронтенда (Баги 1.1 и 1.2: Module not found)**

      * **Причина:** Агент синхронизировал код из `/srv` в `/opt` командой `rsync`, исключив `node_modules`.
      * **Результат:** Исходный код обновился, но `npm install` не был выполнен. Приложения Next.js не смогли найти зависимости (`@ois/shared-ui`, `web-vitals`), необходимые для нового кода.

2.  **Крах Бэкенда (Ошибки кода и Сетевая изоляция)**

      * **Ошибка в коде (Settlement Service):** В обновленном коде `settlement-service` использовался `app.UseRateLimiter()`, но отсутствовала конфигурация `builder.Services.AddRateLimiter()`. Сервис падал при старте (видно в логах сессии w15).
      * **Сетевая изоляция (Issuance Service и др.):** При перезапуске сервисов из `/opt` возникла сегментация сетей Docker. Инфраструктура (Postgres, Keycloak) и сервисы оказались в разных сетях. `issuance-service` падал при подключении к БД (`Resource temporarily unavailable`).

3.  **Крах Аутентификации (Баги 1.3 и 1.4)**

      * **Причина:** Сетевая изоляция и падение ключевых сервисов нарушили связь с Keycloak.
      * **Результат:** Ошибки входа пользователей (Баг 1.3) и таймауты админки Keycloak (Баг 1.4).

### План Восстановления (Recovery Plan)

Единственный корректный путь — привести окружение в соответствие со стандартом и **полностью мигрировать стек в `/srv/cfa/ois-cfa`**.

#### Шаг 1: Исправление кода (Settlement Service)

Это действие необходимо выполнить в коде репозитория (ветка `infra.defis.deploy`) и убедиться, что изменения загружены на сервер `cfa1`.

**Файл:** `services/settlement/Program.cs`

**Изменение:** Перед строкой `var app = builder.Build();` добавьте следующий блок:

```csharp
// Configure Rate Limiting (Fix for startup crash)
builder.Services.AddRateLimiter(options =>
{
    // Example configuration - adjust limits as needed
    options.AddFixedWindowLimiter("fixed", opt =>
    {
        opt.Window = TimeSpan.FromSeconds(5);
        opt.PermitLimit = 20;
        opt.QueueLimit = 5;
    });
    // Sensitive operations limiter (e.g., payments, transfers)
    options.AddConcurrencyLimiter("sensitive", opt =>
    {
        opt.PermitLimit = 5;
        opt.QueueLimit = 10;
    });
    options.RejectionStatusCode = 429; // Too Many Requests
});

var app = builder.Build();
// ...
```

#### Шаг 2: Скрипт восстановления CFA1

Этот скрипт предназначен для выполнения на сервере `cfa1` (через SSH, под пользователем с правами `sudo` и доступом к Docker, например `root`). Он полностью переносит и перезапускает стек.

```bash
#!/bin/bash
set -eou pipefail

# --- Конфигурация ---
TARGET_DIR="/srv/cfa/ois-cfa"
OLD_DIR="/opt/ois-cfa"
# Файлы Compose, идентифицированные из логов сессии w15
COMPOSE_FILES_FULL="-f docker-compose.yml -f docker-compose.override.yml -f docker-compose.kafka.override.yml -f docker-compose.services.yml -f docker-compose.health.yml -f docker-compose.keycloak-proxy.yml"
COMPOSE_INFRA_FILES="-f docker-compose.yml -f docker-compose.override.yml -f docker-compose.kafka.override.yml -f docker-compose.health.yml -f docker-compose.keycloak-proxy.yml"
COMPOSE_SERVICES_FILES="-f docker-compose.yml -f docker-compose.override.yml -f docker-compose.kafka.override.yml -f docker-compose.services.yml"

echo ">>> Начинаем восстановление CFA1 и миграцию в $TARGET_DIR..."

# --- Фаза 1: Остановка сломанного стека (/opt) ---
echo ">>> Фаза 1: Остановка стека в $OLD_DIR..."

# 1.1. Остановка PM2 (для user и root)
echo "Остановка процессов PM2..."
if sudo -u user command -v pm2 &> /dev/null; then
    echo "Stopping PM2 for user..."
    sudo -u user PM2_HOME=/home/user/.pm2 pm2 stop all || true
    sudo -u user PM2_HOME=/home/user/.pm2 pm2 delete all || true
fi
if command -v pm2 &> /dev/null; then
    echo "Stopping PM2 for root..."
    pm2 stop all || true
    pm2 delete all || true
fi

# 1.2. Остановка Docker Compose в /opt
echo "Остановка Docker Compose в $OLD_DIR..."
if [ -d "$OLD_DIR" ]; then
    cd $OLD_DIR
    docker compose $COMPOSE_FILES_FULL down || echo "Стек в $OLD_DIR уже остановлен или произошла ошибка."
fi

# --- Фаза 2: Подготовка $TARGET_DIR ---
echo ">>> Фаза 2: Подготовка $TARGET_DIR..."
cd $TARGET_DIR

# 2.1. Обновление кода (Убедитесь, что фикс Settlement загружен!)
echo "Обновление кода в $TARGET_DIR..."
# Убеждаемся, что права корректны перед операциями git
sudo chown -R user:user $TARGET_DIR
sudo -u user git fetch origin
sudo -u user git checkout infra.defis.deploy
# Используем pull --ff-only для безопасного обновления
sudo -u user git pull --ff-only origin infra.defis.deploy

# 2.2. Миграция переменных окружения (Критично!)
echo "Миграция .env файлов из $OLD_DIR в $TARGET_DIR..."
[ -f $TARGET_DIR/.env ] && mv $TARGET_DIR/.env $TARGET_DIR/.env.backup.$(date +%s)

# Копируем рабочие .env и .env.local из /opt
cp $OLD_DIR/.env $TARGET_DIR/.env
mkdir -p $TARGET_DIR/apps/portal-issuer $TARGET_DIR/apps/portal-investor $TARGET_DIR/apps/backoffice
[ -f $OLD_DIR/apps/portal-issuer/.env.local ] && cp $OLD_DIR/apps/portal-issuer/.env.local $TARGET_DIR/apps/portal-issuer/.env.local
[ -f $OLD_DIR/apps/portal-investor/.env.local ] && cp $OLD_DIR/apps/portal-investor/.env.local $TARGET_DIR/apps/portal-investor/.env.local
[ -f $OLD_DIR/apps/backoffice/.env.local ] && cp $OLD_DIR/apps/backoffice/.env.local $TARGET_DIR/apps/backoffice/.env.local

# 2.3. Установка прав доступа (после копирования)
echo "Установка прав для пользователя 'user'..."
sudo chown -R user:user $TARGET_DIR

# --- Фаза 3: Перезапуск Бэкенда из $TARGET_DIR ---
# Запуск из /srv создаст новую, консистентную конфигурацию сети Docker.
echo ">>> Фаза 3: Перезапуск Бэкенда в $TARGET_DIR..."

# 3.1. Запуск инфраструктуры
echo "Запуск инфраструктуры (DB, Kafka, Keycloak)..."
docker compose $COMPOSE_INFRA_FILES up -d postgres kafka zookeeper minio keycloak keycloak-proxy

echo "Ожидание стабилизации инфраструктуры (45с)..."
sleep 45

# 3.2. Сборка сервисов (Применяет новый код, включая фикс Settlement)
echo "Сборка сервисов..."
docker compose $COMPOSE_SERVICES_FILES build

# 3.3. Запуск сервисов
echo "Запуск сервисов..."
MIGRATE_ON_STARTUP=false docker compose $COMPOSE_SERVICES_FILES up -d

# 3.4. Верификация Бэкенда
echo "Верификация Бэкенда..."
sleep 20
docker ps --format "table {{.Names}}\t{{.Status}}"
curl -sk -I https://api.cfa1.llmneighbors.com/health | grep "HTTP"

# --- Фаза 4: Восстановление Фронтенда (PM2) ---
# Решает Баги 1.1 и 1.2 (Module not found)
echo ">>> Фаза 4: Восстановление Фронтенда (PM2)..."

# 4.1. Установка зависимостей (Выполняется от 'user')
# Порядок: SDK -> Shared-UI -> Apps
echo "Установка TS SDK..."
sudo -u user bash -c "cd $TARGET_DIR/packages/sdks/ts && npm install --no-audit --no-fund --include=dev && npm run build"
echo "Установка Shared UI (Фикс Бага 1.1)..."
sudo -u user bash -c "cd $TARGET_DIR/apps/shared-ui && npm install --no-audit --no-fund --include=dev"

echo "Установка приложений (Фикс Бага 1.2)..."
sudo -u user bash -c "cd $TARGET_DIR/apps/portal-issuer && npm install --no-audit --no-fund --include=dev"
sudo -u user bash -c "cd $TARGET_DIR/apps/portal-investor && npm install --no-audit --no-fund --include=dev"
sudo -u user bash -c "cd $TARGET_DIR/apps/backoffice && npm install --no-audit --no-fund --include=dev"

# 4.2. Запуск фронтендов через PM2 (от 'user')
echo "Запуск процессов PM2..."
export PM2_HOME=/home/user/.pm2
sudo -u user PM2_HOME=$PM2_HOME pm2 start npm --name portal-issuer --cwd $TARGET_DIR/apps/portal-issuer -- run dev
sudo -u user PM2_HOME=$PM2_HOME pm2 start npm --name portal-investor --cwd $TARGET_DIR/apps/portal-investor -- run dev
sudo -u user PM2_HOME=$PM2_HOME pm2 start npm --name backoffice --cwd $TARGET_DIR/apps/backoffice -- run dev
sudo -u user PM2_HOME=$PM2_HOME pm2 save
sudo -u user PM2_HOME=$PM2_HOME pm2 list

# --- Фаза 5: Финальная верификация и фикс авторизации (Баги 1.3, 1.4) ---
echo ">>> Фаза 5: Финальная верификация..."

# 5.1. Проверка URL фронтендов
echo "Проверка Issuer URL:"
curl -sk -I https://issuer.cfa1.llmneighbors.com/ | grep "HTTP"
echo "Проверка Investor URL:"
curl -sk -I https://investor.cfa1.llmneighbors.com/ | grep "HTTP"

# 5.2. Проверка Keycloak Admin (Фикс Бага 1.4)
echo "Проверка Keycloak Admin URL:"
curl -sk -I https://auth.cfa1.llmneighbors.com/admin/ | grep "HTTP"

# 5.3. Фикс входа пользователя (Фикс Бага 1.3 - alexabook1)
# Если вход всё ещё не работает, принудительно ставим emailVerified=true
echo "Проверка и обновление пользователя alexabook1 в Keycloak..."
KEYCLOAK_CONTAINER=$(docker ps -qf "name=ois-keycloak" | head -n 1)

if [ ! -z "$KEYCLOAK_CONTAINER" ]; then
    # Пароль админа по умолчанию 'admin123' (из документации docker-compose-at-vps/06-keycloak.md)
    docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh config credentials --server http://localhost:8080 --realm master --user admin --password admin123 || echo "Ошибка авторизации kcadm"
    
    # Предполагаемый реалм 'ois-dev' (на основе контекста предыдущих сессий)
    REALM_NAME="ois-dev" 
    
    # Получение ID пользователя
    USER_ID=$(docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh get users -r $REALM_NAME -q username=alexabook1 --fields id --format csv | tr -d '\r\n' || echo "")

    if [ ! -z "$USER_ID" ]; then
        echo "Обновление пользователя $USER_ID (alexabook1)..."
        docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r $REALM_NAME -s enabled=true -s emailVerified=true
        echo "Пользователь обновлен."
    else
        echo "Пользователь alexabook1 не найден в реалме $REALM_NAME. Проверьте имя реалма."
    fi
else
    echo "Контейнер Keycloak не найден."
fi

echo ">>> Скрипт восстановления завершен."
```