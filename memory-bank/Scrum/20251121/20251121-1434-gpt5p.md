Начну с краткого ответа, потом разверну 6.1 и 6.2.

1. **Продолжать тому агенту или запускать нового?**
   В твоей ситуации я бы **запускал нового Oracle‑агента** по уже выработанному стандарту `context.txt + prompt.md`, а старые результаты использовал как “сырьё” (часть composer‑контекста). У тебя уже есть skill и пример oracle‑пакета — ими и будем опираться.

2. **Как не перегрузить контекст?**
   Для Oracle‑агента нормальный объём — **10–25k tokens** в `context.txt`. Это как раз то, что ты уже генерировал через `code2prompt` (~22k токенов).
   Ключ — не пытаться засунуть *все* исходники, а давать:

   * снапшот веток/zip‑тегов/статуса NX‑тасок;
   * выжимку из runbook’ов/скриптов;
   * сами NX‑05/06/07/08 таски и summary по ним;
   * только самые важные куски кода (front/back) как примеры.

3. **Дальше отвечу:**

   * 6.1 — конкретный кейс: как сейчас собрать пакет и промпт для “Oracle NX05‑08 + NX07/08 readiness + новый домен”.
   * 6.2 — универсальная методика/cheatsheet (DoD, Kickoff tasks, паттерны промптов).

---

## 6.1. Конкретный кейс: новый Oracle‑агент под NX05‑08 + NX07/08 readiness

### Цель этого агента

Роль: **Senior Oracle/Evaluator & Mentor по OIS‑CFA**
Задача:

1. По `context.txt` понять:

   * состояние NX‑03…NX‑08;
   * состояние deploy/runbook’ов (eywa1 control plane, docker‑compose, Cloudflare, zip‑policy);
2. Оценить **готовность к демо** на новом домене (`*.cfa1.llmneighbors.com`/`cfa1.telex.global` — не критично как назовёшь).
3. Выдать:

   * Findings (по приоритету);
   * Deployment checklist для нового VPS;
   * NX‑07/NX‑08 readiness (что уже есть в коде, какие минимальные заглушки нужны, чтобы UI не падал);
   * Open questions к команде.
4. Плюс: дать **пакет задач для CLI‑агентов** (Codex/Claude/Gemini) и немного “менторинга/объяснений”.

---

### Шаг 1. Собираем свежий context.txt (очень конкретно)

Используем существующий skill **`oracle-evaluator-context-packaging.md`** как базу.

**1. Обновить код:**

```bash
cd ~/__Repositories/yury-customer/prj_Cifra-rwa-exachange-assets
git pull

cd repositories/customer-gitlab/ois-cfa
git fetch origin
git checkout infra.defis.deploy
git pull origin infra.defis.deploy
```

**2. Снимок веток/zip‑тегов:**

```bash
git tag -l 'zip/*' > /tmp/zip-tags.txt
git worktree list > /tmp/worktrees.txt
git log -n 5 --oneline > /tmp/last-commits.txt
```

**3. Сырые composer‑файлы через `repomix` / `code2prompt`**

> Идея — не один монструозный снимок, а **3–4 тематических**, потом ты сам делаешь выжимку в context.txt.

Примеры (адаптируй includes под реальные пути, но паттерн такой):

```bash
# A. Архитектура + контекст + NX-таски
repomix \
  --include "repositories/customer-gitlab/wt__ois-cfa__NX01/docs/context/**,repositories/customer-gitlab/wt__ois-cfa__NX01/docs/deploy/**,repositories/customer-gitlab/wt__ois-cfa__NX01/tasks/NX-0*/**" \
  --style markdown --compress \
  --output memory-bank/snapshots-aggregated-context-duplicates/composers/ois-cfa.nx-arch-and-tasks.repomix.txt

# B. Deploy/ops + zip
repomix \
  --include "repositories/customer-gitlab/ois-cfa/docs/deploy/**,repositories/customer-gitlab/ois-cfa/ops/**,repositories/customer-gitlab/ois-cfa/scripts/**,repositories/customer-gitlab/ois-cfa/docker-compose*.yml" \
  --style markdown --compress \
  --output memory-bank/snapshots-aggregated-context-duplicates/composers/ois-cfa.devops-and-deploy.repomix.txt
```

И (по аналогии с уже существующим oracle‑набором):

```bash
# C. NX05–08 + бэкенд/фронтенд вокруг
code2prompt --no-ignore \
  --include "repositories/customer-gitlab/wt__ois-cfa__NX01/tasks/NX-05-issuer-dashboard-and-reports.md,\
repositories/customer-gitlab/wt__ois-cfa__NX01/tasks/NX-06-issuer-payout-schedule-spec-and-ui.md,\
repositories/customer-gitlab/wt__ois-cfa__NX01/tasks/NX-07-backoffice-kyc-and-user-registry.md,\
repositories/customer-gitlab/wt__ois-cfa__NX01/tasks/NX-08-backoffice-audit-log-ui.md,\
repositories/customer-gitlab/wt__ois-cfa__NX01/artifacts/**,\
repositories/customer-gitlab/wt__ois-cfa__NX01/docs/context/**" \
  --tokens format \
  memory-bank/snapshots-aggregated-context-duplicates/composers/ois-cfa.nx05-08.snapshot.code2prompt.txt
```

**4. Собираем `context.txt` руками** (выжимка, а не просто конкат):

В `memory-bank/snapshots-aggregated-context-duplicates/composers/code2promp/20251121-oracle-nx05-08/`:

* `context.txt`
* `prompt.md`

`context.txt` примерно такой структуры (ты делаешь сводку на основе raw‑файлов):

```markdown
# Oracle Context · NX05–NX08 + Deploy

## 0. Snapshot
- Repo: ois-cfa @ infra.defis.deploy
- Commit: <hash>, Date: <…>
- Active worktrees:
  - wt__ois-cfa__NX01 (spec baseline)
  - wt__ois-cfa__NX05, wt__ois-cfa__NX06, wt__ois-cfa__NX07, wt__ois-cfa__NX08 (if exist)
- Zip tags:
  - zip/2025-11-19-nx03-06-uk1-sync, ...

(вставляешь выдержку из /tmp/zip-tags.txt и worktrees.txt)

## 1. High-level Архитектура / контекст
(сжатый пересказ ключевых мест из PROJECT-CONTEXT, FRONTEND-CONTEXT, C4, reposcan; 1–2 страницы)

## 2. NX03–NX08 Status Summary
(по выжимке из артефактов и oracle-сессии: что DONE, что In Progress, какие баги типа NX-03 500, что план по NX-07/08)

## 3. Deploy / Runbooks / Scripts
(сводка по docker-compose-at-vps/*, 10-eywa1-control-plane-runbook, ops/scripts/deploy/*.sh, Cloudflare/DNS, zip-политике)

## 4. Frontends (issuer / investor / backoffice)
(где лежат ключевые страницы:
- apps/portal-issuer: dashboard, reports,
- apps/backoffice: kyc, users, audit log,
и как они связаны с API.)

## 5. Backend services / API
(services/issuance, registry, settlement, compliance, identity — кто за что отвечает, какие контракты важны для NX05–08/NX07.)

## 6. Known issues / риски
(список того, что ты уже знаешь сам: баг NX-03, нестыковки NX-07 контрактов, дыры в deploy и т.п.)
```

То есть Oracle‑агент получает **структурированную выжимку**, а не набор “сырых” дампов.

---

### Шаг 2. Готовый промпт для этого Oracle‑агента (prompt.md)

Ниже — текст, который можно почти дословно класть в `prompt.md` и/или в само сообщение модели (если кнопками). Он уже учитывает:

* роль Oracle/Evaluator;
* mentoring/teaching;
* выдачу финальных инструкций и задач для CLI‑агентов.

```markdown
You are **GPT‑5.1 Pro acting as OIS‑CFA Senior Oracle/Evaluator & Mentor**.

You have **no access to the filesystem**.  
I attached one file: `context.txt` — it contains:
- snapshot of ois-cfa@infra.defis.deploy (branches, zip tags, worktrees),
- summaries of architecture, NX03–NX08 tasks, deploy/runbooks/scripts,
- key frontend/backend areas for issuer portals and backoffice,
- known issues and risks.

---

## Your Objectives

1. **Evaluate current state of NX03–NX08 and deploy:**
   - Are branches NX‑05/06/07/08 and their tasks/docs consistent with the described architecture?
   - Are deploy/runbook steps for new VPS/domain (cfa1.*) sufficient and consistent?
   - Is the zip/* workflow aligned with merged branches?

2. **Focus on NX‑07 / NX‑08 readiness:**
   - From context, derive:
     - which backend APIs and services (compliance, identity) already exist,
     - which frontend pages/components for KYC/Users/Audit Log exist in apps/backoffice,
     - what minimal stubs/mocks are needed so that new KYC and Audit UI do not crash even if backend is incomplete.
   - Propose **incremental plan**: which small slices can be implemented safely after NX‑05/06/08.

3. **Prepare tasks & guidance for CLI agents:**
   - For each problem / gap you find, propose:
     - a short **CLI‑agent prompt** (Codex/Gemini/Claude friendly),
     - expected DoD and Kickoff tasks (manual steps before the agent runs),
     - concrete file paths and branches to work in.

4. **Mentor me (the human owner):**
   - Explain trade-offs and reasoning in simple, actionable language.
   - Highlight where my existing structure (NX‑tasks, runbooks, skills) already helps, and where I overcomplicate things.

---

## Constraints & Style

- Prefer **precision over volume**. If something is unclear from context, mark it as “ASSUMPTION”.
- Do **not** invent new domains or services unless clearly implied by the context.
- Keep terminology consistent with:
  - NX‑tasks naming (NX‑05, NX‑06, NX‑07, NX‑08),
  - existing service names (issuance, registry, settlement, compliance, identity),
  - existing frontends (portal-issuer, portal-investor, backoffice).

---

## Required Output Format

Answer in **Russian**, except for code snippets and prompts.

### 1. Findings (по убыванию критичности)

For each finding:

- `[Severity: blocker|high|medium|low] Краткое резюме (1–2 строки)`
- Детали: что именно не сходится (ссылка на раздел/факт из context), последствия, что ломается при деплое/демо.

### 2. Deployment Checklist for New VPS/Domain

Markdown‑таблица:

| Phase | Steps | Required Inputs/Secrets | Notes |
|------|-------|-------------------------|-------|

Сфокусируйся на:
- eywa1 Control Plane (ssh, tmux, user, /srv/cfa),
- docker-compose stack (backend),
- PM2/Next.js frontends,
- Nginx + Cloudflare DNS/TLS,
- zip/* policy (какую ветку/tag деплоим).

### 3. NX‑07 / NX‑08 Readiness

Разбей на 3 блока:

1. **Что уже есть** (API, сервисы, страницы backoffice).
2. **Что блокирует запуск KYC/User Registry и Audit Log сразу после релиза NX‑05/06/08**.
3. **Предложенный план**:
   - минимальные backend заглушки/эндпойнты;
   - изменения в `apps/backoffice` (конкретные файлы: api‑клиенты, страницы, routing);
   - очередность шагов (что делать до/после деплоя на новый домен).

### 4. Tasks for CLI Agents

Список задач; каждая запись:

- **[Agent N] Title** — 1 строка.
- **Role & Context** — короткий промпт для CLI‑агента (en).
- **Kickoff** — ручные шаги: создать worktree, подготовить .env, запустить code2prompt/repomix, и т.п.
- **DoD** — чёткий критерий готовности.

### 5. Open Questions

Список вопросов:
- к инженерам (по домену, инфраструктуре, данным),
- к будущему себе (что уточнить перед большим рефакторингом).

---

Если контекст противоречив, сначала отметь противоречия в разделе Findings, а уже потом предлагай план.
```

Этот промпт уже завязан на твой skill `oracle-evaluator-context-packaging` и формат, который ты сам описывал в oracle‑планах (4 секции и задачи для агентов).

---

### Мини-декомпозиция NX‑07 / NX‑08 “по коду” (чтобы сразу не потерять)

Это кусок, который ты просил “давай” сделать — можно включить как подсказку Oracle‑агенту или использовать прямо для CLI‑агента:

* **Backoffice KYC / Users (NX‑07)**

  * Front:

    * `apps/backoffice/app/kyc/page.tsx` — список заявок KYC (минимум: таблица + статус/кнопки).
    * `apps/backoffice/app/users/page.tsx` — список пользователей/инвесторов.
    * `apps/backoffice/src/lib/api/compliance.ts` — клиент к KYC/Compliance API (на первых порах можно с безопасными моками).
  * Backend:

    * `services/compliance` — домен KYC/AML, заявки, статусы.
    * `services/identity` — users / registry of persons.
  * Минимальный шаг: сделать API‑клиент, который:

    * при наличии реального эндпойнта — ходит в него;
    * при отсутствии — возвращает безопасный мок, но не ломает UI (и помечает это в логах/комментариях).

* **Backoffice Audit Log (NX‑08)**

  * Front:

    * новый модуль `apps/backoffice/lib/api/audit.ts`;
    * страница или секция в backoffice `/audit` или “Audit Log”.
  * Backend:

    * сервис/эндпойнт `GET /v1/audit` (или схожий), если есть;
    * если нет — фронт готовится работать с мок‑данными + явным TODO.

Это можно зашить в oracle‑контекст или использовать как базу для отдельных CLI‑промптов.

---

## 6.2. Ready-pack methodology · как запускать таких агентов системно

Сейчас у тебя уже есть два базовых skill’а:

* `context-composer-repomix-code2prompt` — **как собирать сырьё** (repomix/code2prompt).
* `oracle-evaluator-context-packaging` — **как из сырья сделать context.txt + prompt.md**.

Ниже — более общий “HOWTO/cheatsheet”, который можно превратить в отдельный skill/док:

### A. Типы агентов

1. **NX‑Feature Agent** — делает конкретную фичу (NX‑05, NX‑06, NX‑07, NX‑08).
2. **Infra/Deploy Agent** — настраивает VPS/домены/Cloudflare/Keycloak.
3. **Oracle/Evaluator Agent** — смотрит на всё сверху, как мы сейчас.
4. **QA/Playwright Agent** — проверяет end‑to‑end.

Все они живут поверх **одной и той же структуры**:

* NX‑task → SSOT цели и DoD;
* Kickoff → ручные шаги для человека;
* Prompt‑package → тонкая надстройка для конкретной модели (FS‑less или с FS).

---

### B. Общий DoD для “запуска агента”

**Таска считается “Ready для агента”, если:**

1. Есть **NX‑task** в репо:

   * YAML frontmatter, TL;DR, контекст/ссылки (C4, reposcan),
   * Plan/How с шагами,
   * DoD/Acceptance Criteria (по фронту, бэкенду, тестам, артефактам).
     (Пример — обновлённая NX‑05 спека, которую агент уже переписал. )

2. Есть **Kickoff** (ручной чеклист):

   * создать нужную ветку/ worktree;
   * убедиться, что `.env`/секреты подготовлены;
   * запустить нужные `code2prompt`/`repomix` команды (если агент будет Oracle/FS‑less);
   * включить нужный skill (AGENTS.md/.claude/skills).

3. Есть **Prompt‑package**, если агент FS‑less:

   * `context.txt` — по skill’у `oracle-evaluator-context-packaging`;
   * `prompt.md` — конкретная постановка для модели (цели + формат ответа).

4. В DoD явно написано:

   * какие артефакты должны появиться (md‑отчёты, скрипты, PRs),
   * какие команды должны успешно отработать (tests, build, e2e).

---

### C. Kickoff tasks (универсальный шаблон)

Этот блок легко вынести в отдельный Markdown‑шаблон:

```markdown
## Kickoff Checklist (для человека перед запуском агента)

1. **Sync repos**
   - [ ] `git pull` в monorepo.
   - [ ] `git pull origin <base-branch>` в submodules (`ois-cfa` и др).

2. **Branches / Worktrees**
   - [ ] NX‑ветка создана от правильной базы (`infra.defis.deploy` или другая).
   - [ ] worktree создан (`wt__ois-cfa__NX07`, `wt__ois-cfa__NX08`, ...).
   - [ ] symlink `memory-bank/` рабочий.

3. **Env & Secrets**
   - [ ] `.env.*` подготовлены (даже если частично).
   - [ ] доступы к VPS/Cloudflare/Keycloak проверены (ssh, tokens).

4. **Context aggregation (если нужен FS-less агент)**
   - [ ] Отобраны зоны include/exclude для `repomix`/`code2prompt`.
   - [ ] Сгенерированы raw‑файлы с контекстом.
   - [ ] Собран `context.txt` (snapshot + тематические секции).
   - [ ] Написан `prompt.md` (цели + формат ответа).

5. **AGENTS/skills**
   - [ ] В AGENTS.md/skills упомянут новый пакет (путь к context/prompt).
   - [ ] Понимаешь, какой тип агента запускаешь (Feature/Infra/Oracle/QA).
```

---

### D. Как не перегрузить “голову внимания” модели

1. **Oracle‑агенту**:

   * 1 файл `context.txt` **до ~25k tokens**.
   * Внутри — 5–7 разделов, каждый с чётким заголовком и минимумом шума.
   * Вместо повторения большого куска кода — дать 1–2 характерных файла + summary “остальное по такой же схеме”.

2. **Feature‑агенту (CLI с FS)**:

   * Не нужен `context.txt`; достаточно:

     * NX‑task,
     * список директорий, где работать,
     * AGENTS.md со стилем/правилами.

3. **QA‑агенту**:

   * Отдельный маленький контекст: e2e tests, env‑matrix, DoD по тестам.

4. **Правило из eval‑on‑eval**:
   *“1–2 часа на формирование стандарта — ок; дальше на каждую новую большую задачу по 10–15 минут приведения к шаблону”* — не уходить снова в многодневный мета‑режим.

---

### E. Что можно оформить как отдельный skill/cheatsheet

Ты можешь оформить новый skill, условно:

`repositories/customer-gitlab/ois-cfa/.claude/skills/master-oracle-agent.md`

С содержимым примерно такого вида:

* When to use: когда нужно “главный Oracle” по NX‑эпикам/миграции.
* Inputs: ссылку на уже собранный `context.txt` + чек‑лист Kickoff.
* Pattern outputs: 4–5 секций (Findings, Deployment Checklist, Readiness для ключевых NX, Tasks for agents, Open Questions).
* Ссылку на:

  * `context-composer-repomix-code2prompt`,
  * `oracle-evaluator-context-packaging`,
  * шаблон Kickoff/DoD (как выше).

Тогда любой новый эпик:

1. Создаёшь NX‑task/infra‑task по шаблону.
2. Закрываешь Kickoff.
3. Готовишь oracle‑pack по skill’у.
4. Запускаешь Master‑Oracle‑агента.
5. Из его ответа делаешь 3–7 CLI‑агент‑тасок.

---

### Небольшой личный совет

* Считай, что **мета‑слой (skills, oracle‑packs)** у тебя уже сформирован. Докрутить можно, но это не должно быть новой многодневной задачей.
* Сфокусируйся на **одном master‑oracle‑пакете** под NX05‑08 + deploy и выжми из него максимум:

  * получи качественный отчёт,
  * выпиши 5–10 задач для CLI‑агентов,
  * дальше просто **исполняй**.

Если хочешь, в следующем сообщении я могу:

* либо помочь **сформулировать конкретные CLI‑промпты** для NX‑07 backend agent / NX‑08 UI agent / QA agent на базе этого master‑oracle‑подхода,
* либо точечно разобрать **конкретный кусок кода backoffice KYC/Audit** и предложить минимальные заглушки так, чтобы уже сейчас UI не падал.
