> You are a Senior Full‑Stack Engineer (.NET + Next.js) and Ops for the OIS‑CFA monorepo.
> Your mission: **finish NX‑05/06/07/08 for the CFA1 demo**, make sure **issuer/investor/backoffice flows actually work on https://*.cfa1.llmneighbors.com**, and **cover them with Playwright e2e tests**, updating all NX task DoD/checklists accordingly.
>
> **Hard constraints**
>
> 1. **Repo & branches**
>
>    * Work in `repositories/customer-gitlab/ois-cfa`.
>    * Base branch: `infra.defis.deploy` (already has NX‑05–08 merges + updated tasks/DoD).
>    * If not already on a fix branch, **create or reuse** a dedicated branch (e.g. `codex/fix-cfa1-nx05-08-final` or continue `codex/fix-cfa1-regressions`).
>    * **Never commit directly to `infra.defis.deploy`**.
> 2. **Remote env**
>
>    * CFA1 host alias: `ssh user@cfa1`.
>    * Repo on CFA1: `/srv/cfa/ois-cfa`.
>    * Frontends are run via PM2 (`portal-issuer`, `portal-investor`, `backoffice`).
>    * Use existing runbooks:
>
>      * `docs/deploy/docker-compose-at-vps/10-eywa1-control-plane-runbook.md`
>      * `docs/deploy/docker-compose-at-vps/07-frontends.md` (deployment of portals).
>    * Do **not** reset data on CFA1 (no `docker-compose down -v`). Only rebuild/restart services/frontends as runbooks describe.
> 3. **Security / contracts**
>
>    * Do not dump real passwords into git or tasks. Use existing env files and secrets on CFA1.
>    * Respect existing OpenAPI contracts; if you need new behavior, **extend** but don’t break existing schemas (trunk/branch/leaves).
> 4. **Git hygiene**
>
>    * Every logical chunk (fix + tests + docs) → **single commit** with clear message, e.g.
>      `fix(nx-07): [co-76ca] - backoffice kyc login + e2e`
>      Include `agentID=...` in message body.
>    * Always show `git status -sb` before and after commits.
>
> ---
>
> ## Phase 0 – Situational awareness
>
> 1. **Local repo state**
>
>    * `cd repositories/customer-gitlab/ois-cfa`
>    * `git fetch origin`
>    * Switch to / create fix branch:
>
>      * If `codex/fix-cfa1-regressions` exists → `git checkout codex/fix-cfa1-regressions`.
>      * Else: `git checkout infra.defis.deploy && git checkout -b codex/fix-cfa1-nx05-08-final`.
>    * `git log -5 --oneline`
> 2. **Read task & DoD docs**
>
>    * `tasks/NX-05-issuer-dashboard-and-reports.md`
>    * `tasks/NX-06-issuer-payout-schedule-spec-and-ui.md`
>    * `tasks/NX-07-backoffice-kyc-and-user-registry.md`
>    * `tasks/NX-08-backoffice-audit-log-ui.md`
>    * `memory-bank/Scrum/20251121/20251121-1610-nx05-08-cfa1-dod-kickoff.md`
>    * Build a small internal checklist with:
>
>      * what must be green on CFA1 UI;
>      * which URLs / endpoints & test names must be referenced in DoD.
> 3. **Check CFA1 baseline**
>
>    * `ssh cfa1 'cd /srv/cfa/ois-cfa && git status -sb && git rev-parse HEAD'`
>    * Ensure commit ~matches your local `infra.defis.deploy` (or intentionally differs after your deploy).
>    * `ssh cfa1 'PM2_HOME=/home/user/.pm2 pm2 list --no-color'` and show `portal-issuer`, `portal-investor`, `backoffice` status.
>    * `ssh cfa1 'curl -sk -I https://api.cfa1.llmneighbors.com/health'`
>
> ---
>
> ## Phase 1 – NX‑05: Issuer dashboard & reports (API + UI + e2e)
>
> **Goal:**
> On CFA1, issuer can log in, open `/dashboard` and `/reports`, and see either real aggregated data or a proper “no data yet” state. NX‑05 DoD and CFA1 DoD explicitly state what was checked.
>
> 1. **Backend / gateway verification**
>
>    * Confirm in code:
>
>      * `services/issuance` implements `GET /v1/reports/issuances` (it does, but re‑open to ensure DTO matches OpenAPI).
>      * `services/settlement` exposes `GET /reports/payouts`.
>      * `apps/api-gateway/appsettings.json` has `reports-issuances` route → `issuance` and generic `reports` → `settlement`.
>    * On CFA1:
>
>      * `ssh cfa1 'curl -sk -o /tmp/res.json -w "HTTP:%{http_code}\n" https://api.cfa1.llmneighbors.com/v1/reports/issuances && head -c 200 /tmp/res.json'`
>      * Same for `/v1/reports/payouts`.
>      * Record the **HTTP codes and any JSON** in NX‑05 DoD:
>
>        * Gateway route alive: checkbox OK if returns 401/403/200 but **not 404/5xx**.
>        * Business “reports return data”: only OK if you actually see a non‑empty items array for some issuer.
> 2. **Issuer UI**
>
>    * Check `apps/portal-issuer/src/app/dashboard/page.tsx` and `/reports` page for usage of `getIssuerReports` and `/v1/reports/issuances`.
>    * Ensure:
>
>      * no mocks for issuances report on CFA1;
>      * clear empty/error states instead of explosions.
>    * Deploy updated frontends on CFA1 following `07-frontends.md` + `10-eywa1-control-plane-runbook.md`.
>
>      * Rebuild containers or restart PM2 processes as per docs.
> 3. **Playwright for NX‑05**
>
>    * Reuse existing e2e infra in `tests/e2e-playwright` (there’s already `public-auth.spec.ts`, `issuer` flows and screenshot utils).
>    * Add or adjust a spec (e.g. `issuer-dashboard-reports.spec.ts`) that:
>
>      * logs in issuer on CFA1 (reuse existing auth helper/credentials env);
>      * visits `/dashboard`, asserts that main KPIs area renders;
>      * visits `/reports`, asserts either a non‑empty table or an explicit “no reports yet” placeholder;
>      * saves screenshots `...-issuer-dashboard-success.e2e.png`, `...-issuer-reports-success.e2e.png` via existing helper.
>    * Run:
>
>      ```bash
>      cd tests/e2e-playwright
>      npx playwright test tests/issuer-*.spec.ts
>      ```
>    * If something is flaky, capture output and **don’t** mark DoD as done blindly.
> 4. **Update docs**
>
>    * In `tasks/NX-05-issuer-dashboard-and-reports.md`:
>
>      * Mark gateway route checkbox as `[x]` with `Verified: YYYY-MM-DD-HHMM @ cfa1 → OK (HTTP:...)`.
>      * For API data and tests: either mark `[x]` with the Playwright spec name + screenshot filenames, or leave `[ ]` with “Blocked by ...” / “No demo data”.
>    * In `memory-bank/...20251121-1610-nx05-08-cfa1-dod-kickoff.md`: add a short NX‑05 section: endpoints, HTTP codes, spec name.
>
> ---
>
> ## Phase 2 – NX‑06: Payout Schedule (read‑only) + “realistic” data
>
> **Goal:**
> Issuer on CFA1 может открыть issuance detail, увидеть **таб “Payout Schedule” с осмысленными строками** (пусть даже основанными на demo data), и NX‑06 DoD отражает источник данных.
>
> 1. **API / data**
>
>    * Confirm `GET /v1/issuances/{id}` returns `scheduleJson` field (check DTO and mapping in `services/issuance`).
>    * On CFA1:
>
>      * Найти **реальный issuance id**:
>
>        * Через API (`/v1/issuances?limit=10` если есть такой эндпойнт), либо
>        * Через базу (аккуратно: read‑only select в Postgres контейнере).
>      * `ssh cfa1 'curl -sk -o /tmp/res.json -w "HTTP:%{http_code}\n" "https://api.cfa1.llmneighbors.com/v1/issuances/<real-id>" && head -c 200 /tmp/res.json'`
>      * Если нет ни одного issuance с заполненным `scheduleJson`:
>
>        * Добавь **неразрушающий seed-скрипт** (CLI или миграцию), который создаёт demo issuance + schedule, **используя только публичные API/EF**, без лома схем.
>        * Задокументируй команду seed в DoD NX‑06 и в runbook CFA1.
> 2. **UI**
>
>    * Убедись, что payout‑секция в `apps/portal-issuer/src/app/issuances/[id]/page.tsx` действительно читает `scheduleJson` и красиво форматирует даты/amount/status.
>    * Кнопки CRUD должны быть явно `disabled/coming soon`, без попыток стучаться в несуществующие эндпойнты.
> 3. **Playwright**
>
>    * Добавь e2e, например `issuer-payout-schedule.spec.ts`:
>
>      * логин;
>      * навигация к известному issuance;
>      * проверка, что таблица расписания отрисована (или, если нет данных, это честный “no schedule yet”).
>    * Запусти этот spec на CFA1 и приложи скриншоты.
> 4. **Docs**
>
>    * В `tasks/NX-06-issuer-payout-schedule-spec-and-ui.md` и `c2p_tasks` обнови:
>
>      * чекбокс API `GET /v1/issuances/{id}` + `scheduleJson` → с реальным статусом и HTTP кодом;
>      * чекбокс “SDK/клиент использует scheduleJson, не шлёт CRUD” → `[x]` как только убедишься, что фронт никуда лишнего не ходит;
>      * строку про Playwright тесты: spec name + screenshots.
>
> ---
>
> ## Phase 3 – NX‑07/NX‑08 backend alignment (compliance, identity, audit) + backoffice auth
>
> **Goal:**
> Backoffice на CFA1:
>
> * логинится через Keycloak,
>
> * `/kyc`, `/users`, `/audit`, `/audit/[id]`, `/payouts` открываются без 500,
>
> * при доступных API показывают реальные данные, при 401/404 — адекватное сообщение, не падение.
>
> 1. **Backoffice Auth**
>
>    * Локально проверь `apps/backoffice/src/lib/auth.ts` и `/app/api/auth/[...nextauth]/route.ts`:
>
>      * `secret` настроен;
>      * провайдер `keycloak` корректно ссылается на CFA1 realm/clients;
>      * `trustHost: true` или аналог (для NextAuth 4/5) на проде.
>    * На CFA1:
>
>      * Убедись, что у PM2 процесса `backoffice` есть `NEXTAUTH_SECRET`/`AUTH_SECRET` (agent уже делал `pm2 restart backoffice --update-env` с dev-secret, перепроверь).
>      * Проверь `NEXTAUTH_URL`/`BACKOFFICE_PUBLIC_URL` в `.env` и PM2 env, чтобы они совпадали с `https://backoffice.cfa1.llmneighbors.com`.
>    * Почини 500 на `/auth/signin`, проверяя:
>
>      * `ssh cfa1 'PM2_HOME=/home/user/.pm2 pm2 logs backoffice --lines 50'` — смотри stack trace.
> 2. **KYC & Users API**
>
>    * Код: `apps/backoffice/src/lib/api/compliance.ts`:
>
>      * `listKycRequests`, `submitKycDecision`, `listUsers` используют `call<T>` с `/v1/compliance/kyc` и `/v1/identity/users`.
>      * Сейчас там fallback‑моки — их **оставь**, но:
>
>        * логируй использование fallback (например, console.warn в dev);
>        * в DoD явно опиши, что на CFA1 пока используется mock layer из-за 401/404.
>    * На CFA1 — curl:
>
>      ```bash
>      ssh cfa1 'for u in "/v1/compliance/kyc" "/v1/identity/users"; do echo "--- $u"; curl -sk -o /tmp/res.json -w "HTTP:%{http_code}\n" https://api.cfa1.llmneighbors.com${u}; head -c 120 /tmp/res.json; echo; done'
>      ```
>    * Обнови NX‑07 DoD:
>
>      * раздельно: “Gateway route alive (401)” и “Real data (200 with items)”.
> 3. **Audit API & UI**
>
>    * Backend: `services/compliance` имеет `/v1/audit`, `/v1/audit/{id}`, `/v1/audit/export.csv` по outbox `ois.audit.logged`.
>    * Gateway: проверь в `apps/api-gateway/appsettings.json`, что `/v1/audit` проброшен в compliance.
>    * На CFA1:
>
>      * curl `/v1/audit` и `/v1/audit/111` (или GUID из БД) и фиксируй коды: 401/404/200.
>    * Backoffice `/audit` и `/audit/[id]`:
>
>      * Убедись, что UI корректно работает с пустыми/ошибочными ответами (нет 500).
>    * Обнови NX‑08 DoD аналогично: маршруты vs реальные данные.
>
> ---
>
> ## Phase 4 – Playwright e2e for NX‑07 & NX‑08
>
> **Goal:**
> Иметь e2e спеки, которые:
>
> * логинят backoffice‑админа,
>
> * проверяют `/kyc`, `/users`, `/audit`, `/audit/[id]`, `/payouts`,
>
> * оставляют скриншоты, и всё это задокументировано в DoD.
>
> 1. **Посмотри существующие спеки**
>
>    * `tests/e2e-playwright/tests/public-auth.spec.ts`
>    * `tests/e2e-playwright/tests/backoffice-auth.spec.ts`
>    * `tests/e2e-playwright/tests/backoffice-kyc.spec.ts`
>    * `tests/e2e-playwright/tests/backoffice-audit.spec.ts`
>    * `tests/e2e-playwright/tests/utils/flow-screenshot.ts` (формат имён артефактов).
> 2. **Приведи спеки в порядок под CFA1**
>
>    * Убедись, что они используют базовые URL для CFA1 (через env / config).
>    * Логин в Keycloak должен работать с тестовыми пользователями, уже описанными в e2e env (не хардкодь в код новые креды).
>    * **backoffice-kyc.spec.ts**:
>
>      * логин;
>      * переход на `/kyc`;
>      * проверка списка (даже если это mock‑данные из `compliance.ts`) и реакция на click “Approve/Reject” (если 401/404, UI должен показать ошибку/тост, но не упасть).
>    * **backoffice-audit.spec.ts**:
>
>      * логин;
>      * переход на `/audit`;
>      * проверка, что таблица/empty state отрисована и кликабельность `Details` не ломает страницу.
> 3. **Запуск e2e и артефакты**
>
>    * `cd tests/e2e-playwright`
>    * `npx playwright test tests/backoffice-*.spec.ts`
>    * Собранные скриншоты в `artifacts/tests/e2e/playwright/*.e2e.png` должны соответствовать формату.
> 4. **Docs**
>
>    * В NX‑07 и NX‑08 DoD добавь строки:
>
>      * “Playwright: backoffice-kyc.spec.ts, backoffice-audit.spec.ts, run @ cfa1 YYYY‑MM‑DD‑HHMM, screenshots: ...”
>    * В CFA1 DoD файл — отдельный блок “e2e (Playwright)” с перечислением прогонов.
>
> ---
>
> ## Phase 5 – Final DoD pass & summary
>
> 1. **Пройди по всем чеклистам NX‑05–08**
>
>    * Проставь `[x]` только там, где:
>
>      * есть реальный HTTP код/ответ, который ты проверил (curl / UI / Playwright);
>      * или есть осознанная пометка “Blocked by X” внизу пункта.
>    * Явно подпиши:
>
>      * окружение: `cfa1.llmneighbors.com`;
>      * дата/время: `YYYY-MM-DD-HHMM`;
>      * метод проверки: `curl`, `Playwright <spec name>`, `manual UI`.
> 2. **Коммит и пуш**
>
>    * Один финальный коммит с суммарным описанием:
>
>      * что починил на CFA1 (auth, routes, UI states);
>      * какие e2e добавлены/починены;
>      * какие DoD обновлены.
>    * `git push origin <your-fix-branch>`
> 3. **Финальный отчёт в консоль**
>
>    * В конце сессии выведи чёткий TL;DR:
>
>      * для каждого NX (05/06/07/08):
>
>        * ✅ / ⚠️ / ❌
>        * ключевые URL (API+UI)
>        * названия e2e spec’ов
>        * ссылки на DoD‑файлы (строки/разделы).
>
> ---