# Prompt
````prompt
Следуй предыдущей канве и контексту. Будь объективен и непредвзят.

First attentionally read current session and increments, evaluate with a previous DoD, Kickoff tasks by phases and score X-of-100 and estimate 0...100% completeness and accuracy of a agentID=`019aa5f8-8c38-7531-8809-841d16d27c63 `, partAgentID=`8c38` model `Codex-Gpt5.1-Max-Highest`

Then based on new insights and undersanding listen me attentively. Выдели из моего голосового сообщения все requirements, corrections, suggestions from my voice instructions and corrections.

```transcript
Слушай, а у нас Swagger endpoints подняты или нет? И есть ли у нас какой-то аналог Swagger для Kafka? Если да, то по каким URL они доступны и как они у нас защищены через NgNX, Authpass или какой вообще для этого industry standard и best practices? Типа логин и пароль какой-то, можем так.

То есть сделай наилучшим образом. Точнее, не сделай, а спроектируй. Потому что я хочу, чтобы в каждом task, где вот definition of done, если это backend-метод, чтобы было в двух разрезах: как таковые команды на тесты, будь это unit, integration или end-to-end.

Дальше напоминаю, что конечный deliverable, definition of done — это прохождение Playwright-теста с тем, что тест пройден, скриншот сделан и является завершенным. Если в одном коммите у нас вот этот конкретный инкремент, где мы видим изменение исходного кода, если они были, да, тестов, если они были, артефакты от Playwright или артефакты от тестов, которые что-то выдают — ну, в общем, все связанные с этим изменения с соответствующим комментарием получается. И если эта задача закрыта, она должна быть по Git workflow замержена в ветку develop.

Да, очень важный момент. До этого мы постоянно говорили о том, что у нас ветка основная infra.defix.deploy — это не соответствует стандартам. И сегодня я окончательно уравнял, и сейчас на данный момент поддерживаю обе эти ветки, и пора продепрекейтить. Попроси агента отдельной задачей grep'ом пройтись по документациям, и где указано, что основная ветка, по match слово infra.defis.deploy заменить на develop и дальше, как бы, мержиться в неё.

И также ещё отдельный ряд требований. Сегодня на tech sync мы с командой обсуждали, где я внёс предложение использовать единый файлик в корне CHANGELOG. Обрати внимание, я там закинул high-level headings. Идея вот такая, что он не совсем классический changelog — просто если мы сделаем много changelog-документов, все в них растеряются.

Мы делаем разделение. Есть классика, где по версионированию у нас сейчас идёт разработка сырого прототипа, и это не настолько критично. А вот критично, чтобы все члены команды, и в том числе другие агенты — они же тоже являются членами команды, как ты или другой агент codex.tl.ai, которому мы запустим.

Я даже думаю эту философию, наверное, где-то прописать. У всех должен быть Agent ID и четырёхзначное Part Agent ID — четырёхзначное, чтобы мы, люди, могли лучше ориентироваться и не теряться. А также время жизни агента: с какой даты, по какую дату он работал и над какими задачами он работал. Если задачи как таковой не заведено в tasks, то ладно, что тут сказать.

Сейчас мы делаем идеальную систему, проектируем. Мы проектируем систему, которая будет работать, и будем улучшать оперативно.

Так вот, следующий важный шаг в changelog. Ты видишь там разделение: Architecture, Backend, потом Ops (means DevOps) и так далее, дальше Frontend. Что ещё? И Administration. Есть такие мелочи. А, ещё отдельно QA. Хотя QA с Administration я не очень понимаю разделение — пусть будет это Administration/QA H1 заголовок.

То есть у нас есть единый пользователь — вот этот investor и issuer. У нас есть единый backend backoffice admin. Да, вот у него какой-то пароль, да, что у того какой-то пароль. Нужно, чтобы везде в Playwright-тестах был один user, и QA manual-тестировщики тоже использовали этого user'а. И, соответственно, где они это возьмут? Просто из документа зайдут, там оно прописано.

Я там закинул, по-моему, backoffice admin — пароль не актуальный. Я вижу, ты выставил другой пароль, но окей, главное, чтобы он был рабочим, да.

И такие, знаешь, вещи, которые я там тоже начал прописывать: что я в Keycloak создал отдельную типа группу, отдельный client scopes, отдельный role, assigned их, там добавил. Если я выставил какую-то там registration no need to verify email, или я выставил, например, ещё какие-то опции и прочее, которые полезны другим членам команды, то есть это в changelog нужно фиксировать.

Но это отдельная такая системная административная эпика. Всё же напоминаю, нам нужно доделать основные задачи. Я вот зашёл в backoffice, вижу там, например, backend недоступен пишется. Ну а чего он недоступен? Он должен быть доступен на рабочем. Мы же проговаривали это состояние — если агент отошёл от этого, нужно это прописать ему.

Также, поэтому я и затронул Swagger и Kafka endpoints. И вообще, Kafka у нас сейчас работает, связана и так далее — ты это изучал в промпте? Если нет, нужно это тоже добавить.

Напоминаю, то есть вот эти все таски NX-05, 06, 07, 08 должны быть сделаны — ну, такие, чтобы это было не кринжово, чтобы они работали. Надеюсь, я понятно выразил мысли.

Нужно внимательно проаудировать и валидировать агента на выходе конечной промпты и на выходе, как обычно, в данном случае, но только в рамках задачи. И всё это должно быть cross-reference с реальными тасками, чтобы соблюдать single source of truth and don't repeat yourself — короче, чтобы не было mixed.

На этом пока всё.

```
p.s. agent 8c38 - 6% context left, потом compact с рисками, сделать compact и потом дать твой промпт или вообще новый начать? 

Про второстепенную сессию just FYI и это может дать пользу и больше контекста но особых задач тут не выставил

```transcript
Так, короче, следующая история. Я записывал, где оно отвалилось, я повторно запишу.

Суть такая, что в другой сессии с агентом я делал анализ проделанной работы. Мне нужно было понимать основные created, modified, deleted, updated и так далее файлы. Понимать, где и к какой категории софта относятся: frontend, backend. Внутри backend это .NET, это Golang, это TypeScript или что-то ещё. Если это frontend, то что именно менялось, добавлялось. Очень интересно, особенно добавлялось. Понимать инкременты, понимать модифайты. Не трогались ли контракты, пакеджи с архитектурой.

Также есть все подходы, которые я использую: методология trunk-branch-leaves для контроля агентов через guardians. Эта система ещё экспериментальная, я её буду дорабатывать.

Также я что ещё хочу подметить, подсветить ключевые поинты. Видишь, я выдумал там скрипты, которые из YAML уберутся. Я там внимательно прочитаемые промпты в сессии, и там получается больше развёрнуто идей. Я там описывал, короче, вижу.

Как это может помочь? Ну, возможно, тоже натолкнёт на какие-то идеи, или ты мне дашь советы. Best projection со стопа, и с линкой и прочее. Но это отдельная задача. Это просто сейчас как на заметку. Может быть, её стоит увязать для решения основной задачи.

Ещё из новостей: мы на техсинке это обсуждали с командой. И ещё обсуждали мы на следующих франчах. Вот это сделать CI такой. Это GitLab получается. И инструмент Partner. Это, я так понимаю, замена GitLab или GitLab Registry какой-то свой, типа, или Docker Hub, да? Может, не точно. Ну, такой какой-то обозреваемый.

Ну, ладно. Эту задачу тоже сейчас не будем умещать, чтобы не раскачивать голову и внимание агентов в отдельном conversation.

Тут основной вопрос сейчас вот этот: текущий агент мой. Получается, ему надо, наверное, новую сессию начинать и заново собирать контекст. Дать максимально все отсылки, файлы, просто референс, читать коммиты, читать доки, исследовать workflow и так далее, и т. д., и т. п.

А что касается артефактов, произведённых этими скриптами, YAML-ами и то, что делали, то получается... Там... что там? Там всё... прокомментирую потом.
```
````
# Output
Начну сразу с оценки, потом извлеку все требования из твоего голоса и в конце отвечу про `/compact` vs новая сессия.

---

## 1. Оценка агента `8c38` (Codex-Gpt5.1-Max) по NX‑05…08 на CFA1

### 1.1. Что он фактически сделал (по логам)

**Базовый контекст/цель**

* Цель сессии: довести **CFA1** до состояния “ready for demo NX05–NX08” по чеклисту `20251121-1610-nx05-08-cfa1-dod-kickoff.md` и DoD в `tasks/NX-05…08`.
* Структура фаз (Phase 1–4) и конкретные ожидания по NX05–08 заданы в промпте `eywa1-p-cfa-w15.p1-20251121-1449.session.txt`.

**Средний результат по стенду (по его же сводке)**

* Docker‑стек и PM2 на **CFA1**: gateway, issuance, settlement, identity, compliance, keycloak, фронты issuer/investor/backoffice из `/opt/ois-cfa`. 
* API‑коды на CFA1:

  * `/v1/reports/issuances` → 401, `/v1/reports/payouts` → 401
  * `/v1/compliance/kyc` → 401, `kyc/{id}` → 404, `kyc/{id}/decision` → 405
  * `/v1/identity/users` → 200 (stub)
  * `/v1/audit` → 401, `/v1/audit/{id}` → 404 

**NX‑07/08 (backoffice):**

* Исправил NextAuth/Keycloak связку:

  * Нашёл, что на CFA1 у backoffice клиента отсутствует `client_secret`. 
  * Через `kcadm` создал client‑secret для клиента backoffice в realm `ois-dev` и проставил его в `/opt/ois-cfa/apps/backoffice/.env.local` (`KEYCLOAK_CLIENT_SECRET=...`). 
  * Перезапустил PM2‑процесс `backoffice` с обновлёнными `NEXTAUTH_SECRET`, `AUTH_SECRET` и `KEYCLOAK_CLIENT_SECRET`. 
* Поправил `apps/backoffice/src/lib/auth.ts` (secret по умолчанию, client config) и добавил/обновил Playwright‑тесты:

  * `tests/e2e-playwright/tests/backoffice-kyc.spec.ts`
  * `tests/e2e-playwright/tests/backoffice-audit.spec.ts`
  * обновил `backoffice-auth.spec.ts` под CFA1 (юзер `backoffice-admin`). 
* По финалу зафиксировано:

  * Backoffice‑auth фиксится, страницы `/kyc` и `/audit` открываются с fallback‑данными (mocks).
  * Playwright‑сценарии `backoffice-kyc.spec.ts` и `backoffice-audit.spec.ts` зелёные на CFA1.
  * В репо добавлены скриншоты `artifacts/tests/e2e/playwright/*.png` + коммит `fix(nx-07/08): [co-76ca] - backoffice login roles + e2e`.

**NX‑05/06 (issuer портал):**

* Прогнал e2e‑сценарий для issuer:

  * `/dashboard` + `/reports` проверены через Playwright (`issuer-reports.spec.ts`) на CFA1. 
  * API `/v1/reports/{issuances|payouts}` → 401 (маршруты есть, но нет авторизации/данных).
* Обновил DoD в `tasks/NX-05-issuer-dashboard-and-reports.md` и `tasks/NX-06-issuer-payout-schedule-spec-and-ui.md`:

  * NX05 помечен как проверенный на CFA1 с Playwright‑тестом и HTTP‑кодами 401 (маршрут живой, данных нет).
  * NX06 помечен как **blocked**: нет публичного `issuanceId` с `scheduleJson`, демо‑данные не готовы. 
* Коммит: `docs(nx-05/06): [co-76ca] - cfa1 verification updates`. 

**Документация / DoD / CFA1‑чеклист**

* Прочитал и частично обновил:

  * `tasks/NX-05…08` (чекбоксы, Verified‑строки).
  * `memory-bank/Scrum/20251121/20251121-1610-nx05-08-cfa1-dod-kickoff.md` — добавлены статус‑строки по NX05–08 (OK/Blocked + HTTP‑коды, Playwright‑ссылки).
* Столкнулся с ограничением git/symlink для memory‑bank, поэтому не пушил сам DoD‑чеклист как часть сабмодуля `ois-cfa` (это ок для твоей схемы “код отдельно, memory‑bank отдельно”). 

---

### 1.2. Оценка по фазам Kickoff (из промпта) и NX‑таскам

#### Фаза 1 — Sync + понимание DoD

* **Что требовалось:**
  Синхронизировать `infra.defis.deploy`, прочитать tasks NX‑05..08 и файл `20251121-1610-nx05-08-cfa1-dod-kickoff.md`, собрать внутренний план.
* **Что сделал:**

  * Работал в ветке `codex/fix-cfa1-regressions` поверх актуального состояния.
  * Явно прочитал tasks NX‑05..08 и CFA1‑DoD-файл (есть `Explored / Read 20251121-1610...`).
* **Оценка:**

  * **Полнота:** ~90% — контекст DoD он усвоил.
  * **Точность:** ~95% — его дальнейшие действия соответствуют чеклисту.

#### Фаза 2 — NX‑05 (Issuer Dashboard & Reports)

**DoD (CFA1 + задача):**

* `/dashboard` и `/reports` на CFA1 работают, используют реальные эндпоинты через gateway, без заглушек (либо честный “no data yet”), проверено Playwright.

**Фактически:**

* Маршруты `/v1/reports/issuances` и `/v1/reports/payouts` существуют, дают 401 (требуют auth) — это лучше, чем 404, но пока без контента. 
* Issuer Playwright‑тест (`issuer-reports.spec.ts`) проходит на CFA1, UI отображается, скрины приложены. 
* DoD NX‑05 и CFA1‑чеклист обновлены: есть отметки Verified @ cfa1 с датами/HTTP‑кодами.

**Вывод по NX‑05:**

* **Функционально для демо:** ОК — есть живой UI + e2e + живые (хоть и пустые) отчётные маршруты.
* **Строго по формулировке DoD (реальные данные):** сейчас реализован вариант “честный no data yet”, а не “данные”; это в рамках той версии DoD, где “real data **or** honest no data”.

> **Оценка NX‑05:**
>
> * Полнота: **80/100** (сделано всё, кроме наполнения демо‑данных/seed’ов).
> * Точность: **90/100** (документация/статусы совпадают с реальными HTTP‑кодами).

---

#### Фаза 3 — NX‑06 (Payout Schedule)

**DoD:**

* `scheduleJson` в issuance DTO, UI‑вкладка “Payout Schedule” на `/issuances/[id]` показывает строки расписания, проверено на CFA1 для реального выпуска, DoD/чеклист обновлены.

**Фактически:**

* Саму спецификацию и UI для payout schedule делал предыдущий агент `co-c02b`; текущий агент только:

  * Зафиксировал, что на CFA1 **нет демо‑issuance с заполненным `scheduleJson`**, поэтому проверить расписание нельзя.
  * Обновил `tasks/NX-06-issuer-payout-schedule-spec-and-ui.md`, пометив NX‑06 как **blocked** из-за отсутствия данных. 
* Не добавил:

  * ни seed‑скрипт/fixture для создания такого выпуска,
  * ни временный bulk‑метод для генерации расписаний,
  * ни Playwright‑спеку, проверяющую UI payout schedule.

> **Оценка NX‑06:**
>
> * Полнота: **30/100** (проблема корректно детектирована и документирована, но нет решения: seed‑данные, тесты, минимальный демо‑flow).
> * Точность: **95/100** (честно пометил blocked, не стал “затирать” DoD).

---

#### Фаза 4 — NX‑07 (Backoffice KYC & User Registry)

**DoD (CFA1 + tasks):**

* Backoffice `/kyc`, `/users` используют реальные эндпоинты:

  * `/v1/compliance/kyc`, `/v1/compliance/kyc/{id}/decision`
  * `/v1/identity/users`
* Моки OFF (`NEXT_PUBLIC_*_MOCK_MODE=false`), API ответы 200, есть реальные данные.

**Фактически:**

* Исправлен **auth** для backoffice (Keycloak client‑secret, NextAuth config, PM2 env), вход в backoffice теперь работает стабильно.
* Добавлены/обновлены Playwright‑тесты:

  * `backoffice-auth` — логин backoffice‑admin.
  * `backoffice-kyc` — переход на `/kyc`, проверка отображения страницы.
* По состоянию API:

  * `/v1/compliance/kyc` → 401
  * `/decision` → 405
  * `/v1/identity/users` → 200 (stub) 
* UI сейчас **поднимается с mock fallback** (через флаги `NEXT_PUBLIC_COMPLIANCE_MOCK_MODE`), KYC‑таблица в демо заполняется моковыми данными.
* DoD NX‑07 обновлён: отражены коды 401/404/405 и факт использования моков/отсутствия реального бэка.

> **Оценка NX‑07:**
>
> * Полнота: **60/100**
>
>   * Большой плюс: auth и UX backoffice вытащены в рабочее состояние + e2e зелёные.
>   * Минус: “реальный KYC/Registry” нет — до сих пор 401/404/405 и моки.
> * Точность: **85/100**
>
>   * Честно задокументированы статусы и mock‑режим.

* Не хватает явного флага в DoD “моки всё ещё ON (нарушение DoD)” — сейчас это надо “додумать”, а не видно как отдельную красную строчку.

---

#### Фаза 5 — NX‑08 (Backoffice Audit Log)

**DoD:**

* UI `/audit` подключен к реальному `/v1/audit/**` (минимум list‑эндпоинт), gateway‑маршрут настроен на `compliance`, API отвечает 200/404 (но не 5xx), моки OFF.

**Фактически:**

* Ранее по NX‑08 уже настраивались маршруты и фиксировалось, что `/v1/audit` нет → 404; текущий агент:

  * добил gateway‑маршрут `/v1/audit/**` до compliance, теперь вместо 404 → 401 (нет токена),
  * обновил `tasks/NX-08-backoffice-audit-log-ui.md`, отметив:

    * маршрут есть (401 без токена),
    * gateway‑маршрут к кластеру compliance — [x] OK. 
* Добавил Playwright‑тест `backoffice-audit.spec.ts`, UI `/audit` открывается (моки).
* API всё ещё 401/404 при реальных вызовах, содержательных событий нет. 

> **Оценка NX‑08:**
>
> * Полнота: **60/100** (маршрут и UI есть, e2e есть, но реальных событий/данных и моки OFF ещё нет).
> * Точность: **85/100** (хорошо отражено в DoD, что пока 401/404; нет отдельного “красного” флага про mоки).

---

### 1.3. Глобальные цифры по агенту `8c38`

Если свести всё к двум метрикам:

* **Completeness vs DoD NX‑05…08 (CFA1)**

  * NX‑05: ~80%
  * NX‑06: ~30%
  * NX‑07: ~60%
  * NX‑08: ~60%
  * Средневзвешенно (учитывая, что NX‑06/07/08 критичны для “KYC‑платформы”): **≈ 60/100**.

* **Accuracy / Trustworthiness (насколько тому, что он написал/изменил, можно доверять):**

  * Он опирается на реальные команды `ssh`, `curl`, `pm2`, `kcadm`, Playwright‑прогон.
  * Документация (DoD, CFA1‑чеклист) помечена с фактическими HTTP‑кодами и статусами “Blocked”.
  * Нет попыток “приукрасить” — наоборот, явно пишет “blocked by missing demo data / mocks still ON”.
    → **≈ 85–90/100** по честности и соответствию реальному состоянию.

**Если просишь одну цифру “score X/100”:**
Я бы поставил **65/100** за итерацию агента `8c38`:

* фундамент и демо‑сценарии есть,
* KYC/Audit хотя бы открываются и тестируются,
* но ключевые инженерные долги остаются (реальные данные для NX‑06, отключение моков и нормальный бэкенд/события для NX‑07/08).

---

## 2. Требования, корректировки и предложения из твоего голосового сообщения

Я разложу твой voice‑input по темам, чтобы это можно было прямо вставлять в промпты/таски.

### 2.1. Swagger / AsyncAPI / Kafka

1. **Swagger/REST:**

   * Требуется явно понимать: какие Swagger‑UI/JSON‑эндпоинты подняты для микросервисов и gateway.
   * Для каждого сервиса (Issuance, Registry, Settlement, Compliance, Identity, Gateway) должны быть:

     * URL Swagger UI (например, `https://api.cfa1.../swagger/index.html` или `/docs`).
     * Защита: как закрыт доступ (Nginx basic auth, Keycloak, IP‑фильтр и т.п.).
   * В **каждой backend‑таске** DoD должен включать:

     * “Как смотрим спеки” (Swagger URL).
     * “Как тестируем руками” (curl/postman примеры).

2. **Kafka / AsyncAPI:**

   * Хочешь “аналог Swagger для Kafka”:

     * AsyncAPI‑схемы для топиков (особенно вокруг KYC/Audit/Payout).
     * URL, где это можно посмотреть (генерируемый AsyncAPI UI или md‑отчёт).
   * В DoD по задачам, где есть события (audit, kyc decisions, payouts), должно быть:

     * ссылка на AsyncAPI/описание топика,
     * минимум одна команда/шпаргалка, как проверить, что сообщения реально публикуются/читаются.

---

### 2.2. Структура DoD для backend‑/API‑тасок

Ты хочешь, чтобы **каждая задача, где есть backend‑методы**, имела DoD в двух плоскостях:

1. **Tests/Commands:**

   * Чётко перечисленные команды:

     * unit (`dotnet test`, `npm test` …),
     * integration (запуск конкретных тестовых сборок),
     * e2e (Playwright).
   * Примеры `curl`/HTTP‑запросов для ключевых эндпоинтов (с ожидаемыми HTTP‑кодами и схемой ответа).

2. **Playwright как финальный acceptance:**

   * Для бизнес‑критичных фич (issuer dashboard/reports, backoffice KYC/Audit, auth flows) **конечный DoD = зелёный Playwright‑сценарий**:

     * сценарий описан в таске (например, “issuer-journey: login → dashboard → reports”),
     * при падении — скриншот / trace прикладываются и попадают в коммит.

3. **Оформление DoD:**

   * Все подпункты DoD должны быть **чекбоксами** (даже “5. DoD”, а не только “5.1”).
   * У каждого значимого пункта — строка вида:
     `Verified: 2025-11-21-1606 @ cfa1 (Playwright: tests/...spec.ts)`
     с URL/эндпоинтом.

---

### 2.3. Git‑workflow / ветки / коммиты

1. **Основная ветка:**

   * Исторически trunk назывался `infra.defis.deploy`, но **сейчас основная ветка должна быть `develop`**.
   * Нужна отдельная задача:

     * пройтись `grep`/`ripgrep` по репо и документации,
     * в текстах, где “infra.defis.deploy” подразумевалась как “главная”, заменить на `develop` (аккуратно, не ломая реально существующие ветки/теги).

2. **Commit hygiene:**

   * Ожидание: один инкремент = один содержательный коммит, включающий:

     * кодовые изменения,
     * тесты (в т.ч. Playwright спеки/обновления),
     * артефакты от тестов (скриншоты, отчёты),
     * обновление DoD/доков.
   * Коммиты должны быть **маленькими и осмысленными**, а не “свалка всего”.

3. **Мерджи:**

   * После закрытия задачи — код должен быть замёржен в `develop` (или в согласованный trunk), а не висеть в feature‑ветках/“infra” бесконечно.

---

### 2.4. CHANGELOG и метаданные агентов

1. **Единый `CHANGELOG.md` в корне:**

   * Структура уровнем выше “классики”:

     * Architecture
     * Backend
     * Frontend
     * Ops/DevOps
     * Administration/QA
   * Не разбивать на много разных changelog‑ов (можно утонуть), а один файл с чёткой структурой.

2. **Содержимое:**

   * Для каждой существенной правки (особенно конфиги Keycloak, стандартные пользователи, изменения в деплое и т.п.) — короткий entry в CHANGELOG:

     * что изменилось,
     * кем (agentID/человек),
     * для какого стенда (uk1/cfa1/dev).

3. **Агент‑метаданные:**

   * У каждого агента должны быть:

     * `agentID` (UUID),
     * короткий `partAgentID` (4 символа для людей),
     * period of life (дата начала/окончания работы),
     * список задач/епиков, над которыми он работал.
   * Эти данные логично указывать:

     * во frontmatter файлов (tasks/runbooks),
     * и/или в отдельном registry‑файле с “AGENTS / history”.

---

### 2.5. Тестовые пользователи и Keycloak

1. **Стандартные тест‑юзеры:**

   * Должен быть **единый набор пользователей** для:

     * investor
     * issuer
     * backoffice admin
   * Логины/пароли должны:

     * использоваться во всех Playwright‑тестах,
     * быть описаны в документации (секция Administration/QA или отдельный секретный doc), чтобы manual‑QA не гадали.

2. **Keycloak настройки:**

   * Все изменения в Keycloak, которые ты делал вручную:

     * создание пользователя `backoffice-admin`,
     * создание роли `backoffice`,
     * группа `backoffice-group`,
     * client scopes и их привязка,
     * настройки регистрации (`registrationAllowed`, `verifyEmail`, и т.п.),
   * нужно документировать:

     * и в cheat‑sheet/rubnook по Keycloak,
     * и в CHANGELOG (что/когда/зачем изменили).

3. **Self‑registration:**

   * Ожидается базовый working self‑registration flow (иначе e2e по регистрации бессмысленен).
   * Если он не работает (таймаут на auth), это должно быть:

     * явно вынесено как blocker в DoD,
     * ссылаясь на конкретные Keycloak‑настройки/клиенты.

---

### 2.6. Конкретно по NX‑05/06/07/08

1. **NX‑05 (Issuer dashboard & reports):**

   * Дашборд и отчёты должны быть “не кринж”:

     * не просто “Hello world” или статик,
     * а настоящие метрики/хотя бы честное “нет данных, вот почему”.
   * Если реальных бизнес‑данных нет:

     * допускается seed/mock‑данные на backend или job,
     * но **контракты не ломаем** (spec‑first, trunk/branch/leaves).

2. **NX‑06 (Payout schedule):**

   * Итоговая цель — **реальный payout schedule** с живыми цифрами на дашбордах.
   * Для MVP:

     * допустим скрипт/endpoint bulk‑заполнения расписаний для демо‑выпусков,
     * но он не должен ломать существующие схемы (только расширение).
   * В задачах надо:

     * явно прописать, как будут получены “реальные” демо‑данные (seed‑скрипт, миграция, ручной insert, etc.),
     * и как это привязано к NX‑05 дашбордам/отчётам.

3. **NX‑07 (KYC/User Registry):**

   * Платформа должна позволять:

     * пройти KYC (инвестору/эмитенту),
     * отправить заявку,
     * обработать заявку в backoffice (approve/reject).
   * Нужно уточнить и явно задокументировать:

     * где “живут” пользователи: только в Keycloak или ещё и в Postgres (User Registry),
     * как связаны сущности User/KYC/Issuance.
   * Агенту нужно **минимизировать overengineering**: не изобретать монстра, а оформить простую, но рабочую модель.

4. **NX‑08 (Audit Log):**

   * Желание: использовать AsyncAPI/события для аудита.
   * Минимальный DoD:

     * события аудита реально пишутся в Kafka/хранилище,
     * UI `/audit` читает реальные записи (или честно говорит “нет событий”).

---

### 2.7. Качество документации / Single source of truth

* Ты хочешь **строго избегать размазывания истины**:

  * никаких “двух разных DoD” с разным содержимым,
  * tasks, runbooks, DoD, CFA1‑checklist и CHANGELOG должны быть согласованы и ссылаться друг на друга, а не копировать текст.
* Агент при закрытии задачи должен:

  * свериться с существующими файлами (tasks, DoD, runbooks),
  * обновить ровно один источник истины + добавить ссылки, а не дублировать.

---

## 3. Что делать с агентом `8c38` (6% контекста) — `/compact` или новая сессия?

Честный ответ:

* **Сейчас контекст сильно распух**:
  — промпты для runbook’ов,
  — NX‑05/06/07/08 DoD,
  — куча логов по CFA1/Keycloak/Playwright,
  — плюс ты хочешь ещё добавить Swagger/AsyncAPI/Kafka‑требования и глобальный CHANGELOG.

* При **6% контекста** у Codex:

  * `/compact` почти неизбежно что‑то выкинет/сожмёт,
  * риск потерять важные детали (особенно тонкие нюансы типа “mocks OFF на прод‑стенде”, “develop vs infra.defis.deploy”).

**Мой совет:**

1. **Сделать явный “срез состояния” отдельным артефактом:**

   * Например, файл
     `memory-bank/Scrum/20251121/20251121-20xx-nx05-08-cfa1-status-after-8c38.md`
   * Туда кратко:

     * что сделано по NX‑05..08 и по CFA1 (по сути — конспект из раздела 1.2 выше),
     * какие DoD‑пункты закрыты, какие blocked (с ссылками на commits/файлы),
     * какие технические долги (mocks, demo data, swagger/asyncapi, changelog).

2. **Запустить нового агента в новой сессии с чистым контекстом:**

   * В промпт новому агенту:

     * ссылки на:

       * tasks/NX‑05..08,
       * `20251121-1610-nx05-08-cfa1-dod-kickoff.md`,
       * твой новый “status‑after‑8c38.md`,
       * Keycloak cheat‑sheet и deploy/runbook файлы,
     * все требования из секции 2 (Swagger/AsyncAPI, Playwright как DoD, CHANGELOG, ветка develop и т.д.),

       * plus твой guard‑режим “spec‑first, trunk/branch/leaves”.
   * Задача для нового агента:

     * не “делать всё с нуля”,
     * а **закрыть дырки**: NX‑06 demo data, отключение моков и переход на реальные endpoints для NX‑07/08, доработка DoD/Swagger/AsyncAPI/CHANGELOG.

3. **`/compact` можно использовать только как вспомогательный шаг**, если хочешь из любопытства добить пару мелких задач в старой сессии. Но для серьёзной следующей итерации (особенно с новыми требованиями по Swagger/Kafka/Changelog) — я бы на твоём месте **однозначно стартовал новую сессию**.

---

Если хочешь, дальше могу:

* либо помочь сформировать **конкретный стартовый промпт** для следующего агента (с учётом всех требований из секции 2 и текущего статуса 8c38),
* либо разобрать отдельно, **как именно декомпозировать NX‑06 и NX‑07** (какие минимальные seed‑скрипты/заглушки и какие изменения в backoffice/compliance нужны, чтобы KYC реально работал без моков).
