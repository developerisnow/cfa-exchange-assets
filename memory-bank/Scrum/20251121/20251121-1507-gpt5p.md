Начну с сути: **я бы не подсовывал этому же Codex‑агенту просто список багов, а завёл для него отдельный “hotfix” промпт**, который:

* жёстко сфокусирован на **регрессионных багфиксах на cfa1**,
* работает только в рамках уже сделанных NX‑05/06/08 изменений,
* не лезет заново в архитектуру и не трогает лишнее.

Ниже дам:

1. Короткий разбор, *что именно сейчас сломано* и где это жить должно.
2. Готовый промпт для Codex‑CLI‑агента под эти баги (копи‑паст).
3. DoD + Kickoff‑tasks для него.
4. Пара советов тебе как “человеку сверху”.

---

## 1. Что именно сейчас сломано (по тем багам, что ты дал)

### 1.1. `issuer.cfa1...` — `Can't resolve '@ois/shared-ui'`

Это не “сломанный код” как таковой, а **несогласованность кода и окружения**:

* В `apps/portal-issuer` сейчас используется `@ois/shared-ui` как npm‑пакет (`import { ThemeProvider } from '@ois/shared-ui'` и `initWebVitals` из `@ois/shared-ui/utils/webVitals`).
* В `apps/shared-ui` лежит сам пакет, с `ThemeProvider`, `initWebVitals` и т.п.
* В `package.json` `portal-issuer` уже есть зависимость на `"@ois/shared-ui": "file:../shared-ui"`.

На dev‑машине (worktree) агент делал `npm install` в `apps/shared-ui` и затем в `apps/portal-issuer`, поэтому сборка проходила.
**На cfa1**:

* PM2 крутит `portal-issuer` из `/opt/ois-cfa/apps/portal-issuer` (а не из нового `/srv/cfa`).
* После `git pull` в `/opt/ois-cfa` **никто не выполнил новый `npm install` с учётом `@ois/shared-ui`** → в `node_modules` портала нет этого пакета → Next ругается “Module not found: Can't resolve '@ois/shared-ui'”.

Т.е. это **несделанный шаг деплоя фронта**, а не ошибка в репо.

### 1.2. `investor.cfa1...` — `Can't resolve 'web-vitals'`

* В `apps/shared-ui/src/utils/webVitals.ts` идёт `import('web-vitals')`.
* В `apps/portal-investor/package.json` зависимость `web-vitals` есть, но:

  * на cfa1, скорее всего, **не прогоняли `npm install` в `/opt/ois-cfa/apps/portal-investor` после последних изменений** → модуля нет физически;
  * или `NODE_ENV`/путь такой, что берётся другой `node_modules`.

В любом случае, это опять **не докинутые зависимости на сервере**, а не логика.

### 1.3. Логин тестовым пользователем (`alexabook1` / `…ML76HHuA2p`) перестал работать

Тут несколько вероятных причин:

* **Keycloak‑realm / пользователи**:

  * могли пересоздать/переинициализировать базу keycloak (docker‑командой или `down -v`), и пользователь просто пропал;
  * или в скриптах bootstrap‑realm перезаписали пароль/realm/клиент.
* **URL/redirect URIs**: после правок docker‑сети и keycloak‑proxy могли поехать:

  * `frontendUrl` realm’а,
  * `redirectUris`/`webOrigins` для клиента `portal-issuer`/`portal-investor`,
  * из‑за чего Keycloak считает сессию невалидной/таймаутит.
* **NextAuth**: возможны несогласованные `NEXTAUTH_URL`, `NEXT_PUBLIC_KEYCLOAK_URL`, `NEXT_PUBLIC_KEYCLOAK_REALM`, `NEXT_PUBLIC_KEYCLOAK_CLIENT_ID` на cfa1 vs конфиг в Keycloak.

Симптом “Invalid username or password” при логине в портал значит, что либо реально нет такого пользователя/пароль другой, либо фронт бьёт не в тот realm/client.

### 1.4. Не логинится Keycloak admin (`Your login attempt timed out`)

Такая ошибка часто возникает когда:

* reverse‑proxy (nginx + keycloak‑proxy) не сохраняет/пробрасывает нужные cookie/параметры,
* `KEYCLOAK_PUBLIC_URL` / `frontendUrl` не совпадает с фактическим URL,
* или база keycloak не соответствует ожидаемой конфигурации.

С учётом того, что w15‑агент активно правил docker‑сети и keycloak‑proxy, это очень похоже на **незаконченный рефакторинг сетей/URL’ов**, а не на “один битый пароль”.

---

## 2. Как лучше работать с этими багами: новый промпт vs “накидать баги в старый”

Я бы сделал так:

* **Не продолжал ту же сессию агента**, которая уже ломала, а **запустил новый Codex‑CLI сеанс** с отдельной целью:

  > “Fix regressions on CFA1 (frontends + auth), keep NX‑05/06/08 code as is”.
* В промпте:

  * явно описать **состояние до** (фронты работали, логины ок, e2e зелёные),
  * перечислить **симптомы после** (те 4 бага),
  * дать агенту **жёсткий сценарий действий**: сначала анализ (`git diff`, `pm2 describe`, `npm ls`), потом минимальные фиксы, потом проверки (UI + e2e).

Ниже — готовый промпт под Codex‑CLI, который ты можешь просто скопировать.

---

## 3. Готовый промпт для Codex‑CLI агента (регрессионный hotfix)

### 3.1. Что приложить контекстом

Когда запускаешь `codex`, приложи (через `@...`):

* `docs/deploy/docker-compose-at-vps/07-frontends*.md`
* `docs/deploy/docker-compose-at-vps/08-smoke-tests.md`
* `docs/deploy/docker-compose-at-vps/09-troubleshooting.md`
* `docs/deploy/localhost/FRONTEND-STARTUP.md`
* `docs/deploy/localhost/KEYCLOAK-SETUP.md`
* `docs/deploy/20251113-cloudflare-ingress.md`
* `apps/shared-ui/**`
* `apps/portal-issuer/**`
* `apps/portal-investor/**`
* `apps/backoffice/**`
* `docker-compose*.yml`

(Если страшно за токены — можно вынуть фронты + shared-ui отдельным code2prompt snapshot’ом и сослаться на него.)

### 3.2. Тело промпта (копи‑паст для Codex)

```text
You are a Senior DevOps+Fullstack engineer working on the OIS‑CFA project.

GOAL
- Fix REGRESSIONS on CFA1 (cfa1.llmneighbors.com) introduced after NX‑05/06/08 work:
  - Restore working frontends (issuer / investor / backoffice) on HTTPS domains.
  - Restore Keycloak login flows (test user + admin).
  - Preserve NX‑05/06/08 features and code; do NOT undo domain logic.

CONTEXT / ENVIRONMENT
- Repo is checked out to /srv/cfa/ois-cfa on CFA1.
- There is also legacy copy at /opt/ois-cfa used by PM2 to run Next.js dev servers for:
  - portal-issuer (port 3001)
  - portal-investor (port 3002)
  - backoffice (port 3003)
- Backends + Keycloak are running in Docker under /opt/ois-cfa with multiple compose files (base + services + kafka + keycloak-proxy + health).
- CFA1 serves:
  - https://auth.cfa1.llmneighbors.com (Keycloak via nginx + keycloak-proxy)
  - https://issuer.cfa1.llmneighbors.com
  - https://investor.cfa1.llmneighbors.com
  - https://backoffice.cfa1.llmneighbors.com
  - https://api.cfa1.llmneighbors.com

REGRESSION SYMPTOMS (must be used as acceptance tests)
1) portal-issuer (https://issuer.cfa1.llmneighbors.com/)
   - Server error: "Module not found: Can't resolve '@ois/shared-ui'"
   - Import trace points to apps/portal-issuer/src/app/providers.tsx:
       import { ThemeProvider } from '@ois/shared-ui';
       import { initWebVitals } from '@ois/shared-ui/utils/webVitals';

2) portal-investor (https://investor.cfa1.llmneighbors.com/)
   - Server error: "Module not found: Can't resolve 'web-vitals'"
   - Import trace points to initWebVitals (from shared-ui) being used in apps/portal-investor/src/app/providers.tsx.

3) Frontend login with known test user
   - Username/password: alexabook1 / zdwouE$ybQ!4!hCHRtG!ML76HHuA2p
   - Previously worked; now UI shows "Invalid username or password".

4) Keycloak admin login
   - https://auth.cfa1.llmneighbors.com/
   - Trying to log into /auth/admin results in:
     "Your login attempt timed out. Login will start from the beginning."

HARD CONSTRAINTS
- Do NOT touch UK1 server or its config.
- Do NOT change Cloudflare DNS or nginx configs on CFA1 unless absolutely necessary; if you MUST, keep changes minimal and documented.
- Do NOT rework overall architecture (no new networks, no random renames).
- Treat docker-compose networking as STABLE after the last changes: fix small issues, don't redesign.
- Do NOT change business logic for NX‑05/06/08 (issuance/settlement/compliance/audit). Only regression fixes.
- Prefer minimal, localized changes over refactors.

HIGH-LEVEL PLAN (you MUST follow this order)

Phase 0 – Recon and diffs
1. On CFA1, as user:
   - Check which tree PM2 frontends are running from:
     - PM2_HOME=/home/user/.pm2 pm2 list --no-color
     - PM2_HOME=/home/user/.pm2 pm2 describe portal-issuer --no-color
   - Confirm working directory:
     - e.g., /opt/ois-cfa/apps/portal-issuer, /opt/ois-cfa/apps/portal-investor.
2. Compare code between /srv/cfa/ois-cfa and /opt/ois-cfa:
   - Identify if infra.defis.deploy (with NX‑05/06/08 merges) is present in /opt/ois-cfa.
   - If /opt/ois-cfa is outdated, plan a safe sync from /srv/cfa/ois-cfa (but do NOT do it blindly; explain in the plan).

Phase 1 – Fix missing modules (@ois/shared-ui, web-vitals)
1. Inspect apps/shared-ui:
   - Confirm package.json has "name": "@ois/shared-ui".
   - Confirm it declares "web-vitals" in dependencies or devDependencies.
2. For /opt/ois-cfa (the one PM2 uses):
   - Run npm install in apps/shared-ui to ensure its own dependencies (including web-vitals) are present.
   - Run npm install in:
     - apps/portal-issuer (to install @ois/shared-ui via file:../shared-ui).
     - apps/portal-investor (to ensure web-vitals is installed locally).
   - Do NOT bump library versions unless necessary; reuse versions from package-lock if present.
3. Validate locally on CFA1:
   - For each app:
     - cd /opt/ois-cfa/apps/portal-issuer && npm run build
     - cd /opt/ois-cfa/apps/portal-investor && npm run build
     - If build fails, fix only what is necessary (imports, tsconfig, next.config) to make it pass.
4. Restart PM2:
   - PM2_HOME=/home/user/.pm2 pm2 restart portal-issuer portal-investor

Acceptance for Phase 1:
- https://issuer.cfa1.llmneighbors.com and https://investor.cfa1.llmneighbors.com load without "module not found" errors.

Phase 2 – Restore Keycloak & test user login
1. Check Keycloak health and DB:
   - docker ps | grep keycloak
   - docker logs ois-keycloak --tail 100
   - docker exec ois-postgres psql -U ois -d keycloak -c "select username from user_entity limit 10;"
   - Specifically check if user 'alexabook1' exists.
2. If user is missing:
   - Either:
     - Re-run existing bootstrap-realm.sh for realm ois-dev, OR
     - Use kcadm.sh inside ois-keycloak container to create user 'alexabook1' with the given password and proper roles.
   - Make this idempotent (safe to run twice).
3. Check realm/client configuration for portal-issuer/investor:
   - Verify:
     - realm = ois-dev
     - clients portal-issuer, portal-investor, backoffice exist
     - redirectUris and webOrigins include the cfa1.llmneighbors.com URLs
4. Verify admin login:
   - Using correct admin user (as per existing docs), ensure you can login to https://auth.cfa1.llmneighbors.com/admin without "login attempt timed out".
   - If timeout persists, investigate nginx/keycloak-proxy config (cookies, X-Forwarded headers) minimally and fix.

Acceptance for Phase 2:
- You can log into Keycloak admin at https://auth.cfa1.llmneighbors.com/admin.
- You can log into issuer/investor portals with alexabook1 / zdwouE$ybQ!4!hCHRtG!ML76HHuA2p and reach authenticated pages.

Phase 3 – Smoke + e2e checks
1. From eywa1, run the Playwright e2e suite configured for CFA1 (if available):
   - Use existing tests that:
     - open issuer, investor, backoffice;
     - perform login via Keycloak;
     - assert main pages are rendered.
2. If some tests still fail:
   - Treat each failure as a bug to analyze and fix, but:
     - Do NOT “comment out” tests; fix root causes.
3. Fill in:
   - docs/deploy/docker-compose-at-vps/08-smoke-tests.md
   - memory-bank/Scrum/.../cfa1‑deploy‑DoD (or equivalent) with actual "Verified: yyyy-mm-dd-hhmm @ cfa1".

FINAL DELIVERABLES / DoD
- Issuer and Investor portals on CFA1:
  - Build passes locally (npm run build) for both apps.
  - Load without module resolution errors.
  - Login with alexabook1 works (no "invalid username or password").
- Keycloak:
  - Admin login works via https://auth.cfa1.llmneighbors.com/admin.
  - Realm ois-dev has correct clients and redirect URLs for cfa1.llmneighbors.com.
- Docs:
  - Short note added to the relevant runbook(s) describing:
    - required npm install steps for shared-ui + frontends on CFA1,
    - steps to re-create the test user in Keycloak.
- All changes are committed to a dedicated branch (e.g., fix/cfa1-nx05-08-regressions) with clear messages and pushed.
```

---

## 4. Kickoff‑tasks (чтобы агент стартовал правильно)

То, что я бы прямо прописал в промпте как “сначала сделай это”:

1. **Понять, откуда реально крутятся фронты:**

   ```bash
   ssh user@cfa1 'PM2_HOME=/home/user/.pm2 pm2 list --no-color'
   ssh user@cfa1 'PM2_HOME=/home/user/.pm2 pm2 describe portal-issuer --no-color | sed -n "1,80p"'
   ```

2. **Зафиксировать текущие коммиты:**

   ```bash
   ssh user@cfa1 'cd /opt/ois-cfa && git rev-parse HEAD && git status -sb'
   ssh user@cfa1 'cd /srv/cfa/ois-cfa && git rev-parse HEAD && git status -sb'
   ```

3. **Проверить наличие зависимостей:**

   ```bash
   ssh user@cfa1 'cd /opt/ois-cfa/apps/portal-issuer && npm ls @ois/shared-ui || echo "MISSING"'
   ssh user@cfa1 'cd /opt/ois-cfa/apps/portal-investor && npm ls web-vitals || echo "MISSING"'
   ```

4. **Проверить наличие тестового пользователя в Keycloak:**

   ```bash
   ssh user@cfa1 'docker exec ois-postgres psql -U ois -d keycloak -c "select username from user_entity where username = '\''alexabook1'\'';"'
   ```

5. **После этого — уже выполнять план из промпта.**

---

## 5. Советы для тебя (мета‑уровень)

1. **Всегда отделяй “фичу” и “горячий багфикс” по промптам и веткам.**
   То, что сейчас произошло — классический случай, когда один и тот же агент сначала делает фичи (NX‑05/06/08), а потом в той же сессии начинает “править инфраструктуру” и ломает рабочее.

   —> На будущее:

   * фича‑промпт: только код (без ssh/деплоя),
   * деплой‑промпт: только runbook + docker-compose + env,
   * регрессия‑промпт: как выше, очень узкий scope.

2. **У агента всегда должен быть “stop line”:**
   Прямо в промпте:

   > “If you are not 100% sure how to fix Keycloak or nginx, STOP and tell me exactly what you are unsure about instead of experimenting.”

   Это сильно уменьшает вероятность таких сетевых “кривых” фиксов.

3. **Проверка перед выходом из сессии — чеклист.**
   Для таких стендов я бы жёстко закрепил:

   * Перед тем, как агент говорит “done”, он ОБЯЗАН:

     * открыть issuer/investor/backoffice в headless‑браузере (Playwright или хотя бы `curl`/`wget`) и убедиться, что страница рендерится без 500,
     * попробовать логин (e2e, если есть),
     * сохранить в логах явный статус: что зелёное, что красное.

4. **Локальный sandbox vs боевой cfa1.**
   Когда есть возможность, лучше одно и то же прогонять в докере локально (на eywa1) перед тем, как трогать cfa1, а в промпте прописывать:

   > “First reproduce and fix on local Docker (eywa1), then apply the same steps to CFA1.”

---

Если хочешь, дальше я могу именно **декомпозировать NX07/NX08 по коду** (что править в backoffice/compliance/identity, какие заглушки добавить), но уже отдельно от этого регрессионного промпта — чисто как технический план для следующего агента.
