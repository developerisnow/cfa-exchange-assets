Коротко: агент в w15 (1449+1531) **починил регрессии** (issuer / investor / Keycloak), частично поправил DoD в задачах, но **NX‑05–08 как “готово к демо на CFA1” не довёл**, а backoffice/KYC явно в подвешенном состоянии.

Дальше по пунктам.

---

## 1. Что реально сделал агент в w15 и что осталось

### Что он сделал (и это плюс)

1. **Поднял backend+gateway на CFA1 до “не 404” по ключевым маршрутам**

   * До него `/v1/reports/issuances`, `/v1/reports/payouts`, `/v1/identity/users` на CFA1 давали 404, что было задокументировано в NX‑05/07 как “FAIL 404”.
   * В w15‑1449 он:

     * Пересобрал `api-gateway` с обновлённым `appsettings.json` и поправленным маршрутом `/v1/audit/**` к кластеру `compliance` и маршрутами к `identity/settlement`.
     * Проверил:

       * `GET https://api.cfa1.llmneighbors.com/v1/identity/users` → **200** с реальным JSON (issuer/investor пользователи).
       * `GET https://api.cfa1.llmneighbors.com/v1/audit` → **401** (значит маршрут есть, но без токена).
       * `/health` → 200.
   * В `tasks/NX-08-backoffice-audit-log-ui.md` он обновил DoD: 404→401 и отметил, что маршрут `/v1/audit/**` теперь есть и указывает на compliance, с пометкой `Verified: 2025-11-21-1130 @ cfa1`.

2. **Починил модульные ошибки порталов (issuer/investor)**

   * На CFA1 порталы падали, потому что:

     * `@ois/shared-ui` не резолвился в `portal-issuer`.
     * `web-vitals` не был установлен/подтянут для `shared-ui`.
     * Это видно и из твоих симптомов, и из кода `initWebVitals()` в `apps/shared-ui/src/utils/webVitals.ts` — он ожидает `web-vitals` в `node_modules`.
   * В w15‑1531 агент:

     * Зашёл в `/opt/ois-cfa/apps/portal-issuer` и `portal-investor`.
     * Подтянул зависимости (в том числе `@ois/shared-ui` и `web-vitals`) и прогнал `npm run build` — сборка Next.js прошла успешно (до этого падала).
     * Проверил `pm2 list`: issuer/investor/backoffice процессы онлайн.

   → Итог: твои пункты 1.1–1.2 (“Can't resolve '@ois/shared-ui' / 'web-vitals'”) он действительно закрыл.

3. **Починил логин “alexabook1” и Keycloak‑админ**

   * В infra‑репе были тестовые пользователи, но настройки/пароли могли дрейфовать.
   * Агент:

     * Проверил состояние `realm ois-dev` на CFA1, убедился в наличии пользователя `alexabook1`.
     * Через `kcadm` сбросил пароль на твой `zdwouE$ybQ!...`.
     * Убедился, что `/.well-known/openid-configuration` отдаёт 200, и что клиентские настройки (redirect URIs) для порталов приведены в актуальное состояние.
   * В итоговом TL;DR он зафиксировал, что логин `alexabook1` теперь работает, и что Keycloak admin UI доступен на `https://auth.cfa1.llmneighbors.com/admin`.

   → Твои 1.3–1.4 (логин и таймауты Keycloak) — закрыты.

4. **Частично обновил tasks NX‑05/06/07/08 и DoD‑файл для CFA1**

   * Он изменил:

     * `apps/api-gateway/appsettings.json`
     * `docker-compose.*`
     * `services/settlement/Program.cs`
     * `tasks/NX-05...`, `NX-06...`, `NX-07...`, `NX-08...`
       и закоммитил как `docs(tasks)` и `deploy(cfa1) deploy and test on cfa1 WIP`.
   * В `nx05-08-cfa1-dod-kickoff.md` он точно читал и что‑то поправлял, но **не заполнил до конца** “Verified: … @ cfa1” по всем маршрутам — ты это сам видишь в файле.

---

### Что он НЕ сделал (и почему ощущается “недодел”)

1. **Backoffice /auth/signin → KYC flow не довёл**

   * На уровне nginx/Next:

     * `/kyc` на backoffice корректно 307 → `/api/auth/signin?callbackUrl=/kyc`. Это мы видим ещё в w15‑1449.
   * Но:

     * В w15‑1531 он *не* проверял реальный login‑flow на `backoffice.cfa1.llmneighbors.com` (нет ни `curl`, ни описания шагов в браузере).
     * Ты сейчас видишь: `/auth/signin?...` висит, до Keycloak не доходит — значит либо:

       * сломалась страница `apps/backoffice/src/app/auth/signin/page.tsx` (например, кнопка не вызывает `signIn('keycloak')`), либо
       * NextAuth не может сконфигурировать Keycloak‑провайдера (env‑ы, URL, client_id/secret), либо
       * API‑route `/api/auth/*` падает 500 (и UI тупо крутится).
   * Код `apps/backoffice` говорит, что backoffice — отдельное Next 15‑приложение со своим `Dockerfile`, env и `authOptions` (KeycloakProvider).
   * Агент этого не трогал, не заводил DoD по backoffice‑auth для CFA1 и не прогонял Playwright‑тест backoffice после регрессий (только планировал).

   → Отсюда твоё “Backoffice непонятно что происходит” — абсолютно валидно, это **дырка**, а не твоя паранойя.

2. **NX‑07 KYC backend‑часть на CFA1 проверена только наполовину**

   * По коду фронта `apps/backoffice` KYC завязан на:

     * `GET /v1/compliance/kyc` (список аппликаций).
     * `POST /v1/compliance/kyc/{id}/decision` (approve/reject).
     * `GET /v1/identity/users` (мэппинг пользователей, fallback‑моки, если 404/500).
   * На CFA1 он проверил только:

     * `GET /v1/identity/users` → 200.
     * `/v1/audit` → 401 (маршрут появился).
   * **Нет ни одного `curl` или DoD‑пункта по `/v1/compliance/kyc`**, ни по решению KYC, ни по документам.

   → Значит backend KYC в лучшем случае “полуреален, полумоковый”, а DoD NX‑07 по CFA1 — не закрыт.

3. **NX‑05/06 — отчёты по выпускам и payout‑schedule — на CFA1 не подтверждены**

   * До w15‑1449 на CFA1:

     * `GET /v1/reports/issuances` и `/v1/reports/payouts` давали 404.
   * В w15‑1449/1531:

     * Он **не показал ни одного запроса** к `/v1/reports/*` уже после пересборки gateway/settlement. Единственные проверки — identity/audit.
   * В самих задачах NX‑05/06 в разделе “Статус на 20.11” прямо сказано, что UI готов, но backend CRUD/репорты ещё нужно довести и подключить к реальным эндпойнтам; часть пока read‑only через `scheduleJson`.

   → Т.е. на CFA1:

   * Dashboard‑страница issuer’а, скорее всего, грузится (благодаря фиксу shared‑ui/web‑vitals).
   * Но реальные отчёты `/v1/reports/*` могут по‑прежнему не работать так, как на UK1 (или вообще не отвечать корректными 200).
   * DoD NX‑05/06 по CFA1 — не заполнен, URLs/сценарии не перечислены.

4. **Документация и DoD по CFA1 — приросли, но не доведены до “single source of truth”**

   * В `nx05-08-cfa1-dod-kickoff.md` есть каркас DoD по CFA1, но:

     * Часть пунктов “Verified: …” стоит с датой 2025‑11‑21 11:30 только для /v1/audit/** и identity, а UI‑маршруты `/kyc`, `/audit`, `/payouts`, `/dashboard` не помечены.
   * В tasks/NX‑07/08 “Статус на 20.11” описывает, что UI реализован, gateway‑маршруты добавлены, но **тесты и SPEC DIFF для `/v1/audit` и KYC ещё в TODO**.

   → То, о чём ты пишешь: “хрень не отмечено, нет реальных URL, мы делаем KYC, а есть ли страницы и полный flow” — **это не твой perception, это реальный gap**.

5. **Playwright не прогнан заново под текущий стейт и не расширен под KYC/Audit**

   * В w11 мы видим, что Playwright‑тесты для CFA1 (issuer/investor/backoffice login + self‑registration) были зелёные, со скриншотами, и .env указывает на `*.cfa1.llmneighbors.com`.
   * Но это было **до** текущих регрессий.
   * В w15‑1531 Playwright не запускался и не расширялся под:

     * Issuer dashboard reports (NX‑05),
     * Backoffice KYC (NX‑07),
     * Backoffice audit (NX‑08).

   → Сейчас ты прав: “если не прописать e2e по этим flow — задолбёмся ловить регрессы руками”.

**Вывод:**
Агент w15‑1449/1531 сделал полезный “regression‑fix & infra touch‑up”, но **задачу “CFA1 готов к демо NX‑05–NX‑08” он НЕ довёл**.
Надо второй проход, фокусно по backoffice/KYC и DoD.

---

## 2. Ответы на твои конкретные вопросы (a / b / c)

### a) Сколько frontend‑страниц сейчас вообще есть (по коду), и какие из них про NX‑05–08?

По backoffice (`apps/backoffice`):

1. **root `/`**

   * Серверный redirect на `/kyc` при наличии сессии; иначе redirect на `/auth/signin`. (из layout/index + middleware).

2. **`/auth/signin`**

   * Страница NextAuth для входа (кастомный UI или дефолтный провайдер) с `callbackUrl`.
   * Именно на ней у тебя сейчас “висим, не идём в Keycloak”.

3. **`/kyc`**

   * Основная страница KYC: список аппликаций, фильтры, кнопки approve/reject.
   * Использует `lib/api/compliance.ts` → `GET /v1/compliance/kyc`, `POST /v1/compliance/kyc/{id}/decision`, плюс подтягивание users.

4. **`/users`**

   * Страница реестра пользователей (user registry) с таблицей и фильтром.
   * Использует `GET /v1/identity/users` через `listUsers()`, c fallback на моки, если API недоступен.

5. **`/payouts`**

   * Страница управления выплатами (read‑only summary) — часть NX‑06/08 связки, завязанная на отчётность и settlement‑данные.

6. **`/audit`**

   * Список audit events + фильтры (по action/user/date).
   * Использует `lib/api/audit.ts` → `GET /v1/audit?...` с флагом `NEXT_PUBLIC_AUDIT_MOCK_MODE`.

7. **`/audit/[id]`**

   * Деталка конкретного события аудита (`GET /v1/audit/{id}`).

Плюс служебные маршруты `/api/auth/[...nextauth]` и middleware на `/kyc`, `/qualification`, `/payouts`, `/audit` (чтобы пускать только ролями `admin/backoffice`).

**Итого для backoffice:** 6 основных страниц + sign‑in + API‑route.

По порталам:

* **NX‑05/06 в issuer‑портале**:

  * `/dashboard` — issuer dashboard с агрегацией выпусков/объёмов (NX‑05, основной entry‑point).
  * `/issuances/[id]` — страница выпуска с payout‑schedule (NX‑06 read‑only по `scheduleJson`).

* Investor‑портал NX‑05/06 не сильно затронут, кроме отображения обновлённых статусов выпусков.

### b) Сколько endpoint‑методов внедрено и насколько они связаны с UI?

С учётом кода и задач NX‑05–08 (по `context.txt` и tasks):

**NX‑05 / NX‑06 (Reports / Payouts)**

* `GET /v1/reports/issuances` — агрегированный отчёт по выпускам (dashboard issuer).
* `GET /v1/reports/payouts` — агрегированный отчёт по выплатам.
* В NX‑06 дополнительно:

  * Расширение payload в `GET /v1/issuances/{id}` (поле `scheduleJson`, пока read‑only).
  * В будущем планировался `/v1/issuances/{id}/payouts/schedule`, но пока это в разделе “Осталось”.

**Связь с UI:**

* Dashboard issuer (`/dashboard`) и отчётные компоненты используют TS‑SDK, который бьётся в `GET /v1/reports/issuances`/`payouts`.
* На UK1 это проверено; на CFA1 маршруты раньше были 404, сейчас частично поправлены, но явной проверки в логах нет — нужно добить.

---

**NX‑07 (Backoffice KYC / User Registry)**

* `GET /v1/compliance/kyc` — список KYC‑аппликаций (status, userId, level и т.п.).
* `GET /v1/compliance/kyc/{id}` — деталка аппликации.
* `GET /v1/compliance/kyc/{id}/documents` — документация по аппликации (паспорт и пр.).
* `POST /v1/compliance/kyc/{id}/decision` — approve/reject (с решением и причиной).
* `GET /v1/identity/users` — все пользователи/инвесторы (для binding KYC→user).

**Связь с UI:**

* `/kyc`:

  * `getKycApplications()` → `/v1/compliance/kyc`.
  * `makeKycDecision()` → `/v1/compliance/kyc/{id}/decision`.
  * Маппит `userId` через `/v1/identity/users` (реальный call с fallback mock, если 404/500).
* `/users`:

  * `listUsers()` → `/v1/identity/users` (тоже с fallback).

Т.е. **по коду интеграция есть**, но на CFA1:

* `/v1/identity/users` уже даёт 200.
* `/v1/compliance/kyc*` и сами решения не проверялись.

---

**NX‑08 (Backoffice Audit)**

* `GET /v1/audit?from=&to=&action=&actor=` — поиск/фильтр событий аудита.
* `GET /v1/audit/{id}` — деталка события.

**Связь с UI:**

* `/audit`:

  * `listAuditEvents()` → `/v1/audit?...`, доп. флаг `NEXT_PUBLIC_AUDIT_MOCK_MODE`.
* `/audit/[id]`:

  * `getAuditEvent()` → `/v1/audit/{id}`.

На CFA1:

* `GET /v1/audit` → 401 (OK по маршруту, нет токена).
* UI `/audit` существующий, но не проверенный руками/Playwright на этом стенде.

**Вывод по (b):**

* API‑методы для NX‑05–08 **реально есть и связаны с UI через TS‑SDK**.
* На UK1 это доводилось и тестировалось.
* На CFA1:

  * часть эндпойнтов уже отвечает корректно (identity, audit route),
  * часть (reports, compliance/kyc) **логически связана, но не подтверждена запросами**.
* Обязательный следующий шаг — **прошагать все маршруты curl’ом + UI + e2e** и проставить “Verified: … @ cfa1” в DoD.

---

### c) Playwright: что есть и что нужно

**Что уже есть (по NX‑01):**

* Тестовый пакет `tests/e2e-playwright` в worktree `wt__ois-cfa__NX01`.
* .env для CFA1 с:

  * `ISSUER_BASE_URL=https://issuer.cfa1.llmneighbors.com`
  * `INVESTOR_BASE_URL=https://investor.cfa1.llmneighbors.com`
  * `BACKOFFICE_BASE_URL=https://backoffice.cfa1.llmneighbors.com`
  * и тестовыми пользователями issuer/investor/backoffice ([issuer@test.com](mailto:issuer@test.com) / [admin@test.com](mailto:admin@test.com) и т.д.).
* Набор тестов:

  1. issuer portal authenticates via Keycloak
  2. investor portal authenticates via Keycloak
  3. backoffice admin authenticates via Keycloak
  4. investor self‑registration flow (через mail.tm)
* Скриншоты flow’ов в `artifacts/tests/e2e/playwright/*.e2e.png` с именованием `YYYYMMDD-HHMM-runId-flow-step.e2e.png`.

**Чего нет:**

* Нет тестов:

  * issuer dashboard (NX‑05: проверка реальных цифр / таблиц),
  * payout‑schedule (NX‑06),
  * backoffice KYC flow (создать аппликацию, approve, проверить статус),
  * backoffice audit (что события отображаются и фильтры работают).

**Что надо сделать агенту (минимум):**

1. Перезапустить **существующие** тесты против CFA1 после всех фиксов (убеждаемся, что basic auth‑флоу опять зелёный).
2. Добавить новые e2e‑сценарии под NX‑05–08:

   * Issuer dashboard → проверка, что таблица отчётов не падает и показывает хотя бы 1 выпуск.
   * Backoffice:

     * `/auth/signin → /kyc` для admin/backoffice‑пользователя.
     * `/kyc`: approve KYC и проверка статуса.
     * `/audit`: проверка фильтрации.
3. Включить скриншоты (уже есть helper), плюс HTML‑репорт для быстрой проверки.

---

## 3. Новый Kickoff + DoD для агента (готовый кусок под копипаст)

Ниже — **готовый промпт** в стиле твоих codex‑/oracle‑агентов, заточенный под “довести CFA1 до NX‑05–08 demo ready” с фокусом на backoffice/KYC и DoD.

### 3.1. Prompt для агента

```text
# ROLE

You are a Senior .NET 9 + Next.js 15 + DevOps engineer on the OIS-CFA project.

You are NOT an evaluator. Your job is to IMPLEMENT, FIX and VERIFY against already existing Oracle analysis (context.txt, NX tasks, runbooks). Do not invent new specs.

# WORKSPACE / ENV

- Host: eywa1 (control plane)
- Monorepo root: ~/__Repositories/yury-customer/prj_Cifra-rwa-exachange-assets
- Main backend repo: repositories/customer-gitlab/ois-cfa (branch: infra.defis.deploy)
- Remote demo node: cfa1 (user@cfa1, project root /srv/cfa/ois-cfa)
- Frontends on cfa1 currently run from /opt/ois-cfa via PM2 (issuer, investor, backoffice). Treat /opt as deployment copy, /srv/cfa/ois-cfa as git source of truth. DO NOT rsync blindly.

# KEY REFERENCES (READ, do not re-evaluate)

Backend / tasks:
- ois-cfa/tasks/NX-05-issuer-dashboard-and-reports.md
- ois-cfa/tasks/NX-06-issuer-payout-schedule-spec-and-ui.md
- ois-cfa/tasks/NX-07-backoffice-kyc-and-user-registry.md
- ois-cfa/tasks/NX-08-backoffice-audit-log-ui.md

CFA1 DoD:
- ois-cfa/memory-bank/Scrum/20251121/20251121-1610-nx05-08-cfa1-dod-kickoff.md

Deploy / runbooks:
- ois-cfa/docs/deploy/docker-compose-at-vps/10-eywa1-control-plane-runbook.md
- ois-cfa/docs/deploy/docker-compose-at-vps/07-frontends*.md
- ois-cfa/docs/deploy/docker-compose-at-vps/08-smoke-tests.md
- ois-cfa/docs/deploy/docker-compose-at-vps/09-troubleshooting.md

Backoffice / KYC / Audit code:
- ois-cfa/apps/backoffice/next.config.js
- ois-cfa/apps/backoffice/src/app/** (layout, page.tsx, /auth/signin, /kyc, /users, /payouts, /audit, /audit/[id])
- ois-cfa/apps/backoffice/src/lib/api/compliance.ts
- ois-cfa/apps/backoffice/src/lib/api/audit.ts
- ois-cfa/apps/shared-ui/src/utils/webVitals.ts

Playwright:
- wt__ois-cfa__NX01/tests/e2e-playwright/** (+ .env for CFA1)
- artifacts/tests/e2e/playwright/*.e2e.png

# HARD RULES

- DO NOT touch UK1 environment (prod demo). Use UK1 only as reference.
- On cfa1:
  - use user "user" with sudo;
  - main git root: /srv/cfa/ois-cfa;
  - use tmux session "p-cfa" for long-running commands.
- Do NOT force-push, do NOT rewrite tags under zip/*.
- Do NOT create new "oracle" prompts or analysis docs. Use existing Oracle pack and NX tasks as constraints.
- Make small, focused commits with clear messages. Push to infra.defis.deploy or feature/*, do not touch tasks/NX-01-* worktree.

# CURRENT KNOWN ISSUES (MUST FIX)

1) Frontends on cfa1 were broken due to missing @ois/shared-ui and web-vitals modules in issuer/investor. This was fixed once but must be kept stable across your changes.
2) Backoffice on https://backoffice.cfa1.llmneighbors.com currently:
   - redirects /kyc → /auth/signin?callbackUrl=/kyc,
   - but /auth/signin does NOT redirect to Keycloak and login is stuck.
3) NX-05/06/07/08 DoD for CFA1 is not filled with real "Verified: YYYY-MM-DD-HHMM @ cfa1" records for URLs/flows.
4) KYC & Audit APIs:
   - /v1/identity/users returns 200 on cfa1;
   - /v1/audit returns 401 (route OK, no token);
   - /v1/compliance/kyc* NOT verified on cfa1;
   - Playwright e2e for CFA1 were green before, but not re-run after recent regressions and not extended to KYC/Audit.

# SESSION GOAL

Bring CFA1 (cfa1.llmneighbors.com) to a "demo-ready" state for NX-05–NX-08:

- Issuer dashboard & basic reports work end-to-end.
- Backoffice login via Keycloak works for backoffice-admin.
- KYC list/decision and Audit log pages open and talk to real API where implemented (no accidental mocks).
- Playwright e2e for CFA1 are green and extended with minimal KYC/Audit coverage.
- DoD docs clearly state what is verified on CFA1 (with dates, URLs and test references).

# PHASES

## Phase 0 — Sanity check (read-only + no breaking)

1. On eywa1, inspect latest infra.defis.deploy:
   - git status, git log -5 (check last commits like "docs(tasks)" and "deploy(cfa1) ... WIP").
2. On cfa1:
   - docker ps and curl https://api.cfa1.llmneighbors.com/health
   - PM2 list (issuer, investor, backoffice).
3. DO NOT stop working services before you understand how they are started (docker compose location, PM2 ecosystem).

Deliverable: short note (in TL;DR) where services/gateway/Keycloak/frontends are actually running from (/srv vs /opt).

## Phase 1 — Backoffice auth flow fix

Goal: https://backoffice.cfa1.llmneighbors.com/kyc must successfully redirect through Keycloak and return to /kyc with a session for "backoffice-admin".

Steps (high-level):

1. Inspect NextAuth config:
   - apps/backoffice/src/app/api/auth/[...nextauth]/route.ts
   - apps/backoffice/src/lib/auth.ts (or equivalent)
   - env usage: NEXT_PUBLIC_KEYCLOAK_URL, REALM, CLIENT_ID ("backoffice"), NEXTAUTH_URL.
2. Check .env for CFA1 (both in repo and on cfa1) for backoffice:
   - NEXTAUTH_URL, NEXT_PUBLIC_KEYCLOAK_URL, NEXT_PUBLIC_KEYCLOAK_REALM, NEXT_PUBLIC_KEYCLOAK_CLIENT_ID.
3. In browser or via curl:
   - call https://backoffice.cfa1.llmneighbors.com/api/auth/providers
   - ensure "keycloak" provider is returned without 500.
4. Fix config so that:
   - signIn() on /auth/signin actually calls signIn('keycloak');
   - callback URLs include https://backoffice.cfa1.llmneighbors.com/kyc in Keycloak client "backoffice";
   - client secret is set and accessible to NextAuth.
5. Verify manually:
   - Login as backoffice-admin (user already exists with given password).
   - Confirm redirect chain: /auth/signin → Keycloak → /kyc.
   - Confirm logout/login again works.

Update:
   - tasks/NX-07-backoffice-kyc-and-user-registry.md — mark auth DoD item for CFA1 as Verified (with datetime and URL).
   - nx05-08-cfa1-dod-kickoff.md — update section "Backoffice auth on CFA1" with "Verified: YYYY-MM-DD-HHMM @ cfa1".

## Phase 2 — KYC & Audit API verification on CFA1

Goal: backend routes used by backoffice KYC/Audit pages exist and behave predictably (200/401/404, but no 500).

1. From eywa1 or cfa1 run curl checks:
   - GET /v1/compliance/kyc
   - GET /v1/compliance/kyc/{exampleId}
   - GET /v1/compliance/kyc/{exampleId}/documents
   - POST /v1/compliance/kyc/{exampleId}/decision (with dummy body)
   - GET /v1/identity/users
   - GET /v1/audit?from=&to=&actor=&action=
   - GET /v1/audit/{id}
2. For each route:
   - record HTTP status and small payload sample;
   - if route is not implemented yet (404) but UI uses a fallback mock — document that clearly in NX-07/08 tasks ("on CFA1 this route is not live yet, UI uses fallback/mocks").
3. If small, safe fixes are needed (e.g. gateway route missing, wrong cluster mapping):
   - fix apps/api-gateway/appsettings.json and rebuild gateway container via docker compose,
   - do NOT introduce big refactors.

Update:
   - tasks/NX-07, NX-08 — DoD blocks: fill "API status on CFA1" list with real curl results (including 404 where not implemented).
   - nx05-08-cfa1-dod-kickoff.md — fill "API layer" section with verified routes and statuses.

## Phase 3 — Issuer reports (NX-05/06) on CFA1

Goal: Issuer dashboard and payout schedule screens open and do not crash, using real API where available.

1. Check /v1/reports/issuances and /v1/reports/payouts on CFA1:
   - curl with and without auth (if existing flow).
2. Inspect apps/portal-issuer pages:
   - dashboard page: what SDK calls are used, and what is expected from /v1/reports/*?
   - issuances/[id] page: scheduleJson vs future real endpoints.
3. In browser:
   - login to https://issuer.cfa1.llmneighbors.com as issuer user (alexabook1 or issuer@test.com depending on config).
   - open /dashboard and /issuances/{id}; confirm no 500, charts/tables render something meaningful.
4. Update NX-05/06 tasks:
   - mark what is "demo-ready on CFA1" (read-only, partial data),
   - what remains backend-only work for later (full CRUD schedule, filters).

## Phase 4 — Playwright e2e (CFA1, including KYC/Audit)

Goal: end-to-end smoke for auth + minimal KYC/Audit.

1. Use existing tests/e2e-playwright setup for CFA1:
   - make sure .env points to *.cfa1.llmneighbors.com
   - run npx playwright test and ensure all existing tests are green (issuer/investor/backoffice login, self-registration).
2. Add minimal new tests:
   - backoffice-kyc.spec.ts:
     - login as backoffice-admin,
     - open /kyc, assert table not empty or at least component rendered without error,
     - if backend KYC is live: approve/reject one application and assert status change.
   - backoffice-audit.spec.ts:
     - login as backoffice-admin,
     - open /audit, assert initial list rendered,
     - apply filter and ensure list changes (or at least request is sent).
3. Configure screenshot helper to capture final state of /kyc and /audit success flows for CFA1.
4. Save HTML report (e.g. playwright-report-cfa1-nx05-08.html) and mention its path in docs.

Update:
   - nx05-08-cfa1-dod-kickoff.md — "Playwright on CFA1" block with:
     - date/time,
     - list of scenarios,
     - path to HTML report and screenshots.

# DELIVERABLES / DOD FOR THIS SESSION

1) Regression fixed and stable:
   - issuer, investor, backoffice build and run via PM2 on cfa1,
   - no "Module not found" for @ois/shared-ui or web-vitals.

2) Backoffice auth on CFA1:
   - backoffice-admin can login via Keycloak and reach /kyc,
   - issue described and fixed in code (NextAuth / env / Keycloak client),
   - tasks/NX-07 and nx05-08-cfa1-dod-kickoff.md updated with "Verified: date @ cfa1".

3) KYC & Audit APIs:
   - curl matrix for /v1/compliance/kyc*, /v1/identity/users, /v1/audit* on CFA1 with statuses and short notes,
   - DoD in NX-07/08 updated: what works, what is still 404 or mock-only.

4) Issuer reports on CFA1:
   - /dashboard and at least one issuance details page open without crashing,
   - note in NX-05/06 tasks what is demo-ready vs backend-todo.

5) Playwright:
   - existing CFA1 tests green,
   - at least 2 new tests: one for /kyc, one for /audit,
   - HTML report + screenshots saved, path documented in nx05-08-cfa1-dod-kickoff.md.

6) Git hygiene:
   - all changes are in infra.defis.deploy or feature/*,
   - commits have clear messages (e.g. "fix(cfa1-backoffice-auth)", "test(e2e): add cfa1 kyc/audit flows"),
   - no unexpected changes in tasks/NX-01-* or zip/* tags.

If you cannot complete some part (e.g. backend route truly not implemented yet), you MUST:
- clearly mark it in tasks/NX-0X as "NOT IMPLEMENTED on CFA1" with date,
- suggest minimal next backend steps, but DO NOT hack around it in frontend with hidden mocks for demo.
```

---

## 4. Советы тебе (и что делать с мнением Gemini)

1. **Про “бардак с коммитами на cfa1”**

   * Сейчас есть:

     * история NX‑01 (wt__ois-cfa__NX01) с deploy‑runbookами и Playwright;
     * ветка `infra.defis.deploy` в основном репо, куда легли фиксы NX‑03/05/06/07/08 и твой последний WIP‑коммит.
   * Я бы **не делал сейчас жёсткую миграцию /opt → /srv** по схеме, которую предлагал Gemini (массовые rsync/чистки). Это полезно как отдельная эпик‑задача, но:

     * ты только что стабилизировал порталы и Keycloak,
     * у тебя на носу демо KYC,
     * любые “бульдозерные” изменения путей легко всё уронят.

   → Лучше: на этом шаге зафиксировать:
   “**/srv/cfa/ois-cfa — источник кода**, /opt/ois-cfa — деплой‑копия для frontends.
   В новых промптах прямо запрещать агентам делать `rm -rf /opt`/`rsync` без твоего явного одобрения.”

2. **Как подкидывать контекст новому deep‑агенту, чтобы не забивать attention**

   Рабочий шаблон:

   * **В промпте даёшь только список файлов/папок**, а не сами тексты:

     * tasks/NX‑05–08,
     * backoffice pages/lib,
     * runbooks 07–10,
     * контекст про Playwright.
   * Плюс **одну-две ключевые выдержки** (типа TL;DR из oracle‑паков), но не весь oracle‑мегатекст.
   * Дальше прямо пишешь: “открой и прочитай эти файлы по мере необходимости, не копируй сюда содержимое”.

   Это как раз то, что ты уже начал делать в `cfa-back-finalize-nx05-08-21112025-1330` промпте — просто сейчас нужно **добавить фокус на backoffice/KYC и Playwright** как в промпте выше.

3. **Что делать с мнением Gemini**

   * Там есть **правильная боль**: drift между `/opt` и `/srv`, отсутствие единых DoD и слабое e2e покрытие.
   * Но **опасный кусок** — идея сразу “перетащить всё в /srv, закрыть /opt и переписать деплой‑логики”.

     * Это разумно как отдельный проект (после демо, с отдельным DoD и rollback‑планом).
     * Сейчас лучше сфокусироваться: довести KYC/Audit и DoD по CFA1, убедиться в работоспособности через UI + Playwright.
   * Мой совет:

     * взять у Gemini идеи по структуре DoD/пакетов работ,
     * **НЕ** брать его heavy‑refactor шаги до тех пор, пока не закроешь UX‑flows NX‑05–08.

---

Если хочешь, дальше могу уже **точечно разобрать код backoffice KYC/NextAuth (по кускам из context.txt) и расписать, куда именно смотреть агенту (authOptions, signIn‑кнопка, env‑ы)**, чтобы логин с твоим backoffice‑admin гарантированно завёлся — без “магии” и дедуктирования по месту.
