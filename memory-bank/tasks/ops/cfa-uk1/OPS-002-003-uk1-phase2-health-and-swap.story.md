---
created: 2025-11-27 12:40
updated: 2025-11-27 12:40
type: story
sphere: [devops]
topic: [uk1, deploy, healthcheck]
author: alex
agentID: fdfe6b1e-e4ee-4505-a723-e892922472f9
partAgentID: [co-76ca]
version: 0.1.0
tags: [uk1, cfa, health, playwright, swap, rollback]
epic_id: OPS-002-UK1-DEPLOY
story_id: OPS-002-003
status: planned
priority: high
points: 3
---

# OPS-002-003: PHASE2 ¬∑ Health checks, Playwright smoke and safe swap on UK1

## üëî JTBD

–°–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º UK1 –Ω–∞ –Ω–æ–≤—ã–π release‚Äë–∫–∞—Ç–∞–ª–æ–≥ –º—ã:
- –ø–æ–¥–Ω—è–ª–∏ —Å—Ç–µ–∫ –≤ release‚Äë–ø–∞–ø–∫–µ,
- —É–±–µ–¥–∏–ª–∏—Å—å –≤ –µ–≥–æ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ HTTP health‚Äë—á–µ–∫–∏ –∏ Playwright‚Äë—Å—Ü–µ–Ω–∞—Ä–∏–∏ –ª–æ–≥–∏–Ω–∞,
- –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ ‚Äú–±–æ–µ–≤–æ–π‚Äù `/opt/ois-cfa` –Ω–∞ –Ω–æ–≤—ã–π –∫–∞—Ç–∞–ª–æ–≥ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ rollback.

## ‚úÖ Definition of Done

- [ ] –í release‚Äë–∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞ UK1:
  - [ ] –≤—ã–ø–æ–ª–Ω–µ–Ω—ã `docker compose pull` –∏ `docker compose up -d` (–ª–∏–±–æ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏, –ª–∏–±–æ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ä–æ–≥–æ —Å—Ç–µ–∫–∞ ‚Äî –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏);
  - [ ] –≤—Å–µ —Ü–µ–ª–µ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Å—Ç–∞—Ç—É—Å–µ `running` (`docker compose ps`).
- [ ] Health‚Äë—á–µ–∫–∏:
  - [ ] `curl http://localhost:5000/health` –∏–ª–∏ `.../healthz` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200;
  - [ ] `curl http://localhost:8080/health/ready` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200;
  - [ ] –≤–Ω–µ—à–Ω–∏–µ URL `https://auth.cfa.llmneighbors.com/admin`, `https://issuer.cfa.llmneighbors.com`, `https://investor.cfa.llmneighbors.com`, `https://backoffice.cfa.llmneighbors.com` –æ—Ç–≤–µ—á–∞—é—Ç –±–µ–∑ 5xx.
- [ ] Playwright:
  - [ ] –∑–∞–ø—É—â–µ–Ω –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω smoke‚Äë—Å—Ü–µ–Ω–∞—Ä–∏–π –ª–æ–≥–∏–Ω–∞ (Issuer/Investor/Backoffice) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–º–µ–Ω–∞ UK1;
  - [ ] —Å–Ω—è—Ç—ã —Å–∫—Ä–∏–Ω—à–æ—Ç—ã ‚Äú–¥–æ/–ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞‚Äù –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ `memory-bank` –∏–ª–∏ `/opt/checks/` —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏.
- [ ] Swap/rollback:
  - [ ] —Å—Ç–∞—Ä—ã–π `/opt/ois-cfa` –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ `/opt/ois-cfa_old_YYYYMMDD-HHMM` (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ), –Ω–æ–≤—ã–π release‚Äë–∫–∞—Ç–∞–ª–æ–≥ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ `/opt/ois-cfa`;
  - [ ] systemd units / tmux‚Äë—Å–µ—Å—Å–∏–∏ / runbook‚Äô–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –Ω–æ–≤—ã–π –ø—É—Ç—å;
  - [ ] –æ–ø–∏—Å–∞–Ω –±—ã—Å—Ç—Ä—ã–π rollback: –∫–∞–∫ –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—ã–π –∫–∞—Ç–∞–ª–æ–≥ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å docker compose.
- [ ] –í `memory-bank` –µ—Å—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –ø–æ –¥–µ–ø–ª–æ—é develop‚Äë–≤–µ—Ç–∫–∏ –Ω–∞ UK1 —Å:
  - [ ] —Å–ø–∏—Å–∫–æ–º health‚Äë–∫–æ–º–∞–Ω–¥ –∏ –∏—Ö –≤—ã–≤–æ–¥–æ–º;
  - [ ] —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ Playwright‚Äë–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã;
  - [ ] —É–∫–∞–∑–∞–Ω–∏–µ–º commit‚Äëhash release‚Äë–≤–µ—Ç–∫–∏ –∏ –¥–∞—Ç–æ–π/–≤—Ä–µ–º–µ–Ω–µ–º swap.

## üîé Verification Matrix

| Check type | Required | How exactly                                                                                           | Evidence                                         |
|-----------|----------|--------------------------------------------------------------------------------------------------------|--------------------------------------------------|
| Compose   | ‚úÖ       | `ssh uk1 "cd /opt/ois-cfa_new && docker compose ps"`                                                   | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã `running`, –±–µ–∑ CrashLoop              |
| Health    | ‚úÖ       | `curl` –∫ API/Keycloak/–ø–æ—Ä—Ç–∞–ª–∞–º (–ª–æ–∫–∞–ª—å–Ω–æ –∏ —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω—ã Cloudflare)                                   | HTTP 200/302, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ 5xx                     |
| Playwright| ‚úÖ       | `python3 /opt/checks/issuer_login.py` –∏–ª–∏ `npm test -- --grep 'UK1'`                                   | –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∏ –ª–æ–≥ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è               |
| Swap      | ‚úÖ       | `ls -ld /opt/ois-cfa /opt/ois-cfa_old_*` –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏                                                | –ü—É—Ç—å –Ω–æ–≤–æ–≥–æ runtime –∏ –±—ç–∫–∞–ø–∞                     |

## üöÄ Kickoff / Plan (–¥–ª—è –∞–≥–µ–Ω—Ç–∞)

1. –ù–∞ UK1 –≤ release‚Äë–∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ–¥–Ω—è—Ç—å —Å—Ç–µ–∫ (`docker compose up -d`), —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Ä—Ç—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å–æ —Å—Ç–∞—Ä—ã–º runtime.  
2. –ü—Ä–æ–≥–Ω–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ health‚Äë—á–µ–∫–∏ (localhost) –∏ –≤–Ω–µ—à–Ω–∏–µ (—á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω—ã Cloudflare).  
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å Playwright‚Äë—Å—Ü–µ–Ω–∞—Ä–∏–∏, —Å–¥–µ–ª–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–æ–¥ UK1.  
4. –í—ã–ø–æ–ª–Ω–∏—Ç—å swap –∫–∞—Ç–∞–ª–æ–≥–æ–≤ (`/opt/ois-cfa_old_*` ‚Üî –Ω–æ–≤—ã–π `/opt/ois-cfa`), –æ–±–Ω–æ–≤–∏—Ç—å systemd/tmux –∫–æ–Ω—Ñ–∏–≥–∏.  
5. –û–ø–∏—Å–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π rollback –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è –≤ `memory-bank/Scrum/20251126-cicd-cfa2/` –∏ –æ—Ç–º–µ—Ç–∏—Ç—å story –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é.

## üîÅ Loop trace

> Loop 1: –ø–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π develop –Ω–∞ UK1.  
> Loop N: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–≤–æ–ø—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö release‚Äë–≤–µ—Ç–∫–∏.

